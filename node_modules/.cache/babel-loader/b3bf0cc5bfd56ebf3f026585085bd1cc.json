{"remainingRequest":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/babel-loader/lib/index.js!/Users/antonyching/Desktop/project/new-builder-demo/node_modules/@ckeditor/ckeditor5-engine/src/conversion/downcastdispatcher.js","dependencies":[{"path":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/@ckeditor/ckeditor5-engine/src/conversion/downcastdispatcher.js","mtime":499162500000},{"path":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/@ckeditor/ckeditor5-dev-webpack-plugin/lib/translatesourceloader.js","mtime":499162500000},{"path":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/babel-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:LyoqCiAqIEBsaWNlbnNlIENvcHlyaWdodCAoYykgMjAwMy0yMDE5LCBDS1NvdXJjZSAtIEZyZWRlcmljbyBLbmFiYmVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBGb3IgbGljZW5zaW5nLCBzZWUgTElDRU5TRS5tZCBvciBodHRwczovL2NrZWRpdG9yLmNvbS9sZWdhbC9ja2VkaXRvci1vc3MtbGljZW5zZQogKi8KCi8qKgogKiBAbW9kdWxlIGVuZ2luZS9jb252ZXJzaW9uL2Rvd25jYXN0ZGlzcGF0Y2hlcgogKi8KaW1wb3J0IENvbnN1bWFibGUgZnJvbSAnLi9tb2RlbGNvbnN1bWFibGUnOwppbXBvcnQgUmFuZ2UgZnJvbSAnLi4vbW9kZWwvcmFuZ2UnOwppbXBvcnQgRW1pdHRlck1peGluIGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2VtaXR0ZXJtaXhpbic7CmltcG9ydCBtaXggZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11dGlscy9zcmMvbWl4JzsKaW1wb3J0IHsgZXh0ZW5kIH0gZnJvbSAnbG9kYXNoLWVzJzsKLyoqCiAqIGBEb3duY2FzdERpc3BhdGNoZXJgIGlzIGEgY2VudHJhbCBwb2ludCBvZiBkb3duY2FzdGluZyAoY29udmVyc2lvbiBmcm9tIG1vZGVsIHRvIHZpZXcpLCB3aGljaCBpcyBhIHByb2Nlc3Mgb2YgcmVhY3RpbmcgdG8gY2hhbmdlcwogKiBpbiB0aGUgbW9kZWwgYW5kIGZpcmluZyBhIHNldCBvZiBldmVudHMuIENhbGxiYWNrcyBsaXN0ZW5pbmcgdG8gdGhvc2UgZXZlbnRzIGFyZSBjYWxsZWQgY29udmVydGVycy4gVGhvc2UKICogY29udmVydGVycyByb2xlIGlzIHRvIGNvbnZlcnQgdGhlIG1vZGVsIGNoYW5nZXMgdG8gY2hhbmdlcyBpbiB2aWV3IChmb3IgZXhhbXBsZSwgYWRkaW5nIHZpZXcgbm9kZXMgb3IKICogY2hhbmdpbmcgYXR0cmlidXRlcyBvbiB2aWV3IGVsZW1lbnRzKS4KICoKICogRHVyaW5nIGNvbnZlcnNpb24gcHJvY2VzcywgYERvd25jYXN0RGlzcGF0Y2hlcmAgZmlyZXMgZXZlbnRzLCBiYXNpbmcgb24gc3RhdGUgb2YgdGhlIG1vZGVsIGFuZCBwcmVwYXJlcwogKiBkYXRhIGZvciB0aG9zZSBldmVudHMuIEl0IGlzIGltcG9ydGFudCB0byB1bmRlcnN0YW5kIHRoYXQgdGhvc2UgZXZlbnRzIGFyZSBjb25uZWN0ZWQgd2l0aCBjaGFuZ2VzIGRvbmUgb24gbW9kZWwsCiAqIGZvciBleGFtcGxlOiAibm9kZSBoYXMgYmVlbiBpbnNlcnRlZCIgb3IgImF0dHJpYnV0ZSBoYXMgY2hhbmdlZCIuIFRoaXMgaXMgaW4gYSBjb250cmFyeSB0byB1cGNhc3RpbmcgKHZpZXcgdG8gbW9kZWwgY29udmVyc2lvbiksCiAqIHdoZXJlIHdlIGNvbnZlcnQgdmlldyBzdGF0ZSAodmlldyBub2RlcykgdG8gYSBtb2RlbCB0cmVlLgogKgogKiBUaGUgZXZlbnRzIGFyZSBwcmVwYXJlZCBiYXNpbmcgb24gYSBkaWZmIGNyZWF0ZWQgYnkge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZGlmZmVyfkRpZmZlciBEaWZmZXJ9LCB3aGljaCBidWZmZXJzIHRoZW0KICogYW5kIHRoZW4gcGFzc2VzIHRvIGBEb3duY2FzdERpc3BhdGNoZXJgIGFzIGEgZGlmZiBiZXR3ZWVuIG9sZCBtb2RlbCBzdGF0ZSBhbmQgbmV3IG1vZGVsIHN0YXRlLgogKgogKiBOb3RlLCB0aGF0IGJlY2F1c2UgY2hhbmdlcyBhcmUgY29udmVydGVkIHRoZXJlIGlzIGEgbmVlZCB0byBoYXZlIGEgbWFwcGluZyBiZXR3ZWVuIG1vZGVsIHN0cnVjdHVyZSBhbmQgdmlldyBzdHJ1Y3R1cmUuCiAqIFRvIG1hcCBwb3NpdGlvbnMgYW5kIGVsZW1lbnRzIGR1cmluZyBkb3duY2FzdCAobW9kZWwgdG8gdmlldyBjb252ZXJzaW9uKSB1c2Uge0BsaW5rIG1vZHVsZTplbmdpbmUvY29udmVyc2lvbi9tYXBwZXJ+TWFwcGVyfS4KICoKICogYERvd25jYXN0RGlzcGF0Y2hlcmAgZmlyZXMgZm9sbG93aW5nIGV2ZW50cyBmb3IgbW9kZWwgdHJlZSBjaGFuZ2VzOgogKgogKiAqIHtAbGluayBtb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vZG93bmNhc3RkaXNwYXRjaGVyfkRvd25jYXN0RGlzcGF0Y2hlciNldmVudDppbnNlcnQgaW5zZXJ0fQogKiBpZiBhIHJhbmdlIG9mIG5vZGVzIGhhcyBiZWVuIGluc2VydGVkIHRvIHRoZSBtb2RlbCB0cmVlLAogKiAqIHtAbGluayBtb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vZG93bmNhc3RkaXNwYXRjaGVyfkRvd25jYXN0RGlzcGF0Y2hlciNldmVudDpyZW1vdmUgcmVtb3ZlfQogKiBpZiBhIHJhbmdlIG9mIG5vZGVzIGhhcyBiZWVuIHJlbW92ZWQgZnJvbSB0aGUgbW9kZWwgdHJlZSwKICogKiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9jb252ZXJzaW9uL2Rvd25jYXN0ZGlzcGF0Y2hlcn5Eb3duY2FzdERpc3BhdGNoZXIjZXZlbnQ6YXR0cmlidXRlIGF0dHJpYnV0ZX0KICogaWYgYXR0cmlidXRlIGhhcyBiZWVuIGFkZGVkLCBjaGFuZ2VkIG9yIHJlbW92ZWQgZnJvbSBhIG1vZGVsIG5vZGUuCiAqCiAqIEZvciB7QGxpbmsgbW9kdWxlOmVuZ2luZS9jb252ZXJzaW9uL2Rvd25jYXN0ZGlzcGF0Y2hlcn5Eb3duY2FzdERpc3BhdGNoZXIjZXZlbnQ6aW5zZXJ0IGluc2VydH0KICogYW5kIHtAbGluayBtb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vZG93bmNhc3RkaXNwYXRjaGVyfkRvd25jYXN0RGlzcGF0Y2hlciNldmVudDphdHRyaWJ1dGUgYXR0cmlidXRlfSwKICogYERvd25jYXN0RGlzcGF0Y2hlcmAgZ2VuZXJhdGVzIHtAbGluayBtb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vbW9kZWxjb25zdW1hYmxlfk1vZGVsQ29uc3VtYWJsZSBjb25zdW1hYmxlc30uCiAqIFRoZXNlIGFyZSB1c2VkIHRvIGhhdmUgYSBjb250cm9sIG92ZXIgd2hpY2ggY2hhbmdlcyBoYXMgYmVlbiBhbHJlYWR5IGNvbnN1bWVkLiBJdCBpcyB1c2VmdWwgd2hlbiBzb21lIGNvbnZlcnRlcnMKICogb3ZlcndyaXRlIG90aGVyIG9yIGNvbnZlcnRzIG11bHRpcGxlIGNoYW5nZXMgKGZvciBleGFtcGxlIGNvbnZlcnRzIGluc2VydGlvbiBvZiBhbiBlbGVtZW50IGFuZCBhbHNvIGNvbnZlcnRzIHRoYXQKICogZWxlbWVudCdzIGF0dHJpYnV0ZXMgZHVyaW5nIGluc2VydGlvbikuCiAqCiAqIEFkZGl0aW9uYWxseSwgYERvd25jYXN0RGlzcGF0Y2hlcmAgZmlyZXMgZXZlbnRzIGZvciB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9tYXJrZXJjb2xsZWN0aW9ufk1hcmtlciBtYXJrZXJ9IGNoYW5nZXM6CiAqCiAqICoge0BsaW5rIG1vZHVsZTplbmdpbmUvY29udmVyc2lvbi9kb3duY2FzdGRpc3BhdGNoZXJ+RG93bmNhc3REaXNwYXRjaGVyI2V2ZW50OmFkZE1hcmtlcn0gaWYgYSBtYXJrZXIgaGFzIGJlZW4gYWRkZWQsCiAqICoge0BsaW5rIG1vZHVsZTplbmdpbmUvY29udmVyc2lvbi9kb3duY2FzdGRpc3BhdGNoZXJ+RG93bmNhc3REaXNwYXRjaGVyI2V2ZW50OnJlbW92ZU1hcmtlcn0gaWYgYSBtYXJrZXIgaGFzIGJlZW4gcmVtb3ZlZC4KICoKICogTm90ZSwgdGhhdCBjaGFuZ2luZyBhIG1hcmtlciBpcyBkb25lIHRocm91Z2ggcmVtb3ZpbmcgdGhlIG1hcmtlciBmcm9tIHRoZSBvbGQgcmFuZ2UsIGFuZCBhZGRpbmcgb24gdGhlIG5ldyByYW5nZSwKICogc28gYm90aCB0aG9zZSBldmVudHMgYXJlIGZpcmVkLgogKgogKiBGaW5hbGx5LCBgRG93bmNhc3REaXNwYXRjaGVyYCBhbHNvIGhhbmRsZXMgZmlyaW5nIGV2ZW50cyBmb3Ige0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvc2VsZWN0aW9uIG1vZGVsIHNlbGVjdGlvbn0KICogY29udmVyc2lvbjoKICoKICogKiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9jb252ZXJzaW9uL2Rvd25jYXN0ZGlzcGF0Y2hlcn5Eb3duY2FzdERpc3BhdGNoZXIjZXZlbnQ6c2VsZWN0aW9ufQogKiB3aGljaCBjb252ZXJ0cyBzZWxlY3Rpb24gZnJvbSBtb2RlbCB0byB2aWV3LAogKiAqIHtAbGluayBtb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vZG93bmNhc3RkaXNwYXRjaGVyfkRvd25jYXN0RGlzcGF0Y2hlciNldmVudDphdHRyaWJ1dGV9CiAqIHdoaWNoIGlzIGZpcmVkIGZvciBldmVyeSBzZWxlY3Rpb24gYXR0cmlidXRlLAogKiAqIHtAbGluayBtb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vZG93bmNhc3RkaXNwYXRjaGVyfkRvd25jYXN0RGlzcGF0Y2hlciNldmVudDphZGRNYXJrZXJ9CiAqIHdoaWNoIGlzIGZpcmVkIGZvciBldmVyeSBtYXJrZXIgd2hpY2ggY29udGFpbnMgc2VsZWN0aW9uLgogKgogKiBVbmxpa2UgbW9kZWwgdHJlZSBhbmQgbWFya2VycywgZXZlbnRzIGZvciBzZWxlY3Rpb24gYXJlIG5vdCBmaXJlZCBmb3IgY2hhbmdlcyBidXQgZm9yIHNlbGVjdGlvbiBzdGF0ZS4KICoKICogV2hlbiBwcm92aWRpbmcgY3VzdG9tIGxpc3RlbmVycyBmb3IgYERvd25jYXN0RGlzcGF0Y2hlcmAgcmVtZW1iZXIgdG8gY2hlY2sgd2hldGhlciBnaXZlbiBjaGFuZ2UgaGFzIG5vdCBiZWVuCiAqIHtAbGluayBtb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vbW9kZWxjb25zdW1hYmxlfk1vZGVsQ29uc3VtYWJsZSNjb25zdW1lIGNvbnN1bWVkfSB5ZXQuCiAqCiAqIFdoZW4gcHJvdmlkaW5nIGN1c3RvbSBsaXN0ZW5lcnMgZm9yIGBEb3duY2FzdERpc3BhdGNoZXJgIGtlZXAgaW4gbWluZCB0aGF0IGFueSBjYWxsYmFjayB0aGF0IGhhZAogKiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9jb252ZXJzaW9uL21vZGVsY29uc3VtYWJsZX5Nb2RlbENvbnN1bWFibGUjY29uc3VtZSBjb25zdW1lZH0gYSB2YWx1ZSBmcm9tIGEgY29uc3VtYWJsZSBhbmQKICogY29udmVydGVkIHRoZSBjaGFuZ2Ugc2hvdWxkIGFsc28gc3RvcCB0aGUgZXZlbnQgKGZvciBlZmZpY2llbmN5IHB1cnBvc2VzKS4KICoKICogV2hlbiBwcm92aWRpbmcgY3VzdG9tIGxpc3RlbmVycyBmb3IgYERvd25jYXN0RGlzcGF0Y2hlcmAgcmVtZW1iZXIgdG8gdXNlIHByb3ZpZGVkCiAqIHtAbGluayBtb2R1bGU6ZW5naW5lL3ZpZXcvZG93bmNhc3R3cml0ZXJ+RG93bmNhc3RXcml0ZXIgdmlldyBkb3duY2FzdCB3cml0ZXJ9IHRvIGFwcGx5IGNoYW5nZXMgdG8gdGhlIHZpZXcgZG9jdW1lbnQuCiAqCiAqIEV4YW1wbGUgb2YgYSBjdXN0b20gY29udmVydGVyIGZvciBgRG93bmNhc3REaXNwYXRjaGVyYDoKICoKICoJCS8vIFdlIHdpbGwgY29udmVydCBpbnNlcnRpbmcgInBhcmFncmFwaCIgbW9kZWwgZWxlbWVudCBpbnRvIHRoZSBtb2RlbC4KICoJCWRvd25jYXN0RGlzcGF0Y2hlci5vbiggJ2luc2VydDpwYXJhZ3JhcGgnLCAoIGV2dCwgZGF0YSwgY29udmVyc2lvbkFwaSApID0+IHsKICoJCQkvLyBSZW1lbWJlciB0byBjaGVjayB3aGV0aGVyIHRoZSBjaGFuZ2UgaGFzIG5vdCBiZWVuIGNvbnN1bWVkIHlldCBhbmQgY29uc3VtZSBpdC4KICoJCQlpZiAoIGNvbnZlcnNpb25BcGkuY29uc3VtYWJsZS5jb25zdW1lKCBkYXRhLml0ZW0sICdpbnNlcnQnICkgKSB7CiAqCQkJCXJldHVybjsKICoJCQl9CiAqCiAqCQkJLy8gVHJhbnNsYXRlIHBvc2l0aW9uIGluIG1vZGVsIHRvIHBvc2l0aW9uIGluIHZpZXcuCiAqCQkJY29uc3Qgdmlld1Bvc2l0aW9uID0gY29udmVyc2lvbkFwaS5tYXBwZXIudG9WaWV3UG9zaXRpb24oIGRhdGEucmFuZ2Uuc3RhcnQgKTsKICoKICoJCQkvLyBDcmVhdGUgPHA+IGVsZW1lbnQgdGhhdCB3aWxsIGJlIGluc2VydGVkIGluIHZpZXcgYXQgYHZpZXdQb3NpdGlvbmAuCiAqCQkJY29uc3Qgdmlld0VsZW1lbnQgPSBjb252ZXJzaW9uQXBpLndyaXRlci5jcmVhdGVDb250YWluZXJFbGVtZW50KCAncCcgKTsKICoKICoJCQkvLyBCaW5kIHRoZSBuZXdseSBjcmVhdGVkIHZpZXcgZWxlbWVudCB0byBtb2RlbCBlbGVtZW50IHNvIHBvc2l0aW9ucyB3aWxsIG1hcCBhY2NvcmRpbmdseSBpbiBmdXR1cmUuCiAqCQkJY29udmVyc2lvbkFwaS5tYXBwZXIuYmluZEVsZW1lbnRzKCBkYXRhLml0ZW0sIHZpZXdFbGVtZW50ICk7CiAqCiAqCQkJLy8gQWRkIHRoZSBuZXdseSBjcmVhdGVkIHZpZXcgZWxlbWVudCB0byB0aGUgdmlldy4KICoJCQljb252ZXJzaW9uQXBpLndyaXRlci5pbnNlcnQoIHZpZXdQb3NpdGlvbiwgdmlld0VsZW1lbnQgKTsKICoKICoJCQkvLyBSZW1lbWJlciB0byBzdG9wIHRoZSBldmVudCBwcm9wYWdhdGlvbi4KICoJCQlldnQuc3RvcCgpOwogKgkJfSApOwogKi8KCmV4cG9ydCBkZWZhdWx0IGNsYXNzIERvd25jYXN0RGlzcGF0Y2hlciB7CiAgLyoqCiAgICogQ3JlYXRlcyBhIGBEb3duY2FzdERpc3BhdGNoZXJgIGluc3RhbmNlLgogICAqCiAgICogQHNlZSBtb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vZG93bmNhc3RkaXNwYXRjaGVyfkRvd25jYXN0Q29udmVyc2lvbkFwaQogICAqIEBwYXJhbSB7T2JqZWN0fSBjb252ZXJzaW9uQXBpIEFkZGl0aW9uYWwgcHJvcGVydGllcyBmb3IgaW50ZXJmYWNlIHRoYXQgd2lsbCBiZSBwYXNzZWQgdG8gZXZlbnRzIGZpcmVkCiAgICogYnkgYERvd25jYXN0RGlzcGF0Y2hlcmAuCiAgICovCiAgY29uc3RydWN0b3IoY29udmVyc2lvbkFwaSkgewogICAgLyoqCiAgICAgKiBJbnRlcmZhY2UgcGFzc2VkIGJ5IGRpc3BhdGNoZXIgdG8gdGhlIGV2ZW50cyBjYWxsYmFja3MuCiAgICAgKgogICAgICogQG1lbWJlciB7bW9kdWxlOmVuZ2luZS9jb252ZXJzaW9uL2Rvd25jYXN0ZGlzcGF0Y2hlcn5Eb3duY2FzdENvbnZlcnNpb25BcGl9CiAgICAgKi8KICAgIHRoaXMuY29udmVyc2lvbkFwaSA9IGV4dGVuZCh7CiAgICAgIGRpc3BhdGNoZXI6IHRoaXMKICAgIH0sIGNvbnZlcnNpb25BcGkpOwogIH0KICAvKioKICAgKiBUYWtlcyB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9kaWZmZXJ+RGlmZmVyIG1vZGVsIGRpZmZlcn0gb2JqZWN0IHdpdGggYnVmZmVyZWQgY2hhbmdlcyBhbmQgZmlyZXMgY29udmVyc2lvbiBiYXNpbmcgb24gaXQuCiAgICoKICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvZGlmZmVyfkRpZmZlcn0gZGlmZmVyIERpZmZlciBvYmplY3Qgd2l0aCBidWZmZXJlZCBjaGFuZ2VzLgogICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9tYXJrZXJjb2xsZWN0aW9ufk1hcmtlckNvbGxlY3Rpb259IG1hcmtlcnMgTWFya2VycyBjb25uZWN0ZWQgd2l0aCBjb252ZXJ0ZWQgbW9kZWwuCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvZG93bmNhc3R3cml0ZXJ+RG93bmNhc3RXcml0ZXJ9IHdyaXRlciBWaWV3IHdyaXRlciB0aGF0IHNob3VsZCBiZSB1c2VkIHRvIG1vZGlmeSB2aWV3IGRvY3VtZW50LgogICAqLwoKCiAgY29udmVydENoYW5nZXMoZGlmZmVyLCBtYXJrZXJzLCB3cml0ZXIpIHsKICAgIC8vIEJlZm9yZSB0aGUgdmlldyBpcyB1cGRhdGVkLCByZW1vdmUgbWFya2VycyB3aGljaCBoYXZlIGNoYW5nZWQuCiAgICBmb3IgKGNvbnN0IGNoYW5nZSBvZiBkaWZmZXIuZ2V0TWFya2Vyc1RvUmVtb3ZlKCkpIHsKICAgICAgdGhpcy5jb252ZXJ0TWFya2VyUmVtb3ZlKGNoYW5nZS5uYW1lLCBjaGFuZ2UucmFuZ2UsIHdyaXRlcik7CiAgICB9IC8vIENvbnZlcnQgY2hhbmdlcyB0aGF0IGhhcHBlbmVkIG9uIG1vZGVsIHRyZWUuCgoKICAgIGZvciAoY29uc3QgZW50cnkgb2YgZGlmZmVyLmdldENoYW5nZXMoKSkgewogICAgICBpZiAoZW50cnkudHlwZSA9PSAnaW5zZXJ0JykgewogICAgICAgIHRoaXMuY29udmVydEluc2VydChSYW5nZS5fY3JlYXRlRnJvbVBvc2l0aW9uQW5kU2hpZnQoZW50cnkucG9zaXRpb24sIGVudHJ5Lmxlbmd0aCksIHdyaXRlcik7CiAgICAgIH0gZWxzZSBpZiAoZW50cnkudHlwZSA9PSAncmVtb3ZlJykgewogICAgICAgIHRoaXMuY29udmVydFJlbW92ZShlbnRyeS5wb3NpdGlvbiwgZW50cnkubGVuZ3RoLCBlbnRyeS5uYW1lLCB3cml0ZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGVudHJ5LnR5cGUgPT0gJ2F0dHJpYnV0ZScuCiAgICAgICAgdGhpcy5jb252ZXJ0QXR0cmlidXRlKGVudHJ5LnJhbmdlLCBlbnRyeS5hdHRyaWJ1dGVLZXksIGVudHJ5LmF0dHJpYnV0ZU9sZFZhbHVlLCBlbnRyeS5hdHRyaWJ1dGVOZXdWYWx1ZSwgd3JpdGVyKTsKICAgICAgfQogICAgfQoKICAgIGZvciAoY29uc3QgbWFya2VyTmFtZSBvZiB0aGlzLmNvbnZlcnNpb25BcGkubWFwcGVyLmZsdXNoVW5ib3VuZE1hcmtlck5hbWVzKCkpIHsKICAgICAgY29uc3QgbWFya2VyUmFuZ2UgPSBtYXJrZXJzLmdldChtYXJrZXJOYW1lKS5nZXRSYW5nZSgpOwogICAgICB0aGlzLmNvbnZlcnRNYXJrZXJSZW1vdmUobWFya2VyTmFtZSwgbWFya2VyUmFuZ2UsIHdyaXRlcik7CiAgICAgIHRoaXMuY29udmVydE1hcmtlckFkZChtYXJrZXJOYW1lLCBtYXJrZXJSYW5nZSwgd3JpdGVyKTsKICAgIH0gLy8gQWZ0ZXIgdGhlIHZpZXcgaXMgdXBkYXRlZCwgY29udmVydCBtYXJrZXJzIHdoaWNoIGhhdmUgY2hhbmdlZC4KCgogICAgZm9yIChjb25zdCBjaGFuZ2Ugb2YgZGlmZmVyLmdldE1hcmtlcnNUb0FkZCgpKSB7CiAgICAgIHRoaXMuY29udmVydE1hcmtlckFkZChjaGFuZ2UubmFtZSwgY2hhbmdlLnJhbmdlLCB3cml0ZXIpOwogICAgfQogIH0KICAvKioKICAgKiBTdGFydHMgY29udmVyc2lvbiBvZiBhIHJhbmdlIGluc2VydGlvbi4KICAgKgogICAqIEZvciBlYWNoIG5vZGUgaW4gdGhlIHJhbmdlLCB7QGxpbmsgI2V2ZW50Omluc2VydCBpbnNlcnQgZXZlbnQgaXMgZmlyZWR9LiBGb3IgZWFjaCBhdHRyaWJ1dGUgb24gZWFjaCBub2RlLAogICAqIHtAbGluayAjZXZlbnQ6YXR0cmlidXRlIGF0dHJpYnV0ZSBldmVudCBpcyBmaXJlZH0uCiAgICoKICAgKiBAZmlyZXMgaW5zZXJ0CiAgICogQGZpcmVzIGF0dHJpYnV0ZQogICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9yYW5nZX5SYW5nZX0gcmFuZ2UgSW5zZXJ0ZWQgcmFuZ2UuCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvZG93bmNhc3R3cml0ZXJ+RG93bmNhc3RXcml0ZXJ9IHdyaXRlciBWaWV3IHdyaXRlciB0aGF0IHNob3VsZCBiZSB1c2VkIHRvIG1vZGlmeSB2aWV3IGRvY3VtZW50LgogICAqLwoKCiAgY29udmVydEluc2VydChyYW5nZSwgd3JpdGVyKSB7CiAgICB0aGlzLmNvbnZlcnNpb25BcGkud3JpdGVyID0gd3JpdGVyOyAvLyBDcmVhdGUgYSBsaXN0IG9mIHRoaW5ncyB0aGF0IGNhbiBiZSBjb25zdW1lZCwgY29uc2lzdGluZyBvZiBub2RlcyBhbmQgdGhlaXIgYXR0cmlidXRlcy4KCiAgICB0aGlzLmNvbnZlcnNpb25BcGkuY29uc3VtYWJsZSA9IHRoaXMuX2NyZWF0ZUluc2VydENvbnN1bWFibGUocmFuZ2UpOyAvLyBGaXJlIGEgc2VwYXJhdGUgaW5zZXJ0IGV2ZW50IGZvciBlYWNoIG5vZGUgYW5kIHRleHQgZnJhZ21lbnQgY29udGFpbmVkIGluIHRoZSByYW5nZS4KCiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHJhbmdlKSB7CiAgICAgIGNvbnN0IGl0ZW0gPSB2YWx1ZS5pdGVtOwoKICAgICAgY29uc3QgaXRlbVJhbmdlID0gUmFuZ2UuX2NyZWF0ZUZyb21Qb3NpdGlvbkFuZFNoaWZ0KHZhbHVlLnByZXZpb3VzUG9zaXRpb24sIHZhbHVlLmxlbmd0aCk7CgogICAgICBjb25zdCBkYXRhID0gewogICAgICAgIGl0ZW0sCiAgICAgICAgcmFuZ2U6IGl0ZW1SYW5nZQogICAgICB9OwoKICAgICAgdGhpcy5fdGVzdEFuZEZpcmUoJ2luc2VydCcsIGRhdGEpOyAvLyBGaXJlIGEgc2VwYXJhdGUgYWRkQXR0cmlidXRlIGV2ZW50IGZvciBlYWNoIGF0dHJpYnV0ZSB0aGF0IHdhcyBzZXQgb24gaW5zZXJ0ZWQgaXRlbXMuCiAgICAgIC8vIFRoaXMgaXMgaW1wb3J0YW50IGJlY2F1c2UgbW9zdCBhdHRyaWJ1dGVzIGNvbnZlcnRlcnMgd2lsbCBsaXN0ZW4gb25seSB0byBhZGQvY2hhbmdlL3JlbW92ZUF0dHJpYnV0ZSBldmVudHMuCiAgICAgIC8vIElmIHdlIHdvdWxkIG5vdCBhZGQgdGhpcyBwYXJ0LCBhdHRyaWJ1dGVzIG9uIGluc2VydGVkIG5vZGVzIHdvdWxkIG5vdCBiZSBjb252ZXJ0ZWQuCgoKICAgICAgZm9yIChjb25zdCBrZXkgb2YgaXRlbS5nZXRBdHRyaWJ1dGVLZXlzKCkpIHsKICAgICAgICBkYXRhLmF0dHJpYnV0ZUtleSA9IGtleTsKICAgICAgICBkYXRhLmF0dHJpYnV0ZU9sZFZhbHVlID0gbnVsbDsKICAgICAgICBkYXRhLmF0dHJpYnV0ZU5ld1ZhbHVlID0gaXRlbS5nZXRBdHRyaWJ1dGUoa2V5KTsKCiAgICAgICAgdGhpcy5fdGVzdEFuZEZpcmUoYGF0dHJpYnV0ZToke2tleX1gLCBkYXRhKTsKICAgICAgfQogICAgfQoKICAgIHRoaXMuX2NsZWFyQ29udmVyc2lvbkFwaSgpOwogIH0KICAvKioKICAgKiBGaXJlcyBjb252ZXJzaW9uIG9mIGEgc2luZ2xlIG5vZGUgcmVtb3ZhbC4gRmlyZXMge0BsaW5rICNldmVudDpyZW1vdmUgcmVtb3ZlIGV2ZW50fSB3aXRoIHByb3ZpZGVkIGRhdGEuCiAgICoKICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvcG9zaXRpb25+UG9zaXRpb259IHBvc2l0aW9uIFBvc2l0aW9uIGZyb20gd2hpY2ggbm9kZSB3YXMgcmVtb3ZlZC4KICAgKiBAcGFyYW0ge051bWJlcn0gbGVuZ3RoIE9mZnNldCBzaXplIG9mIHJlbW92ZWQgbm9kZS4KICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBOYW1lIG9mIHJlbW92ZWQgbm9kZS4KICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9kb3duY2FzdHdyaXRlcn5Eb3duY2FzdFdyaXRlcn0gd3JpdGVyIFZpZXcgd3JpdGVyIHRoYXQgc2hvdWxkIGJlIHVzZWQgdG8gbW9kaWZ5IHZpZXcgZG9jdW1lbnQuCiAgICovCgoKICBjb252ZXJ0UmVtb3ZlKHBvc2l0aW9uLCBsZW5ndGgsIG5hbWUsIHdyaXRlcikgewogICAgdGhpcy5jb252ZXJzaW9uQXBpLndyaXRlciA9IHdyaXRlcjsKICAgIHRoaXMuZmlyZSgncmVtb3ZlOicgKyBuYW1lLCB7CiAgICAgIHBvc2l0aW9uLAogICAgICBsZW5ndGgKICAgIH0sIHRoaXMuY29udmVyc2lvbkFwaSk7CgogICAgdGhpcy5fY2xlYXJDb252ZXJzaW9uQXBpKCk7CiAgfQogIC8qKgogICAqIFN0YXJ0cyBjb252ZXJzaW9uIG9mIGF0dHJpYnV0ZSBjaGFuZ2Ugb24gZ2l2ZW4gYHJhbmdlYC4KICAgKgogICAqIEZvciBlYWNoIG5vZGUgaW4gdGhlIGdpdmVuIGByYW5nZWAsIHtAbGluayAjZXZlbnQ6YXR0cmlidXRlIGF0dHJpYnV0ZSBldmVudH0gaXMgZmlyZWQgd2l0aCB0aGUgcGFzc2VkIGRhdGEuCiAgICoKICAgKiBAZmlyZXMgYXR0cmlidXRlCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL3JhbmdlflJhbmdlfSByYW5nZSBDaGFuZ2VkIHJhbmdlLgogICAqIEBwYXJhbSB7U3RyaW5nfSBrZXkgS2V5IG9mIHRoZSBhdHRyaWJ1dGUgdGhhdCBoYXMgY2hhbmdlZC4KICAgKiBAcGFyYW0geyp9IG9sZFZhbHVlIEF0dHJpYnV0ZSB2YWx1ZSBiZWZvcmUgdGhlIGNoYW5nZSBvciBgbnVsbGAgaWYgdGhlIGF0dHJpYnV0ZSBoYXMgbm90IGJlZW4gc2V0IGJlZm9yZS4KICAgKiBAcGFyYW0geyp9IG5ld1ZhbHVlIE5ldyBhdHRyaWJ1dGUgdmFsdWUgb3IgYG51bGxgIGlmIHRoZSBhdHRyaWJ1dGUgaGFzIGJlZW4gcmVtb3ZlZC4KICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9kb3duY2FzdHdyaXRlcn5Eb3duY2FzdFdyaXRlcn0gd3JpdGVyIFZpZXcgd3JpdGVyIHRoYXQgc2hvdWxkIGJlIHVzZWQgdG8gbW9kaWZ5IHZpZXcgZG9jdW1lbnQuCiAgICovCgoKICBjb252ZXJ0QXR0cmlidXRlKHJhbmdlLCBrZXksIG9sZFZhbHVlLCBuZXdWYWx1ZSwgd3JpdGVyKSB7CiAgICB0aGlzLmNvbnZlcnNpb25BcGkud3JpdGVyID0gd3JpdGVyOyAvLyBDcmVhdGUgYSBsaXN0IHdpdGggYXR0cmlidXRlcyB0byBjb25zdW1lLgoKICAgIHRoaXMuY29udmVyc2lvbkFwaS5jb25zdW1hYmxlID0gdGhpcy5fY3JlYXRlQ29uc3VtYWJsZUZvclJhbmdlKHJhbmdlLCBgYXR0cmlidXRlOiR7a2V5fWApOyAvLyBDcmVhdGUgYSBzZXBhcmF0ZSBhdHRyaWJ1dGUgZXZlbnQgZm9yIGVhY2ggbm9kZSBpbiB0aGUgcmFuZ2UuCgogICAgZm9yIChjb25zdCB2YWx1ZSBvZiByYW5nZSkgewogICAgICBjb25zdCBpdGVtID0gdmFsdWUuaXRlbTsKCiAgICAgIGNvbnN0IGl0ZW1SYW5nZSA9IFJhbmdlLl9jcmVhdGVGcm9tUG9zaXRpb25BbmRTaGlmdCh2YWx1ZS5wcmV2aW91c1Bvc2l0aW9uLCB2YWx1ZS5sZW5ndGgpOwoKICAgICAgY29uc3QgZGF0YSA9IHsKICAgICAgICBpdGVtLAogICAgICAgIHJhbmdlOiBpdGVtUmFuZ2UsCiAgICAgICAgYXR0cmlidXRlS2V5OiBrZXksCiAgICAgICAgYXR0cmlidXRlT2xkVmFsdWU6IG9sZFZhbHVlLAogICAgICAgIGF0dHJpYnV0ZU5ld1ZhbHVlOiBuZXdWYWx1ZQogICAgICB9OwoKICAgICAgdGhpcy5fdGVzdEFuZEZpcmUoYGF0dHJpYnV0ZToke2tleX1gLCBkYXRhKTsKICAgIH0KCiAgICB0aGlzLl9jbGVhckNvbnZlcnNpb25BcGkoKTsKICB9CiAgLyoqCiAgICogU3RhcnRzIG1vZGVsIHNlbGVjdGlvbiBjb252ZXJzaW9uLgogICAqCiAgICogRmlyZXMgZXZlbnRzIGZvciBnaXZlbiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9zZWxlY3Rpb25+U2VsZWN0aW9uIHNlbGVjdGlvbn0gdG8gc3RhcnQgc2VsZWN0aW9uIGNvbnZlcnNpb24uCiAgICoKICAgKiBAZmlyZXMgc2VsZWN0aW9uCiAgICogQGZpcmVzIGFkZE1hcmtlcgogICAqIEBmaXJlcyBhdHRyaWJ1dGUKICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvc2VsZWN0aW9uflNlbGVjdGlvbn0gc2VsZWN0aW9uIFNlbGVjdGlvbiB0byBjb252ZXJ0LgogICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9tYXJrZXJjb2xsZWN0aW9ufk1hcmtlckNvbGxlY3Rpb259IG1hcmtlcnMgTWFya2VycyBjb25uZWN0ZWQgd2l0aCBjb252ZXJ0ZWQgbW9kZWwuCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvZG93bmNhc3R3cml0ZXJ+RG93bmNhc3RXcml0ZXJ9IHdyaXRlciBWaWV3IHdyaXRlciB0aGF0IHNob3VsZCBiZSB1c2VkIHRvIG1vZGlmeSB2aWV3IGRvY3VtZW50LgogICAqLwoKCiAgY29udmVydFNlbGVjdGlvbihzZWxlY3Rpb24sIG1hcmtlcnMsIHdyaXRlcikgewogICAgY29uc3QgbWFya2Vyc0F0U2VsZWN0aW9uID0gQXJyYXkuZnJvbShtYXJrZXJzLmdldE1hcmtlcnNBdFBvc2l0aW9uKHNlbGVjdGlvbi5nZXRGaXJzdFBvc2l0aW9uKCkpKTsKICAgIHRoaXMuY29udmVyc2lvbkFwaS53cml0ZXIgPSB3cml0ZXI7CiAgICB0aGlzLmNvbnZlcnNpb25BcGkuY29uc3VtYWJsZSA9IHRoaXMuX2NyZWF0ZVNlbGVjdGlvbkNvbnN1bWFibGUoc2VsZWN0aW9uLCBtYXJrZXJzQXRTZWxlY3Rpb24pOwogICAgdGhpcy5maXJlKCdzZWxlY3Rpb24nLCB7CiAgICAgIHNlbGVjdGlvbgogICAgfSwgdGhpcy5jb252ZXJzaW9uQXBpKTsKCiAgICBpZiAoIXNlbGVjdGlvbi5pc0NvbGxhcHNlZCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgZm9yIChjb25zdCBtYXJrZXIgb2YgbWFya2Vyc0F0U2VsZWN0aW9uKSB7CiAgICAgIGNvbnN0IG1hcmtlclJhbmdlID0gbWFya2VyLmdldFJhbmdlKCk7CgogICAgICBpZiAoIXNob3VsZE1hcmtlckNoYW5nZUJlQ29udmVydGVkKHNlbGVjdGlvbi5nZXRGaXJzdFBvc2l0aW9uKCksIG1hcmtlciwgdGhpcy5jb252ZXJzaW9uQXBpLm1hcHBlcikpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgY29uc3QgZGF0YSA9IHsKICAgICAgICBpdGVtOiBzZWxlY3Rpb24sCiAgICAgICAgbWFya2VyTmFtZTogbWFya2VyLm5hbWUsCiAgICAgICAgbWFya2VyUmFuZ2UKICAgICAgfTsKCiAgICAgIGlmICh0aGlzLmNvbnZlcnNpb25BcGkuY29uc3VtYWJsZS50ZXN0KHNlbGVjdGlvbiwgJ2FkZE1hcmtlcjonICsgbWFya2VyLm5hbWUpKSB7CiAgICAgICAgdGhpcy5maXJlKCdhZGRNYXJrZXI6JyArIG1hcmtlci5uYW1lLCBkYXRhLCB0aGlzLmNvbnZlcnNpb25BcGkpOwogICAgICB9CiAgICB9CgogICAgZm9yIChjb25zdCBrZXkgb2Ygc2VsZWN0aW9uLmdldEF0dHJpYnV0ZUtleXMoKSkgewogICAgICBjb25zdCBkYXRhID0gewogICAgICAgIGl0ZW06IHNlbGVjdGlvbiwKICAgICAgICByYW5nZTogc2VsZWN0aW9uLmdldEZpcnN0UmFuZ2UoKSwKICAgICAgICBhdHRyaWJ1dGVLZXk6IGtleSwKICAgICAgICBhdHRyaWJ1dGVPbGRWYWx1ZTogbnVsbCwKICAgICAgICBhdHRyaWJ1dGVOZXdWYWx1ZTogc2VsZWN0aW9uLmdldEF0dHJpYnV0ZShrZXkpCiAgICAgIH07IC8vIERvIG5vdCBmaXJlIGV2ZW50IGlmIHRoZSBhdHRyaWJ1dGUgaGFzIGJlZW4gY29uc3VtZWQuCgogICAgICBpZiAodGhpcy5jb252ZXJzaW9uQXBpLmNvbnN1bWFibGUudGVzdChzZWxlY3Rpb24sICdhdHRyaWJ1dGU6JyArIGRhdGEuYXR0cmlidXRlS2V5KSkgewogICAgICAgIHRoaXMuZmlyZSgnYXR0cmlidXRlOicgKyBkYXRhLmF0dHJpYnV0ZUtleSArICc6JHRleHQnLCBkYXRhLCB0aGlzLmNvbnZlcnNpb25BcGkpOwogICAgICB9CiAgICB9CgogICAgdGhpcy5fY2xlYXJDb252ZXJzaW9uQXBpKCk7CiAgfQogIC8qKgogICAqIENvbnZlcnRzIGFkZGVkIG1hcmtlci4gRmlyZXMge0BsaW5rICNldmVudDphZGRNYXJrZXIgYWRkTWFya2VyfSBldmVudCBmb3IgZWFjaCBpdGVtCiAgICogaW4gbWFya2VyJ3MgcmFuZ2UuIElmIHJhbmdlIGlzIGNvbGxhcHNlZCBzaW5nbGUgZXZlbnQgaXMgZGlzcGF0Y2hlZC4gU2VlIGV2ZW50IGRlc2NyaXB0aW9uIGZvciBtb3JlIGRldGFpbHMuCiAgICoKICAgKiBAZmlyZXMgYWRkTWFya2VyCiAgICogQHBhcmFtIHtTdHJpbmd9IG1hcmtlck5hbWUgTWFya2VyIG5hbWUuCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL3JhbmdlflJhbmdlfSBtYXJrZXJSYW5nZSBNYXJrZXIgcmFuZ2UuCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvZG93bmNhc3R3cml0ZXJ+RG93bmNhc3RXcml0ZXJ9IHdyaXRlciBWaWV3IHdyaXRlciB0aGF0IHNob3VsZCBiZSB1c2VkIHRvIG1vZGlmeSB2aWV3IGRvY3VtZW50LgogICAqLwoKCiAgY29udmVydE1hcmtlckFkZChtYXJrZXJOYW1lLCBtYXJrZXJSYW5nZSwgd3JpdGVyKSB7CiAgICAvLyBEbyBub3QgY29udmVydCBpZiByYW5nZSBpcyBpbiBncmF2ZXlhcmQgb3Igbm90IGluIHRoZSBkb2N1bWVudCAoZS5nLiBpbiBEb2N1bWVudEZyYWdtZW50KS4KICAgIGlmICghbWFya2VyUmFuZ2Uucm9vdC5kb2N1bWVudCB8fCBtYXJrZXJSYW5nZS5yb290LnJvb3ROYW1lID09ICckZ3JhdmV5YXJkJykgewogICAgICByZXR1cm47CiAgICB9CgogICAgdGhpcy5jb252ZXJzaW9uQXBpLndyaXRlciA9IHdyaXRlcjsgLy8gSW4gbWFya2VycycgY2FzZSwgZXZlbnQgbmFtZSA9PSBjb25zdW1hYmxlIG5hbWUuCgogICAgY29uc3QgZXZlbnROYW1lID0gJ2FkZE1hcmtlcjonICsgbWFya2VyTmFtZTsgLy8KICAgIC8vIEZpcnN0LCBmaXJlIGFuIGV2ZW50IGZvciB0aGUgd2hvbGUgbWFya2VyLgogICAgLy8KCiAgICBjb25zdCBjb25zdW1hYmxlID0gbmV3IENvbnN1bWFibGUoKTsKICAgIGNvbnN1bWFibGUuYWRkKG1hcmtlclJhbmdlLCBldmVudE5hbWUpOwogICAgdGhpcy5jb252ZXJzaW9uQXBpLmNvbnN1bWFibGUgPSBjb25zdW1hYmxlOwogICAgdGhpcy5maXJlKGV2ZW50TmFtZSwgewogICAgICBtYXJrZXJOYW1lLAogICAgICBtYXJrZXJSYW5nZQogICAgfSwgdGhpcy5jb252ZXJzaW9uQXBpKTsgLy8KICAgIC8vIERvIG5vdCBmaXJlIGV2ZW50cyBmb3IgZWFjaCBpdGVtIGluc2lkZSB0aGUgcmFuZ2UgaWYgdGhlIHJhbmdlIGdvdCBjb25zdW1lZC4KICAgIC8vCgogICAgaWYgKCFjb25zdW1hYmxlLnRlc3QobWFya2VyUmFuZ2UsIGV2ZW50TmFtZSkpIHsKICAgICAgcmV0dXJuOwogICAgfSAvLwogICAgLy8gVGhlbiwgZmlyZSBhbiBldmVudCBmb3IgZWFjaCBpdGVtIGluc2lkZSB0aGUgbWFya2VyIHJhbmdlLgogICAgLy8KCgogICAgdGhpcy5jb252ZXJzaW9uQXBpLmNvbnN1bWFibGUgPSB0aGlzLl9jcmVhdGVDb25zdW1hYmxlRm9yUmFuZ2UobWFya2VyUmFuZ2UsIGV2ZW50TmFtZSk7CgogICAgZm9yIChjb25zdCBpdGVtIG9mIG1hcmtlclJhbmdlLmdldEl0ZW1zKCkpIHsKICAgICAgLy8gRG8gbm90IGZpcmUgZXZlbnQgZm9yIGFscmVhZHkgY29uc3VtZWQgaXRlbXMuCiAgICAgIGlmICghdGhpcy5jb252ZXJzaW9uQXBpLmNvbnN1bWFibGUudGVzdChpdGVtLCBldmVudE5hbWUpKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIGNvbnN0IGRhdGEgPSB7CiAgICAgICAgaXRlbSwKICAgICAgICByYW5nZTogUmFuZ2UuX2NyZWF0ZU9uKGl0ZW0pLAogICAgICAgIG1hcmtlck5hbWUsCiAgICAgICAgbWFya2VyUmFuZ2UKICAgICAgfTsKICAgICAgdGhpcy5maXJlKGV2ZW50TmFtZSwgZGF0YSwgdGhpcy5jb252ZXJzaW9uQXBpKTsKICAgIH0KCiAgICB0aGlzLl9jbGVhckNvbnZlcnNpb25BcGkoKTsKICB9CiAgLyoqCiAgICogRmlyZXMgY29udmVyc2lvbiBvZiBtYXJrZXIgcmVtb3ZhbC4gRmlyZXMge0BsaW5rICNldmVudDpyZW1vdmVNYXJrZXIgcmVtb3ZlTWFya2VyfSBldmVudCB3aXRoIHByb3ZpZGVkIGRhdGEuCiAgICoKICAgKiBAZmlyZXMgcmVtb3ZlTWFya2VyCiAgICogQHBhcmFtIHtTdHJpbmd9IG1hcmtlck5hbWUgTWFya2VyIG5hbWUuCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL3JhbmdlflJhbmdlfSBtYXJrZXJSYW5nZSBNYXJrZXIgcmFuZ2UuCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvZG93bmNhc3R3cml0ZXJ+RG93bmNhc3RXcml0ZXJ9IHdyaXRlciBWaWV3IHdyaXRlciB0aGF0IHNob3VsZCBiZSB1c2VkIHRvIG1vZGlmeSB2aWV3IGRvY3VtZW50LgogICAqLwoKCiAgY29udmVydE1hcmtlclJlbW92ZShtYXJrZXJOYW1lLCBtYXJrZXJSYW5nZSwgd3JpdGVyKSB7CiAgICAvLyBEbyBub3QgY29udmVydCBpZiByYW5nZSBpcyBpbiBncmF2ZXlhcmQgb3Igbm90IGluIHRoZSBkb2N1bWVudCAoZS5nLiBpbiBEb2N1bWVudEZyYWdtZW50KS4KICAgIGlmICghbWFya2VyUmFuZ2Uucm9vdC5kb2N1bWVudCB8fCBtYXJrZXJSYW5nZS5yb290LnJvb3ROYW1lID09ICckZ3JhdmV5YXJkJykgewogICAgICByZXR1cm47CiAgICB9CgogICAgdGhpcy5jb252ZXJzaW9uQXBpLndyaXRlciA9IHdyaXRlcjsKICAgIHRoaXMuZmlyZSgncmVtb3ZlTWFya2VyOicgKyBtYXJrZXJOYW1lLCB7CiAgICAgIG1hcmtlck5hbWUsCiAgICAgIG1hcmtlclJhbmdlCiAgICB9LCB0aGlzLmNvbnZlcnNpb25BcGkpOwoKICAgIHRoaXMuX2NsZWFyQ29udmVyc2lvbkFwaSgpOwogIH0KICAvKioKICAgKiBDcmVhdGVzIHtAbGluayBtb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vbW9kZWxjb25zdW1hYmxlfk1vZGVsQ29uc3VtYWJsZX0gd2l0aCB2YWx1ZXMgdG8gY29uc3VtZSBmcm9tIGdpdmVuIHJhbmdlLAogICAqIGFzc3VtaW5nIHRoYXQgdGhlIHJhbmdlIGhhcyBqdXN0IGJlZW4gaW5zZXJ0ZWQgdG8gdGhlIG1vZGVsLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvcmFuZ2V+UmFuZ2V9IHJhbmdlIEluc2VydGVkIHJhbmdlLgogICAqIEByZXR1cm5zIHttb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vbW9kZWxjb25zdW1hYmxlfk1vZGVsQ29uc3VtYWJsZX0gVmFsdWVzIHRvIGNvbnN1bWUuCiAgICovCgoKICBfY3JlYXRlSW5zZXJ0Q29uc3VtYWJsZShyYW5nZSkgewogICAgY29uc3QgY29uc3VtYWJsZSA9IG5ldyBDb25zdW1hYmxlKCk7CgogICAgZm9yIChjb25zdCB2YWx1ZSBvZiByYW5nZSkgewogICAgICBjb25zdCBpdGVtID0gdmFsdWUuaXRlbTsKICAgICAgY29uc3VtYWJsZS5hZGQoaXRlbSwgJ2luc2VydCcpOwoKICAgICAgZm9yIChjb25zdCBrZXkgb2YgaXRlbS5nZXRBdHRyaWJ1dGVLZXlzKCkpIHsKICAgICAgICBjb25zdW1hYmxlLmFkZChpdGVtLCAnYXR0cmlidXRlOicgKyBrZXkpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGNvbnN1bWFibGU7CiAgfQogIC8qKgogICAqIENyZWF0ZXMge0BsaW5rIG1vZHVsZTplbmdpbmUvY29udmVyc2lvbi9tb2RlbGNvbnN1bWFibGV+TW9kZWxDb25zdW1hYmxlfSB3aXRoIHZhbHVlcyB0byBjb25zdW1lIGZvciBnaXZlbiByYW5nZS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL3JhbmdlflJhbmdlfSByYW5nZSBBZmZlY3RlZCByYW5nZS4KICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBDb25zdW1hYmxlIHR5cGUuCiAgICogQHJldHVybnMge21vZHVsZTplbmdpbmUvY29udmVyc2lvbi9tb2RlbGNvbnN1bWFibGV+TW9kZWxDb25zdW1hYmxlfSBWYWx1ZXMgdG8gY29uc3VtZS4KICAgKi8KCgogIF9jcmVhdGVDb25zdW1hYmxlRm9yUmFuZ2UocmFuZ2UsIHR5cGUpIHsKICAgIGNvbnN0IGNvbnN1bWFibGUgPSBuZXcgQ29uc3VtYWJsZSgpOwoKICAgIGZvciAoY29uc3QgaXRlbSBvZiByYW5nZS5nZXRJdGVtcygpKSB7CiAgICAgIGNvbnN1bWFibGUuYWRkKGl0ZW0sIHR5cGUpOwogICAgfQoKICAgIHJldHVybiBjb25zdW1hYmxlOwogIH0KICAvKioKICAgKiBDcmVhdGVzIHtAbGluayBtb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vbW9kZWxjb25zdW1hYmxlfk1vZGVsQ29uc3VtYWJsZX0gd2l0aCBzZWxlY3Rpb24gY29uc3VtYWJsZSB2YWx1ZXMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9zZWxlY3Rpb25+U2VsZWN0aW9ufSBzZWxlY3Rpb24gU2VsZWN0aW9uIHRvIGNyZWF0ZSBjb25zdW1hYmxlIGZyb20uCiAgICogQHBhcmFtIHtJdGVyYWJsZS48bW9kdWxlOmVuZ2luZS9tb2RlbC9tYXJrZXJjb2xsZWN0aW9ufk1hcmtlcj59IG1hcmtlcnMgTWFya2VycyB3aGljaCBjb250YWlucyBzZWxlY3Rpb24uCiAgICogQHJldHVybnMge21vZHVsZTplbmdpbmUvY29udmVyc2lvbi9tb2RlbGNvbnN1bWFibGV+TW9kZWxDb25zdW1hYmxlfSBWYWx1ZXMgdG8gY29uc3VtZS4KICAgKi8KCgogIF9jcmVhdGVTZWxlY3Rpb25Db25zdW1hYmxlKHNlbGVjdGlvbiwgbWFya2VycykgewogICAgY29uc3QgY29uc3VtYWJsZSA9IG5ldyBDb25zdW1hYmxlKCk7CiAgICBjb25zdW1hYmxlLmFkZChzZWxlY3Rpb24sICdzZWxlY3Rpb24nKTsKCiAgICBmb3IgKGNvbnN0IG1hcmtlciBvZiBtYXJrZXJzKSB7CiAgICAgIGNvbnN1bWFibGUuYWRkKHNlbGVjdGlvbiwgJ2FkZE1hcmtlcjonICsgbWFya2VyLm5hbWUpOwogICAgfQoKICAgIGZvciAoY29uc3Qga2V5IG9mIHNlbGVjdGlvbi5nZXRBdHRyaWJ1dGVLZXlzKCkpIHsKICAgICAgY29uc3VtYWJsZS5hZGQoc2VsZWN0aW9uLCAnYXR0cmlidXRlOicgKyBrZXkpOwogICAgfQoKICAgIHJldHVybiBjb25zdW1hYmxlOwogIH0KICAvKioKICAgKiBUZXN0cyBwYXNzZWQgYGNvbnN1bWFibGVgIHRvIGNoZWNrIHdoZXRoZXIgZ2l2ZW4gZXZlbnQgY2FuIGJlIGZpcmVkIGFuZCBpZiBzbywgZmlyZXMgaXQuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBmaXJlcyBpbnNlcnQKICAgKiBAZmlyZXMgYXR0cmlidXRlCiAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgRXZlbnQgdHlwZS4KICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSBFdmVudCBkYXRhLgogICAqLwoKCiAgX3Rlc3RBbmRGaXJlKHR5cGUsIGRhdGEpIHsKICAgIGlmICghdGhpcy5jb252ZXJzaW9uQXBpLmNvbnN1bWFibGUudGVzdChkYXRhLml0ZW0sIHR5cGUpKSB7CiAgICAgIC8vIERvIG5vdCBmaXJlIGV2ZW50IGlmIHRoZSBpdGVtIHdhcyBjb25zdW1lZC4KICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNvbnN0IG5hbWUgPSBkYXRhLml0ZW0ubmFtZSB8fCAnJHRleHQnOwogICAgdGhpcy5maXJlKHR5cGUgKyAnOicgKyBuYW1lLCBkYXRhLCB0aGlzLmNvbnZlcnNpb25BcGkpOwogIH0KICAvKioKICAgKiBDbGVhcnMgY29udmVyc2lvbiBBUEkgb2JqZWN0LgogICAqCiAgICogQHByaXZhdGUKICAgKi8KCgogIF9jbGVhckNvbnZlcnNpb25BcGkoKSB7CiAgICBkZWxldGUgdGhpcy5jb252ZXJzaW9uQXBpLndyaXRlcjsKICAgIGRlbGV0ZSB0aGlzLmNvbnZlcnNpb25BcGkuY29uc3VtYWJsZTsKICB9CiAgLyoqCiAgICogRmlyZWQgZm9yIGluc2VydGVkIG5vZGVzLgogICAqCiAgICogYGluc2VydGAgaXMgYSBuYW1lc3BhY2UgZm9yIGEgY2xhc3Mgb2YgZXZlbnRzLiBOYW1lcyBvZiBhY3R1YWxseSBjYWxsZWQgZXZlbnRzIGZvbGxvdyB0aGlzIHBhdHRlcm46CiAgICogYGluc2VydDpuYW1lYC4gYG5hbWVgIGlzIGVpdGhlciBgJyR0ZXh0J2AsIHdoZW4ge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvdGV4dH5UZXh0IGEgdGV4dCBub2RlfSBoYXMgYmVlbiBpbnNlcnRlZCwKICAgKiBvciB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9lbGVtZW50fkVsZW1lbnQjbmFtZSBuYW1lfSBvZiBpbnNlcnRlZCBlbGVtZW50LgogICAqCiAgICogVGhpcyB3YXkgbGlzdGVuZXJzIGNhbiBlaXRoZXIgbGlzdGVuIHRvIGEgZ2VuZXJhbCBgaW5zZXJ0YCBldmVudCBvciBzcGVjaWZpYyBldmVudCAoZm9yIGV4YW1wbGUgYGluc2VydDpwYXJhZ3JhcGhgKS4KICAgKgogICAqIEBldmVudCBpbnNlcnQKICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSBBZGRpdGlvbmFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjaGFuZ2UuCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL2l0ZW1+SXRlbX0gZGF0YS5pdGVtIEluc2VydGVkIGl0ZW0uCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL3JhbmdlflJhbmdlfSBkYXRhLnJhbmdlIFJhbmdlIHNwYW5uaW5nIG92ZXIgaW5zZXJ0ZWQgaXRlbS4KICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvY29udmVyc2lvbi9kb3duY2FzdGRpc3BhdGNoZXJ+RG93bmNhc3RDb252ZXJzaW9uQXBpfSBjb252ZXJzaW9uQXBpIENvbnZlcnNpb24gaW50ZXJmYWNlCiAgICogdG8gYmUgdXNlZCBieSBjYWxsYmFjaywgcGFzc2VkIGluIGBEb3duY2FzdERpc3BhdGNoZXJgIGNvbnN0cnVjdG9yLgogICAqLwoKICAvKioKICAgKiBGaXJlZCBmb3IgcmVtb3ZlZCBub2Rlcy4KICAgKgogICAqIGByZW1vdmVgIGlzIGEgbmFtZXNwYWNlIGZvciBhIGNsYXNzIG9mIGV2ZW50cy4gTmFtZXMgb2YgYWN0dWFsbHkgY2FsbGVkIGV2ZW50cyBmb2xsb3cgdGhpcyBwYXR0ZXJuOgogICAqIGByZW1vdmU6bmFtZWAuIGBuYW1lYCBpcyBlaXRoZXIgYCckdGV4dCdgLCB3aGVuIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3RleHR+VGV4dCBhIHRleHQgbm9kZX0gaGFzIGJlZW4gcmVtb3ZlZCwKICAgKiBvciB0aGUge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZWxlbWVudH5FbGVtZW50I25hbWUgbmFtZX0gb2YgcmVtb3ZlZCBlbGVtZW50LgogICAqCiAgICogVGhpcyB3YXkgbGlzdGVuZXJzIGNhbiBlaXRoZXIgbGlzdGVuIHRvIGEgZ2VuZXJhbCBgcmVtb3ZlYCBldmVudCBvciBzcGVjaWZpYyBldmVudCAoZm9yIGV4YW1wbGUgYHJlbW92ZTpwYXJhZ3JhcGhgKS4KICAgKgogICAqIEBldmVudCByZW1vdmUKICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSBBZGRpdGlvbmFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjaGFuZ2UuCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL3Bvc2l0aW9uflBvc2l0aW9ufSBkYXRhLnBvc2l0aW9uIFBvc2l0aW9uIGZyb20gd2hpY2ggdGhlIG5vZGUgaGFzIGJlZW4gcmVtb3ZlZC4KICAgKiBAcGFyYW0ge051bWJlcn0gZGF0YS5sZW5ndGggT2Zmc2V0IHNpemUgb2YgdGhlIHJlbW92ZWQgbm9kZS4KICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvY29udmVyc2lvbi9kb3duY2FzdGRpc3BhdGNoZXJ+RG93bmNhc3RDb252ZXJzaW9uQXBpfSBjb252ZXJzaW9uQXBpIENvbnZlcnNpb24gaW50ZXJmYWNlCiAgICogdG8gYmUgdXNlZCBieSBjYWxsYmFjaywgcGFzc2VkIGluIGBEb3duY2FzdERpc3BhdGNoZXJgIGNvbnN0cnVjdG9yLgogICAqLwoKICAvKioKICAgKiBGaXJlZCBpbiB0aGUgZm9sbG93aW5nIGNhc2VzOgogICAqCiAgICogKiB3aGVuIGFuIGF0dHJpYnV0ZSBoYXMgYmVlbiBhZGRlZCwgY2hhbmdlZCwgb3IgcmVtb3ZlZCBmcm9tIGEgbm9kZSwKICAgKiAqIHdoZW4gYSBub2RlIHdpdGggYW4gYXR0cmlidXRlIGlzIGluc2VydGVkLAogICAqICogd2hlbiBjb2xsYXBzZWQgbW9kZWwgc2VsZWN0aW9uIGF0dHJpYnV0ZSBpcyBjb252ZXJ0ZWQuCiAgICoKICAgKiBgYXR0cmlidXRlYCBpcyBhIG5hbWVzcGFjZSBmb3IgYSBjbGFzcyBvZiBldmVudHMuIE5hbWVzIG9mIGFjdHVhbGx5IGNhbGxlZCBldmVudHMgZm9sbG93IHRoaXMgcGF0dGVybjoKICAgKiBgYXR0cmlidXRlOmF0dHJpYnV0ZUtleTpuYW1lYC4gYGF0dHJpYnV0ZUtleWAgaXMgdGhlIGtleSBvZiBhZGRlZC9jaGFuZ2VkL3JlbW92ZWQgYXR0cmlidXRlLgogICAqIGBuYW1lYCBpcyBlaXRoZXIgYCckdGV4dCdgIGlmIGNoYW5nZSB3YXMgb24ge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvdGV4dH5UZXh0IGEgdGV4dCBub2RlfSwKICAgKiBvciB0aGUge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZWxlbWVudH5FbGVtZW50I25hbWUgbmFtZX0gb2YgZWxlbWVudCB3aGljaCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCiAgICoKICAgKiBUaGlzIHdheSBsaXN0ZW5lcnMgY2FuIGVpdGhlciBsaXN0ZW4gdG8gYSBnZW5lcmFsIGBhdHRyaWJ1dGU6Ym9sZGAgZXZlbnQgb3Igc3BlY2lmaWMgZXZlbnQgKGZvciBleGFtcGxlIGBhdHRyaWJ1dGU6c3JjOmltYWdlYCkuCiAgICoKICAgKiBAZXZlbnQgYXR0cmlidXRlCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgQWRkaXRpb25hbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY2hhbmdlLgogICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9pdGVtfkl0ZW18bW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudHNlbGVjdGlvbn5Eb2N1bWVudFNlbGVjdGlvbn0gZGF0YS5pdGVtIENoYW5nZWQgaXRlbQogICAqIG9yIGNvbnZlcnRlZCBzZWxlY3Rpb24uCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL3JhbmdlflJhbmdlfSBkYXRhLnJhbmdlIFJhbmdlIHNwYW5uaW5nIG92ZXIgY2hhbmdlZCBpdGVtIG9yIHNlbGVjdGlvbiByYW5nZS4KICAgKiBAcGFyYW0ge1N0cmluZ30gZGF0YS5hdHRyaWJ1dGVLZXkgQXR0cmlidXRlIGtleS4KICAgKiBAcGFyYW0geyp9IGRhdGEuYXR0cmlidXRlT2xkVmFsdWUgQXR0cmlidXRlIHZhbHVlIGJlZm9yZSB0aGUgY2hhbmdlLiBUaGlzIGlzIGBudWxsYCB3aGVuIHNlbGVjdGlvbiBhdHRyaWJ1dGUgaXMgY29udmVydGVkLgogICAqIEBwYXJhbSB7Kn0gZGF0YS5hdHRyaWJ1dGVOZXdWYWx1ZSBOZXcgYXR0cmlidXRlIHZhbHVlLgogICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9jb252ZXJzaW9uL2Rvd25jYXN0ZGlzcGF0Y2hlcn5Eb3duY2FzdENvbnZlcnNpb25BcGl9IGNvbnZlcnNpb25BcGkgQ29udmVyc2lvbiBpbnRlcmZhY2UKICAgKiB0byBiZSB1c2VkIGJ5IGNhbGxiYWNrLCBwYXNzZWQgaW4gYERvd25jYXN0RGlzcGF0Y2hlcmAgY29uc3RydWN0b3IuCiAgICovCgogIC8qKgogICAqIEZpcmVkIGZvciB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9zZWxlY3Rpb25+U2VsZWN0aW9uIHNlbGVjdGlvbn0gY2hhbmdlcy4KICAgKgogICAqIEBldmVudCBzZWxlY3Rpb24KICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvc2VsZWN0aW9uflNlbGVjdGlvbn0gc2VsZWN0aW9uIFNlbGVjdGlvbiB0aGF0IGlzIGNvbnZlcnRlZC4KICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvY29udmVyc2lvbi9kb3duY2FzdGRpc3BhdGNoZXJ+RG93bmNhc3RDb252ZXJzaW9uQXBpfSBjb252ZXJzaW9uQXBpIENvbnZlcnNpb24gaW50ZXJmYWNlCiAgICogdG8gYmUgdXNlZCBieSBjYWxsYmFjaywgcGFzc2VkIGluIGBEb3duY2FzdERpc3BhdGNoZXJgIGNvbnN0cnVjdG9yLgogICAqLwoKICAvKioKICAgKiBGaXJlZCB3aGVuIGEgbmV3IG1hcmtlciBpcyBhZGRlZCB0byB0aGUgbW9kZWwuIEFsc28gZmlyZWQgd2hlbiBjb2xsYXBzZWQgbW9kZWwgc2VsZWN0aW9uIHRoYXQgaXMgaW5zaWRlIG1hcmtlciBpcyBjb252ZXJ0ZWQuCiAgICoKICAgKiBgYWRkTWFya2VyYCBpcyBhIG5hbWVzcGFjZSBmb3IgYSBjbGFzcyBvZiBldmVudHMuIE5hbWVzIG9mIGFjdHVhbGx5IGNhbGxlZCBldmVudHMgZm9sbG93IHRoaXMgcGF0dGVybjoKICAgKiBgYWRkTWFya2VyOm1hcmtlck5hbWVgLiBCeSBzcGVjaWZ5aW5nIGNlcnRhaW4gbWFya2VyIG5hbWVzLCB5b3UgY2FuIG1ha2UgdGhlIGV2ZW50cyBldmVuIG1vcmUgZ3JhZHVhbC4gRm9yIGV4YW1wbGUsCiAgICogaWYgbWFya2VycyBhcmUgbmFtZWQgYGZvbzphYmNgLCBgZm9vOmJhcmAsIHRoZW4gaXQgaXMgcG9zc2libGUgdG8gbGlzdGVuIHRvIGBhZGRNYXJrZXI6Zm9vYCBvciBgYWRkTWFya2VyOmZvbzphYmNgIGFuZAogICAqIGBhZGRNYXJrZXI6Zm9vOmJhcmAgZXZlbnRzLgogICAqCiAgICogSWYgdGhlIG1hcmtlciByYW5nZSBpcyBub3QgY29sbGFwc2VkOgogICAqCiAgICogKiB0aGUgZXZlbnQgaXMgZmlyZWQgZm9yIGVhY2ggaXRlbSBpbiB0aGUgbWFya2VyIHJhbmdlIG9uZSBieSBvbmUsCiAgICogKiBgY29udmVyc2lvbkFwaS5jb25zdW1hYmxlYCBpbmNsdWRlcyBlYWNoIGl0ZW0gb2YgdGhlIG1hcmtlciByYW5nZSBhbmQgdGhlIGNvbnN1bWFibGUgdmFsdWUgaXMgc2FtZSBhcyBldmVudCBuYW1lLgogICAqCiAgICogSWYgdGhlIG1hcmtlciByYW5nZSBpcyBjb2xsYXBzZWQ6CiAgICoKICAgKiAqIHRoZXJlIGlzIG9ubHkgb25lIGV2ZW50LAogICAqICogYGNvbnZlcnNpb25BcGkuY29uc3VtYWJsZWAgaW5jbHVkZXMgbWFya2VyIHJhbmdlIHdpdGggZXZlbnQgbmFtZS4KICAgKgogICAqIElmIHNlbGVjdGlvbiBpbnNpZGUgYSBtYXJrZXIgaXMgY29udmVydGVkOgogICAqCiAgICogKiB0aGVyZSBpcyBvbmx5IG9uZSBldmVudCwKICAgKiAqIGBjb252ZXJzaW9uQXBpLmNvbnN1bWFibGVgIGluY2x1ZGVzIHNlbGVjdGlvbiBpbnN0YW5jZSB3aXRoIGV2ZW50IG5hbWUuCiAgICoKICAgKiBAZXZlbnQgYWRkTWFya2VyCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgQWRkaXRpb25hbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY2hhbmdlLgogICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9pdGVtfkl0ZW18bW9kdWxlOmVuZ2luZS9tb2RlbC9zZWxlY3Rpb25+U2VsZWN0aW9ufSBkYXRhLml0ZW0gSXRlbSBpbnNpZGUgdGhlIG5ldyBtYXJrZXIgb3IKICAgKiB0aGUgc2VsZWN0aW9uIHRoYXQgaXMgYmVpbmcgY29udmVydGVkLgogICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9yYW5nZX5SYW5nZX0gW2RhdGEucmFuZ2VdIFJhbmdlIHNwYW5uaW5nIG92ZXIgY29udmVydGVkIGl0ZW0uIEF2YWlsYWJsZSBvbmx5IGluIG1hcmtlciBjb252ZXJzaW9uLCBpZgogICAqIHRoZSBtYXJrZXIgcmFuZ2Ugd2FzIG5vdCBjb2xsYXBzZWQuCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL3JhbmdlflJhbmdlfSBkYXRhLm1hcmtlclJhbmdlIE1hcmtlciByYW5nZS4KICAgKiBAcGFyYW0ge1N0cmluZ30gZGF0YS5tYXJrZXJOYW1lIE1hcmtlciBuYW1lLgogICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9jb252ZXJzaW9uL2Rvd25jYXN0ZGlzcGF0Y2hlcn5Eb3duY2FzdENvbnZlcnNpb25BcGl9IGNvbnZlcnNpb25BcGkgQ29udmVyc2lvbiBpbnRlcmZhY2UKICAgKiB0byBiZSB1c2VkIGJ5IGNhbGxiYWNrLCBwYXNzZWQgaW4gYERvd25jYXN0RGlzcGF0Y2hlcmAgY29uc3RydWN0b3IuCiAgICovCgogIC8qKgogICAqIEZpcmVkIHdoZW4gbWFya2VyIGlzIHJlbW92ZWQgZnJvbSB0aGUgbW9kZWwuCiAgICoKICAgKiBgcmVtb3ZlTWFya2VyYCBpcyBhIG5hbWVzcGFjZSBmb3IgYSBjbGFzcyBvZiBldmVudHMuIE5hbWVzIG9mIGFjdHVhbGx5IGNhbGxlZCBldmVudHMgZm9sbG93IHRoaXMgcGF0dGVybjoKICAgKiBgcmVtb3ZlTWFya2VyOm1hcmtlck5hbWVgLiBCeSBzcGVjaWZ5aW5nIGNlcnRhaW4gbWFya2VyIG5hbWVzLCB5b3UgY2FuIG1ha2UgdGhlIGV2ZW50cyBldmVuIG1vcmUgZ3JhZHVhbC4gRm9yIGV4YW1wbGUsCiAgICogaWYgbWFya2VycyBhcmUgbmFtZWQgYGZvbzphYmNgLCBgZm9vOmJhcmAsIHRoZW4gaXQgaXMgcG9zc2libGUgdG8gbGlzdGVuIHRvIGByZW1vdmVNYXJrZXI6Zm9vYCBvciBgcmVtb3ZlTWFya2VyOmZvbzphYmNgIGFuZAogICAqIGByZW1vdmVNYXJrZXI6Zm9vOmJhcmAgZXZlbnRzLgogICAqCiAgICogQGV2ZW50IHJlbW92ZU1hcmtlcgogICAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIEFkZGl0aW9uYWwgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGNoYW5nZS4KICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvcmFuZ2V+UmFuZ2V9IGRhdGEubWFya2VyUmFuZ2UgTWFya2VyIHJhbmdlLgogICAqIEBwYXJhbSB7U3RyaW5nfSBkYXRhLm1hcmtlck5hbWUgTWFya2VyIG5hbWUuCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vZG93bmNhc3RkaXNwYXRjaGVyfkRvd25jYXN0Q29udmVyc2lvbkFwaX0gY29udmVyc2lvbkFwaSBDb252ZXJzaW9uIGludGVyZmFjZQogICAqIHRvIGJlIHVzZWQgYnkgY2FsbGJhY2ssIHBhc3NlZCBpbiBgRG93bmNhc3REaXNwYXRjaGVyYCBjb25zdHJ1Y3Rvci4KICAgKi8KCgp9Cm1peChEb3duY2FzdERpc3BhdGNoZXIsIEVtaXR0ZXJNaXhpbik7IC8vIEhlbHBlciBmdW5jdGlvbiwgY2hlY2tzIHdoZXRoZXIgY2hhbmdlIG9mIGBtYXJrZXJgIGF0IGBtb2RlbFBvc2l0aW9uYCBzaG91bGQgYmUgY29udmVydGVkLiBNYXJrZXIgY2hhbmdlcyBhcmUgbm90Ci8vIGNvbnZlcnRlZCBpZiB0aGV5IGhhcHBlbiBpbnNpZGUgYW4gZWxlbWVudCB3aXRoIGN1c3RvbSBjb252ZXJzaW9uIG1ldGhvZC4KLy8KLy8gQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL3Bvc2l0aW9uflBvc2l0aW9ufSBtb2RlbFBvc2l0aW9uCi8vIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9tYXJrZXJjb2xsZWN0aW9ufk1hcmtlcn0gbWFya2VyCi8vIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9jb252ZXJzaW9uL21hcHBlcn5NYXBwZXJ9IG1hcHBlcgovLyBAcmV0dXJucyB7Qm9vbGVhbn0KCmZ1bmN0aW9uIHNob3VsZE1hcmtlckNoYW5nZUJlQ29udmVydGVkKG1vZGVsUG9zaXRpb24sIG1hcmtlciwgbWFwcGVyKSB7CiAgY29uc3QgcmFuZ2UgPSBtYXJrZXIuZ2V0UmFuZ2UoKTsKICBjb25zdCBhbmNlc3RvcnMgPSBBcnJheS5mcm9tKG1vZGVsUG9zaXRpb24uZ2V0QW5jZXN0b3JzKCkpOwogIGFuY2VzdG9ycy5zaGlmdCgpOyAvLyBSZW1vdmUgcm9vdCBlbGVtZW50LiBJdCBjYW5ub3QgYmUgcGFzc2VkIHRvIGBtb2RlbC5SYW5nZSNjb250YWluc0l0ZW1gLgoKICBhbmNlc3RvcnMucmV2ZXJzZSgpOwogIGNvbnN0IGhhc0N1c3RvbUhhbmRsaW5nID0gYW5jZXN0b3JzLnNvbWUoZWxlbWVudCA9PiB7CiAgICBpZiAocmFuZ2UuY29udGFpbnNJdGVtKGVsZW1lbnQpKSB7CiAgICAgIGNvbnN0IHZpZXdFbGVtZW50ID0gbWFwcGVyLnRvVmlld0VsZW1lbnQoZWxlbWVudCk7CiAgICAgIHJldHVybiAhIXZpZXdFbGVtZW50LmdldEN1c3RvbVByb3BlcnR5KCdhZGRIaWdobGlnaHQnKTsKICAgIH0KICB9KTsKICByZXR1cm4gIWhhc0N1c3RvbUhhbmRsaW5nOwp9Ci8qKgogKiBDb252ZXJzaW9uIGludGVyZmFjZSB0aGF0IGlzIHJlZ2lzdGVyZWQgZm9yIGdpdmVuIHtAbGluayBtb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vZG93bmNhc3RkaXNwYXRjaGVyfkRvd25jYXN0RGlzcGF0Y2hlcn0KICogYW5kIGlzIHBhc3NlZCBhcyBvbmUgb2YgcGFyYW1ldGVycyB3aGVuIHtAbGluayBtb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vZG93bmNhc3RkaXNwYXRjaGVyfkRvd25jYXN0RGlzcGF0Y2hlciBkaXNwYXRjaGVyfQogKiBmaXJlcyBpdCdzIGV2ZW50cy4KICoKICogQGludGVyZmFjZSBtb2R1bGU6ZW5naW5lL2NvbnZlcnNpb24vZG93bmNhc3RkaXNwYXRjaGVyfkRvd25jYXN0Q29udmVyc2lvbkFwaQogKi8KCi8qKgogKiBUaGUge0BsaW5rIG1vZHVsZTplbmdpbmUvY29udmVyc2lvbi9kb3duY2FzdGRpc3BhdGNoZXJ+RG93bmNhc3REaXNwYXRjaGVyfSBpbnN0YW5jZS4KICoKICogQG1lbWJlciB7bW9kdWxlOmVuZ2luZS9jb252ZXJzaW9uL2Rvd25jYXN0ZGlzcGF0Y2hlcn5Eb3duY2FzdERpc3BhdGNoZXJ9ICNkaXNwYXRjaGVyCiAqLwoKLyoqCiAqIFN0b3JlcyBpbmZvcm1hdGlvbiBhYm91dCB3aGF0IHBhcnRzIG9mIHByb2Nlc3NlZCBtb2RlbCBpdGVtIGFyZSBzdGlsbCB3YWl0aW5nIHRvIGJlIGhhbmRsZWQuIEFmdGVyIGEgcGllY2Ugb2YgbW9kZWwgaXRlbQogKiB3YXMgY29udmVydGVkLCBhcHByb3ByaWF0ZSBjb25zdW1hYmxlIHZhbHVlIHNob3VsZCBiZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9jb252ZXJzaW9uL21vZGVsY29uc3VtYWJsZX5Nb2RlbENvbnN1bWFibGUjY29uc3VtZSBjb25zdW1lZH0uCiAqCiAqIEBtZW1iZXIge21vZHVsZTplbmdpbmUvY29udmVyc2lvbi9tb2RlbGNvbnN1bWFibGV+TW9kZWxDb25zdW1hYmxlfSAjY29uc3VtYWJsZQogKi8KCi8qKgogKiBUaGUge0BsaW5rIG1vZHVsZTplbmdpbmUvY29udmVyc2lvbi9tYXBwZXJ+TWFwcGVyfSBpbnN0YW5jZS4KICoKICogQG1lbWJlciB7bW9kdWxlOmVuZ2luZS9jb252ZXJzaW9uL21hcHBlcn5NYXBwZXJ9ICNtYXBwZXIKICovCgovKioKICogVGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL3ZpZXcvZG93bmNhc3R3cml0ZXJ+RG93bmNhc3RXcml0ZXJ9IGluc3RhbmNlIHVzZWQgdG8gbWFuaXB1bGF0ZSBkYXRhIGR1cmluZyBjb252ZXJzaW9uLgogKgogKiBAbWVtYmVyIHttb2R1bGU6ZW5naW5lL3ZpZXcvZG93bmNhc3R3cml0ZXJ+RG93bmNhc3RXcml0ZXJ9ICN3cml0ZXIKICov"},{"version":3,"sources":["/Users/antonyching/Desktop/project/new-builder-demo/node_modules/@ckeditor/ckeditor5-engine/src/conversion/downcastdispatcher.js"],"names":["Consumable","Range","EmitterMixin","mix","extend","DowncastDispatcher","constructor","conversionApi","dispatcher","convertChanges","differ","markers","writer","change","getMarkersToRemove","convertMarkerRemove","name","range","entry","getChanges","type","convertInsert","_createFromPositionAndShift","position","length","convertRemove","convertAttribute","attributeKey","attributeOldValue","attributeNewValue","markerName","mapper","flushUnboundMarkerNames","markerRange","get","getRange","convertMarkerAdd","getMarkersToAdd","consumable","_createInsertConsumable","value","item","itemRange","previousPosition","data","_testAndFire","key","getAttributeKeys","getAttribute","_clearConversionApi","fire","oldValue","newValue","_createConsumableForRange","convertSelection","selection","markersAtSelection","Array","from","getMarkersAtPosition","getFirstPosition","_createSelectionConsumable","isCollapsed","marker","shouldMarkerChangeBeConverted","test","getFirstRange","root","document","rootName","eventName","add","getItems","_createOn","modelPosition","ancestors","getAncestors","shift","reverse","hasCustomHandling","some","element","containsItem","viewElement","toViewElement","getCustomProperty"],"mappings":"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","sourcesContent":["/**\n * @license Copyright (c) 2003-2019, CKSource - Frederico Knabben. All rights reserved.\n * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license\n */\n\n/**\n * @module engine/conversion/downcastdispatcher\n */\n\nimport Consumable from './modelconsumable';\nimport Range from '../model/range';\nimport EmitterMixin from '@ckeditor/ckeditor5-utils/src/emittermixin';\nimport mix from '@ckeditor/ckeditor5-utils/src/mix';\nimport { extend } from 'lodash-es';\n\n/**\n * `DowncastDispatcher` is a central point of downcasting (conversion from model to view), which is a process of reacting to changes\n * in the model and firing a set of events. Callbacks listening to those events are called converters. Those\n * converters role is to convert the model changes to changes in view (for example, adding view nodes or\n * changing attributes on view elements).\n *\n * During conversion process, `DowncastDispatcher` fires events, basing on state of the model and prepares\n * data for those events. It is important to understand that those events are connected with changes done on model,\n * for example: \"node has been inserted\" or \"attribute has changed\". This is in a contrary to upcasting (view to model conversion),\n * where we convert view state (view nodes) to a model tree.\n *\n * The events are prepared basing on a diff created by {@link module:engine/model/differ~Differ Differ}, which buffers them\n * and then passes to `DowncastDispatcher` as a diff between old model state and new model state.\n *\n * Note, that because changes are converted there is a need to have a mapping between model structure and view structure.\n * To map positions and elements during downcast (model to view conversion) use {@link module:engine/conversion/mapper~Mapper}.\n *\n * `DowncastDispatcher` fires following events for model tree changes:\n *\n * * {@link module:engine/conversion/downcastdispatcher~DowncastDispatcher#event:insert insert}\n * if a range of nodes has been inserted to the model tree,\n * * {@link module:engine/conversion/downcastdispatcher~DowncastDispatcher#event:remove remove}\n * if a range of nodes has been removed from the model tree,\n * * {@link module:engine/conversion/downcastdispatcher~DowncastDispatcher#event:attribute attribute}\n * if attribute has been added, changed or removed from a model node.\n *\n * For {@link module:engine/conversion/downcastdispatcher~DowncastDispatcher#event:insert insert}\n * and {@link module:engine/conversion/downcastdispatcher~DowncastDispatcher#event:attribute attribute},\n * `DowncastDispatcher` generates {@link module:engine/conversion/modelconsumable~ModelConsumable consumables}.\n * These are used to have a control over which changes has been already consumed. It is useful when some converters\n * overwrite other or converts multiple changes (for example converts insertion of an element and also converts that\n * element's attributes during insertion).\n *\n * Additionally, `DowncastDispatcher` fires events for {@link module:engine/model/markercollection~Marker marker} changes:\n *\n * * {@link module:engine/conversion/downcastdispatcher~DowncastDispatcher#event:addMarker} if a marker has been added,\n * * {@link module:engine/conversion/downcastdispatcher~DowncastDispatcher#event:removeMarker} if a marker has been removed.\n *\n * Note, that changing a marker is done through removing the marker from the old range, and adding on the new range,\n * so both those events are fired.\n *\n * Finally, `DowncastDispatcher` also handles firing events for {@link module:engine/model/selection model selection}\n * conversion:\n *\n * * {@link module:engine/conversion/downcastdispatcher~DowncastDispatcher#event:selection}\n * which converts selection from model to view,\n * * {@link module:engine/conversion/downcastdispatcher~DowncastDispatcher#event:attribute}\n * which is fired for every selection attribute,\n * * {@link module:engine/conversion/downcastdispatcher~DowncastDispatcher#event:addMarker}\n * which is fired for every marker which contains selection.\n *\n * Unlike model tree and markers, events for selection are not fired for changes but for selection state.\n *\n * When providing custom listeners for `DowncastDispatcher` remember to check whether given change has not been\n * {@link module:engine/conversion/modelconsumable~ModelConsumable#consume consumed} yet.\n *\n * When providing custom listeners for `DowncastDispatcher` keep in mind that any callback that had\n * {@link module:engine/conversion/modelconsumable~ModelConsumable#consume consumed} a value from a consumable and\n * converted the change should also stop the event (for efficiency purposes).\n *\n * When providing custom listeners for `DowncastDispatcher` remember to use provided\n * {@link module:engine/view/downcastwriter~DowncastWriter view downcast writer} to apply changes to the view document.\n *\n * Example of a custom converter for `DowncastDispatcher`:\n *\n *\t\t// We will convert inserting \"paragraph\" model element into the model.\n *\t\tdowncastDispatcher.on( 'insert:paragraph', ( evt, data, conversionApi ) => {\n *\t\t\t// Remember to check whether the change has not been consumed yet and consume it.\n *\t\t\tif ( conversionApi.consumable.consume( data.item, 'insert' ) ) {\n *\t\t\t\treturn;\n *\t\t\t}\n *\n *\t\t\t// Translate position in model to position in view.\n *\t\t\tconst viewPosition = conversionApi.mapper.toViewPosition( data.range.start );\n *\n *\t\t\t// Create <p> element that will be inserted in view at `viewPosition`.\n *\t\t\tconst viewElement = conversionApi.writer.createContainerElement( 'p' );\n *\n *\t\t\t// Bind the newly created view element to model element so positions will map accordingly in future.\n *\t\t\tconversionApi.mapper.bindElements( data.item, viewElement );\n *\n *\t\t\t// Add the newly created view element to the view.\n *\t\t\tconversionApi.writer.insert( viewPosition, viewElement );\n *\n *\t\t\t// Remember to stop the event propagation.\n *\t\t\tevt.stop();\n *\t\t} );\n */\nexport default class DowncastDispatcher {\n\t/**\n\t * Creates a `DowncastDispatcher` instance.\n\t *\n\t * @see module:engine/conversion/downcastdispatcher~DowncastConversionApi\n\t * @param {Object} conversionApi Additional properties for interface that will be passed to events fired\n\t * by `DowncastDispatcher`.\n\t */\n\tconstructor( conversionApi ) {\n\t\t/**\n\t\t * Interface passed by dispatcher to the events callbacks.\n\t\t *\n\t\t * @member {module:engine/conversion/downcastdispatcher~DowncastConversionApi}\n\t\t */\n\t\tthis.conversionApi = extend( { dispatcher: this }, conversionApi );\n\t}\n\n\t/**\n\t * Takes {@link module:engine/model/differ~Differ model differ} object with buffered changes and fires conversion basing on it.\n\t *\n\t * @param {module:engine/model/differ~Differ} differ Differ object with buffered changes.\n\t * @param {module:engine/model/markercollection~MarkerCollection} markers Markers connected with converted model.\n\t * @param {module:engine/view/downcastwriter~DowncastWriter} writer View writer that should be used to modify view document.\n\t */\n\tconvertChanges( differ, markers, writer ) {\n\t\t// Before the view is updated, remove markers which have changed.\n\t\tfor ( const change of differ.getMarkersToRemove() ) {\n\t\t\tthis.convertMarkerRemove( change.name, change.range, writer );\n\t\t}\n\n\t\t// Convert changes that happened on model tree.\n\t\tfor ( const entry of differ.getChanges() ) {\n\t\t\tif ( entry.type == 'insert' ) {\n\t\t\t\tthis.convertInsert( Range._createFromPositionAndShift( entry.position, entry.length ), writer );\n\t\t\t} else if ( entry.type == 'remove' ) {\n\t\t\t\tthis.convertRemove( entry.position, entry.length, entry.name, writer );\n\t\t\t} else {\n\t\t\t\t// entry.type == 'attribute'.\n\t\t\t\tthis.convertAttribute( entry.range, entry.attributeKey, entry.attributeOldValue, entry.attributeNewValue, writer );\n\t\t\t}\n\t\t}\n\n\t\tfor ( const markerName of this.conversionApi.mapper.flushUnboundMarkerNames() ) {\n\t\t\tconst markerRange = markers.get( markerName ).getRange();\n\n\t\t\tthis.convertMarkerRemove( markerName, markerRange, writer );\n\t\t\tthis.convertMarkerAdd( markerName, markerRange, writer );\n\t\t}\n\n\t\t// After the view is updated, convert markers which have changed.\n\t\tfor ( const change of differ.getMarkersToAdd() ) {\n\t\t\tthis.convertMarkerAdd( change.name, change.range, writer );\n\t\t}\n\t}\n\n\t/**\n\t * Starts conversion of a range insertion.\n\t *\n\t * For each node in the range, {@link #event:insert insert event is fired}. For each attribute on each node,\n\t * {@link #event:attribute attribute event is fired}.\n\t *\n\t * @fires insert\n\t * @fires attribute\n\t * @param {module:engine/model/range~Range} range Inserted range.\n\t * @param {module:engine/view/downcastwriter~DowncastWriter} writer View writer that should be used to modify view document.\n\t */\n\tconvertInsert( range, writer ) {\n\t\tthis.conversionApi.writer = writer;\n\n\t\t// Create a list of things that can be consumed, consisting of nodes and their attributes.\n\t\tthis.conversionApi.consumable = this._createInsertConsumable( range );\n\n\t\t// Fire a separate insert event for each node and text fragment contained in the range.\n\t\tfor ( const value of range ) {\n\t\t\tconst item = value.item;\n\t\t\tconst itemRange = Range._createFromPositionAndShift( value.previousPosition, value.length );\n\t\t\tconst data = {\n\t\t\t\titem,\n\t\t\t\trange: itemRange\n\t\t\t};\n\n\t\t\tthis._testAndFire( 'insert', data );\n\n\t\t\t// Fire a separate addAttribute event for each attribute that was set on inserted items.\n\t\t\t// This is important because most attributes converters will listen only to add/change/removeAttribute events.\n\t\t\t// If we would not add this part, attributes on inserted nodes would not be converted.\n\t\t\tfor ( const key of item.getAttributeKeys() ) {\n\t\t\t\tdata.attributeKey = key;\n\t\t\t\tdata.attributeOldValue = null;\n\t\t\t\tdata.attributeNewValue = item.getAttribute( key );\n\n\t\t\t\tthis._testAndFire( `attribute:${ key }`, data );\n\t\t\t}\n\t\t}\n\n\t\tthis._clearConversionApi();\n\t}\n\n\t/**\n\t * Fires conversion of a single node removal. Fires {@link #event:remove remove event} with provided data.\n\t *\n\t * @param {module:engine/model/position~Position} position Position from which node was removed.\n\t * @param {Number} length Offset size of removed node.\n\t * @param {String} name Name of removed node.\n\t * @param {module:engine/view/downcastwriter~DowncastWriter} writer View writer that should be used to modify view document.\n\t */\n\tconvertRemove( position, length, name, writer ) {\n\t\tthis.conversionApi.writer = writer;\n\n\t\tthis.fire( 'remove:' + name, { position, length }, this.conversionApi );\n\n\t\tthis._clearConversionApi();\n\t}\n\n\t/**\n\t * Starts conversion of attribute change on given `range`.\n\t *\n\t * For each node in the given `range`, {@link #event:attribute attribute event} is fired with the passed data.\n\t *\n\t * @fires attribute\n\t * @param {module:engine/model/range~Range} range Changed range.\n\t * @param {String} key Key of the attribute that has changed.\n\t * @param {*} oldValue Attribute value before the change or `null` if the attribute has not been set before.\n\t * @param {*} newValue New attribute value or `null` if the attribute has been removed.\n\t * @param {module:engine/view/downcastwriter~DowncastWriter} writer View writer that should be used to modify view document.\n\t */\n\tconvertAttribute( range, key, oldValue, newValue, writer ) {\n\t\tthis.conversionApi.writer = writer;\n\n\t\t// Create a list with attributes to consume.\n\t\tthis.conversionApi.consumable = this._createConsumableForRange( range, `attribute:${ key }` );\n\n\t\t// Create a separate attribute event for each node in the range.\n\t\tfor ( const value of range ) {\n\t\t\tconst item = value.item;\n\t\t\tconst itemRange = Range._createFromPositionAndShift( value.previousPosition, value.length );\n\t\t\tconst data = {\n\t\t\t\titem,\n\t\t\t\trange: itemRange,\n\t\t\t\tattributeKey: key,\n\t\t\t\tattributeOldValue: oldValue,\n\t\t\t\tattributeNewValue: newValue\n\t\t\t};\n\n\t\t\tthis._testAndFire( `attribute:${ key }`, data );\n\t\t}\n\n\t\tthis._clearConversionApi();\n\t}\n\n\t/**\n\t * Starts model selection conversion.\n\t *\n\t * Fires events for given {@link module:engine/model/selection~Selection selection} to start selection conversion.\n\t *\n\t * @fires selection\n\t * @fires addMarker\n\t * @fires attribute\n\t * @param {module:engine/model/selection~Selection} selection Selection to convert.\n\t * @param {module:engine/model/markercollection~MarkerCollection} markers Markers connected with converted model.\n\t * @param {module:engine/view/downcastwriter~DowncastWriter} writer View writer that should be used to modify view document.\n\t */\n\tconvertSelection( selection, markers, writer ) {\n\t\tconst markersAtSelection = Array.from( markers.getMarkersAtPosition( selection.getFirstPosition() ) );\n\n\t\tthis.conversionApi.writer = writer;\n\t\tthis.conversionApi.consumable = this._createSelectionConsumable( selection, markersAtSelection );\n\n\t\tthis.fire( 'selection', { selection }, this.conversionApi );\n\n\t\tif ( !selection.isCollapsed ) {\n\t\t\treturn;\n\t\t}\n\n\t\tfor ( const marker of markersAtSelection ) {\n\t\t\tconst markerRange = marker.getRange();\n\n\t\t\tif ( !shouldMarkerChangeBeConverted( selection.getFirstPosition(), marker, this.conversionApi.mapper ) ) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst data = {\n\t\t\t\titem: selection,\n\t\t\t\tmarkerName: marker.name,\n\t\t\t\tmarkerRange\n\t\t\t};\n\n\t\t\tif ( this.conversionApi.consumable.test( selection, 'addMarker:' + marker.name ) ) {\n\t\t\t\tthis.fire( 'addMarker:' + marker.name, data, this.conversionApi );\n\t\t\t}\n\t\t}\n\n\t\tfor ( const key of selection.getAttributeKeys() ) {\n\t\t\tconst data = {\n\t\t\t\titem: selection,\n\t\t\t\trange: selection.getFirstRange(),\n\t\t\t\tattributeKey: key,\n\t\t\t\tattributeOldValue: null,\n\t\t\t\tattributeNewValue: selection.getAttribute( key )\n\t\t\t};\n\n\t\t\t// Do not fire event if the attribute has been consumed.\n\t\t\tif ( this.conversionApi.consumable.test( selection, 'attribute:' + data.attributeKey ) ) {\n\t\t\t\tthis.fire( 'attribute:' + data.attributeKey + ':$text', data, this.conversionApi );\n\t\t\t}\n\t\t}\n\n\t\tthis._clearConversionApi();\n\t}\n\n\t/**\n\t * Converts added marker. Fires {@link #event:addMarker addMarker} event for each item\n\t * in marker's range. If range is collapsed single event is dispatched. See event description for more details.\n\t *\n\t * @fires addMarker\n\t * @param {String} markerName Marker name.\n\t * @param {module:engine/model/range~Range} markerRange Marker range.\n\t * @param {module:engine/view/downcastwriter~DowncastWriter} writer View writer that should be used to modify view document.\n\t */\n\tconvertMarkerAdd( markerName, markerRange, writer ) {\n\t\t// Do not convert if range is in graveyard or not in the document (e.g. in DocumentFragment).\n\t\tif ( !markerRange.root.document || markerRange.root.rootName == '$graveyard' ) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.conversionApi.writer = writer;\n\n\t\t// In markers' case, event name == consumable name.\n\t\tconst eventName = 'addMarker:' + markerName;\n\n\t\t//\n\t\t// First, fire an event for the whole marker.\n\t\t//\n\t\tconst consumable = new Consumable();\n\t\tconsumable.add( markerRange, eventName );\n\n\t\tthis.conversionApi.consumable = consumable;\n\n\t\tthis.fire( eventName, { markerName, markerRange }, this.conversionApi );\n\n\t\t//\n\t\t// Do not fire events for each item inside the range if the range got consumed.\n\t\t//\n\t\tif ( !consumable.test( markerRange, eventName ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\t//\n\t\t// Then, fire an event for each item inside the marker range.\n\t\t//\n\t\tthis.conversionApi.consumable = this._createConsumableForRange( markerRange, eventName );\n\n\t\tfor ( const item of markerRange.getItems() ) {\n\t\t\t// Do not fire event for already consumed items.\n\t\t\tif ( !this.conversionApi.consumable.test( item, eventName ) ) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst data = { item, range: Range._createOn( item ), markerName, markerRange };\n\n\t\t\tthis.fire( eventName, data, this.conversionApi );\n\t\t}\n\n\t\tthis._clearConversionApi();\n\t}\n\n\t/**\n\t * Fires conversion of marker removal. Fires {@link #event:removeMarker removeMarker} event with provided data.\n\t *\n\t * @fires removeMarker\n\t * @param {String} markerName Marker name.\n\t * @param {module:engine/model/range~Range} markerRange Marker range.\n\t * @param {module:engine/view/downcastwriter~DowncastWriter} writer View writer that should be used to modify view document.\n\t */\n\tconvertMarkerRemove( markerName, markerRange, writer ) {\n\t\t// Do not convert if range is in graveyard or not in the document (e.g. in DocumentFragment).\n\t\tif ( !markerRange.root.document || markerRange.root.rootName == '$graveyard' ) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.conversionApi.writer = writer;\n\n\t\tthis.fire( 'removeMarker:' + markerName, { markerName, markerRange }, this.conversionApi );\n\n\t\tthis._clearConversionApi();\n\t}\n\n\t/**\n\t * Creates {@link module:engine/conversion/modelconsumable~ModelConsumable} with values to consume from given range,\n\t * assuming that the range has just been inserted to the model.\n\t *\n\t * @private\n\t * @param {module:engine/model/range~Range} range Inserted range.\n\t * @returns {module:engine/conversion/modelconsumable~ModelConsumable} Values to consume.\n\t */\n\t_createInsertConsumable( range ) {\n\t\tconst consumable = new Consumable();\n\n\t\tfor ( const value of range ) {\n\t\t\tconst item = value.item;\n\n\t\t\tconsumable.add( item, 'insert' );\n\n\t\t\tfor ( const key of item.getAttributeKeys() ) {\n\t\t\t\tconsumable.add( item, 'attribute:' + key );\n\t\t\t}\n\t\t}\n\n\t\treturn consumable;\n\t}\n\n\t/**\n\t * Creates {@link module:engine/conversion/modelconsumable~ModelConsumable} with values to consume for given range.\n\t *\n\t * @private\n\t * @param {module:engine/model/range~Range} range Affected range.\n\t * @param {String} type Consumable type.\n\t * @returns {module:engine/conversion/modelconsumable~ModelConsumable} Values to consume.\n\t */\n\t_createConsumableForRange( range, type ) {\n\t\tconst consumable = new Consumable();\n\n\t\tfor ( const item of range.getItems() ) {\n\t\t\tconsumable.add( item, type );\n\t\t}\n\n\t\treturn consumable;\n\t}\n\n\t/**\n\t * Creates {@link module:engine/conversion/modelconsumable~ModelConsumable} with selection consumable values.\n\t *\n\t * @private\n\t * @param {module:engine/model/selection~Selection} selection Selection to create consumable from.\n\t * @param {Iterable.<module:engine/model/markercollection~Marker>} markers Markers which contains selection.\n\t * @returns {module:engine/conversion/modelconsumable~ModelConsumable} Values to consume.\n\t */\n\t_createSelectionConsumable( selection, markers ) {\n\t\tconst consumable = new Consumable();\n\n\t\tconsumable.add( selection, 'selection' );\n\n\t\tfor ( const marker of markers ) {\n\t\t\tconsumable.add( selection, 'addMarker:' + marker.name );\n\t\t}\n\n\t\tfor ( const key of selection.getAttributeKeys() ) {\n\t\t\tconsumable.add( selection, 'attribute:' + key );\n\t\t}\n\n\t\treturn consumable;\n\t}\n\n\t/**\n\t * Tests passed `consumable` to check whether given event can be fired and if so, fires it.\n\t *\n\t * @private\n\t * @fires insert\n\t * @fires attribute\n\t * @param {String} type Event type.\n\t * @param {Object} data Event data.\n\t */\n\t_testAndFire( type, data ) {\n\t\tif ( !this.conversionApi.consumable.test( data.item, type ) ) {\n\t\t\t// Do not fire event if the item was consumed.\n\t\t\treturn;\n\t\t}\n\n\t\tconst name = data.item.name || '$text';\n\n\t\tthis.fire( type + ':' + name, data, this.conversionApi );\n\t}\n\n\t/**\n\t * Clears conversion API object.\n\t *\n\t * @private\n\t */\n\t_clearConversionApi() {\n\t\tdelete this.conversionApi.writer;\n\t\tdelete this.conversionApi.consumable;\n\t}\n\n\t/**\n\t * Fired for inserted nodes.\n\t *\n\t * `insert` is a namespace for a class of events. Names of actually called events follow this pattern:\n\t * `insert:name`. `name` is either `'$text'`, when {@link module:engine/model/text~Text a text node} has been inserted,\n\t * or {@link module:engine/model/element~Element#name name} of inserted element.\n\t *\n\t * This way listeners can either listen to a general `insert` event or specific event (for example `insert:paragraph`).\n\t *\n\t * @event insert\n\t * @param {Object} data Additional information about the change.\n\t * @param {module:engine/model/item~Item} data.item Inserted item.\n\t * @param {module:engine/model/range~Range} data.range Range spanning over inserted item.\n\t * @param {module:engine/conversion/downcastdispatcher~DowncastConversionApi} conversionApi Conversion interface\n\t * to be used by callback, passed in `DowncastDispatcher` constructor.\n\t */\n\n\t/**\n\t * Fired for removed nodes.\n\t *\n\t * `remove` is a namespace for a class of events. Names of actually called events follow this pattern:\n\t * `remove:name`. `name` is either `'$text'`, when {@link module:engine/model/text~Text a text node} has been removed,\n\t * or the {@link module:engine/model/element~Element#name name} of removed element.\n\t *\n\t * This way listeners can either listen to a general `remove` event or specific event (for example `remove:paragraph`).\n\t *\n\t * @event remove\n\t * @param {Object} data Additional information about the change.\n\t * @param {module:engine/model/position~Position} data.position Position from which the node has been removed.\n\t * @param {Number} data.length Offset size of the removed node.\n\t * @param {module:engine/conversion/downcastdispatcher~DowncastConversionApi} conversionApi Conversion interface\n\t * to be used by callback, passed in `DowncastDispatcher` constructor.\n\t */\n\n\t/**\n\t * Fired in the following cases:\n\t *\n\t * * when an attribute has been added, changed, or removed from a node,\n\t * * when a node with an attribute is inserted,\n\t * * when collapsed model selection attribute is converted.\n\t *\n\t * `attribute` is a namespace for a class of events. Names of actually called events follow this pattern:\n\t * `attribute:attributeKey:name`. `attributeKey` is the key of added/changed/removed attribute.\n\t * `name` is either `'$text'` if change was on {@link module:engine/model/text~Text a text node},\n\t * or the {@link module:engine/model/element~Element#name name} of element which attribute has changed.\n\t *\n\t * This way listeners can either listen to a general `attribute:bold` event or specific event (for example `attribute:src:image`).\n\t *\n\t * @event attribute\n\t * @param {Object} data Additional information about the change.\n\t * @param {module:engine/model/item~Item|module:engine/model/documentselection~DocumentSelection} data.item Changed item\n\t * or converted selection.\n\t * @param {module:engine/model/range~Range} data.range Range spanning over changed item or selection range.\n\t * @param {String} data.attributeKey Attribute key.\n\t * @param {*} data.attributeOldValue Attribute value before the change. This is `null` when selection attribute is converted.\n\t * @param {*} data.attributeNewValue New attribute value.\n\t * @param {module:engine/conversion/downcastdispatcher~DowncastConversionApi} conversionApi Conversion interface\n\t * to be used by callback, passed in `DowncastDispatcher` constructor.\n\t */\n\n\t/**\n\t * Fired for {@link module:engine/model/selection~Selection selection} changes.\n\t *\n\t * @event selection\n\t * @param {module:engine/model/selection~Selection} selection Selection that is converted.\n\t * @param {module:engine/conversion/downcastdispatcher~DowncastConversionApi} conversionApi Conversion interface\n\t * to be used by callback, passed in `DowncastDispatcher` constructor.\n\t */\n\n\t/**\n\t * Fired when a new marker is added to the model. Also fired when collapsed model selection that is inside marker is converted.\n\t *\n\t * `addMarker` is a namespace for a class of events. Names of actually called events follow this pattern:\n\t * `addMarker:markerName`. By specifying certain marker names, you can make the events even more gradual. For example,\n\t * if markers are named `foo:abc`, `foo:bar`, then it is possible to listen to `addMarker:foo` or `addMarker:foo:abc` and\n\t * `addMarker:foo:bar` events.\n\t *\n\t * If the marker range is not collapsed:\n\t *\n\t * * the event is fired for each item in the marker range one by one,\n\t * * `conversionApi.consumable` includes each item of the marker range and the consumable value is same as event name.\n\t *\n\t * If the marker range is collapsed:\n\t *\n\t * * there is only one event,\n\t * * `conversionApi.consumable` includes marker range with event name.\n\t *\n\t * If selection inside a marker is converted:\n\t *\n\t * * there is only one event,\n\t * * `conversionApi.consumable` includes selection instance with event name.\n\t *\n\t * @event addMarker\n\t * @param {Object} data Additional information about the change.\n\t * @param {module:engine/model/item~Item|module:engine/model/selection~Selection} data.item Item inside the new marker or\n\t * the selection that is being converted.\n\t * @param {module:engine/model/range~Range} [data.range] Range spanning over converted item. Available only in marker conversion, if\n\t * the marker range was not collapsed.\n\t * @param {module:engine/model/range~Range} data.markerRange Marker range.\n\t * @param {String} data.markerName Marker name.\n\t * @param {module:engine/conversion/downcastdispatcher~DowncastConversionApi} conversionApi Conversion interface\n\t * to be used by callback, passed in `DowncastDispatcher` constructor.\n\t */\n\n\t/**\n\t * Fired when marker is removed from the model.\n\t *\n\t * `removeMarker` is a namespace for a class of events. Names of actually called events follow this pattern:\n\t * `removeMarker:markerName`. By specifying certain marker names, you can make the events even more gradual. For example,\n\t * if markers are named `foo:abc`, `foo:bar`, then it is possible to listen to `removeMarker:foo` or `removeMarker:foo:abc` and\n\t * `removeMarker:foo:bar` events.\n\t *\n\t * @event removeMarker\n\t * @param {Object} data Additional information about the change.\n\t * @param {module:engine/model/range~Range} data.markerRange Marker range.\n\t * @param {String} data.markerName Marker name.\n\t * @param {module:engine/conversion/downcastdispatcher~DowncastConversionApi} conversionApi Conversion interface\n\t * to be used by callback, passed in `DowncastDispatcher` constructor.\n\t */\n}\n\nmix( DowncastDispatcher, EmitterMixin );\n\n// Helper function, checks whether change of `marker` at `modelPosition` should be converted. Marker changes are not\n// converted if they happen inside an element with custom conversion method.\n//\n// @param {module:engine/model/position~Position} modelPosition\n// @param {module:engine/model/markercollection~Marker} marker\n// @param {module:engine/conversion/mapper~Mapper} mapper\n// @returns {Boolean}\nfunction shouldMarkerChangeBeConverted( modelPosition, marker, mapper ) {\n\tconst range = marker.getRange();\n\tconst ancestors = Array.from( modelPosition.getAncestors() );\n\tancestors.shift(); // Remove root element. It cannot be passed to `model.Range#containsItem`.\n\tancestors.reverse();\n\n\tconst hasCustomHandling = ancestors.some( element => {\n\t\tif ( range.containsItem( element ) ) {\n\t\t\tconst viewElement = mapper.toViewElement( element );\n\n\t\t\treturn !!viewElement.getCustomProperty( 'addHighlight' );\n\t\t}\n\t} );\n\n\treturn !hasCustomHandling;\n}\n\n/**\n * Conversion interface that is registered for given {@link module:engine/conversion/downcastdispatcher~DowncastDispatcher}\n * and is passed as one of parameters when {@link module:engine/conversion/downcastdispatcher~DowncastDispatcher dispatcher}\n * fires it's events.\n *\n * @interface module:engine/conversion/downcastdispatcher~DowncastConversionApi\n */\n\n/**\n * The {@link module:engine/conversion/downcastdispatcher~DowncastDispatcher} instance.\n *\n * @member {module:engine/conversion/downcastdispatcher~DowncastDispatcher} #dispatcher\n */\n\n/**\n * Stores information about what parts of processed model item are still waiting to be handled. After a piece of model item\n * was converted, appropriate consumable value should be {@link module:engine/conversion/modelconsumable~ModelConsumable#consume consumed}.\n *\n * @member {module:engine/conversion/modelconsumable~ModelConsumable} #consumable\n */\n\n/**\n * The {@link module:engine/conversion/mapper~Mapper} instance.\n *\n * @member {module:engine/conversion/mapper~Mapper} #mapper\n */\n\n/**\n * The {@link module:engine/view/downcastwriter~DowncastWriter} instance used to manipulate data during conversion.\n *\n * @member {module:engine/view/downcastwriter~DowncastWriter} #writer\n */\n"]}]}