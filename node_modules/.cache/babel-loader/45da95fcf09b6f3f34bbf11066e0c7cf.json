{"remainingRequest":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/babel-loader/lib/index.js!/Users/antonyching/Desktop/project/new-builder-demo/node_modules/@ckeditor/ckeditor5-engine/src/model/documentselection.js","dependencies":[{"path":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/@ckeditor/ckeditor5-engine/src/model/documentselection.js","mtime":499162500000},{"path":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/@ckeditor/ckeditor5-dev-webpack-plugin/lib/translatesourceloader.js","mtime":499162500000},{"path":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/babel-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:LyoqCiAqIEBsaWNlbnNlIENvcHlyaWdodCAoYykgMjAwMy0yMDE5LCBDS1NvdXJjZSAtIEZyZWRlcmljbyBLbmFiYmVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBGb3IgbGljZW5zaW5nLCBzZWUgTElDRU5TRS5tZCBvciBodHRwczovL2NrZWRpdG9yLmNvbS9sZWdhbC9ja2VkaXRvci1vc3MtbGljZW5zZQogKi8KCi8qKgogKiBAbW9kdWxlIGVuZ2luZS9tb2RlbC9kb2N1bWVudHNlbGVjdGlvbgogKi8KaW1wb3J0IG1peCBmcm9tICdAY2tlZGl0b3IvY2tlZGl0b3I1LXV0aWxzL3NyYy9taXgnOwppbXBvcnQgRW1pdHRlck1peGluIGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2VtaXR0ZXJtaXhpbic7CmltcG9ydCBTZWxlY3Rpb24gZnJvbSAnLi9zZWxlY3Rpb24nOwppbXBvcnQgTGl2ZVJhbmdlIGZyb20gJy4vbGl2ZXJhbmdlJzsKaW1wb3J0IFRleHQgZnJvbSAnLi90ZXh0JzsKaW1wb3J0IFRleHRQcm94eSBmcm9tICcuL3RleHRwcm94eSc7CmltcG9ydCB0b01hcCBmcm9tICdAY2tlZGl0b3IvY2tlZGl0b3I1LXV0aWxzL3NyYy90b21hcCc7CmltcG9ydCBDb2xsZWN0aW9uIGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2NvbGxlY3Rpb24nOwppbXBvcnQgQ0tFZGl0b3JFcnJvciBmcm9tICdAY2tlZGl0b3IvY2tlZGl0b3I1LXV0aWxzL3NyYy9ja2VkaXRvcmVycm9yJzsKaW1wb3J0IHVpZCBmcm9tICdAY2tlZGl0b3IvY2tlZGl0b3I1LXV0aWxzL3NyYy91aWQnOwpjb25zdCBzdG9yZVByZWZpeCA9ICdzZWxlY3Rpb246JzsKLyoqCiAqIGBEb2N1bWVudFNlbGVjdGlvbmAgaXMgYSBzcGVjaWFsIHNlbGVjdGlvbiB3aGljaCBpcyB1c2VkIGFzIHRoZQogKiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudH5Eb2N1bWVudCNzZWxlY3Rpb24gZG9jdW1lbnQncyBzZWxlY3Rpb259LgogKiBUaGVyZSBjYW4gYmUgb25seSBvbmUgaW5zdGFuY2Ugb2YgYERvY3VtZW50U2VsZWN0aW9uYCBwZXIgZG9jdW1lbnQuCiAqCiAqIERvY3VtZW50IHNlbGVjdGlvbiBjYW4gb25seSBiZSBjaGFuZ2VkIGJ5IHVzaW5nIHRoZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC93cml0ZXJ+V3JpdGVyfSBpbnN0YW5jZQogKiBpbnNpZGUgdGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL21vZGVsfk1vZGVsI2NoYW5nZSBgY2hhbmdlKClgfSBibG9jaywgYXMgaXQgcHJvdmlkZXMgYSBzZWN1cmUgd2F5IHRvIG1vZGlmeSBtb2RlbC4KICoKICogYERvY3VtZW50U2VsZWN0aW9uYCBpcyBhdXRvbWF0aWNhbGx5IHVwZGF0ZWQgdXBvbiBjaGFuZ2VzIGluIHRoZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudH5Eb2N1bWVudCBkb2N1bWVudH0KICogdG8gYWx3YXlzIGNvbnRhaW4gdmFsaWQgcmFuZ2VzLiBJdHMgYXR0cmlidXRlcyBhcmUgaW5oZXJpdGVkIGZyb20gdGhlIHRleHQgdW5sZXNzIHNldCBleHBsaWNpdGx5LgogKgogKiBEaWZmZXJlbmNlcyBiZXR3ZWVuIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3NlbGVjdGlvbn5TZWxlY3Rpb259IGFuZCBgRG9jdW1lbnRTZWxlY3Rpb25gIGFyZToKICogKiB0aGVyZSBpcyBhbHdheXMgYSByYW5nZSBpbiBgRG9jdW1lbnRTZWxlY3Rpb25gIC0gZXZlbiBpZiBubyByYW5nZXMgd2VyZSBhZGRlZCB0aGVyZSBpcyBhICJkZWZhdWx0IHJhbmdlIgogKiBwcmVzZW50IGluIHRoZSBzZWxlY3Rpb24sCiAqICogcmFuZ2VzIGFkZGVkIHRvIHRoaXMgc2VsZWN0aW9uIHVwZGF0ZXMgYXV0b21hdGljYWxseSB3aGVuIHRoZSBkb2N1bWVudCBjaGFuZ2VzLAogKiAqIGF0dHJpYnV0ZXMgb2YgYERvY3VtZW50U2VsZWN0aW9uYCBhcmUgdXBkYXRlZCBhdXRvbWF0aWNhbGx5IGFjY29yZGluZyB0byBzZWxlY3Rpb24gcmFuZ2VzLgogKgogKiBTaW5jZSBgRG9jdW1lbnRTZWxlY3Rpb25gIHVzZXMge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvbGl2ZXJhbmdlfkxpdmVSYW5nZSBsaXZlIHJhbmdlc30KICogYW5kIGlzIHVwZGF0ZWQgd2hlbiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudH5Eb2N1bWVudCBkb2N1bWVudH0KICogY2hhbmdlcywgaXQgY2Fubm90IGJlIHNldCBvbiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9ub2Rlfk5vZGUgbm9kZXN9CiAqIHRoYXQgYXJlIGluc2lkZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudGZyYWdtZW50fkRvY3VtZW50RnJhZ21lbnQgZG9jdW1lbnQgZnJhZ21lbnR9LgogKiBJZiB5b3UgbmVlZCB0byByZXByZXNlbnQgYSBzZWxlY3Rpb24gaW4gZG9jdW1lbnQgZnJhZ21lbnQsCiAqIHVzZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9zZWxlY3Rpb25+U2VsZWN0aW9uIFNlbGVjdGlvbiBjbGFzc30gaW5zdGVhZC4KICoKICogQG1peGVzIG1vZHVsZTp1dGlscy9lbWl0dGVybWl4aW5+RW1pdHRlck1peGluCiAqLwoKZXhwb3J0IGRlZmF1bHQgY2xhc3MgRG9jdW1lbnRTZWxlY3Rpb24gewogIC8qKgogICAqIENyZWF0ZXMgYW4gZW1wdHkgbGl2ZSBzZWxlY3Rpb24gZm9yIGdpdmVuIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2RvY3VtZW50fkRvY3VtZW50fS4KICAgKgogICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudH5Eb2N1bWVudH0gZG9jIERvY3VtZW50IHdoaWNoIG93bnMgdGhpcyBzZWxlY3Rpb24uCiAgICovCiAgY29uc3RydWN0b3IoZG9jKSB7CiAgICAvKioKICAgICAqIFNlbGVjdGlvbiB1c2VkIGludGVybmFsbHkgYnkgdGhhdCBjbGFzcyAoYERvY3VtZW50U2VsZWN0aW9uYCBpcyBhIHByb3h5IHRvIHRoYXQgc2VsZWN0aW9uKS4KICAgICAqCiAgICAgKiBAcHJvdGVjdGVkCiAgICAgKi8KICAgIHRoaXMuX3NlbGVjdGlvbiA9IG5ldyBMaXZlU2VsZWN0aW9uKGRvYyk7CgogICAgdGhpcy5fc2VsZWN0aW9uLmRlbGVnYXRlKCdjaGFuZ2U6cmFuZ2UnKS50byh0aGlzKTsKCiAgICB0aGlzLl9zZWxlY3Rpb24uZGVsZWdhdGUoJ2NoYW5nZTphdHRyaWJ1dGUnKS50byh0aGlzKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB3aGV0aGVyIHRoZSBzZWxlY3Rpb24gaXMgY29sbGFwc2VkLiBTZWxlY3Rpb24gaXMgY29sbGFwc2VkIHdoZW4gdGhlcmUgaXMgZXhhY3RseSBvbmUgcmFuZ2Ugd2hpY2ggaXMKICAgKiBjb2xsYXBzZWQuCiAgICoKICAgKiBAcmVhZG9ubHkKICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgKi8KCgogIGdldCBpc0NvbGxhcHNlZCgpIHsKICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uaXNDb2xsYXBzZWQ7CiAgfQogIC8qKgogICAqIFNlbGVjdGlvbiBhbmNob3IuIEFuY2hvciBtYXkgYmUgZGVzY3JpYmVkIGFzIGEgcG9zaXRpb24gd2hlcmUgdGhlIG1vc3QgcmVjZW50IHBhcnQgb2YgdGhlIHNlbGVjdGlvbiBzdGFydHMuCiAgICogVG9nZXRoZXIgd2l0aCB7QGxpbmsgI2ZvY3VzfSB0aGV5IGRlZmluZSB0aGUgZGlyZWN0aW9uIG9mIHNlbGVjdGlvbiwgd2hpY2ggaXMgaW1wb3J0YW50CiAgICogd2hlbiBleHBhbmRpbmcvc2hyaW5raW5nIHNlbGVjdGlvbi4gQW5jaG9yIGlzIGFsd2F5cyB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9yYW5nZX5SYW5nZSNzdGFydCBzdGFydH0gb3IKICAgKiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9yYW5nZX5SYW5nZSNlbmQgZW5kfSBwb3NpdGlvbiBvZiB0aGUgbW9zdCByZWNlbnRseSBhZGRlZCByYW5nZS4KICAgKgogICAqIElzIHNldCB0byBgbnVsbGAgaWYgdGhlcmUgYXJlIG5vIHJhbmdlcyBpbiBzZWxlY3Rpb24uCiAgICoKICAgKiBAc2VlICNmb2N1cwogICAqIEByZWFkb25seQogICAqIEB0eXBlIHttb2R1bGU6ZW5naW5lL21vZGVsL3Bvc2l0aW9uflBvc2l0aW9ufG51bGx9CiAgICovCgoKICBnZXQgYW5jaG9yKCkgewogICAgcmV0dXJuIHRoaXMuX3NlbGVjdGlvbi5hbmNob3I7CiAgfQogIC8qKgogICAqIFNlbGVjdGlvbiBmb2N1cy4gRm9jdXMgaXMgYSBwb3NpdGlvbiB3aGVyZSB0aGUgc2VsZWN0aW9uIGVuZHMuCiAgICoKICAgKiBJcyBzZXQgdG8gYG51bGxgIGlmIHRoZXJlIGFyZSBubyByYW5nZXMgaW4gc2VsZWN0aW9uLgogICAqCiAgICogQHNlZSAjYW5jaG9yCiAgICogQHJlYWRvbmx5CiAgICogQHR5cGUge21vZHVsZTplbmdpbmUvbW9kZWwvcG9zaXRpb25+UG9zaXRpb258bnVsbH0KICAgKi8KCgogIGdldCBmb2N1cygpIHsKICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uZm9jdXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgbnVtYmVyIG9mIHJhbmdlcyBpbiBzZWxlY3Rpb24uCiAgICoKICAgKiBAcmVhZG9ubHkKICAgKiBAdHlwZSB7TnVtYmVyfQogICAqLwoKCiAgZ2V0IHJhbmdlQ291bnQoKSB7CiAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLnJhbmdlQ291bnQ7CiAgfQogIC8qKgogICAqIERlc2NyaWJlcyB3aGV0aGVyIGBEb2N1bWVudHNlbGVjdGlvbmAgaGFzIG93biByYW5nZShzKSBzZXQsIG9yIGlmIGl0IGlzIGRlZmF1bHRlZCB0bwogICAqIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2RvY3VtZW50fkRvY3VtZW50I19nZXREZWZhdWx0UmFuZ2UgZG9jdW1lbnQncyBkZWZhdWx0IHJhbmdlfS4KICAgKgogICAqIEByZWFkb25seQogICAqIEB0eXBlIHtCb29sZWFufQogICAqLwoKCiAgZ2V0IGhhc093blJhbmdlKCkgewogICAgcmV0dXJuIHRoaXMuX3NlbGVjdGlvbi5oYXNPd25SYW5nZTsKICB9CiAgLyoqCiAgICogU3BlY2lmaWVzIHdoZXRoZXIgdGhlIHtAbGluayAjZm9jdXN9CiAgICogcHJlY2VkZXMge0BsaW5rICNhbmNob3J9LgogICAqCiAgICogQHJlYWRvbmx5CiAgICogQHR5cGUge0Jvb2xlYW59CiAgICovCgoKICBnZXQgaXNCYWNrd2FyZCgpIHsKICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uaXNCYWNrd2FyZDsKICB9CiAgLyoqCiAgICogRGVzY3JpYmVzIHdoZXRoZXIgdGhlIGdyYXZpdHkgaXMgb3ZlcnJpZGRlbiAodXNpbmcge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvd3JpdGVyfldyaXRlciNvdmVycmlkZVNlbGVjdGlvbkdyYXZpdHl9KSBvciBub3QuCiAgICoKICAgKiBOb3RlIHRoYXQgdGhlIGdyYXZpdHkgcmVtYWlucyBvdmVycmlkZGVuIGFzIGxvbmcgYXMgd2lsbCBub3QgYmUgcmVzdG9yZWQgdGhlIHNhbWUgbnVtYmVyIG9mIHRpbWVzIGFzIGl0IHdhcyBvdmVycmlkZGVuLgogICAqCiAgICogQHJlYWRvbmx5CiAgICogQHJldHVybnMge0Jvb2xlYW59CiAgICovCgoKICBnZXQgaXNHcmF2aXR5T3ZlcnJpZGRlbigpIHsKICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uaXNHcmF2aXR5T3ZlcnJpZGRlbjsKICB9CiAgLyoqCiAgICogQSBjb2xsZWN0aW9uIG9mIHNlbGVjdGlvbiBtYXJrZXJzLgogICAqIE1hcmtlciBpcyBhIHNlbGVjdGlvbiBtYXJrZXIgd2hlbiBzZWxlY3Rpb24gcmFuZ2UgaXMgaW5zaWRlIHRoZSBtYXJrZXIgcmFuZ2UuCiAgICoKICAgKiBAcmVhZG9ubHkKICAgKiBAdHlwZSB7bW9kdWxlOnV0aWxzL2NvbGxlY3Rpb25+Q29sbGVjdGlvbi48bW9kdWxlOmVuZ2luZS9tb2RlbC9tYXJrZXJjb2xsZWN0aW9ufk1hcmtlcj59CiAgICovCgoKICBnZXQgbWFya2VycygpIHsKICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24ubWFya2VyczsKICB9CiAgLyoqCiAgICogVXNlZCBmb3IgdGhlIGNvbXBhdGliaWxpdHkgd2l0aCB0aGUge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvc2VsZWN0aW9uflNlbGVjdGlvbiNpc0VxdWFsfSBtZXRob2QuCiAgICoKICAgKiBAcHJvdGVjdGVkCiAgICovCgoKICBnZXQgX3JhbmdlcygpIHsKICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uX3JhbmdlczsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhbiBpdGVyYWJsZSB0aGF0IGl0ZXJhdGVzIG92ZXIgY29waWVzIG9mIHNlbGVjdGlvbiByYW5nZXMuCiAgICoKICAgKiBAcmV0dXJucyB7SXRlcmFibGUuPG1vZHVsZTplbmdpbmUvbW9kZWwvcmFuZ2V+UmFuZ2U+fQogICAqLwoKCiAgZ2V0UmFuZ2VzKCkgewogICAgcmV0dXJuIHRoaXMuX3NlbGVjdGlvbi5nZXRSYW5nZXMoKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgZmlyc3QgcG9zaXRpb24gaW4gdGhlIHNlbGVjdGlvbi4KICAgKiBGaXJzdCBwb3NpdGlvbiBpcyB0aGUgcG9zaXRpb24gdGhhdCB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9wb3NpdGlvbn5Qb3NpdGlvbiNpc0JlZm9yZSBpcyBiZWZvcmV9CiAgICogYW55IG90aGVyIHBvc2l0aW9uIGluIHRoZSBzZWxlY3Rpb24uCiAgICoKICAgKiBSZXR1cm5zIGBudWxsYCBpZiB0aGVyZSBhcmUgbm8gcmFuZ2VzIGluIHNlbGVjdGlvbi4KICAgKgogICAqIEByZXR1cm5zIHttb2R1bGU6ZW5naW5lL21vZGVsL3Bvc2l0aW9uflBvc2l0aW9ufG51bGx9CiAgICovCgoKICBnZXRGaXJzdFBvc2l0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3NlbGVjdGlvbi5nZXRGaXJzdFBvc2l0aW9uKCk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGxhc3QgcG9zaXRpb24gaW4gdGhlIHNlbGVjdGlvbi4KICAgKiBMYXN0IHBvc2l0aW9uIGlzIHRoZSBwb3NpdGlvbiB0aGF0IHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3Bvc2l0aW9uflBvc2l0aW9uI2lzQWZ0ZXIgaXMgYWZ0ZXJ9CiAgICogYW55IG90aGVyIHBvc2l0aW9uIGluIHRoZSBzZWxlY3Rpb24uCiAgICoKICAgKiBSZXR1cm5zIGBudWxsYCBpZiB0aGVyZSBhcmUgbm8gcmFuZ2VzIGluIHNlbGVjdGlvbi4KICAgKgogICAqIEByZXR1cm5zIHttb2R1bGU6ZW5naW5lL21vZGVsL3Bvc2l0aW9uflBvc2l0aW9ufG51bGx9CiAgICovCgoKICBnZXRMYXN0UG9zaXRpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLmdldExhc3RQb3NpdGlvbigpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgY29weSBvZiB0aGUgZmlyc3QgcmFuZ2UgaW4gdGhlIHNlbGVjdGlvbi4KICAgKiBGaXJzdCByYW5nZSBpcyB0aGUgb25lIHdoaWNoIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3JhbmdlflJhbmdlI3N0YXJ0IHN0YXJ0fSBwb3NpdGlvbgogICAqIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3Bvc2l0aW9uflBvc2l0aW9uI2lzQmVmb3JlIGlzIGJlZm9yZX0gc3RhcnQgcG9zaXRpb24gb2YgYWxsIG90aGVyIHJhbmdlcwogICAqIChub3QgdG8gY29uZnVzZSB3aXRoIHRoZSBmaXJzdCByYW5nZSBhZGRlZCB0byB0aGUgc2VsZWN0aW9uKS4KICAgKgogICAqIFJldHVybnMgYG51bGxgIGlmIHRoZXJlIGFyZSBubyByYW5nZXMgaW4gc2VsZWN0aW9uLgogICAqCiAgICogQHJldHVybnMge21vZHVsZTplbmdpbmUvbW9kZWwvcmFuZ2V+UmFuZ2V8bnVsbH0KICAgKi8KCgogIGdldEZpcnN0UmFuZ2UoKSB7CiAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLmdldEZpcnN0UmFuZ2UoKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIGNvcHkgb2YgdGhlIGxhc3QgcmFuZ2UgaW4gdGhlIHNlbGVjdGlvbi4KICAgKiBMYXN0IHJhbmdlIGlzIHRoZSBvbmUgd2hpY2gge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvcmFuZ2V+UmFuZ2UjZW5kIGVuZH0gcG9zaXRpb24KICAgKiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9wb3NpdGlvbn5Qb3NpdGlvbiNpc0FmdGVyIGlzIGFmdGVyfSBlbmQgcG9zaXRpb24gb2YgYWxsIG90aGVyIHJhbmdlcyAobm90IHRvIGNvbmZ1c2Ugd2l0aCB0aGUgcmFuZ2UgbW9zdAogICAqIHJlY2VudGx5IGFkZGVkIHRvIHRoZSBzZWxlY3Rpb24pLgogICAqCiAgICogUmV0dXJucyBgbnVsbGAgaWYgdGhlcmUgYXJlIG5vIHJhbmdlcyBpbiBzZWxlY3Rpb24uCiAgICoKICAgKiBAcmV0dXJucyB7bW9kdWxlOmVuZ2luZS9tb2RlbC9yYW5nZX5SYW5nZXxudWxsfQogICAqLwoKCiAgZ2V0TGFzdFJhbmdlKCkgewogICAgcmV0dXJuIHRoaXMuX3NlbGVjdGlvbi5nZXRMYXN0UmFuZ2UoKTsKICB9CiAgLyoqCiAgICogR2V0cyBlbGVtZW50cyBvZiB0eXBlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3NjaGVtYX5TY2hlbWEjaXNCbG9jayAiYmxvY2sifSB0b3VjaGVkIGJ5IHRoZSBzZWxlY3Rpb24uCiAgICoKICAgKiBUaGlzIG1ldGhvZCdzIHJlc3VsdCBjYW4gYmUgdXNlZCBmb3IgZXhhbXBsZSB0byBhcHBseSBibG9jayBzdHlsaW5nIHRvIGFsbCBibG9ja3MgY292ZXJlZCBieSB0aGlzIHNlbGVjdGlvbi4KICAgKgogICAqICoqTm90ZToqKiBgZ2V0U2VsZWN0ZWRCbG9ja3MoKWAgcmV0dXJucyBibG9ja3MgdGhhdCBhcmUgbmVzdGVkIGluIG90aGVyIG5vbi1ibG9jayBlbGVtZW50cwogICAqIGJ1dCB3aWxsIG5vdCByZXR1cm4gYmxvY2tzIG5lc3RlZCBpbiBvdGhlciBibG9ja3MuCiAgICoKICAgKiBJbiB0aGlzIGNhc2UgdGhlIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIGV4YWN0bHkgYWxsIDMgcGFyYWdyYXBocyAobm90ZTogYDxibG9ja1F1b3RlPmAgaXMgbm90IGEgYmxvY2sgaXRzZWxmKToKICAgKgogICAqCQk8cGFyYWdyYXBoPlthPC9wYXJhZ3JhcGg+CiAgICoJCTxibG9ja1F1b3RlPgogICAqCQkJPHBhcmFncmFwaD5iPC9wYXJhZ3JhcGg+CiAgICoJCTwvYmxvY2tRdW90ZT4KICAgKgkJPHBhcmFncmFwaD5jXWQ8L3BhcmFncmFwaD4KICAgKgogICAqIEluIHRoaXMgY2FzZSB0aGUgcGFyYWdyYXBoIHdpbGwgYWxzbyBiZSByZXR1cm5lZCwgZGVzcGl0ZSB0aGUgY29sbGFwc2VkIHNlbGVjdGlvbjoKICAgKgogICAqCQk8cGFyYWdyYXBoPltdYTwvcGFyYWdyYXBoPgogICAqCiAgICogSW4gc3VjaCBhIHNjZW5hcmlvLCBob3dldmVyLCBvbmx5IGJsb2NrcyBBLCBCICYgRSB3aWxsIGJlIHJldHVybmVkIGFzIGJsb2NrcyBDICYgRCBhcmUgbmVzdGVkIGluIGJsb2NrIEI6CiAgICoKICAgKgkJWzxibG9ja0E+PC9ibG9ja0E+CiAgICoJCTxibG9ja0I+CiAgICoJCQk8YmxvY2tDPjwvYmxvY2tDPgogICAqCQkJPGJsb2NrRD48L2Jsb2NrRD4KICAgKgkJPC9ibG9ja0I+CiAgICoJCTxibG9ja0U+PC9ibG9ja0U+XQogICAqCiAgICogSWYgdGhlIHNlbGVjdGlvbiBpcyBpbnNpZGUgYSBibG9jayBhbGwgdGhlIGlubmVyIGJsb2NrcyAoQSAmIEIpIGFyZSByZXR1cm5lZDoKICAgKgogICAqIAkJPGJsb2NrPgogICAqCQkJPGJsb2NrQT5bYTwvYmxvY2tBPgogICAqIAkJCTxibG9ja0I+Yl08L2Jsb2NrQj4KICAgKiAJCTwvYmxvY2s+CiAgICoKICAgKiAqKlNwZWNpYWwgY2FzZSoqOiBJZiBhIHNlbGVjdGlvbiBlbmRzIGF0IHRoZSBiZWdpbm5pbmcgb2YgYSBibG9jaywgdGhhdCBibG9jayBpcyBub3QgcmV0dXJuZWQgYXMgZnJvbSB1c2VyIHBlcnNwZWN0aXZlCiAgICogdGhpcyBibG9jayB3YXNuJ3Qgc2VsZWN0ZWQuIFNlZSBbIzk4NF0oaHR0cHM6Ly9naXRodWIuY29tL2NrZWRpdG9yL2NrZWRpdG9yNS1lbmdpbmUvaXNzdWVzLzk4NCkgZm9yIG1vcmUgZGV0YWlscy4KICAgKgogICAqCQk8cGFyYWdyYXBoPlthPC9wYXJhZ3JhcGg+CiAgICoJCTxwYXJhZ3JhcGg+YjwvcGFyYWdyYXBoPgogICAqCQk8cGFyYWdyYXBoPl1jPC9wYXJhZ3JhcGg+IC8vIHRoaXMgYmxvY2sgd2lsbCBub3QgYmUgcmV0dXJuZWQKICAgKgogICAqIEByZXR1cm5zIHtJdGVyYWJsZS48bW9kdWxlOmVuZ2luZS9tb2RlbC9lbGVtZW50fkVsZW1lbnQ+fQogICAqLwoKCiAgZ2V0U2VsZWN0ZWRCbG9ja3MoKSB7CiAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLmdldFNlbGVjdGVkQmxvY2tzKCk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHNlbGVjdGVkIGVsZW1lbnQuIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2VsZW1lbnR+RWxlbWVudCBFbGVtZW50fSBpcyBjb25zaWRlcmVkIGFzIHNlbGVjdGVkIGlmIHRoZXJlIGlzIG9ubHkKICAgKiBvbmUgcmFuZ2UgaW4gdGhlIHNlbGVjdGlvbiwgYW5kIHRoYXQgcmFuZ2UgY29udGFpbnMgZXhhY3RseSBvbmUgZWxlbWVudC4KICAgKiBSZXR1cm5zIGBudWxsYCBpZiB0aGVyZSBpcyBubyBzZWxlY3RlZCBlbGVtZW50LgogICAqCiAgICogQHJldHVybnMge21vZHVsZTplbmdpbmUvbW9kZWwvZWxlbWVudH5FbGVtZW50fG51bGx9CiAgICovCgoKICBnZXRTZWxlY3RlZEVsZW1lbnQoKSB7CiAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLmdldFNlbGVjdGVkRWxlbWVudCgpOwogIH0KICAvKioKICAgKiBDaGVja3Mgd2hldGhlciB0aGUgc2VsZWN0aW9uIGNvbnRhaW5zIHRoZSBlbnRpcmUgY29udGVudCBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4gVGhpcyBtZWFucyB0aGF0IHNlbGVjdGlvbiBtdXN0IHN0YXJ0CiAgICogYXQgYSBwb3NpdGlvbiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9wb3NpdGlvbn5Qb3NpdGlvbiNpc1RvdWNoaW5nIHRvdWNoaW5nfSB0aGUgZWxlbWVudCdzIHN0YXJ0IGFuZCBlbmRzIGF0IHBvc2l0aW9uCiAgICogdG91Y2hpbmcgdGhlIGVsZW1lbnQncyBlbmQuCiAgICoKICAgKiBCeSBkZWZhdWx0LCB0aGlzIG1ldGhvZCB3aWxsIGNoZWNrIHdoZXRoZXIgdGhlIGVudGlyZSBjb250ZW50IG9mIHRoZSBzZWxlY3Rpb24ncyBjdXJyZW50IHJvb3QgaXMgc2VsZWN0ZWQuCiAgICogVXNlZnVsIHRvIGNoZWNrIGlmIGUuZy4gdGhlIHVzZXIgaGFzIGp1c3QgcHJlc3NlZCA8a2JkPkN0cmw8L2tiZD4gKyA8a2JkPkE8L2tiZD4uCiAgICoKICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvZWxlbWVudH5FbGVtZW50fSBbZWxlbWVudD10aGlzLmFuY2hvci5yb290XQogICAqIEByZXR1cm5zIHtCb29sZWFufQogICAqLwoKCiAgY29udGFpbnNFbnRpcmVDb250ZW50KGVsZW1lbnQpIHsKICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uY29udGFpbnNFbnRpcmVDb250ZW50KGVsZW1lbnQpOwogIH0KICAvKioKICAgKiBVbmJpbmRzIGFsbCBldmVudHMgcHJldmlvdXNseSBib3VuZCBieSBkb2N1bWVudCBzZWxlY3Rpb24uCiAgICovCgoKICBkZXN0cm95KCkgewogICAgdGhpcy5fc2VsZWN0aW9uLmRlc3Ryb3koKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBpdGVyYWJsZSB0aGF0IGl0ZXJhdGVzIG92ZXIgdGhpcyBzZWxlY3Rpb24ncyBhdHRyaWJ1dGUga2V5cy4KICAgKgogICAqIEByZXR1cm5zIHtJdGVyYWJsZS48U3RyaW5nPn0KICAgKi8KCgogIGdldEF0dHJpYnV0ZUtleXMoKSB7CiAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLmdldEF0dHJpYnV0ZUtleXMoKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBpdGVyYWJsZSB0aGF0IGl0ZXJhdGVzIG92ZXIgdGhpcyBzZWxlY3Rpb24ncyBhdHRyaWJ1dGVzLgogICAqCiAgICogQXR0cmlidXRlcyBhcmUgcmV0dXJuZWQgYXMgYXJyYXlzIGNvbnRhaW5pbmcgdHdvIGl0ZW1zLiBGaXJzdCBvbmUgaXMgYXR0cmlidXRlIGtleSBhbmQgc2Vjb25kIGlzIGF0dHJpYnV0ZSB2YWx1ZS4KICAgKiBUaGlzIGZvcm1hdCBpcyBhY2NlcHRlZCBieSBuYXRpdmUgYE1hcGAgb2JqZWN0IGFuZCBhbHNvIGNhbiBiZSBwYXNzZWQgaW4gYE5vZGVgIGNvbnN0cnVjdG9yLgogICAqCiAgICogQHJldHVybnMge0l0ZXJhYmxlLjwqPn0KICAgKi8KCgogIGdldEF0dHJpYnV0ZXMoKSB7CiAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLmdldEF0dHJpYnV0ZXMoKTsKICB9CiAgLyoqCiAgICogR2V0cyBhbiBhdHRyaWJ1dGUgdmFsdWUgZm9yIGdpdmVuIGtleSBvciBgdW5kZWZpbmVkYCBpZiB0aGF0IGF0dHJpYnV0ZSBpcyBub3Qgc2V0IG9uIHRoZSBzZWxlY3Rpb24uCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30ga2V5IEtleSBvZiBhdHRyaWJ1dGUgdG8gbG9vayBmb3IuCiAgICogQHJldHVybnMgeyp9IEF0dHJpYnV0ZSB2YWx1ZSBvciBgdW5kZWZpbmVkYC4KICAgKi8KCgogIGdldEF0dHJpYnV0ZShrZXkpIHsKICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uZ2V0QXR0cmlidXRlKGtleSk7CiAgfQogIC8qKgogICAqIENoZWNrcyBpZiB0aGUgc2VsZWN0aW9uIGhhcyBhbiBhdHRyaWJ1dGUgZm9yIGdpdmVuIGtleS4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBrZXkgS2V5IG9mIGF0dHJpYnV0ZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gYHRydWVgIGlmIGF0dHJpYnV0ZSB3aXRoIGdpdmVuIGtleSBpcyBzZXQgb24gc2VsZWN0aW9uLCBgZmFsc2VgIG90aGVyd2lzZS4KICAgKi8KCgogIGhhc0F0dHJpYnV0ZShrZXkpIHsKICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uaGFzQXR0cmlidXRlKGtleSk7CiAgfQogIC8qKgogICAqIFJlZnJlc2hlcyBzZWxlY3Rpb24gYXR0cmlidXRlcyBhbmQgbWFya2VycyBhY2NvcmRpbmcgdG8gdGhlIGN1cnJlbnQgcG9zaXRpb24gaW4gdGhlIG1vZGVsLgogICAqLwoKCiAgcmVmcmVzaCgpIHsKICAgIHRoaXMuX3NlbGVjdGlvbi5fdXBkYXRlTWFya2VycygpOwoKICAgIHRoaXMuX3NlbGVjdGlvbi5fdXBkYXRlQXR0cmlidXRlcyhmYWxzZSk7CiAgfQogIC8qKgogICAqIENoZWNrcyB3aGV0aGVyIHRoaXMgb2JqZWN0IGlzIG9mIHRoZSBnaXZlbiB0eXBlLgogICAqCiAgICoJCXNlbGVjdGlvbi5pcyggJ3NlbGVjdGlvbicgKTsgLy8gLT4gdHJ1ZQogICAqCQlzZWxlY3Rpb24uaXMoICdkb2N1bWVudFNlbGVjdGlvbicgKTsgLy8gLT4gdHJ1ZQogICAqCQlzZWxlY3Rpb24uaXMoICdtb2RlbDpzZWxlY3Rpb24nICk7IC8vIC0+IHRydWUKICAgKgkJc2VsZWN0aW9uLmlzKCAnbW9kZWw6ZG9jdW1lbnRTZWxlY3Rpb24nICk7IC8vIC0+IHRydWUKICAgKgogICAqCQlzZWxlY3Rpb24uaXMoICd2aWV3OnNlbGVjdGlvbicgKTsgLy8gLT4gZmFsc2UKICAgKgkJc2VsZWN0aW9uLmlzKCAnZWxlbWVudCcgKTsgLy8gLT4gZmFsc2UKICAgKgkJc2VsZWN0aW9uLmlzKCAnbm9kZScgKTsgLy8gLT4gZmFsc2UKICAgKgogICAqIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL25vZGV+Tm9kZSNpcyBDaGVjayB0aGUgZW50aXJlIGxpc3Qgb2YgbW9kZWwgb2JqZWN0c30gd2hpY2ggaW1wbGVtZW50IHRoZSBgaXMoKWAgbWV0aG9kLgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0KICAgKi8KCgogIGlzKHR5cGUpIHsKICAgIHJldHVybiB0eXBlID09ICdzZWxlY3Rpb24nIHx8IHR5cGUgPT0gJ21vZGVsOnNlbGVjdGlvbicgfHwgdHlwZSA9PSAnZG9jdW1lbnRTZWxlY3Rpb24nIHx8IHR5cGUgPT0gJ21vZGVsOmRvY3VtZW50U2VsZWN0aW9uJzsKICB9CiAgLyoqCiAgICogTW92ZXMge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZG9jdW1lbnRzZWxlY3Rpb25+RG9jdW1lbnRTZWxlY3Rpb24jZm9jdXN9IHRvIHRoZSBzcGVjaWZpZWQgbG9jYXRpb24uCiAgICogU2hvdWxkIGJlIHVzZWQgb25seSB3aXRoaW4gdGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3dyaXRlcn5Xcml0ZXIjc2V0U2VsZWN0aW9uRm9jdXN9IG1ldGhvZC4KICAgKgogICAqIFRoZSBsb2NhdGlvbiBjYW4gYmUgc3BlY2lmaWVkIGluIHRoZSBzYW1lIGZvcm0gYXMKICAgKiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC93cml0ZXJ+V3JpdGVyI2NyZWF0ZVBvc2l0aW9uQXQgd3JpdGVyLmNyZWF0ZVBvc2l0aW9uQXQoKX0gcGFyYW1ldGVycy4KICAgKgogICAqIEBzZWUgbW9kdWxlOmVuZ2luZS9tb2RlbC93cml0ZXJ+V3JpdGVyI3NldFNlbGVjdGlvbkZvY3VzCiAgICogQHByb3RlY3RlZAogICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9pdGVtfkl0ZW18bW9kdWxlOmVuZ2luZS9tb2RlbC9wb3NpdGlvbn5Qb3NpdGlvbn0gaXRlbU9yUG9zaXRpb24KICAgKiBAcGFyYW0ge051bWJlcnwnZW5kJ3wnYmVmb3JlJ3wnYWZ0ZXInfSBbb2Zmc2V0XSBPZmZzZXQgb3Igb25lIG9mIHRoZSBmbGFncy4gVXNlZCBvbmx5IHdoZW4KICAgKiBmaXJzdCBwYXJhbWV0ZXIgaXMgYSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9pdGVtfkl0ZW0gbW9kZWwgaXRlbX0uCiAgICovCgoKICBfc2V0Rm9jdXMoaXRlbU9yUG9zaXRpb24sIG9mZnNldCkgewogICAgdGhpcy5fc2VsZWN0aW9uLnNldEZvY3VzKGl0ZW1PclBvc2l0aW9uLCBvZmZzZXQpOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgc2VsZWN0aW9uJ3MgcmFuZ2VzIGFuZCBkaXJlY3Rpb24gdG8gdGhlIHNwZWNpZmllZCBsb2NhdGlvbiBiYXNlZCBvbiB0aGUgZ2l2ZW4KICAgKiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9zZWxlY3Rpb25+U2VsZWN0YWJsZSBzZWxlY3RhYmxlfS4KICAgKiBTaG91bGQgYmUgdXNlZCBvbmx5IHdpdGhpbiB0aGUge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvd3JpdGVyfldyaXRlciNzZXRTZWxlY3Rpb259IG1ldGhvZC4KICAgKgogICAqIEBzZWUgbW9kdWxlOmVuZ2luZS9tb2RlbC93cml0ZXJ+V3JpdGVyI3NldFNlbGVjdGlvbgogICAqIEBwcm90ZWN0ZWQKICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvc2VsZWN0aW9uflNlbGVjdGFibGV9IHNlbGVjdGFibGUKICAgKiBAcGFyYW0ge051bWJlcnwnYmVmb3JlJ3wnZW5kJ3wnYWZ0ZXInfCdvbid8J2luJ30gW3BsYWNlT3JPZmZzZXRdIFNldHMgcGxhY2Ugb3Igb2Zmc2V0IG9mIHRoZSBzZWxlY3Rpb24uCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXQogICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuYmFja3dhcmRdIFNldHMgdGhpcyBzZWxlY3Rpb24gaW5zdGFuY2UgdG8gYmUgYmFja3dhcmQuCiAgICovCgoKICBfc2V0VG8oc2VsZWN0YWJsZSwgcGxhY2VPck9mZnNldCwgb3B0aW9ucykgewogICAgdGhpcy5fc2VsZWN0aW9uLnNldFRvKHNlbGVjdGFibGUsIHBsYWNlT3JPZmZzZXQsIG9wdGlvbnMpOwogIH0KICAvKioKICAgKiBTZXRzIGF0dHJpYnV0ZSBvbiB0aGUgc2VsZWN0aW9uLiBJZiBhdHRyaWJ1dGUgd2l0aCB0aGUgc2FtZSBrZXkgYWxyZWFkeSBpcyBzZXQsIGl0J3MgdmFsdWUgaXMgb3ZlcndyaXR0ZW4uCiAgICogU2hvdWxkIGJlIHVzZWQgb25seSB3aXRoaW4gdGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3dyaXRlcn5Xcml0ZXIjc2V0U2VsZWN0aW9uQXR0cmlidXRlfSBtZXRob2QuCiAgICoKICAgKiBAc2VlIG1vZHVsZTplbmdpbmUvbW9kZWwvd3JpdGVyfldyaXRlciNzZXRTZWxlY3Rpb25BdHRyaWJ1dGUKICAgKiBAcHJvdGVjdGVkCiAgICogQHBhcmFtIHtTdHJpbmd9IGtleSBLZXkgb2YgdGhlIGF0dHJpYnV0ZSB0byBzZXQuCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBBdHRyaWJ1dGUgdmFsdWUuCiAgICovCgoKICBfc2V0QXR0cmlidXRlKGtleSwgdmFsdWUpIHsKICAgIHRoaXMuX3NlbGVjdGlvbi5zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSk7CiAgfQogIC8qKgogICAqIFJlbW92ZXMgYW4gYXR0cmlidXRlIHdpdGggZ2l2ZW4ga2V5IGZyb20gdGhlIHNlbGVjdGlvbi4KICAgKiBJZiB0aGUgZ2l2ZW4gYXR0cmlidXRlIHdhcyBzZXQgb24gdGhlIHNlbGVjdGlvbiwgZmlyZXMgdGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3NlbGVjdGlvbn5TZWxlY3Rpb24jZXZlbnQ6Y2hhbmdlOnJhbmdlfQogICAqIGV2ZW50IHdpdGggcmVtb3ZlZCBhdHRyaWJ1dGUga2V5LgogICAqIFNob3VsZCBiZSB1c2VkIG9ubHkgd2l0aGluIHRoZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC93cml0ZXJ+V3JpdGVyI3JlbW92ZVNlbGVjdGlvbkF0dHJpYnV0ZX0gbWV0aG9kLgogICAqCiAgICogQHNlZSBtb2R1bGU6ZW5naW5lL21vZGVsL3dyaXRlcn5Xcml0ZXIjcmVtb3ZlU2VsZWN0aW9uQXR0cmlidXRlCiAgICogQHByb3RlY3RlZAogICAqIEBwYXJhbSB7U3RyaW5nfSBrZXkgS2V5IG9mIHRoZSBhdHRyaWJ1dGUgdG8gcmVtb3ZlLgogICAqLwoKCiAgX3JlbW92ZUF0dHJpYnV0ZShrZXkpIHsKICAgIHRoaXMuX3NlbGVjdGlvbi5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhbiBpdGVyYWJsZSB0aGF0IGl0ZXJhdGVzIHRocm91Z2ggYWxsIHNlbGVjdGlvbiBhdHRyaWJ1dGVzIHN0b3JlZCBpbiBjdXJyZW50IHNlbGVjdGlvbidzIHBhcmVudC4KICAgKgogICAqIEBwcm90ZWN0ZWQKICAgKiBAcmV0dXJucyB7SXRlcmFibGUuPCo+fQogICAqLwoKCiAgX2dldFN0b3JlZEF0dHJpYnV0ZXMoKSB7CiAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLl9nZXRTdG9yZWRBdHRyaWJ1dGVzKCk7CiAgfQogIC8qKgogICAqIFRlbXBvcmFyaWx5IGNoYW5nZXMgdGhlIGdyYXZpdHkgb2YgdGhlIHNlbGVjdGlvbiBmcm9tIHRoZSBsZWZ0IHRvIHRoZSByaWdodC4KICAgKgogICAqIFRoZSBncmF2aXR5IGRlZmluZXMgZnJvbSB3aGljaCBkaXJlY3Rpb24gdGhlIHNlbGVjdGlvbiBpbmhlcml0cyBpdHMgYXR0cmlidXRlcy4gSWYgaXQncyB0aGUgZGVmYXVsdCBsZWZ0CiAgICogZ3Jhdml0eSwgdGhlIHNlbGVjdGlvbiAoYWZ0ZXIgYmVpbmcgbW92ZWQgYnkgdGhlIHRoZSB1c2VyKSBpbmhlcml0cyBhdHRyaWJ1dGVzIGZyb20gaXRzIGxlZnQgaGFuZCBzaWRlLgogICAqIFRoaXMgbWV0aG9kIGFsbG93cyB0byB0ZW1wb3JhcmlseSBvdmVycmlkZSB0aGlzIGJlaGF2aW9yIGJ5IGZvcmNpbmcgdGhlIGdyYXZpdHkgdG8gdGhlIHJpZ2h0LgogICAqCiAgICogSXQgcmV0dXJucyBhbiB1bmlxdWUgaWRlbnRpZmllciB3aGljaCBpcyByZXF1aXJlZCB0byByZXN0b3JlIHRoZSBncmF2aXR5LiBJdCBndWFyYW50ZWVzIHRoZSBzeW1tZXRyeQogICAqIG9mIHRoZSBwcm9jZXNzLgogICAqCiAgICogQHNlZSBtb2R1bGU6ZW5naW5lL21vZGVsL3dyaXRlcn5Xcml0ZXIjb3ZlcnJpZGVTZWxlY3Rpb25HcmF2aXR5CiAgICogQHByb3RlY3RlZAogICAqIEByZXR1cm5zIHtTdHJpbmd9IFRoZSB1bmlxdWUgaWQgd2hpY2ggYWxsb3dzIHJlc3RvcmluZyB0aGUgZ3Jhdml0eS4KICAgKi8KCgogIF9vdmVycmlkZUdyYXZpdHkoKSB7CiAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLm92ZXJyaWRlR3Jhdml0eSgpOwogIH0KICAvKioKICAgKiBSZXN0b3JlcyB0aGUge0BsaW5rIH5Eb2N1bWVudFNlbGVjdGlvbiNfb3ZlcnJpZGVHcmF2aXR5IG92ZXJyaWRkZW4gZ3Jhdml0eX0uCiAgICoKICAgKiBSZXN0b3JpbmcgdGhlIGdyYXZpdHkgaXMgb25seSBwb3NzaWJsZSB1c2luZyB0aGUgdW5pcXVlIGlkZW50aWZpZXIgcmV0dXJuZWQgYnkKICAgKiB7QGxpbmsgfkRvY3VtZW50U2VsZWN0aW9uI19vdmVycmlkZUdyYXZpdHl9LiBOb3RlIHRoYXQgdGhlIGdyYXZpdHkgcmVtYWlucyBvdmVycmlkZGVuIGFzIGxvbmcgYXMgd29uJ3QgYmUgcmVzdG9yZWQKICAgKiB0aGUgc2FtZSBudW1iZXIgb2YgdGltZXMgaXQgd2FzIG92ZXJyaWRkZW4uCiAgICoKICAgKiBAc2VlIG1vZHVsZTplbmdpbmUvbW9kZWwvd3JpdGVyfldyaXRlciNyZXN0b3JlU2VsZWN0aW9uR3Jhdml0eQogICAqIEBwcm90ZWN0ZWQKICAgKiBAcGFyYW0ge1N0cmluZ30gdWlkIFRoZSB1bmlxdWUgaWQgcmV0dXJuZWQgYnkge0BsaW5rICNfb3ZlcnJpZGVHcmF2aXR5fS4KICAgKi8KCgogIF9yZXN0b3JlR3Jhdml0eSh1aWQpIHsKICAgIHRoaXMuX3NlbGVjdGlvbi5yZXN0b3JlR3Jhdml0eSh1aWQpOwogIH0KICAvKioKICAgKiBHZW5lcmF0ZXMgYW5kIHJldHVybnMgYW4gYXR0cmlidXRlIGtleSBmb3Igc2VsZWN0aW9uIGF0dHJpYnV0ZXMgc3RvcmUsIGJhc2luZyBvbiBvcmlnaW5hbCBhdHRyaWJ1dGUga2V5LgogICAqCiAgICogQHByb3RlY3RlZAogICAqIEBwYXJhbSB7U3RyaW5nfSBrZXkgQXR0cmlidXRlIGtleSB0byBjb252ZXJ0LgogICAqIEByZXR1cm5zIHtTdHJpbmd9IENvbnZlcnRlZCBhdHRyaWJ1dGUga2V5LCBhcHBsaWNhYmxlIGZvciBzZWxlY3Rpb24gc3RvcmUuCiAgICovCgoKICBzdGF0aWMgX2dldFN0b3JlQXR0cmlidXRlS2V5KGtleSkgewogICAgcmV0dXJuIHN0b3JlUHJlZml4ICsga2V5OwogIH0KICAvKioKICAgKiBDaGVja3Mgd2hldGhlciB0aGUgZ2l2ZW4gYXR0cmlidXRlIGtleSBpcyBhbiBhdHRyaWJ1dGUgc3RvcmVkIG9uIGFuIGVsZW1lbnQuCiAgICoKICAgKiBAcHJvdGVjdGVkCiAgICogQHBhcmFtIHtTdHJpbmd9IGtleQogICAqIEByZXR1cm5zIHtCb29sZWFufQogICAqLwoKCiAgc3RhdGljIF9pc1N0b3JlQXR0cmlidXRlS2V5KGtleSkgewogICAgcmV0dXJuIGtleS5zdGFydHNXaXRoKHN0b3JlUHJlZml4KTsKICB9Cgp9Cm1peChEb2N1bWVudFNlbGVjdGlvbiwgRW1pdHRlck1peGluKTsKLyoqCiAqIEZpcmVkIHdoZW4gc2VsZWN0aW9uIHJhbmdlKHMpIGNoYW5nZWQuCiAqCiAqIEBldmVudCBjaGFuZ2U6cmFuZ2UKICogQHBhcmFtIHtCb29sZWFufSBkaXJlY3RDaGFuZ2UgSW4gY2FzZSBvZiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9zZWxlY3Rpb25+U2VsZWN0aW9ufSBjbGFzcyBpdCBpcyBhbHdheXMgc2V0CiAqIHRvIGB0cnVlYCB3aGljaCBpbmRpY2F0ZXMgdGhhdCB0aGUgc2VsZWN0aW9uIGNoYW5nZSB3YXMgY2F1c2VkIGJ5IGEgZGlyZWN0IHVzZSBvZiBzZWxlY3Rpb24ncyBBUEkuCiAqIFRoZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudHNlbGVjdGlvbn5Eb2N1bWVudFNlbGVjdGlvbn0sIGhvd2V2ZXIsIG1heSBjaGFuZ2UgYmVjYXVzZSBpdHMgcG9zaXRpb24KICogd2FzIGRpcmVjdGx5IGNoYW5nZWQgdGhyb3VnaCB0aGUge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvd3JpdGVyfldyaXRlciB3cml0ZXJ9IG9yIGJlY2F1c2UgaXRzIHBvc2l0aW9uIHdhcwogKiBjaGFuZ2VkIGJlY2F1c2UgdGhlIHN0cnVjdHVyZSBvZiB0aGUgbW9kZWwgaGFzIGJlZW4gY2hhbmdlZCAod2hpY2ggbWVhbnMgYW4gaW5kaXJlY3QgY2hhbmdlKS4KICogVGhlIGluZGlyZWN0IGNoYW5nZSBkb2VzIG5vdCBvY2N1ciBpbiBjYXNlIG9mIG5vcm1hbCAoZGV0YWNoZWQpIHNlbGVjdGlvbnMgYmVjYXVzZSB0aGV5IGFyZSAic3RhdGljIiAoYXMgIm5vdCBsaXZlIikKICogd2hpY2ggbWVhbiB0aGF0IHRoZXkgYXJlIG5vdCB1cGRhdGVkIG9uY2UgdGhlIGRvY3VtZW50IGNoYW5nZXMuCiAqLwoKLyoqCiAqIEZpcmVkIHdoZW4gc2VsZWN0aW9uIGF0dHJpYnV0ZSBjaGFuZ2VkLgogKgogKiBAZXZlbnQgY2hhbmdlOmF0dHJpYnV0ZQogKiBAcGFyYW0ge0Jvb2xlYW59IGRpcmVjdENoYW5nZSBJbiBjYXNlIG9mIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3NlbGVjdGlvbn5TZWxlY3Rpb259IGNsYXNzIGl0IGlzIGFsd2F5cyBzZXQKICogdG8gYHRydWVgIHdoaWNoIGluZGljYXRlcyB0aGF0IHRoZSBzZWxlY3Rpb24gY2hhbmdlIHdhcyBjYXVzZWQgYnkgYSBkaXJlY3QgdXNlIG9mIHNlbGVjdGlvbidzIEFQSS4KICogVGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2RvY3VtZW50c2VsZWN0aW9ufkRvY3VtZW50U2VsZWN0aW9ufSwgaG93ZXZlciwgbWF5IGNoYW5nZSBiZWNhdXNlIGl0cyBhdHRyaWJ1dGVzCiAqIHdlcmUgZGlyZWN0bHkgY2hhbmdlZCB0aHJvdWdoIHRoZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC93cml0ZXJ+V3JpdGVyIHdyaXRlcn0gb3IgYmVjYXVzZSBpdHMgcG9zaXRpb24gd2FzCiAqIGNoYW5nZWQgaW4gdGhlIG1vZGVsIGFuZCBpdHMgYXR0cmlidXRlcyB3ZXJlIHJlZnJlc2hlZCAod2hpY2ggbWVhbnMgYW4gaW5kaXJlY3QgY2hhbmdlKS4KICogVGhlIGluZGlyZWN0IGNoYW5nZSBkb2VzIG5vdCBvY2N1ciBpbiBjYXNlIG9mIG5vcm1hbCAoZGV0YWNoZWQpIHNlbGVjdGlvbnMgYmVjYXVzZSB0aGV5IGFyZSAic3RhdGljIiAoYXMgIm5vdCBsaXZlIikKICogd2hpY2ggbWVhbiB0aGF0IHRoZXkgYXJlIG5vdCB1cGRhdGVkIG9uY2UgdGhlIGRvY3VtZW50IGNoYW5nZXMuCiAqIEBwYXJhbSB7QXJyYXkuPFN0cmluZz59IGF0dHJpYnV0ZUtleXMgQXJyYXkgY29udGFpbmluZyBrZXlzIG9mIGF0dHJpYnV0ZXMgdGhhdCBjaGFuZ2VkLgogKi8KLy8gYExpdmVTZWxlY3Rpb25gIGlzIHVzZWQgaW50ZXJuYWxseSBieSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudHNlbGVjdGlvbn5Eb2N1bWVudFNlbGVjdGlvbn0gYW5kIHNob3VsZG4ndCBiZSB1c2VkIGRpcmVjdGx5LgovLwovLyBMaXZlU2VsZWN0aW9uYCBpcyBhdXRvbWF0aWNhbGx5IHVwZGF0ZWQgdXBvbiBjaGFuZ2VzIGluIHRoZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudH5Eb2N1bWVudCBkb2N1bWVudH0KLy8gdG8gYWx3YXlzIGNvbnRhaW4gdmFsaWQgcmFuZ2VzLiBJdHMgYXR0cmlidXRlcyBhcmUgaW5oZXJpdGVkIGZyb20gdGhlIHRleHQgdW5sZXNzIHNldCBleHBsaWNpdGx5LgovLwovLyBEaWZmZXJlbmNlcyBiZXR3ZWVuIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3NlbGVjdGlvbn5TZWxlY3Rpb259IGFuZCBgTGl2ZVNlbGVjdGlvbmAgYXJlOgovLyAqIHRoZXJlIGlzIGFsd2F5cyBhIHJhbmdlIGluIGBMaXZlU2VsZWN0aW9uYCAtIGV2ZW4gaWYgbm8gcmFuZ2VzIHdlcmUgYWRkZWQgdGhlcmUgaXMgYSAiZGVmYXVsdCByYW5nZSIKLy8gcHJlc2VudCBpbiB0aGUgc2VsZWN0aW9uLAovLyAqIHJhbmdlcyBhZGRlZCB0byB0aGlzIHNlbGVjdGlvbiB1cGRhdGVzIGF1dG9tYXRpY2FsbHkgd2hlbiB0aGUgZG9jdW1lbnQgY2hhbmdlcywKLy8gKiBhdHRyaWJ1dGVzIG9mIGBMaXZlU2VsZWN0aW9uYCBhcmUgdXBkYXRlZCBhdXRvbWF0aWNhbGx5IGFjY29yZGluZyB0byBzZWxlY3Rpb24gcmFuZ2VzLgovLwovLyBAZXh0ZW5kcyBtb2R1bGU6ZW5naW5lL21vZGVsL3NlbGVjdGlvbn5TZWxlY3Rpb24KLy8KCmNsYXNzIExpdmVTZWxlY3Rpb24gZXh0ZW5kcyBTZWxlY3Rpb24gewogIC8vIENyZWF0ZXMgYW4gZW1wdHkgbGl2ZSBzZWxlY3Rpb24gZm9yIGdpdmVuIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2RvY3VtZW50fkRvY3VtZW50fS4KICAvLyBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvZG9jdW1lbnR+RG9jdW1lbnR9IGRvYyBEb2N1bWVudCB3aGljaCBvd25zIHRoaXMgc2VsZWN0aW9uLgogIGNvbnN0cnVjdG9yKGRvYykgewogICAgc3VwZXIoKTsgLy8gTGlzdCBvZiBzZWxlY3Rpb24gbWFya2Vycy4KICAgIC8vIE1hcmtlciBpcyBhIHNlbGVjdGlvbiBtYXJrZXIgd2hlbiBzZWxlY3Rpb24gcmFuZ2UgaXMgaW5zaWRlIHRoZSBtYXJrZXIgcmFuZ2UuCiAgICAvLwogICAgLy8gQHR5cGUge21vZHVsZTp1dGlscy9jb2xsZWN0aW9ufkNvbGxlY3Rpb259CgogICAgdGhpcy5tYXJrZXJzID0gbmV3IENvbGxlY3Rpb24oewogICAgICBpZFByb3BlcnR5OiAnbmFtZScKICAgIH0pOyAvLyBEb2N1bWVudCB3aGljaCBvd25zIHRoaXMgc2VsZWN0aW9uLgogICAgLy8KICAgIC8vIEBwcm90ZWN0ZWQKICAgIC8vIEBtZW1iZXIge21vZHVsZTplbmdpbmUvbW9kZWwvbW9kZWx+TW9kZWx9CgogICAgdGhpcy5fbW9kZWwgPSBkb2MubW9kZWw7IC8vIERvY3VtZW50IHdoaWNoIG93bnMgdGhpcyBzZWxlY3Rpb24uCiAgICAvLwogICAgLy8gQHByb3RlY3RlZAogICAgLy8gQG1lbWJlciB7bW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudH5Eb2N1bWVudH0KCiAgICB0aGlzLl9kb2N1bWVudCA9IGRvYzsgLy8gS2VlcHMgbWFwcGluZyBvZiBhdHRyaWJ1dGUgbmFtZSB0byBwcmlvcml0eSB3aXRoIHdoaWNoIHRoZSBhdHRyaWJ1dGUgZ290IG1vZGlmaWVkIChhZGRlZC9jaGFuZ2VkL3JlbW92ZWQpCiAgICAvLyBsYXN0IHRpbWUuIFBvc3NpYmxlIHZhbHVlcyBvZiBwcmlvcml0eSBhcmU6IGAnbG93J2AgYW5kIGAnbm9ybWFsJ2AuCiAgICAvLwogICAgLy8gUHJpb3JpdGllcyBhcmUgdXNlZCBieSBpbnRlcm5hbCBgTGl2ZVNlbGVjdGlvbmAgbWVjaGFuaXNtcy4gQWxsIGF0dHJpYnV0ZXMgc2V0IHVzaW5nIGBMaXZlU2VsZWN0aW9uYAogICAgLy8gYXR0cmlidXRlcyBBUEkgYXJlIHNldCB3aXRoIGAnbm9ybWFsJ2AgcHJpb3JpdHkuCiAgICAvLwogICAgLy8gQHByaXZhdGUKICAgIC8vIEBtZW1iZXIge01hcH0gbW9kdWxlOmVuZ2luZS9tb2RlbC9saXZlc2VsZWN0aW9ufkxpdmVTZWxlY3Rpb24jX2F0dHJpYnV0ZVByaW9yaXR5CgogICAgdGhpcy5fYXR0cmlidXRlUHJpb3JpdHkgPSBuZXcgTWFwKCk7IC8vIENvbnRhaW5zIGRhdGEgcmVxdWlyZWQgdG8gZml4IHJhbmdlcyB3aGljaCBoYXZlIGJlZW4gbW92ZWQgdG8gdGhlIGdyYXZleWFyZC4KICAgIC8vIEBwcml2YXRlCiAgICAvLyBAbWVtYmVyIHtBcnJheX0gbW9kdWxlOmVuZ2luZS9tb2RlbC9saXZlc2VsZWN0aW9ufkxpdmVTZWxlY3Rpb24jX2ZpeEdyYXZleWFyZFJhbmdlc0RhdGEKCiAgICB0aGlzLl9maXhHcmF2ZXlhcmRSYW5nZXNEYXRhID0gW107IC8vIEZsYWcgdGhhdCBpbmZvcm1zIHdoZXRoZXIgdGhlIHNlbGVjdGlvbiByYW5nZXMgaGF2ZSBjaGFuZ2VkLiBJdCBpcyBjaGFuZ2VkIG9uIHRydWUgd2hlbiBgTGl2ZVJhbmdlI2NoYW5nZTpyYW5nZWAgZXZlbnQgaXMgZmlyZWQuCiAgICAvLyBAcHJpdmF0ZQogICAgLy8gQG1lbWJlciB7QXJyYXl9IG1vZHVsZTplbmdpbmUvbW9kZWwvbGl2ZXNlbGVjdGlvbn5MaXZlU2VsZWN0aW9uI19oYXNDaGFuZ2VkUmFuZ2UKCiAgICB0aGlzLl9oYXNDaGFuZ2VkUmFuZ2UgPSBmYWxzZTsgLy8gRWFjaCBvdmVycmlkaW5nIGdyYXZpdHkgYWRkcyBhbiBVSUQgdG8gdGhlIHNldCBhbmQgZWFjaCByZW1vdmFsIHJlbW92ZXMgaXQuCiAgICAvLyBHcmF2aXR5IGlzIG92ZXJyaWRkZW4gd2hlbiB0aGVyZSdzIGF0IGxlYXN0IG9uZSBVSUQgaW4gdGhlIHNldC4KICAgIC8vIEdyYXZpdHkgaXMgcmVzdG9yZWQgd2hlbiB0aGUgc2V0IGlzIGVtcHR5LgogICAgLy8gVGhpcyBpcyB0byBwcmV2ZW50IGNvbmZsaWN0cyB3aGVuIGdyYXZpdHkgaXMgb3ZlcnJpZGRlbiBieSBtb3JlIHRoYW4gb25lIGZlYXR1cmUgYXQgdGhlIHNhbWUgdGltZS4KICAgIC8vIEBwcml2YXRlCiAgICAvLyBAdHlwZSB7U2V0fQoKICAgIHRoaXMuX292ZXJyaWRkZW5HcmF2aXR5UmVnaXN0ZXIgPSBuZXcgU2V0KCk7IC8vIEVuc3VyZSBzZWxlY3Rpb24gaXMgY29ycmVjdCBhZnRlciBlYWNoIG9wZXJhdGlvbi4KCiAgICB0aGlzLmxpc3RlblRvKHRoaXMuX21vZGVsLCAnYXBwbHlPcGVyYXRpb24nLCAoZXZ0LCBhcmdzKSA9PiB7CiAgICAgIGNvbnN0IG9wZXJhdGlvbiA9IGFyZ3NbMF07CgogICAgICBpZiAoIW9wZXJhdGlvbi5pc0RvY3VtZW50T3BlcmF0aW9uIHx8IG9wZXJhdGlvbi50eXBlID09ICdtYXJrZXInIHx8IG9wZXJhdGlvbi50eXBlID09ICdyZW5hbWUnIHx8IG9wZXJhdGlvbi50eXBlID09ICdub29wJykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgd2hpbGUgKHRoaXMuX2ZpeEdyYXZleWFyZFJhbmdlc0RhdGEubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgewogICAgICAgICAgbGl2ZVJhbmdlLAogICAgICAgICAgc291cmNlUG9zaXRpb24KICAgICAgICB9ID0gdGhpcy5fZml4R3JhdmV5YXJkUmFuZ2VzRGF0YS5zaGlmdCgpOwoKICAgICAgICB0aGlzLl9maXhHcmF2ZXlhcmRTZWxlY3Rpb24obGl2ZVJhbmdlLCBzb3VyY2VQb3NpdGlvbik7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9oYXNDaGFuZ2VkUmFuZ2UpIHsKICAgICAgICB0aGlzLl9oYXNDaGFuZ2VkUmFuZ2UgPSBmYWxzZTsKICAgICAgICB0aGlzLmZpcmUoJ2NoYW5nZTpyYW5nZScsIHsKICAgICAgICAgIGRpcmVjdENoYW5nZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgfQogICAgfSwgewogICAgICBwcmlvcml0eTogJ2xvd2VzdCcKICAgIH0pOyAvLyBFbnN1cmUgc2VsZWN0aW9uIGlzIGNvcnJlY3QgYW5kIHVwIHRvIGRhdGUgYWZ0ZXIgZWFjaCByYW5nZSBjaGFuZ2UuCgogICAgdGhpcy5vbignY2hhbmdlOnJhbmdlJywgKCkgPT4gewogICAgICBmb3IgKGNvbnN0IHJhbmdlIG9mIHRoaXMuZ2V0UmFuZ2VzKCkpIHsKICAgICAgICBpZiAoIXRoaXMuX2RvY3VtZW50Ll92YWxpZGF0ZVNlbGVjdGlvblJhbmdlKHJhbmdlKSkgewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBSYW5nZSBmcm9tIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2RvY3VtZW50c2VsZWN0aW9ufkRvY3VtZW50U2VsZWN0aW9uIGRvY3VtZW50IHNlbGVjdGlvbn0KICAgICAgICAgICAqIHN0YXJ0cyBvciBlbmRzIGF0IGluY29ycmVjdCBwb3NpdGlvbi4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZXJyb3IgZG9jdW1lbnQtc2VsZWN0aW9uLXdyb25nLXBvc2l0aW9uCiAgICAgICAgICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvcmFuZ2V+UmFuZ2V9IHJhbmdlCiAgICAgICAgICAgKi8KICAgICAgICAgIHRocm93IG5ldyBDS0VkaXRvckVycm9yKCdkb2N1bWVudC1zZWxlY3Rpb24td3JvbmctcG9zaXRpb246IFJhbmdlIGZyb20gZG9jdW1lbnQgc2VsZWN0aW9uIHN0YXJ0cyBvciBlbmRzIGF0IGluY29ycmVjdCBwb3NpdGlvbi4nLCB0aGlzLCB7CiAgICAgICAgICAgIHJhbmdlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOyAvLyBVcGRhdGUgbWFya2VycyBkYXRhIHN0b3JlZCBieSB0aGUgc2VsZWN0aW9uIGFmdGVyIGVhY2ggbWFya2VyIGNoYW5nZS4KCiAgICB0aGlzLmxpc3RlblRvKHRoaXMuX21vZGVsLm1hcmtlcnMsICd1cGRhdGUnLCAoKSA9PiB0aGlzLl91cGRhdGVNYXJrZXJzKCkpOyAvLyBFbnN1cmUgc2VsZWN0aW9uIGlzIHVwIHRvIGRhdGUgYWZ0ZXIgZWFjaCBjaGFuZ2UgYmxvY2suCgogICAgdGhpcy5saXN0ZW5Ubyh0aGlzLl9kb2N1bWVudCwgJ2NoYW5nZScsIChldnQsIGJhdGNoKSA9PiB7CiAgICAgIGNsZWFyQXR0cmlidXRlc1N0b3JlZEluRWxlbWVudCh0aGlzLl9tb2RlbCwgYmF0Y2gpOwogICAgfSk7CiAgfQoKICBnZXQgaXNDb2xsYXBzZWQoKSB7CiAgICBjb25zdCBsZW5ndGggPSB0aGlzLl9yYW5nZXMubGVuZ3RoOwogICAgcmV0dXJuIGxlbmd0aCA9PT0gMCA/IHRoaXMuX2RvY3VtZW50Ll9nZXREZWZhdWx0UmFuZ2UoKS5pc0NvbGxhcHNlZCA6IHN1cGVyLmlzQ29sbGFwc2VkOwogIH0KCiAgZ2V0IGFuY2hvcigpIHsKICAgIHJldHVybiBzdXBlci5hbmNob3IgfHwgdGhpcy5fZG9jdW1lbnQuX2dldERlZmF1bHRSYW5nZSgpLnN0YXJ0OwogIH0KCiAgZ2V0IGZvY3VzKCkgewogICAgcmV0dXJuIHN1cGVyLmZvY3VzIHx8IHRoaXMuX2RvY3VtZW50Ll9nZXREZWZhdWx0UmFuZ2UoKS5lbmQ7CiAgfQoKICBnZXQgcmFuZ2VDb3VudCgpIHsKICAgIHJldHVybiB0aGlzLl9yYW5nZXMubGVuZ3RoID8gdGhpcy5fcmFuZ2VzLmxlbmd0aCA6IDE7CiAgfSAvLyBEZXNjcmliZXMgd2hldGhlciBgTGl2ZVNlbGVjdGlvbmAgaGFzIG93biByYW5nZShzKSBzZXQsIG9yIGlmIGl0IGlzIGRlZmF1bHRlZCB0bwogIC8vIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2RvY3VtZW50fkRvY3VtZW50I19nZXREZWZhdWx0UmFuZ2UgZG9jdW1lbnQncyBkZWZhdWx0IHJhbmdlfS4KICAvLwogIC8vIEByZWFkb25seQogIC8vIEB0eXBlIHtCb29sZWFufQoKCiAgZ2V0IGhhc093blJhbmdlKCkgewogICAgcmV0dXJuIHRoaXMuX3Jhbmdlcy5sZW5ndGggPiAwOwogIH0gLy8gV2hlbiBzZXQgdG8gYHRydWVgIHRoZW4gc2VsZWN0aW9uIGF0dHJpYnV0ZXMgb24gbm9kZSBiZWZvcmUgdGhlIGNhcmV0IHdvbid0IGJlIHRha2VuCiAgLy8gaW50byBjb25zaWRlcmF0aW9uIHdoaWxlIHVwZGF0aW5nIHNlbGVjdGlvbiBhdHRyaWJ1dGVzLgogIC8vCiAgLy8gQHByb3RlY3RlZAogIC8vIEB0eXBlIHtCb29sZWFufQoKCiAgZ2V0IGlzR3Jhdml0eU92ZXJyaWRkZW4oKSB7CiAgICByZXR1cm4gISF0aGlzLl9vdmVycmlkZGVuR3Jhdml0eVJlZ2lzdGVyLnNpemU7CiAgfSAvLyBVbmJpbmRzIGFsbCBldmVudHMgcHJldmlvdXNseSBib3VuZCBieSBsaXZlIHNlbGVjdGlvbi4KCgogIGRlc3Ryb3koKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3Jhbmdlcy5sZW5ndGg7IGkrKykgewogICAgICB0aGlzLl9yYW5nZXNbaV0uZGV0YWNoKCk7CiAgICB9CgogICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgfQoKICAqZ2V0UmFuZ2VzKCkgewogICAgaWYgKHRoaXMuX3Jhbmdlcy5sZW5ndGgpIHsKICAgICAgeWllbGQqIHN1cGVyLmdldFJhbmdlcygpOwogICAgfSBlbHNlIHsKICAgICAgeWllbGQgdGhpcy5fZG9jdW1lbnQuX2dldERlZmF1bHRSYW5nZSgpOwogICAgfQogIH0KCiAgZ2V0Rmlyc3RSYW5nZSgpIHsKICAgIHJldHVybiBzdXBlci5nZXRGaXJzdFJhbmdlKCkgfHwgdGhpcy5fZG9jdW1lbnQuX2dldERlZmF1bHRSYW5nZSgpOwogIH0KCiAgZ2V0TGFzdFJhbmdlKCkgewogICAgcmV0dXJuIHN1cGVyLmdldExhc3RSYW5nZSgpIHx8IHRoaXMuX2RvY3VtZW50Ll9nZXREZWZhdWx0UmFuZ2UoKTsKICB9CgogIHNldFRvKHNlbGVjdGFibGUsIG9wdGlvbnNPclBsYWNlT3JPZmZzZXQsIG9wdGlvbnMpIHsKICAgIHN1cGVyLnNldFRvKHNlbGVjdGFibGUsIG9wdGlvbnNPclBsYWNlT3JPZmZzZXQsIG9wdGlvbnMpOwoKICAgIHRoaXMuX3VwZGF0ZUF0dHJpYnV0ZXModHJ1ZSk7CiAgfQoKICBzZXRGb2N1cyhpdGVtT3JQb3NpdGlvbiwgb2Zmc2V0KSB7CiAgICBzdXBlci5zZXRGb2N1cyhpdGVtT3JQb3NpdGlvbiwgb2Zmc2V0KTsKCiAgICB0aGlzLl91cGRhdGVBdHRyaWJ1dGVzKHRydWUpOwogIH0KCiAgc2V0QXR0cmlidXRlKGtleSwgdmFsdWUpIHsKICAgIGlmICh0aGlzLl9zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSkpIHsKICAgICAgLy8gRmlyZSBldmVudCB3aXRoIGV4YWN0IGRhdGEuCiAgICAgIGNvbnN0IGF0dHJpYnV0ZUtleXMgPSBba2V5XTsKICAgICAgdGhpcy5maXJlKCdjaGFuZ2U6YXR0cmlidXRlJywgewogICAgICAgIGF0dHJpYnV0ZUtleXMsCiAgICAgICAgZGlyZWN0Q2hhbmdlOiB0cnVlCiAgICAgIH0pOwogICAgfQogIH0KCiAgcmVtb3ZlQXR0cmlidXRlKGtleSkgewogICAgaWYgKHRoaXMuX3JlbW92ZUF0dHJpYnV0ZShrZXkpKSB7CiAgICAgIC8vIEZpcmUgZXZlbnQgd2l0aCBleGFjdCBkYXRhLgogICAgICBjb25zdCBhdHRyaWJ1dGVLZXlzID0gW2tleV07CiAgICAgIHRoaXMuZmlyZSgnY2hhbmdlOmF0dHJpYnV0ZScsIHsKICAgICAgICBhdHRyaWJ1dGVLZXlzLAogICAgICAgIGRpcmVjdENoYW5nZTogdHJ1ZQogICAgICB9KTsKICAgIH0KICB9CgogIG92ZXJyaWRlR3Jhdml0eSgpIHsKICAgIGNvbnN0IG92ZXJyaWRlVWlkID0gdWlkKCk7IC8vIFJlbWVtYmVyIHRoYXQgYW5vdGhlciBvdmVycmlkaW5nIGhhcyBiZWVuIHJlcXVlc3RlZC4gSXQgd2lsbCBuZWVkIHRvIGJlIHJlbW92ZWQKICAgIC8vIGJlZm9yZSB0aGUgZ3Jhdml0eSBpcyB0byBiZSByZXN0b3JlZC4KCiAgICB0aGlzLl9vdmVycmlkZGVuR3Jhdml0eVJlZ2lzdGVyLmFkZChvdmVycmlkZVVpZCk7CgogICAgaWYgKHRoaXMuX292ZXJyaWRkZW5HcmF2aXR5UmVnaXN0ZXIuc2l6ZSA9PT0gMSkgewogICAgICB0aGlzLl91cGRhdGVBdHRyaWJ1dGVzKHRydWUpOwogICAgfQoKICAgIHJldHVybiBvdmVycmlkZVVpZDsKICB9CgogIHJlc3RvcmVHcmF2aXR5KHVpZCkgewogICAgaWYgKCF0aGlzLl9vdmVycmlkZGVuR3Jhdml0eVJlZ2lzdGVyLmhhcyh1aWQpKSB7CiAgICAgIC8qKgogICAgICAgKiBSZXN0b3JpbmcgZ3Jhdml0eSBmb3IgYW4gdW5rbm93biBVSUQgaXMgbm90IHBvc3NpYmxlLiBNYWtlIHN1cmUgeW91IGFyZSB1c2luZyBhIGNvcnJlY3QKICAgICAgICogVUlEIG9idGFpbmVkIGZyb20gdGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3dyaXRlcn5Xcml0ZXIjb3ZlcnJpZGVTZWxlY3Rpb25HcmF2aXR5fSB0byByZXN0b3JlLgogICAgICAgKgogICAgICAgKiBAZXJyb3IgZG9jdW1lbnQtc2VsZWN0aW9uLWdyYXZpdHktd3JvbmctcmVzdG9yZQogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdWlkIFRoZSB1bmlxdWUgaWRlbnRpZmllciByZXR1cm5lZCBieQogICAgICAgKiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudHNlbGVjdGlvbn5Eb2N1bWVudFNlbGVjdGlvbiNfb3ZlcnJpZGVHcmF2aXR5fS4KICAgICAgICovCiAgICAgIHRocm93IG5ldyBDS0VkaXRvckVycm9yKCdkb2N1bWVudC1zZWxlY3Rpb24tZ3Jhdml0eS13cm9uZy1yZXN0b3JlOiBBdHRlbXB0aW5nIHRvIHJlc3RvcmUgdGhlIHNlbGVjdGlvbiBncmF2aXR5IGZvciBhbiB1bmtub3duIFVJRC4nLCB0aGlzLCB7CiAgICAgICAgdWlkCiAgICAgIH0pOwogICAgfQoKICAgIHRoaXMuX292ZXJyaWRkZW5HcmF2aXR5UmVnaXN0ZXIuZGVsZXRlKHVpZCk7IC8vIFJlc3RvcmUgZ3Jhdml0eSBvbmx5IHdoZW4gYWxsIG92ZXJyaWRpbmcgaGF2ZSBiZWVuIHJlc3RvcmVkLgoKCiAgICBpZiAoIXRoaXMuaXNHcmF2aXR5T3ZlcnJpZGRlbikgewogICAgICB0aGlzLl91cGRhdGVBdHRyaWJ1dGVzKHRydWUpOwogICAgfQogIH0KCiAgX3BvcFJhbmdlKCkgewogICAgdGhpcy5fcmFuZ2VzLnBvcCgpLmRldGFjaCgpOwogIH0KCiAgX3B1c2hSYW5nZShyYW5nZSkgewogICAgY29uc3QgbGl2ZVJhbmdlID0gdGhpcy5fcHJlcGFyZVJhbmdlKHJhbmdlKTsgLy8gYHVuZGVmaW5lZGAgaXMgcmV0dXJuZWQgd2hlbiBnaXZlbiBgcmFuZ2VgIGlzIGluIGdyYXZleWFyZCByb290LgoKCiAgICBpZiAobGl2ZVJhbmdlKSB7CiAgICAgIHRoaXMuX3Jhbmdlcy5wdXNoKGxpdmVSYW5nZSk7CiAgICB9CiAgfSAvLyBQcmVwYXJlcyBnaXZlbiByYW5nZSB0byBiZSBhZGRlZCB0byBzZWxlY3Rpb24uIENoZWNrcyBpZiBpdCBpcyBjb3JyZWN0LAogIC8vIGNvbnZlcnRzIGl0IHRvIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2xpdmVyYW5nZX5MaXZlUmFuZ2UgTGl2ZVJhbmdlfQogIC8vIGFuZCBzZXRzIGxpc3RlbmVycyBsaXN0ZW5pbmcgdG8gdGhlIHJhbmdlJ3MgY2hhbmdlIGV2ZW50LgogIC8vCiAgLy8gQHByaXZhdGUKICAvLyBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvcmFuZ2V+UmFuZ2V9IHJhbmdlCgoKICBfcHJlcGFyZVJhbmdlKHJhbmdlKSB7CiAgICB0aGlzLl9jaGVja1JhbmdlKHJhbmdlKTsKCiAgICBpZiAocmFuZ2Uucm9vdCA9PSB0aGlzLl9kb2N1bWVudC5ncmF2ZXlhcmQpIHsKICAgICAgLy8gQGlmIENLX0RFQlVHIC8vIGNvbnNvbGUud2FybiggJ1RyeWluZyB0byBhZGQgYSBSYW5nZSB0aGF0IGlzIGluIHRoZSBncmF2ZXlhcmQgcm9vdC4gUmFuZ2UgcmVqZWN0ZWQuJyApOwogICAgICByZXR1cm47CiAgICB9CgogICAgY29uc3QgbGl2ZVJhbmdlID0gTGl2ZVJhbmdlLmZyb21SYW5nZShyYW5nZSk7CiAgICBsaXZlUmFuZ2Uub24oJ2NoYW5nZTpyYW5nZScsIChldnQsIG9sZFJhbmdlLCBkYXRhKSA9PiB7CiAgICAgIHRoaXMuX2hhc0NoYW5nZWRSYW5nZSA9IHRydWU7IC8vIElmIGBMaXZlUmFuZ2VgIGlzIGluIHdob2xlIG1vdmVkIHRvIHRoZSBncmF2ZXlhcmQsIHNhdmUgbmVjZXNzYXJ5IGRhdGEuIEl0IHdpbGwgYmUgZml4ZWQgb24gYE1vZGVsI2FwcGx5T3BlcmF0aW9uYCBldmVudC4KCiAgICAgIGlmIChsaXZlUmFuZ2Uucm9vdCA9PSB0aGlzLl9kb2N1bWVudC5ncmF2ZXlhcmQpIHsKICAgICAgICB0aGlzLl9maXhHcmF2ZXlhcmRSYW5nZXNEYXRhLnB1c2goewogICAgICAgICAgbGl2ZVJhbmdlLAogICAgICAgICAgc291cmNlUG9zaXRpb246IGRhdGEuZGVsZXRpb25Qb3NpdGlvbgogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBsaXZlUmFuZ2U7CiAgfQoKICBfdXBkYXRlTWFya2VycygpIHsKICAgIGNvbnN0IG1hcmtlcnMgPSBbXTsKCiAgICBmb3IgKGNvbnN0IG1hcmtlciBvZiB0aGlzLl9tb2RlbC5tYXJrZXJzKSB7CiAgICAgIGNvbnN0IG1hcmtlclJhbmdlID0gbWFya2VyLmdldFJhbmdlKCk7CgogICAgICBmb3IgKGNvbnN0IHNlbGVjdGlvblJhbmdlIG9mIHRoaXMuZ2V0UmFuZ2VzKCkpIHsKICAgICAgICBpZiAobWFya2VyUmFuZ2UuY29udGFpbnNSYW5nZShzZWxlY3Rpb25SYW5nZSwgIXNlbGVjdGlvblJhbmdlLmlzQ29sbGFwc2VkKSkgewogICAgICAgICAgbWFya2Vycy5wdXNoKG1hcmtlcik7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZm9yIChjb25zdCBtYXJrZXIgb2YgbWFya2VycykgewogICAgICBpZiAoIXRoaXMubWFya2Vycy5oYXMobWFya2VyKSkgewogICAgICAgIHRoaXMubWFya2Vycy5hZGQobWFya2VyKTsKICAgICAgfQogICAgfQoKICAgIGZvciAoY29uc3QgbWFya2VyIG9mIEFycmF5LmZyb20odGhpcy5tYXJrZXJzKSkgewogICAgICBpZiAoIW1hcmtlcnMuaW5jbHVkZXMobWFya2VyKSkgewogICAgICAgIHRoaXMubWFya2Vycy5yZW1vdmUobWFya2VyKTsKICAgICAgfQogICAgfQogIH0gLy8gVXBkYXRlcyB0aGlzIHNlbGVjdGlvbiBhdHRyaWJ1dGVzIGFjY29yZGluZyB0byBpdHMgcmFuZ2VzIGFuZCB0aGUge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZG9jdW1lbnR+RG9jdW1lbnQgbW9kZWwgZG9jdW1lbnR9LgogIC8vCiAgLy8gQHByb3RlY3RlZAogIC8vIEBwYXJhbSB7Qm9vbGVhbn0gY2xlYXJBbGwKICAvLyBAZmlyZXMgY2hhbmdlOmF0dHJpYnV0ZQoKCiAgX3VwZGF0ZUF0dHJpYnV0ZXMoY2xlYXJBbGwpIHsKICAgIGNvbnN0IG5ld0F0dHJpYnV0ZXMgPSB0b01hcCh0aGlzLl9nZXRTdXJyb3VuZGluZ0F0dHJpYnV0ZXMoKSk7CiAgICBjb25zdCBvbGRBdHRyaWJ1dGVzID0gdG9NYXAodGhpcy5nZXRBdHRyaWJ1dGVzKCkpOwoKICAgIGlmIChjbGVhckFsbCkgewogICAgICAvLyBJZiBgY2xlYXJBbGxgIHJlbW92ZSBhbGwgYXR0cmlidXRlcyBhbmQgcmVzZXQgcHJpb3JpdGllcy4KICAgICAgdGhpcy5fYXR0cmlidXRlUHJpb3JpdHkgPSBuZXcgTWFwKCk7CiAgICAgIHRoaXMuX2F0dHJzID0gbmV3IE1hcCgpOwogICAgfSBlbHNlIHsKICAgICAgLy8gSWYgbm90LCByZW1vdmUgb25seSBhdHRyaWJ1dGVzIGFkZGVkIHdpdGggYGxvd2AgcHJpb3JpdHkuCiAgICAgIGZvciAoY29uc3QgW2tleSwgcHJpb3JpdHldIG9mIHRoaXMuX2F0dHJpYnV0ZVByaW9yaXR5KSB7CiAgICAgICAgaWYgKHByaW9yaXR5ID09ICdsb3cnKSB7CiAgICAgICAgICB0aGlzLl9hdHRycy5kZWxldGUoa2V5KTsKCiAgICAgICAgICB0aGlzLl9hdHRyaWJ1dGVQcmlvcml0eS5kZWxldGUoa2V5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9zZXRBdHRyaWJ1dGVzVG8obmV3QXR0cmlidXRlcyk7IC8vIExldCdzIGV2YWx1YXRlIHdoaWNoIGF0dHJpYnV0ZXMgcmVhbGx5IGNoYW5nZWQuCgoKICAgIGNvbnN0IGNoYW5nZWQgPSBbXTsgLy8gRmlyc3QsIGxvb3AgdGhyb3VnaCBhbGwgYXR0cmlidXRlcyB0aGF0IGFyZSBzZXQgb24gc2VsZWN0aW9uIHJpZ2h0IG5vdy4KICAgIC8vIENoZWNrIHdoaWNoIG9mIHRoZW0gYXJlIGRpZmZlcmVudCB0aGFuIG9sZCBhdHRyaWJ1dGVzLgoKICAgIGZvciAoY29uc3QgW25ld0tleSwgbmV3VmFsdWVdIG9mIHRoaXMuZ2V0QXR0cmlidXRlcygpKSB7CiAgICAgIGlmICghb2xkQXR0cmlidXRlcy5oYXMobmV3S2V5KSB8fCBvbGRBdHRyaWJ1dGVzLmdldChuZXdLZXkpICE9PSBuZXdWYWx1ZSkgewogICAgICAgIGNoYW5nZWQucHVzaChuZXdLZXkpOwogICAgICB9CiAgICB9IC8vIFRoZW4sIGNoZWNrIHdoaWNoIG9mIG9sZCBhdHRyaWJ1dGVzIGdvdCByZW1vdmVkLgoKCiAgICBmb3IgKGNvbnN0IFtvbGRLZXldIG9mIG9sZEF0dHJpYnV0ZXMpIHsKICAgICAgaWYgKCF0aGlzLmhhc0F0dHJpYnV0ZShvbGRLZXkpKSB7CiAgICAgICAgY2hhbmdlZC5wdXNoKG9sZEtleSk7CiAgICAgIH0KICAgIH0gLy8gRmlyZSBldmVudCB3aXRoIGV4YWN0IGRhdGEgKGZpcmUgb25seSBpZiBhbnl0aGluZyBjaGFuZ2VkKS4KCgogICAgaWYgKGNoYW5nZWQubGVuZ3RoID4gMCkgewogICAgICB0aGlzLmZpcmUoJ2NoYW5nZTphdHRyaWJ1dGUnLCB7CiAgICAgICAgYXR0cmlidXRlS2V5czogY2hhbmdlZCwKICAgICAgICBkaXJlY3RDaGFuZ2U6IGZhbHNlCiAgICAgIH0pOwogICAgfQogIH0gLy8gSW50ZXJuYWwgbWV0aG9kIGZvciBzZXR0aW5nIGBMaXZlU2VsZWN0aW9uYCBhdHRyaWJ1dGUuIFN1cHBvcnRzIGF0dHJpYnV0ZSBwcmlvcml0aWVzICh0aHJvdWdoIGBkaXJlY3RDaGFuZ2VgCiAgLy8gcGFyYW1ldGVyKS4KICAvLwogIC8vIEBwcml2YXRlCiAgLy8gQHBhcmFtIHtTdHJpbmd9IGtleSBBdHRyaWJ1dGUga2V5LgogIC8vIEBwYXJhbSB7Kn0gdmFsdWUgQXR0cmlidXRlIHZhbHVlLgogIC8vIEBwYXJhbSB7Qm9vbGVhbn0gW2RpcmVjdENoYW5nZT10cnVlXSBgdHJ1ZWAgaWYgdGhlIGNoYW5nZSBpcyBjYXVzZWQgYnkgYFNlbGVjdGlvbmAgQVBJLCBgZmFsc2VgIGlmIGNoYW5nZQogIC8vIGlzIGNhdXNlZCBieSBgQmF0Y2hgIEFQSS4KICAvLyBAcmV0dXJucyB7Qm9vbGVhbn0gV2hldGhlciB2YWx1ZSBoYXMgY2hhbmdlZC4KCgogIF9zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSwgZGlyZWN0Q2hhbmdlID0gdHJ1ZSkgewogICAgY29uc3QgcHJpb3JpdHkgPSBkaXJlY3RDaGFuZ2UgPyAnbm9ybWFsJyA6ICdsb3cnOwoKICAgIGlmIChwcmlvcml0eSA9PSAnbG93JyAmJiB0aGlzLl9hdHRyaWJ1dGVQcmlvcml0eS5nZXQoa2V5KSA9PSAnbm9ybWFsJykgewogICAgICAvLyBQcmlvcml0eSB0b28gbG93LgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgY29uc3Qgb2xkVmFsdWUgPSBzdXBlci5nZXRBdHRyaWJ1dGUoa2V5KTsgLy8gRG9uJ3QgZG8gYW55dGhpbmcgaWYgdmFsdWUgaGFzIG5vdCBjaGFuZ2VkLgoKICAgIGlmIChvbGRWYWx1ZSA9PT0gdmFsdWUpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHRoaXMuX2F0dHJzLnNldChrZXksIHZhbHVlKTsgLy8gVXBkYXRlIHByaW9yaXRpZXMgbWFwLgoKCiAgICB0aGlzLl9hdHRyaWJ1dGVQcmlvcml0eS5zZXQoa2V5LCBwcmlvcml0eSk7CgogICAgcmV0dXJuIHRydWU7CiAgfSAvLyBJbnRlcm5hbCBtZXRob2QgZm9yIHJlbW92aW5nIGBMaXZlU2VsZWN0aW9uYCBhdHRyaWJ1dGUuIFN1cHBvcnRzIGF0dHJpYnV0ZSBwcmlvcml0aWVzICh0aHJvdWdoIGBkaXJlY3RDaGFuZ2VgCiAgLy8gcGFyYW1ldGVyKS4KICAvLwogIC8vIE5PVEU6IEV2ZW4gaWYgYXR0cmlidXRlIGlzIG5vdCBwcmVzZW50IGluIHRoZSBzZWxlY3Rpb24gYnV0IGlzIHByb3ZpZGVkIHRvIHRoaXMgbWV0aG9kLCBpdCdzIHByaW9yaXR5IHdpbGwKICAvLyBiZSBjaGFuZ2VkIGFjY29yZGluZyB0byBgZGlyZWN0Q2hhbmdlYCBwYXJhbWV0ZXIuCiAgLy8KICAvLyBAcHJpdmF0ZQogIC8vIEBwYXJhbSB7U3RyaW5nfSBrZXkgQXR0cmlidXRlIGtleS4KICAvLyBAcGFyYW0ge0Jvb2xlYW59IFtkaXJlY3RDaGFuZ2U9dHJ1ZV0gYHRydWVgIGlmIHRoZSBjaGFuZ2UgaXMgY2F1c2VkIGJ5IGBTZWxlY3Rpb25gIEFQSSwgYGZhbHNlYCBpZiBjaGFuZ2UKICAvLyBpcyBjYXVzZWQgYnkgYEJhdGNoYCBBUEkuCiAgLy8gQHJldHVybnMge0Jvb2xlYW59IFdoZXRoZXIgYXR0cmlidXRlIHdhcyByZW1vdmVkLiBNYXkgbm90IGJlIHRydWUgaWYgc3VjaCBhdHRyaWJ1dGVzIGRpZG4ndCBleGlzdCBvciB0aGUKICAvLyBleGlzdGluZyBhdHRyaWJ1dGUgaGFkIGhpZ2hlciBwcmlvcml0eS4KCgogIF9yZW1vdmVBdHRyaWJ1dGUoa2V5LCBkaXJlY3RDaGFuZ2UgPSB0cnVlKSB7CiAgICBjb25zdCBwcmlvcml0eSA9IGRpcmVjdENoYW5nZSA/ICdub3JtYWwnIDogJ2xvdyc7CgogICAgaWYgKHByaW9yaXR5ID09ICdsb3cnICYmIHRoaXMuX2F0dHJpYnV0ZVByaW9yaXR5LmdldChrZXkpID09ICdub3JtYWwnKSB7CiAgICAgIC8vIFByaW9yaXR5IHRvbyBsb3cuCiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gLy8gVXBkYXRlIHByaW9yaXRpZXMgbWFwLgoKCiAgICB0aGlzLl9hdHRyaWJ1dGVQcmlvcml0eS5zZXQoa2V5LCBwcmlvcml0eSk7IC8vIERvbid0IGRvIGFueXRoaW5nIGlmIHZhbHVlIGhhcyBub3QgY2hhbmdlZC4KCgogICAgaWYgKCFzdXBlci5oYXNBdHRyaWJ1dGUoa2V5KSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgdGhpcy5fYXR0cnMuZGVsZXRlKGtleSk7CgogICAgcmV0dXJuIHRydWU7CiAgfSAvLyBJbnRlcm5hbCBtZXRob2QgZm9yIHNldHRpbmcgbXVsdGlwbGUgYExpdmVTZWxlY3Rpb25gIGF0dHJpYnV0ZXMuIFN1cHBvcnRzIGF0dHJpYnV0ZSBwcmlvcml0aWVzICh0aHJvdWdoCiAgLy8gYGRpcmVjdENoYW5nZWAgcGFyYW1ldGVyKS4KICAvLwogIC8vIEBwcml2YXRlCiAgLy8gQHBhcmFtIHtNYXAuPFN0cmluZywqPn0gYXR0cnMgSXRlcmFibGUgb2JqZWN0IGNvbnRhaW5pbmcgYXR0cmlidXRlcyB0byBiZSBzZXQuCiAgLy8gQHJldHVybnMge1NldC48U3RyaW5nPn0gQ2hhbmdlZCBhdHRyaWJ1dGUga2V5cy4KCgogIF9zZXRBdHRyaWJ1dGVzVG8oYXR0cnMpIHsKICAgIGNvbnN0IGNoYW5nZWQgPSBuZXcgU2V0KCk7CgogICAgZm9yIChjb25zdCBbb2xkS2V5LCBvbGRWYWx1ZV0gb2YgdGhpcy5nZXRBdHRyaWJ1dGVzKCkpIHsKICAgICAgLy8gRG8gbm90IHJlbW92ZSBhdHRyaWJ1dGUgaWYgYXR0cmlidXRlIHdpdGggc2FtZSBrZXkgYW5kIHZhbHVlIGlzIGFib3V0IHRvIGJlIHNldC4KICAgICAgaWYgKGF0dHJzLmdldChvbGRLZXkpID09PSBvbGRWYWx1ZSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9IC8vIEFsbCByZXN0IGF0dHJpYnV0ZXMgd2lsbCBiZSByZW1vdmVkIHNvIGNoYW5nZWQgYXR0cmlidXRlcyB3b24ndCBjaGFuZ2UgLgoKCiAgICAgIHRoaXMuX3JlbW92ZUF0dHJpYnV0ZShvbGRLZXksIGZhbHNlKTsKICAgIH0KCiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBhdHRycykgewogICAgICAvLyBBdHRyaWJ1dGUgbWF5IG5vdCBiZSBzZXQgYmVjYXVzZSBvZiBhdHRyaWJ1dGVzIG9yIGJlY2F1c2Ugc2FtZSBrZXkvdmFsdWUgaXMgYWxyZWFkeSBhZGRlZC4KICAgICAgY29uc3QgZ290QWRkZWQgPSB0aGlzLl9zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSwgZmFsc2UpOwoKICAgICAgaWYgKGdvdEFkZGVkKSB7CiAgICAgICAgY2hhbmdlZC5hZGQoa2V5KTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBjaGFuZ2VkOwogIH0gLy8gUmV0dXJucyBhbiBpdGVyYWJsZSB0aGF0IGl0ZXJhdGVzIHRocm91Z2ggYWxsIHNlbGVjdGlvbiBhdHRyaWJ1dGVzIHN0b3JlZCBpbiBjdXJyZW50IHNlbGVjdGlvbidzIHBhcmVudC4KICAvLwogIC8vIEBwcm90ZWN0ZWQKICAvLyBAcmV0dXJucyB7SXRlcmFibGUuPCo+fQoKCiAgKl9nZXRTdG9yZWRBdHRyaWJ1dGVzKCkgewogICAgY29uc3Qgc2VsZWN0aW9uUGFyZW50ID0gdGhpcy5nZXRGaXJzdFBvc2l0aW9uKCkucGFyZW50OwoKICAgIGlmICh0aGlzLmlzQ29sbGFwc2VkICYmIHNlbGVjdGlvblBhcmVudC5pc0VtcHR5KSB7CiAgICAgIGZvciAoY29uc3Qga2V5IG9mIHNlbGVjdGlvblBhcmVudC5nZXRBdHRyaWJ1dGVLZXlzKCkpIHsKICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoc3RvcmVQcmVmaXgpKSB7CiAgICAgICAgICBjb25zdCByZWFsS2V5ID0ga2V5LnN1YnN0cihzdG9yZVByZWZpeC5sZW5ndGgpOwogICAgICAgICAgeWllbGQgW3JlYWxLZXksIHNlbGVjdGlvblBhcmVudC5nZXRBdHRyaWJ1dGUoa2V5KV07CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSAvLyBDaGVja3MgbW9kZWwgdGV4dCBub2RlcyB0aGF0IGFyZSBjbG9zZXN0IHRvIHRoZSBzZWxlY3Rpb24ncyBmaXJzdCBwb3NpdGlvbiBhbmQgcmV0dXJucyBhdHRyaWJ1dGVzIG9mIGZpcnN0CiAgLy8gZm91bmQgZWxlbWVudC4gSWYgdGhlcmUgYXJlIG5vIHRleHQgbm9kZXMgaW4gc2VsZWN0aW9uJ3MgZmlyc3QgcG9zaXRpb24gcGFyZW50LCBpdCByZXR1cm5zIHNlbGVjdGlvbgogIC8vIGF0dHJpYnV0ZXMgc3RvcmVkIGluIHRoYXQgcGFyZW50LgogIC8vCiAgLy8gQHByaXZhdGUKICAvLyBAcmV0dXJucyB7SXRlcmFibGUuPCo+fSBDb2xsZWN0aW9uIG9mIGF0dHJpYnV0ZXMuCgoKICBfZ2V0U3Vycm91bmRpbmdBdHRyaWJ1dGVzKCkgewogICAgY29uc3QgcG9zaXRpb24gPSB0aGlzLmdldEZpcnN0UG9zaXRpb24oKTsKICAgIGNvbnN0IHNjaGVtYSA9IHRoaXMuX21vZGVsLnNjaGVtYTsKICAgIGxldCBhdHRycyA9IG51bGw7CgogICAgaWYgKCF0aGlzLmlzQ29sbGFwc2VkKSB7CiAgICAgIC8vIDEuIElmIHNlbGVjdGlvbiBpcyBhIHJhbmdlLi4uCiAgICAgIGNvbnN0IHJhbmdlID0gdGhpcy5nZXRGaXJzdFJhbmdlKCk7IC8vIC4uLmxvb2sgZm9yIGEgZmlyc3QgY2hhcmFjdGVyIG5vZGUgaW4gdGhhdCByYW5nZSBhbmQgdGFrZSBhdHRyaWJ1dGVzIGZyb20gaXQuCgogICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHJhbmdlKSB7CiAgICAgICAgLy8gSWYgdGhlIGl0ZW0gaXMgYW4gb2JqZWN0LCB3ZSBkb24ndCB3YW50IHRvIGdldCBhdHRyaWJ1dGVzIGZyb20gaXRzIGNoaWxkcmVuLgogICAgICAgIGlmICh2YWx1ZS5pdGVtLmlzKCdlbGVtZW50JykgJiYgc2NoZW1hLmlzT2JqZWN0KHZhbHVlLml0ZW0pKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGlmICh2YWx1ZS50eXBlID09ICd0ZXh0JykgewogICAgICAgICAgYXR0cnMgPSB2YWx1ZS5pdGVtLmdldEF0dHJpYnV0ZXMoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gMi4gSWYgdGhlIHNlbGVjdGlvbiBpcyBhIGNhcmV0IG9yIHRoZSByYW5nZSBkb2VzIG5vdCBjb250YWluIGEgY2hhcmFjdGVyIG5vZGUuLi4KICAgICAgY29uc3Qgbm9kZUJlZm9yZSA9IHBvc2l0aW9uLnRleHROb2RlID8gcG9zaXRpb24udGV4dE5vZGUgOiBwb3NpdGlvbi5ub2RlQmVmb3JlOwogICAgICBjb25zdCBub2RlQWZ0ZXIgPSBwb3NpdGlvbi50ZXh0Tm9kZSA/IHBvc2l0aW9uLnRleHROb2RlIDogcG9zaXRpb24ubm9kZUFmdGVyOyAvLyBXaGVuIGdyYXZpdHkgaXMgb3ZlcnJpZGRlbiB0aGVuIGRvbid0IHRha2Ugbm9kZSBiZWZvcmUgaW50byBjb25zaWRlcmF0aW9uLgoKICAgICAgaWYgKCF0aGlzLmlzR3Jhdml0eU92ZXJyaWRkZW4pIHsKICAgICAgICAvLyAuLi5sb29rIGF0IHRoZSBub2RlIGJlZm9yZSBjYXJldCBhbmQgdGFrZSBhdHRyaWJ1dGVzIGZyb20gaXQgaWYgaXQgaXMgYSBjaGFyYWN0ZXIgbm9kZS4KICAgICAgICBhdHRycyA9IGdldEF0dHJzSWZDaGFyYWN0ZXIobm9kZUJlZm9yZSk7CiAgICAgIH0gLy8gMy4gSWYgbm90LCBsb29rIGF0IHRoZSBub2RlIGFmdGVyIGNhcmV0Li4uCgoKICAgICAgaWYgKCFhdHRycykgewogICAgICAgIGF0dHJzID0gZ2V0QXR0cnNJZkNoYXJhY3Rlcihub2RlQWZ0ZXIpOwogICAgICB9IC8vIDQuIElmIG5vdCwgdHJ5IHRvIGZpbmQgdGhlIGZpcnN0IGNoYXJhY3RlciBvbiB0aGUgbGVmdCwgdGhhdCBpcyBpbiB0aGUgc2FtZSBub2RlLgogICAgICAvLyBXaGVuIGdyYXZpdHkgaXMgb3ZlcnJpZGRlbiB0aGVuIGRvbid0IHRha2Ugbm9kZSBiZWZvcmUgaW50byBjb25zaWRlcmF0aW9uLgoKCiAgICAgIGlmICghdGhpcy5pc0dyYXZpdHlPdmVycmlkZGVuICYmICFhdHRycykgewogICAgICAgIGxldCBub2RlID0gbm9kZUJlZm9yZTsKCiAgICAgICAgd2hpbGUgKG5vZGUgJiYgIWF0dHJzKSB7CiAgICAgICAgICBub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICBhdHRycyA9IGdldEF0dHJzSWZDaGFyYWN0ZXIobm9kZSk7CiAgICAgICAgfQogICAgICB9IC8vIDUuIElmIG5vdCBmb3VuZCwgdHJ5IHRvIGZpbmQgdGhlIGZpcnN0IGNoYXJhY3RlciBvbiB0aGUgcmlnaHQsIHRoYXQgaXMgaW4gdGhlIHNhbWUgbm9kZS4KCgogICAgICBpZiAoIWF0dHJzKSB7CiAgICAgICAgbGV0IG5vZGUgPSBub2RlQWZ0ZXI7CgogICAgICAgIHdoaWxlIChub2RlICYmICFhdHRycykgewogICAgICAgICAgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICBhdHRycyA9IGdldEF0dHJzSWZDaGFyYWN0ZXIobm9kZSk7CiAgICAgICAgfQogICAgICB9IC8vIDYuIElmIG5vdCBmb3VuZCwgc2VsZWN0aW9uIHNob3VsZCByZXRyaWV2ZSBhdHRyaWJ1dGVzIGZyb20gcGFyZW50LgoKCiAgICAgIGlmICghYXR0cnMpIHsKICAgICAgICBhdHRycyA9IHRoaXMuX2dldFN0b3JlZEF0dHJpYnV0ZXMoKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBhdHRyczsKICB9IC8vIEZpeGVzIGEgc2VsZWN0aW9uIHJhbmdlIGFmdGVyIGl0IGVuZHMgdXAgaW4gZ3JhdmV5YXJkIHJvb3QuCiAgLy8KICAvLyBAcHJpdmF0ZQogIC8vIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9saXZlcmFuZ2V+TGl2ZVJhbmdlfSBsaXZlUmFuZ2UgVGhlIHJhbmdlIGZyb20gc2VsZWN0aW9uLCB0aGF0IGVuZGVkIHVwIGluIHRoZSBncmF2ZXlhcmQgcm9vdC4KICAvLyBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvcG9zaXRpb25+UG9zaXRpb259IHJlbW92ZWRSYW5nZVN0YXJ0IFN0YXJ0IHBvc2l0aW9uIG9mIGEgcmFuZ2Ugd2hpY2ggd2FzIHJlbW92ZWQuCgoKICBfZml4R3JhdmV5YXJkU2VsZWN0aW9uKGxpdmVSYW5nZSwgcmVtb3ZlZFJhbmdlU3RhcnQpIHsKICAgIC8vIFRoZSBzdGFydCBvZiB0aGUgcmVtb3ZlZCByYW5nZSBpcyB0aGUgY2xvc2VzdCBwb3NpdGlvbiB0byB0aGUgYGxpdmVSYW5nZWAgLSB0aGUgb3JpZ2luYWwgc2VsZWN0aW9uIHJhbmdlLgogICAgLy8gVGhpcyBpcyBhIGdvb2QgY2FuZGlkYXRlIGZvciBhIGZpeGVkIHNlbGVjdGlvbiByYW5nZS4KICAgIGNvbnN0IHBvc2l0aW9uQ2FuZGlkYXRlID0gcmVtb3ZlZFJhbmdlU3RhcnQuY2xvbmUoKTsgLy8gRmluZCBhIHJhbmdlIHRoYXQgaXMgYSBjb3JyZWN0IHNlbGVjdGlvbiByYW5nZSBhbmQgaXMgY2xvc2VzdCB0byB0aGUgc3RhcnQgb2YgcmVtb3ZlZCByYW5nZS4KCiAgICBjb25zdCBzZWxlY3Rpb25SYW5nZSA9IHRoaXMuX21vZGVsLnNjaGVtYS5nZXROZWFyZXN0U2VsZWN0aW9uUmFuZ2UocG9zaXRpb25DYW5kaWRhdGUpOyAvLyBSZW1vdmUgdGhlIG9sZCBzZWxlY3Rpb24gcmFuZ2UgYmVmb3JlIHByZXBhcmluZyBhbmQgYWRkaW5nIG5ldyBzZWxlY3Rpb24gcmFuZ2UuIFRoaXMgb3JkZXIgaXMgaW1wb3J0YW50LAogICAgLy8gYmVjYXVzZSBuZXcgcmFuZ2UsIGluIHNvbWUgY2FzZXMsIG1heSBpbnRlcnNlY3Qgd2l0aCBvbGQgcmFuZ2UgKGl0IGRlcGVuZHMgb24gYGdldE5lYXJlc3RTZWxlY3Rpb25SYW5nZSgpYCByZXN1bHQpLgoKCiAgICBjb25zdCBpbmRleCA9IHRoaXMuX3Jhbmdlcy5pbmRleE9mKGxpdmVSYW5nZSk7CgogICAgdGhpcy5fcmFuZ2VzLnNwbGljZShpbmRleCwgMSk7CgogICAgbGl2ZVJhbmdlLmRldGFjaCgpOyAvLyBJZiBuZWFyZXN0IHZhbGlkIHNlbGVjdGlvbiByYW5nZSBoYXMgYmVlbiBmb3VuZCAtIGFkZCBpdCBpbiB0aGUgcGxhY2Ugb2Ygb2xkIHJhbmdlLgoKICAgIGlmIChzZWxlY3Rpb25SYW5nZSkgewogICAgICAvLyBDaGVjayB0aGUgcmFuZ2UsIGNvbnZlcnQgaXQgdG8gbGl2ZSByYW5nZSwgYmluZCBldmVudHMsIGV0Yy4KICAgICAgY29uc3QgbmV3UmFuZ2UgPSB0aGlzLl9wcmVwYXJlUmFuZ2Uoc2VsZWN0aW9uUmFuZ2UpOyAvLyBBZGQgbmV3IHJhbmdlIGluIHRoZSBwbGFjZSBvZiBvbGQgcmFuZ2UuCgoKICAgICAgdGhpcy5fcmFuZ2VzLnNwbGljZShpbmRleCwgMCwgbmV3UmFuZ2UpOwogICAgfSAvLyBJZiBuZWFyZXN0IHZhbGlkIHNlbGVjdGlvbiByYW5nZSBjYW5ub3QgYmUgZm91bmQgLSBqdXN0IHJlbW92aW5nIHRoZSBvbGQgcmFuZ2UgaXMgZmluZS4KCiAgfQoKfSAvLyBIZWxwZXIgZnVuY3Rpb24gZm9yIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2xpdmVzZWxlY3Rpb25+TGl2ZVNlbGVjdGlvbiNfdXBkYXRlQXR0cmlidXRlc30uCi8vCi8vIEl0IHRha2VzIG1vZGVsIGl0ZW0sIGNoZWNrcyB3aGV0aGVyIGl0IGlzIGEgdGV4dCBub2RlIChvciB0ZXh0IHByb3h5KSBhbmQsIGlmIHNvLCByZXR1cm5zIGl0J3MgYXR0cmlidXRlcy4gSWYgbm90LCByZXR1cm5zIGBudWxsYC4KLy8KLy8gQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL2l0ZW1+SXRlbXxudWxsfSAgbm9kZQovLyBAcmV0dXJucyB7Qm9vbGVhbn0KCgpmdW5jdGlvbiBnZXRBdHRyc0lmQ2hhcmFjdGVyKG5vZGUpIHsKICBpZiAobm9kZSBpbnN0YW5jZW9mIFRleHRQcm94eSB8fCBub2RlIGluc3RhbmNlb2YgVGV4dCkgewogICAgcmV0dXJuIG5vZGUuZ2V0QXR0cmlidXRlcygpOwogIH0KCiAgcmV0dXJuIG51bGw7Cn0gLy8gUmVtb3ZlcyBzZWxlY3Rpb24gYXR0cmlidXRlcyBmcm9tIGVsZW1lbnQgd2hpY2ggaXMgbm90IGVtcHR5IGFueW1vcmUuCi8vCi8vIEBwcml2YXRlCi8vIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9tb2RlbH5Nb2RlbH0gbW9kZWwKLy8gQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL2JhdGNofkJhdGNofSBiYXRjaAoKCmZ1bmN0aW9uIGNsZWFyQXR0cmlidXRlc1N0b3JlZEluRWxlbWVudChtb2RlbCwgYmF0Y2gpIHsKICBjb25zdCBkaWZmZXIgPSBtb2RlbC5kb2N1bWVudC5kaWZmZXI7CgogIGZvciAoY29uc3QgZW50cnkgb2YgZGlmZmVyLmdldENoYW5nZXMoKSkgewogICAgaWYgKGVudHJ5LnR5cGUgIT0gJ2luc2VydCcpIHsKICAgICAgY29udGludWU7CiAgICB9CgogICAgY29uc3QgY2hhbmdlUGFyZW50ID0gZW50cnkucG9zaXRpb24ucGFyZW50OwogICAgY29uc3QgaXNOb0xvbmdlckVtcHR5ID0gZW50cnkubGVuZ3RoID09PSBjaGFuZ2VQYXJlbnQubWF4T2Zmc2V0OwoKICAgIGlmIChpc05vTG9uZ2VyRW1wdHkpIHsKICAgICAgbW9kZWwuZW5xdWV1ZUNoYW5nZShiYXRjaCwgd3JpdGVyID0+IHsKICAgICAgICBjb25zdCBzdG9yZWRBdHRyaWJ1dGVzID0gQXJyYXkuZnJvbShjaGFuZ2VQYXJlbnQuZ2V0QXR0cmlidXRlS2V5cygpKS5maWx0ZXIoa2V5ID0+IGtleS5zdGFydHNXaXRoKHN0b3JlUHJlZml4KSk7CgogICAgICAgIGZvciAoY29uc3Qga2V5IG9mIHN0b3JlZEF0dHJpYnV0ZXMpIHsKICAgICAgICAgIHdyaXRlci5yZW1vdmVBdHRyaWJ1dGUoa2V5LCBjaGFuZ2VQYXJlbnQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQp9"},{"version":3,"sources":["/Users/antonyching/Desktop/project/new-builder-demo/node_modules/@ckeditor/ckeditor5-engine/src/model/documentselection.js"],"names":["mix","EmitterMixin","Selection","LiveRange","Text","TextProxy","toMap","Collection","CKEditorError","uid","storePrefix","DocumentSelection","constructor","doc","_selection","LiveSelection","delegate","to","isCollapsed","anchor","focus","rangeCount","hasOwnRange","isBackward","isGravityOverridden","markers","_ranges","getRanges","getFirstPosition","getLastPosition","getFirstRange","getLastRange","getSelectedBlocks","getSelectedElement","containsEntireContent","element","destroy","getAttributeKeys","getAttributes","getAttribute","key","hasAttribute","refresh","_updateMarkers","_updateAttributes","is","type","_setFocus","itemOrPosition","offset","setFocus","_setTo","selectable","placeOrOffset","options","setTo","_setAttribute","value","setAttribute","_removeAttribute","removeAttribute","_getStoredAttributes","_overrideGravity","overrideGravity","_restoreGravity","restoreGravity","_getStoreAttributeKey","_isStoreAttributeKey","startsWith","idProperty","_model","model","_document","_attributePriority","Map","_fixGraveyardRangesData","_hasChangedRange","_overriddenGravityRegister","Set","listenTo","evt","args","operation","isDocumentOperation","length","liveRange","sourcePosition","shift","_fixGraveyardSelection","fire","directChange","priority","on","range","_validateSelectionRange","batch","clearAttributesStoredInElement","_getDefaultRange","start","end","size","i","detach","stopListening","optionsOrPlaceOrOffset","attributeKeys","overrideUid","add","has","delete","_popRange","pop","_pushRange","_prepareRange","push","_checkRange","root","graveyard","fromRange","oldRange","data","deletionPosition","marker","markerRange","getRange","selectionRange","containsRange","Array","from","includes","remove","clearAll","newAttributes","_getSurroundingAttributes","oldAttributes","_attrs","_setAttributesTo","changed","newKey","newValue","get","oldKey","oldValue","set","attrs","gotAdded","selectionParent","parent","isEmpty","realKey","substr","position","schema","item","isObject","nodeBefore","textNode","nodeAfter","getAttrsIfCharacter","node","previousSibling","nextSibling","removedRangeStart","positionCandidate","clone","getNearestSelectionRange","index","indexOf","splice","newRange","differ","document","entry","getChanges","changeParent","isNoLongerEmpty","maxOffset","enqueueChange","writer","storedAttributes","filter"],"mappings":"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","sourcesContent":["/**\n * @license Copyright (c) 2003-2019, CKSource - Frederico Knabben. All rights reserved.\n * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license\n */\n\n/**\n * @module engine/model/documentselection\n */\n\nimport mix from '@ckeditor/ckeditor5-utils/src/mix';\nimport EmitterMixin from '@ckeditor/ckeditor5-utils/src/emittermixin';\n\nimport Selection from './selection';\nimport LiveRange from './liverange';\nimport Text from './text';\nimport TextProxy from './textproxy';\nimport toMap from '@ckeditor/ckeditor5-utils/src/tomap';\nimport Collection from '@ckeditor/ckeditor5-utils/src/collection';\nimport CKEditorError from '@ckeditor/ckeditor5-utils/src/ckeditorerror';\nimport uid from '@ckeditor/ckeditor5-utils/src/uid';\n\nconst storePrefix = 'selection:';\n\n/**\n * `DocumentSelection` is a special selection which is used as the\n * {@link module:engine/model/document~Document#selection document's selection}.\n * There can be only one instance of `DocumentSelection` per document.\n *\n * Document selection can only be changed by using the {@link module:engine/model/writer~Writer} instance\n * inside the {@link module:engine/model/model~Model#change `change()`} block, as it provides a secure way to modify model.\n *\n * `DocumentSelection` is automatically updated upon changes in the {@link module:engine/model/document~Document document}\n * to always contain valid ranges. Its attributes are inherited from the text unless set explicitly.\n *\n * Differences between {@link module:engine/model/selection~Selection} and `DocumentSelection` are:\n * * there is always a range in `DocumentSelection` - even if no ranges were added there is a \"default range\"\n * present in the selection,\n * * ranges added to this selection updates automatically when the document changes,\n * * attributes of `DocumentSelection` are updated automatically according to selection ranges.\n *\n * Since `DocumentSelection` uses {@link module:engine/model/liverange~LiveRange live ranges}\n * and is updated when {@link module:engine/model/document~Document document}\n * changes, it cannot be set on {@link module:engine/model/node~Node nodes}\n * that are inside {@link module:engine/model/documentfragment~DocumentFragment document fragment}.\n * If you need to represent a selection in document fragment,\n * use {@link module:engine/model/selection~Selection Selection class} instead.\n *\n * @mixes module:utils/emittermixin~EmitterMixin\n */\nexport default class DocumentSelection {\n\t/**\n\t * Creates an empty live selection for given {@link module:engine/model/document~Document}.\n\t *\n\t * @param {module:engine/model/document~Document} doc Document which owns this selection.\n\t */\n\tconstructor( doc ) {\n\t\t/**\n\t\t * Selection used internally by that class (`DocumentSelection` is a proxy to that selection).\n\t\t *\n\t\t * @protected\n\t\t */\n\t\tthis._selection = new LiveSelection( doc );\n\n\t\tthis._selection.delegate( 'change:range' ).to( this );\n\t\tthis._selection.delegate( 'change:attribute' ).to( this );\n\t}\n\n\t/**\n\t * Returns whether the selection is collapsed. Selection is collapsed when there is exactly one range which is\n\t * collapsed.\n\t *\n\t * @readonly\n\t * @type {Boolean}\n\t */\n\tget isCollapsed() {\n\t\treturn this._selection.isCollapsed;\n\t}\n\n\t/**\n\t * Selection anchor. Anchor may be described as a position where the most recent part of the selection starts.\n\t * Together with {@link #focus} they define the direction of selection, which is important\n\t * when expanding/shrinking selection. Anchor is always {@link module:engine/model/range~Range#start start} or\n\t * {@link module:engine/model/range~Range#end end} position of the most recently added range.\n\t *\n\t * Is set to `null` if there are no ranges in selection.\n\t *\n\t * @see #focus\n\t * @readonly\n\t * @type {module:engine/model/position~Position|null}\n\t */\n\tget anchor() {\n\t\treturn this._selection.anchor;\n\t}\n\n\t/**\n\t * Selection focus. Focus is a position where the selection ends.\n\t *\n\t * Is set to `null` if there are no ranges in selection.\n\t *\n\t * @see #anchor\n\t * @readonly\n\t * @type {module:engine/model/position~Position|null}\n\t */\n\tget focus() {\n\t\treturn this._selection.focus;\n\t}\n\n\t/**\n\t * Returns number of ranges in selection.\n\t *\n\t * @readonly\n\t * @type {Number}\n\t */\n\tget rangeCount() {\n\t\treturn this._selection.rangeCount;\n\t}\n\n\t/**\n\t * Describes whether `Documentselection` has own range(s) set, or if it is defaulted to\n\t * {@link module:engine/model/document~Document#_getDefaultRange document's default range}.\n\t *\n\t * @readonly\n\t * @type {Boolean}\n\t */\n\tget hasOwnRange() {\n\t\treturn this._selection.hasOwnRange;\n\t}\n\n\t/**\n\t * Specifies whether the {@link #focus}\n\t * precedes {@link #anchor}.\n\t *\n\t * @readonly\n\t * @type {Boolean}\n\t */\n\tget isBackward() {\n\t\treturn this._selection.isBackward;\n\t}\n\n\t/**\n\t * Describes whether the gravity is overridden (using {@link module:engine/model/writer~Writer#overrideSelectionGravity}) or not.\n\t *\n\t * Note that the gravity remains overridden as long as will not be restored the same number of times as it was overridden.\n\t *\n\t * @readonly\n\t * @returns {Boolean}\n\t */\n\tget isGravityOverridden() {\n\t\treturn this._selection.isGravityOverridden;\n\t}\n\n\t/**\n\t * A collection of selection markers.\n\t * Marker is a selection marker when selection range is inside the marker range.\n\t *\n\t * @readonly\n\t * @type {module:utils/collection~Collection.<module:engine/model/markercollection~Marker>}\n\t */\n\tget markers() {\n\t\treturn this._selection.markers;\n\t}\n\n\t/**\n\t * Used for the compatibility with the {@link module:engine/model/selection~Selection#isEqual} method.\n\t *\n\t * @protected\n\t */\n\tget _ranges() {\n\t\treturn this._selection._ranges;\n\t}\n\n\t/**\n\t * Returns an iterable that iterates over copies of selection ranges.\n\t *\n\t * @returns {Iterable.<module:engine/model/range~Range>}\n\t */\n\tgetRanges() {\n\t\treturn this._selection.getRanges();\n\t}\n\n\t/**\n\t * Returns the first position in the selection.\n\t * First position is the position that {@link module:engine/model/position~Position#isBefore is before}\n\t * any other position in the selection.\n\t *\n\t * Returns `null` if there are no ranges in selection.\n\t *\n\t * @returns {module:engine/model/position~Position|null}\n\t */\n\tgetFirstPosition() {\n\t\treturn this._selection.getFirstPosition();\n\t}\n\n\t/**\n\t * Returns the last position in the selection.\n\t * Last position is the position that {@link module:engine/model/position~Position#isAfter is after}\n\t * any other position in the selection.\n\t *\n\t * Returns `null` if there are no ranges in selection.\n\t *\n\t * @returns {module:engine/model/position~Position|null}\n\t */\n\tgetLastPosition() {\n\t\treturn this._selection.getLastPosition();\n\t}\n\n\t/**\n\t * Returns a copy of the first range in the selection.\n\t * First range is the one which {@link module:engine/model/range~Range#start start} position\n\t * {@link module:engine/model/position~Position#isBefore is before} start position of all other ranges\n\t * (not to confuse with the first range added to the selection).\n\t *\n\t * Returns `null` if there are no ranges in selection.\n\t *\n\t * @returns {module:engine/model/range~Range|null}\n\t */\n\tgetFirstRange() {\n\t\treturn this._selection.getFirstRange();\n\t}\n\n\t/**\n\t * Returns a copy of the last range in the selection.\n\t * Last range is the one which {@link module:engine/model/range~Range#end end} position\n\t * {@link module:engine/model/position~Position#isAfter is after} end position of all other ranges (not to confuse with the range most\n\t * recently added to the selection).\n\t *\n\t * Returns `null` if there are no ranges in selection.\n\t *\n\t * @returns {module:engine/model/range~Range|null}\n\t */\n\tgetLastRange() {\n\t\treturn this._selection.getLastRange();\n\t}\n\n\t/**\n\t * Gets elements of type {@link module:engine/model/schema~Schema#isBlock \"block\"} touched by the selection.\n\t *\n\t * This method's result can be used for example to apply block styling to all blocks covered by this selection.\n\t *\n\t * **Note:** `getSelectedBlocks()` returns blocks that are nested in other non-block elements\n\t * but will not return blocks nested in other blocks.\n\t *\n\t * In this case the function will return exactly all 3 paragraphs (note: `<blockQuote>` is not a block itself):\n\t *\n\t *\t\t<paragraph>[a</paragraph>\n\t *\t\t<blockQuote>\n\t *\t\t\t<paragraph>b</paragraph>\n\t *\t\t</blockQuote>\n\t *\t\t<paragraph>c]d</paragraph>\n\t *\n\t * In this case the paragraph will also be returned, despite the collapsed selection:\n\t *\n\t *\t\t<paragraph>[]a</paragraph>\n\t *\n\t * In such a scenario, however, only blocks A, B & E will be returned as blocks C & D are nested in block B:\n\t *\n\t *\t\t[<blockA></blockA>\n\t *\t\t<blockB>\n\t *\t\t\t<blockC></blockC>\n\t *\t\t\t<blockD></blockD>\n\t *\t\t</blockB>\n\t *\t\t<blockE></blockE>]\n\t *\n\t * If the selection is inside a block all the inner blocks (A & B) are returned:\n\t *\n\t * \t\t<block>\n\t *\t\t\t<blockA>[a</blockA>\n\t * \t\t\t<blockB>b]</blockB>\n\t * \t\t</block>\n\t *\n\t * **Special case**: If a selection ends at the beginning of a block, that block is not returned as from user perspective\n\t * this block wasn't selected. See [#984](https://github.com/ckeditor/ckeditor5-engine/issues/984) for more details.\n\t *\n\t *\t\t<paragraph>[a</paragraph>\n\t *\t\t<paragraph>b</paragraph>\n\t *\t\t<paragraph>]c</paragraph> // this block will not be returned\n\t *\n\t * @returns {Iterable.<module:engine/model/element~Element>}\n\t */\n\tgetSelectedBlocks() {\n\t\treturn this._selection.getSelectedBlocks();\n\t}\n\n\t/**\n\t * Returns the selected element. {@link module:engine/model/element~Element Element} is considered as selected if there is only\n\t * one range in the selection, and that range contains exactly one element.\n\t * Returns `null` if there is no selected element.\n\t *\n\t * @returns {module:engine/model/element~Element|null}\n\t */\n\tgetSelectedElement() {\n\t\treturn this._selection.getSelectedElement();\n\t}\n\n\t/**\n\t * Checks whether the selection contains the entire content of the given element. This means that selection must start\n\t * at a position {@link module:engine/model/position~Position#isTouching touching} the element's start and ends at position\n\t * touching the element's end.\n\t *\n\t * By default, this method will check whether the entire content of the selection's current root is selected.\n\t * Useful to check if e.g. the user has just pressed <kbd>Ctrl</kbd> + <kbd>A</kbd>.\n\t *\n\t * @param {module:engine/model/element~Element} [element=this.anchor.root]\n\t * @returns {Boolean}\n\t */\n\tcontainsEntireContent( element ) {\n\t\treturn this._selection.containsEntireContent( element );\n\t}\n\n\t/**\n\t * Unbinds all events previously bound by document selection.\n\t */\n\tdestroy() {\n\t\tthis._selection.destroy();\n\t}\n\n\t/**\n\t * Returns iterable that iterates over this selection's attribute keys.\n\t *\n\t * @returns {Iterable.<String>}\n\t */\n\tgetAttributeKeys() {\n\t\treturn this._selection.getAttributeKeys();\n\t}\n\n\t/**\n\t * Returns iterable that iterates over this selection's attributes.\n\t *\n\t * Attributes are returned as arrays containing two items. First one is attribute key and second is attribute value.\n\t * This format is accepted by native `Map` object and also can be passed in `Node` constructor.\n\t *\n\t * @returns {Iterable.<*>}\n\t */\n\tgetAttributes() {\n\t\treturn this._selection.getAttributes();\n\t}\n\n\t/**\n\t * Gets an attribute value for given key or `undefined` if that attribute is not set on the selection.\n\t *\n\t * @param {String} key Key of attribute to look for.\n\t * @returns {*} Attribute value or `undefined`.\n\t */\n\tgetAttribute( key ) {\n\t\treturn this._selection.getAttribute( key );\n\t}\n\n\t/**\n\t * Checks if the selection has an attribute for given key.\n\t *\n\t * @param {String} key Key of attribute to check.\n\t * @returns {Boolean} `true` if attribute with given key is set on selection, `false` otherwise.\n\t */\n\thasAttribute( key ) {\n\t\treturn this._selection.hasAttribute( key );\n\t}\n\n\t/**\n\t * Refreshes selection attributes and markers according to the current position in the model.\n\t */\n\trefresh() {\n\t\tthis._selection._updateMarkers();\n\t\tthis._selection._updateAttributes( false );\n\t}\n\n\t/**\n\t * Checks whether this object is of the given type.\n\t *\n\t *\t\tselection.is( 'selection' ); // -> true\n\t *\t\tselection.is( 'documentSelection' ); // -> true\n\t *\t\tselection.is( 'model:selection' ); // -> true\n\t *\t\tselection.is( 'model:documentSelection' ); // -> true\n\t *\n\t *\t\tselection.is( 'view:selection' ); // -> false\n\t *\t\tselection.is( 'element' ); // -> false\n\t *\t\tselection.is( 'node' ); // -> false\n\t *\n\t * {@link module:engine/model/node~Node#is Check the entire list of model objects} which implement the `is()` method.\n\t *\n\t * @param {String} type\n\t * @returns {Boolean}\n\t */\n\tis( type ) {\n\t\treturn type == 'selection' ||\n\t\t\ttype == 'model:selection' ||\n\t\t\ttype == 'documentSelection' ||\n\t\t\ttype == 'model:documentSelection';\n\t}\n\n\t/**\n\t * Moves {@link module:engine/model/documentselection~DocumentSelection#focus} to the specified location.\n\t * Should be used only within the {@link module:engine/model/writer~Writer#setSelectionFocus} method.\n\t *\n\t * The location can be specified in the same form as\n\t * {@link module:engine/model/writer~Writer#createPositionAt writer.createPositionAt()} parameters.\n\t *\n\t * @see module:engine/model/writer~Writer#setSelectionFocus\n\t * @protected\n\t * @param {module:engine/model/item~Item|module:engine/model/position~Position} itemOrPosition\n\t * @param {Number|'end'|'before'|'after'} [offset] Offset or one of the flags. Used only when\n\t * first parameter is a {@link module:engine/model/item~Item model item}.\n\t */\n\t_setFocus( itemOrPosition, offset ) {\n\t\tthis._selection.setFocus( itemOrPosition, offset );\n\t}\n\n\t/**\n\t * Sets this selection's ranges and direction to the specified location based on the given\n\t * {@link module:engine/model/selection~Selectable selectable}.\n\t * Should be used only within the {@link module:engine/model/writer~Writer#setSelection} method.\n\t *\n\t * @see module:engine/model/writer~Writer#setSelection\n\t * @protected\n\t * @param {module:engine/model/selection~Selectable} selectable\n\t * @param {Number|'before'|'end'|'after'|'on'|'in'} [placeOrOffset] Sets place or offset of the selection.\n\t * @param {Object} [options]\n\t * @param {Boolean} [options.backward] Sets this selection instance to be backward.\n\t */\n\t_setTo( selectable, placeOrOffset, options ) {\n\t\tthis._selection.setTo( selectable, placeOrOffset, options );\n\t}\n\n\t/**\n\t * Sets attribute on the selection. If attribute with the same key already is set, it's value is overwritten.\n\t * Should be used only within the {@link module:engine/model/writer~Writer#setSelectionAttribute} method.\n\t *\n\t * @see module:engine/model/writer~Writer#setSelectionAttribute\n\t * @protected\n\t * @param {String} key Key of the attribute to set.\n\t * @param {*} value Attribute value.\n\t */\n\t_setAttribute( key, value ) {\n\t\tthis._selection.setAttribute( key, value );\n\t}\n\n\t/**\n\t * Removes an attribute with given key from the selection.\n\t * If the given attribute was set on the selection, fires the {@link module:engine/model/selection~Selection#event:change:range}\n\t * event with removed attribute key.\n\t * Should be used only within the {@link module:engine/model/writer~Writer#removeSelectionAttribute} method.\n\t *\n\t * @see module:engine/model/writer~Writer#removeSelectionAttribute\n\t * @protected\n\t * @param {String} key Key of the attribute to remove.\n\t */\n\t_removeAttribute( key ) {\n\t\tthis._selection.removeAttribute( key );\n\t}\n\n\t/**\n\t * Returns an iterable that iterates through all selection attributes stored in current selection's parent.\n\t *\n\t * @protected\n\t * @returns {Iterable.<*>}\n\t */\n\t_getStoredAttributes() {\n\t\treturn this._selection._getStoredAttributes();\n\t}\n\n\t/**\n\t * Temporarily changes the gravity of the selection from the left to the right.\n\t *\n\t * The gravity defines from which direction the selection inherits its attributes. If it's the default left\n\t * gravity, the selection (after being moved by the the user) inherits attributes from its left hand side.\n\t * This method allows to temporarily override this behavior by forcing the gravity to the right.\n\t *\n\t * It returns an unique identifier which is required to restore the gravity. It guarantees the symmetry\n\t * of the process.\n\t *\n\t * @see module:engine/model/writer~Writer#overrideSelectionGravity\n\t * @protected\n\t * @returns {String} The unique id which allows restoring the gravity.\n\t */\n\t_overrideGravity() {\n\t\treturn this._selection.overrideGravity();\n\t}\n\n\t/**\n\t * Restores the {@link ~DocumentSelection#_overrideGravity overridden gravity}.\n\t *\n\t * Restoring the gravity is only possible using the unique identifier returned by\n\t * {@link ~DocumentSelection#_overrideGravity}. Note that the gravity remains overridden as long as won't be restored\n\t * the same number of times it was overridden.\n\t *\n\t * @see module:engine/model/writer~Writer#restoreSelectionGravity\n\t * @protected\n\t * @param {String} uid The unique id returned by {@link #_overrideGravity}.\n\t */\n\t_restoreGravity( uid ) {\n\t\tthis._selection.restoreGravity( uid );\n\t}\n\n\t/**\n\t * Generates and returns an attribute key for selection attributes store, basing on original attribute key.\n\t *\n\t * @protected\n\t * @param {String} key Attribute key to convert.\n\t * @returns {String} Converted attribute key, applicable for selection store.\n\t */\n\tstatic _getStoreAttributeKey( key ) {\n\t\treturn storePrefix + key;\n\t}\n\n\t/**\n\t * Checks whether the given attribute key is an attribute stored on an element.\n\t *\n\t * @protected\n\t * @param {String} key\n\t * @returns {Boolean}\n\t */\n\tstatic _isStoreAttributeKey( key ) {\n\t\treturn key.startsWith( storePrefix );\n\t}\n}\n\nmix( DocumentSelection, EmitterMixin );\n\n/**\n * Fired when selection range(s) changed.\n *\n * @event change:range\n * @param {Boolean} directChange In case of {@link module:engine/model/selection~Selection} class it is always set\n * to `true` which indicates that the selection change was caused by a direct use of selection's API.\n * The {@link module:engine/model/documentselection~DocumentSelection}, however, may change because its position\n * was directly changed through the {@link module:engine/model/writer~Writer writer} or because its position was\n * changed because the structure of the model has been changed (which means an indirect change).\n * The indirect change does not occur in case of normal (detached) selections because they are \"static\" (as \"not live\")\n * which mean that they are not updated once the document changes.\n */\n\n/**\n * Fired when selection attribute changed.\n *\n * @event change:attribute\n * @param {Boolean} directChange In case of {@link module:engine/model/selection~Selection} class it is always set\n * to `true` which indicates that the selection change was caused by a direct use of selection's API.\n * The {@link module:engine/model/documentselection~DocumentSelection}, however, may change because its attributes\n * were directly changed through the {@link module:engine/model/writer~Writer writer} or because its position was\n * changed in the model and its attributes were refreshed (which means an indirect change).\n * The indirect change does not occur in case of normal (detached) selections because they are \"static\" (as \"not live\")\n * which mean that they are not updated once the document changes.\n * @param {Array.<String>} attributeKeys Array containing keys of attributes that changed.\n */\n\n// `LiveSelection` is used internally by {@link module:engine/model/documentselection~DocumentSelection} and shouldn't be used directly.\n//\n// LiveSelection` is automatically updated upon changes in the {@link module:engine/model/document~Document document}\n// to always contain valid ranges. Its attributes are inherited from the text unless set explicitly.\n//\n// Differences between {@link module:engine/model/selection~Selection} and `LiveSelection` are:\n// * there is always a range in `LiveSelection` - even if no ranges were added there is a \"default range\"\n// present in the selection,\n// * ranges added to this selection updates automatically when the document changes,\n// * attributes of `LiveSelection` are updated automatically according to selection ranges.\n//\n// @extends module:engine/model/selection~Selection\n//\n\nclass LiveSelection extends Selection {\n\t// Creates an empty live selection for given {@link module:engine/model/document~Document}.\n\t// @param {module:engine/model/document~Document} doc Document which owns this selection.\n\tconstructor( doc ) {\n\t\tsuper();\n\n\t\t// List of selection markers.\n\t\t// Marker is a selection marker when selection range is inside the marker range.\n\t\t//\n\t\t// @type {module:utils/collection~Collection}\n\t\tthis.markers = new Collection( { idProperty: 'name' } );\n\n\t\t// Document which owns this selection.\n\t\t//\n\t\t// @protected\n\t\t// @member {module:engine/model/model~Model}\n\t\tthis._model = doc.model;\n\n\t\t// Document which owns this selection.\n\t\t//\n\t\t// @protected\n\t\t// @member {module:engine/model/document~Document}\n\t\tthis._document = doc;\n\n\t\t// Keeps mapping of attribute name to priority with which the attribute got modified (added/changed/removed)\n\t\t// last time. Possible values of priority are: `'low'` and `'normal'`.\n\t\t//\n\t\t// Priorities are used by internal `LiveSelection` mechanisms. All attributes set using `LiveSelection`\n\t\t// attributes API are set with `'normal'` priority.\n\t\t//\n\t\t// @private\n\t\t// @member {Map} module:engine/model/liveselection~LiveSelection#_attributePriority\n\t\tthis._attributePriority = new Map();\n\n\t\t// Contains data required to fix ranges which have been moved to the graveyard.\n\t\t// @private\n\t\t// @member {Array} module:engine/model/liveselection~LiveSelection#_fixGraveyardRangesData\n\t\tthis._fixGraveyardRangesData = [];\n\n\t\t// Flag that informs whether the selection ranges have changed. It is changed on true when `LiveRange#change:range` event is fired.\n\t\t// @private\n\t\t// @member {Array} module:engine/model/liveselection~LiveSelection#_hasChangedRange\n\t\tthis._hasChangedRange = false;\n\n\t\t// Each overriding gravity adds an UID to the set and each removal removes it.\n\t\t// Gravity is overridden when there's at least one UID in the set.\n\t\t// Gravity is restored when the set is empty.\n\t\t// This is to prevent conflicts when gravity is overridden by more than one feature at the same time.\n\t\t// @private\n\t\t// @type {Set}\n\t\tthis._overriddenGravityRegister = new Set();\n\n\t\t// Ensure selection is correct after each operation.\n\t\tthis.listenTo( this._model, 'applyOperation', ( evt, args ) => {\n\t\t\tconst operation = args[ 0 ];\n\n\t\t\tif ( !operation.isDocumentOperation || operation.type == 'marker' || operation.type == 'rename' || operation.type == 'noop' ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\twhile ( this._fixGraveyardRangesData.length ) {\n\t\t\t\tconst { liveRange, sourcePosition } = this._fixGraveyardRangesData.shift();\n\n\t\t\t\tthis._fixGraveyardSelection( liveRange, sourcePosition );\n\t\t\t}\n\n\t\t\tif ( this._hasChangedRange ) {\n\t\t\t\tthis._hasChangedRange = false;\n\t\t\t\tthis.fire( 'change:range', { directChange: false } );\n\t\t\t}\n\t\t}, { priority: 'lowest' } );\n\n\t\t// Ensure selection is correct and up to date after each range change.\n\t\tthis.on( 'change:range', () => {\n\t\t\tfor ( const range of this.getRanges() ) {\n\t\t\t\tif ( !this._document._validateSelectionRange( range ) ) {\n\t\t\t\t\t/**\n\t\t\t\t\t * Range from {@link module:engine/model/documentselection~DocumentSelection document selection}\n\t\t\t\t\t * starts or ends at incorrect position.\n\t\t\t\t\t *\n\t\t\t\t\t * @error document-selection-wrong-position\n\t\t\t\t\t * @param {module:engine/model/range~Range} range\n\t\t\t\t\t */\n\t\t\t\t\tthrow new CKEditorError(\n\t\t\t\t\t\t'document-selection-wrong-position: Range from document selection starts or ends at incorrect position.',\n\t\t\t\t\t\tthis,\n\t\t\t\t\t\t{ range }\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t} );\n\n\t\t// Update markers data stored by the selection after each marker change.\n\t\tthis.listenTo( this._model.markers, 'update', () => this._updateMarkers() );\n\n\t\t// Ensure selection is up to date after each change block.\n\t\tthis.listenTo( this._document, 'change', ( evt, batch ) => {\n\t\t\tclearAttributesStoredInElement( this._model, batch );\n\t\t} );\n\t}\n\n\tget isCollapsed() {\n\t\tconst length = this._ranges.length;\n\n\t\treturn length === 0 ? this._document._getDefaultRange().isCollapsed : super.isCollapsed;\n\t}\n\n\tget anchor() {\n\t\treturn super.anchor || this._document._getDefaultRange().start;\n\t}\n\n\tget focus() {\n\t\treturn super.focus || this._document._getDefaultRange().end;\n\t}\n\n\tget rangeCount() {\n\t\treturn this._ranges.length ? this._ranges.length : 1;\n\t}\n\n\t// Describes whether `LiveSelection` has own range(s) set, or if it is defaulted to\n\t// {@link module:engine/model/document~Document#_getDefaultRange document's default range}.\n\t//\n\t// @readonly\n\t// @type {Boolean}\n\tget hasOwnRange() {\n\t\treturn this._ranges.length > 0;\n\t}\n\n\t// When set to `true` then selection attributes on node before the caret won't be taken\n\t// into consideration while updating selection attributes.\n\t//\n\t// @protected\n\t// @type {Boolean}\n\tget isGravityOverridden() {\n\t\treturn !!this._overriddenGravityRegister.size;\n\t}\n\n\t// Unbinds all events previously bound by live selection.\n\tdestroy() {\n\t\tfor ( let i = 0; i < this._ranges.length; i++ ) {\n\t\t\tthis._ranges[ i ].detach();\n\t\t}\n\n\t\tthis.stopListening();\n\t}\n\n\t* getRanges() {\n\t\tif ( this._ranges.length ) {\n\t\t\tyield* super.getRanges();\n\t\t} else {\n\t\t\tyield this._document._getDefaultRange();\n\t\t}\n\t}\n\n\tgetFirstRange() {\n\t\treturn super.getFirstRange() || this._document._getDefaultRange();\n\t}\n\n\tgetLastRange() {\n\t\treturn super.getLastRange() || this._document._getDefaultRange();\n\t}\n\n\tsetTo( selectable, optionsOrPlaceOrOffset, options ) {\n\t\tsuper.setTo( selectable, optionsOrPlaceOrOffset, options );\n\t\tthis._updateAttributes( true );\n\t}\n\n\tsetFocus( itemOrPosition, offset ) {\n\t\tsuper.setFocus( itemOrPosition, offset );\n\t\tthis._updateAttributes( true );\n\t}\n\n\tsetAttribute( key, value ) {\n\t\tif ( this._setAttribute( key, value ) ) {\n\t\t\t// Fire event with exact data.\n\t\t\tconst attributeKeys = [ key ];\n\t\t\tthis.fire( 'change:attribute', { attributeKeys, directChange: true } );\n\t\t}\n\t}\n\n\tremoveAttribute( key ) {\n\t\tif ( this._removeAttribute( key ) ) {\n\t\t\t// Fire event with exact data.\n\t\t\tconst attributeKeys = [ key ];\n\t\t\tthis.fire( 'change:attribute', { attributeKeys, directChange: true } );\n\t\t}\n\t}\n\n\toverrideGravity() {\n\t\tconst overrideUid = uid();\n\n\t\t// Remember that another overriding has been requested. It will need to be removed\n\t\t// before the gravity is to be restored.\n\t\tthis._overriddenGravityRegister.add( overrideUid );\n\n\t\tif ( this._overriddenGravityRegister.size === 1 ) {\n\t\t\tthis._updateAttributes( true );\n\t\t}\n\n\t\treturn overrideUid;\n\t}\n\n\trestoreGravity( uid ) {\n\t\tif ( !this._overriddenGravityRegister.has( uid ) ) {\n\t\t\t/**\n\t\t\t * Restoring gravity for an unknown UID is not possible. Make sure you are using a correct\n\t\t\t * UID obtained from the {@link module:engine/model/writer~Writer#overrideSelectionGravity} to restore.\n\t\t\t *\n\t\t\t * @error document-selection-gravity-wrong-restore\n\t\t\t * @param {String} uid The unique identifier returned by\n\t\t\t * {@link module:engine/model/documentselection~DocumentSelection#_overrideGravity}.\n\t\t\t */\n\t\t\tthrow new CKEditorError(\n\t\t\t\t'document-selection-gravity-wrong-restore: Attempting to restore the selection gravity for an unknown UID.',\n\t\t\t\tthis,\n\t\t\t\t{ uid }\n\t\t\t);\n\t\t}\n\n\t\tthis._overriddenGravityRegister.delete( uid );\n\n\t\t// Restore gravity only when all overriding have been restored.\n\t\tif ( !this.isGravityOverridden ) {\n\t\t\tthis._updateAttributes( true );\n\t\t}\n\t}\n\n\t_popRange() {\n\t\tthis._ranges.pop().detach();\n\t}\n\n\t_pushRange( range ) {\n\t\tconst liveRange = this._prepareRange( range );\n\n\t\t// `undefined` is returned when given `range` is in graveyard root.\n\t\tif ( liveRange ) {\n\t\t\tthis._ranges.push( liveRange );\n\t\t}\n\t}\n\n\t// Prepares given range to be added to selection. Checks if it is correct,\n\t// converts it to {@link module:engine/model/liverange~LiveRange LiveRange}\n\t// and sets listeners listening to the range's change event.\n\t//\n\t// @private\n\t// @param {module:engine/model/range~Range} range\n\t_prepareRange( range ) {\n\t\tthis._checkRange( range );\n\n\t\tif ( range.root == this._document.graveyard ) {\n\t\t\t// @if CK_DEBUG // console.warn( 'Trying to add a Range that is in the graveyard root. Range rejected.' );\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst liveRange = LiveRange.fromRange( range );\n\n\t\tliveRange.on( 'change:range', ( evt, oldRange, data ) => {\n\t\t\tthis._hasChangedRange = true;\n\n\t\t\t// If `LiveRange` is in whole moved to the graveyard, save necessary data. It will be fixed on `Model#applyOperation` event.\n\t\t\tif ( liveRange.root == this._document.graveyard ) {\n\t\t\t\tthis._fixGraveyardRangesData.push( {\n\t\t\t\t\tliveRange,\n\t\t\t\t\tsourcePosition: data.deletionPosition\n\t\t\t\t} );\n\t\t\t}\n\t\t} );\n\n\t\treturn liveRange;\n\t}\n\n\t_updateMarkers() {\n\t\tconst markers = [];\n\n\t\tfor ( const marker of this._model.markers ) {\n\t\t\tconst markerRange = marker.getRange();\n\n\t\t\tfor ( const selectionRange of this.getRanges() ) {\n\t\t\t\tif ( markerRange.containsRange( selectionRange, !selectionRange.isCollapsed ) ) {\n\t\t\t\t\tmarkers.push( marker );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfor ( const marker of markers ) {\n\t\t\tif ( !this.markers.has( marker ) ) {\n\t\t\t\tthis.markers.add( marker );\n\t\t\t}\n\t\t}\n\n\t\tfor ( const marker of Array.from( this.markers ) ) {\n\t\t\tif ( !markers.includes( marker ) ) {\n\t\t\t\tthis.markers.remove( marker );\n\t\t\t}\n\t\t}\n\t}\n\n\t// Updates this selection attributes according to its ranges and the {@link module:engine/model/document~Document model document}.\n\t//\n\t// @protected\n\t// @param {Boolean} clearAll\n\t// @fires change:attribute\n\t_updateAttributes( clearAll ) {\n\t\tconst newAttributes = toMap( this._getSurroundingAttributes() );\n\t\tconst oldAttributes = toMap( this.getAttributes() );\n\n\t\tif ( clearAll ) {\n\t\t\t// If `clearAll` remove all attributes and reset priorities.\n\t\t\tthis._attributePriority = new Map();\n\t\t\tthis._attrs = new Map();\n\t\t} else {\n\t\t\t// If not, remove only attributes added with `low` priority.\n\t\t\tfor ( const [ key, priority ] of this._attributePriority ) {\n\t\t\t\tif ( priority == 'low' ) {\n\t\t\t\t\tthis._attrs.delete( key );\n\t\t\t\t\tthis._attributePriority.delete( key );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis._setAttributesTo( newAttributes );\n\n\t\t// Let's evaluate which attributes really changed.\n\t\tconst changed = [];\n\n\t\t// First, loop through all attributes that are set on selection right now.\n\t\t// Check which of them are different than old attributes.\n\t\tfor ( const [ newKey, newValue ] of this.getAttributes() ) {\n\t\t\tif ( !oldAttributes.has( newKey ) || oldAttributes.get( newKey ) !== newValue ) {\n\t\t\t\tchanged.push( newKey );\n\t\t\t}\n\t\t}\n\n\t\t// Then, check which of old attributes got removed.\n\t\tfor ( const [ oldKey ] of oldAttributes ) {\n\t\t\tif ( !this.hasAttribute( oldKey ) ) {\n\t\t\t\tchanged.push( oldKey );\n\t\t\t}\n\t\t}\n\n\t\t// Fire event with exact data (fire only if anything changed).\n\t\tif ( changed.length > 0 ) {\n\t\t\tthis.fire( 'change:attribute', { attributeKeys: changed, directChange: false } );\n\t\t}\n\t}\n\n\t// Internal method for setting `LiveSelection` attribute. Supports attribute priorities (through `directChange`\n\t// parameter).\n\t//\n\t// @private\n\t// @param {String} key Attribute key.\n\t// @param {*} value Attribute value.\n\t// @param {Boolean} [directChange=true] `true` if the change is caused by `Selection` API, `false` if change\n\t// is caused by `Batch` API.\n\t// @returns {Boolean} Whether value has changed.\n\t_setAttribute( key, value, directChange = true ) {\n\t\tconst priority = directChange ? 'normal' : 'low';\n\n\t\tif ( priority == 'low' && this._attributePriority.get( key ) == 'normal' ) {\n\t\t\t// Priority too low.\n\t\t\treturn false;\n\t\t}\n\n\t\tconst oldValue = super.getAttribute( key );\n\n\t\t// Don't do anything if value has not changed.\n\t\tif ( oldValue === value ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tthis._attrs.set( key, value );\n\n\t\t// Update priorities map.\n\t\tthis._attributePriority.set( key, priority );\n\n\t\treturn true;\n\t}\n\n\t// Internal method for removing `LiveSelection` attribute. Supports attribute priorities (through `directChange`\n\t// parameter).\n\t//\n\t// NOTE: Even if attribute is not present in the selection but is provided to this method, it's priority will\n\t// be changed according to `directChange` parameter.\n\t//\n\t// @private\n\t// @param {String} key Attribute key.\n\t// @param {Boolean} [directChange=true] `true` if the change is caused by `Selection` API, `false` if change\n\t// is caused by `Batch` API.\n\t// @returns {Boolean} Whether attribute was removed. May not be true if such attributes didn't exist or the\n\t// existing attribute had higher priority.\n\t_removeAttribute( key, directChange = true ) {\n\t\tconst priority = directChange ? 'normal' : 'low';\n\n\t\tif ( priority == 'low' && this._attributePriority.get( key ) == 'normal' ) {\n\t\t\t// Priority too low.\n\t\t\treturn false;\n\t\t}\n\n\t\t// Update priorities map.\n\t\tthis._attributePriority.set( key, priority );\n\n\t\t// Don't do anything if value has not changed.\n\t\tif ( !super.hasAttribute( key ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tthis._attrs.delete( key );\n\n\t\treturn true;\n\t}\n\n\t// Internal method for setting multiple `LiveSelection` attributes. Supports attribute priorities (through\n\t// `directChange` parameter).\n\t//\n\t// @private\n\t// @param {Map.<String,*>} attrs Iterable object containing attributes to be set.\n\t// @returns {Set.<String>} Changed attribute keys.\n\t_setAttributesTo( attrs ) {\n\t\tconst changed = new Set();\n\n\t\tfor ( const [ oldKey, oldValue ] of this.getAttributes() ) {\n\t\t\t// Do not remove attribute if attribute with same key and value is about to be set.\n\t\t\tif ( attrs.get( oldKey ) === oldValue ) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// All rest attributes will be removed so changed attributes won't change .\n\t\t\tthis._removeAttribute( oldKey, false );\n\t\t}\n\n\t\tfor ( const [ key, value ] of attrs ) {\n\t\t\t// Attribute may not be set because of attributes or because same key/value is already added.\n\t\t\tconst gotAdded = this._setAttribute( key, value, false );\n\n\t\t\tif ( gotAdded ) {\n\t\t\t\tchanged.add( key );\n\t\t\t}\n\t\t}\n\n\t\treturn changed;\n\t}\n\n\t// Returns an iterable that iterates through all selection attributes stored in current selection's parent.\n\t//\n\t// @protected\n\t// @returns {Iterable.<*>}\n\t* _getStoredAttributes() {\n\t\tconst selectionParent = this.getFirstPosition().parent;\n\n\t\tif ( this.isCollapsed && selectionParent.isEmpty ) {\n\t\t\tfor ( const key of selectionParent.getAttributeKeys() ) {\n\t\t\t\tif ( key.startsWith( storePrefix ) ) {\n\t\t\t\t\tconst realKey = key.substr( storePrefix.length );\n\n\t\t\t\t\tyield [ realKey, selectionParent.getAttribute( key ) ];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Checks model text nodes that are closest to the selection's first position and returns attributes of first\n\t// found element. If there are no text nodes in selection's first position parent, it returns selection\n\t// attributes stored in that parent.\n\t//\n\t// @private\n\t// @returns {Iterable.<*>} Collection of attributes.\n\t_getSurroundingAttributes() {\n\t\tconst position = this.getFirstPosition();\n\t\tconst schema = this._model.schema;\n\n\t\tlet attrs = null;\n\n\t\tif ( !this.isCollapsed ) {\n\t\t\t// 1. If selection is a range...\n\t\t\tconst range = this.getFirstRange();\n\n\t\t\t// ...look for a first character node in that range and take attributes from it.\n\t\t\tfor ( const value of range ) {\n\t\t\t\t// If the item is an object, we don't want to get attributes from its children.\n\t\t\t\tif ( value.item.is( 'element' ) && schema.isObject( value.item ) ) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tif ( value.type == 'text' ) {\n\t\t\t\t\tattrs = value.item.getAttributes();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// 2. If the selection is a caret or the range does not contain a character node...\n\n\t\t\tconst nodeBefore = position.textNode ? position.textNode : position.nodeBefore;\n\t\t\tconst nodeAfter = position.textNode ? position.textNode : position.nodeAfter;\n\n\t\t\t// When gravity is overridden then don't take node before into consideration.\n\t\t\tif ( !this.isGravityOverridden ) {\n\t\t\t\t// ...look at the node before caret and take attributes from it if it is a character node.\n\t\t\t\tattrs = getAttrsIfCharacter( nodeBefore );\n\t\t\t}\n\n\t\t\t// 3. If not, look at the node after caret...\n\t\t\tif ( !attrs ) {\n\t\t\t\tattrs = getAttrsIfCharacter( nodeAfter );\n\t\t\t}\n\n\t\t\t// 4. If not, try to find the first character on the left, that is in the same node.\n\t\t\t// When gravity is overridden then don't take node before into consideration.\n\t\t\tif ( !this.isGravityOverridden && !attrs ) {\n\t\t\t\tlet node = nodeBefore;\n\n\t\t\t\twhile ( node && !attrs ) {\n\t\t\t\t\tnode = node.previousSibling;\n\t\t\t\t\tattrs = getAttrsIfCharacter( node );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// 5. If not found, try to find the first character on the right, that is in the same node.\n\t\t\tif ( !attrs ) {\n\t\t\t\tlet node = nodeAfter;\n\n\t\t\t\twhile ( node && !attrs ) {\n\t\t\t\t\tnode = node.nextSibling;\n\t\t\t\t\tattrs = getAttrsIfCharacter( node );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// 6. If not found, selection should retrieve attributes from parent.\n\t\t\tif ( !attrs ) {\n\t\t\t\tattrs = this._getStoredAttributes();\n\t\t\t}\n\t\t}\n\n\t\treturn attrs;\n\t}\n\n\t// Fixes a selection range after it ends up in graveyard root.\n\t//\n\t// @private\n\t// @param {module:engine/model/liverange~LiveRange} liveRange The range from selection, that ended up in the graveyard root.\n\t// @param {module:engine/model/position~Position} removedRangeStart Start position of a range which was removed.\n\t_fixGraveyardSelection( liveRange, removedRangeStart ) {\n\t\t// The start of the removed range is the closest position to the `liveRange` - the original selection range.\n\t\t// This is a good candidate for a fixed selection range.\n\t\tconst positionCandidate = removedRangeStart.clone();\n\n\t\t// Find a range that is a correct selection range and is closest to the start of removed range.\n\t\tconst selectionRange = this._model.schema.getNearestSelectionRange( positionCandidate );\n\n\t\t// Remove the old selection range before preparing and adding new selection range. This order is important,\n\t\t// because new range, in some cases, may intersect with old range (it depends on `getNearestSelectionRange()` result).\n\t\tconst index = this._ranges.indexOf( liveRange );\n\t\tthis._ranges.splice( index, 1 );\n\t\tliveRange.detach();\n\n\t\t// If nearest valid selection range has been found - add it in the place of old range.\n\t\tif ( selectionRange ) {\n\t\t\t// Check the range, convert it to live range, bind events, etc.\n\t\t\tconst newRange = this._prepareRange( selectionRange );\n\n\t\t\t// Add new range in the place of old range.\n\t\t\tthis._ranges.splice( index, 0, newRange );\n\t\t}\n\t\t// If nearest valid selection range cannot be found - just removing the old range is fine.\n\t}\n}\n\n// Helper function for {@link module:engine/model/liveselection~LiveSelection#_updateAttributes}.\n//\n// It takes model item, checks whether it is a text node (or text proxy) and, if so, returns it's attributes. If not, returns `null`.\n//\n// @param {module:engine/model/item~Item|null}  node\n// @returns {Boolean}\nfunction getAttrsIfCharacter( node ) {\n\tif ( node instanceof TextProxy || node instanceof Text ) {\n\t\treturn node.getAttributes();\n\t}\n\n\treturn null;\n}\n\n// Removes selection attributes from element which is not empty anymore.\n//\n// @private\n// @param {module:engine/model/model~Model} model\n// @param {module:engine/model/batch~Batch} batch\nfunction clearAttributesStoredInElement( model, batch ) {\n\tconst differ = model.document.differ;\n\n\tfor ( const entry of differ.getChanges() ) {\n\t\tif ( entry.type != 'insert' ) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst changeParent = entry.position.parent;\n\t\tconst isNoLongerEmpty = entry.length === changeParent.maxOffset;\n\n\t\tif ( isNoLongerEmpty ) {\n\t\t\tmodel.enqueueChange( batch, writer => {\n\t\t\t\tconst storedAttributes = Array.from( changeParent.getAttributeKeys() )\n\t\t\t\t\t.filter( key => key.startsWith( storePrefix ) );\n\n\t\t\t\tfor ( const key of storedAttributes ) {\n\t\t\t\t\twriter.removeAttribute( key, changeParent );\n\t\t\t\t}\n\t\t\t} );\n\t\t}\n\t}\n}\n"]}]}