{"remainingRequest":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/babel-loader/lib/index.js!/Users/antonyching/Desktop/project/new-builder-demo/node_modules/@ckeditor/ckeditor5-engine/src/view/renderer.js","dependencies":[{"path":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/@ckeditor/ckeditor5-engine/src/view/renderer.js","mtime":499162500000},{"path":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/@ckeditor/ckeditor5-dev-webpack-plugin/lib/translatesourceloader.js","mtime":499162500000},{"path":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/antonyching/Desktop/project/new-builder-demo/node_modules/babel-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:LyoqCiAqIEBsaWNlbnNlIENvcHlyaWdodCAoYykgMjAwMy0yMDE5LCBDS1NvdXJjZSAtIEZyZWRlcmljbyBLbmFiYmVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBGb3IgbGljZW5zaW5nLCBzZWUgTElDRU5TRS5tZCBvciBodHRwczovL2NrZWRpdG9yLmNvbS9sZWdhbC9ja2VkaXRvci1vc3MtbGljZW5zZQogKi8KCi8qIGdsb2JhbHMgTm9kZSAqLwoKLyoqCiAqIEBtb2R1bGUgZW5naW5lL3ZpZXcvcmVuZGVyZXIKICovCmltcG9ydCBWaWV3VGV4dCBmcm9tICcuL3RleHQnOwppbXBvcnQgVmlld1Bvc2l0aW9uIGZyb20gJy4vcG9zaXRpb24nOwppbXBvcnQgeyBJTkxJTkVfRklMTEVSLCBJTkxJTkVfRklMTEVSX0xFTkdUSCwgc3RhcnRzV2l0aEZpbGxlciwgaXNJbmxpbmVGaWxsZXIgfSBmcm9tICcuL2ZpbGxlcic7CmltcG9ydCBtaXggZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11dGlscy9zcmMvbWl4JzsKaW1wb3J0IGRpZmYgZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11dGlscy9zcmMvZGlmZic7CmltcG9ydCBpbnNlcnRBdCBmcm9tICdAY2tlZGl0b3IvY2tlZGl0b3I1LXV0aWxzL3NyYy9kb20vaW5zZXJ0YXQnOwppbXBvcnQgcmVtb3ZlIGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2RvbS9yZW1vdmUnOwppbXBvcnQgT2JzZXJ2YWJsZU1peGluIGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL29ic2VydmFibGVtaXhpbic7CmltcG9ydCBDS0VkaXRvckVycm9yIGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2NrZWRpdG9yZXJyb3InOwppbXBvcnQgaXNUZXh0IGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2RvbS9pc3RleHQnOwppbXBvcnQgaXNOb2RlIGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2RvbS9pc25vZGUnOwppbXBvcnQgZmFzdERpZmYgZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11dGlscy9zcmMvZmFzdGRpZmYnOwppbXBvcnQgZW52IGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2Vudic7Ci8qKgogKiBSZW5kZXJlciBpcyByZXNwb25zaWJsZSBmb3IgdXBkYXRpbmcgdGhlIERPTSBzdHJ1Y3R1cmUgYW5kIHRoZSBET00gc2VsZWN0aW9uIGJhc2VkIG9uCiAqIHRoZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS92aWV3L3JlbmRlcmVyflJlbmRlcmVyI21hcmtUb1N5bmMgaW5mb3JtYXRpb24gYWJvdXQgdXBkYXRlZCB2aWV3IG5vZGVzfS4KICogSW4gb3RoZXIgd29yZHMsIGl0IHJlbmRlcnMgdGhlIHZpZXcgdG8gdGhlIERPTS4KICoKICogSXRzIG1haW4gcmVzcG9uc2liaWxpdHkgaXMgdG8gbWFrZSBvbmx5IHRoZSBuZWNlc3NhcnksIG1pbmltYWwgY2hhbmdlcyB0byB0aGUgRE9NLiBIb3dldmVyLCB1bmxpa2UgaW4gbWFueQogKiB2aXJ0dWFsIERPTSBpbXBsZW1lbnRhdGlvbnMsIHRoZSBwcmltYXJ5IHJlYXNvbiBmb3IgZG9pbmcgbWluaW1hbCBjaGFuZ2VzIGlzIG5vdCB0aGUgcGVyZm9ybWFuY2UgYnV0IGVuc3VyaW5nCiAqIHRoYXQgbmF0aXZlIGVkaXRpbmcgZmVhdHVyZXMgc3VjaCBhcyB0ZXh0IGNvbXBvc2l0aW9uLCBhdXRvY29tcGxldGlvbiwgc3BlbGwgY2hlY2tpbmcsIHNlbGVjdGlvbidzIHgtaW5kZXggYXJlCiAqIGFmZmVjdGVkIGFzIGxpdHRsZSBhcyBwb3NzaWJsZS4KICoKICogUmVuZGVyZXIgdXNlcyB7QGxpbmsgbW9kdWxlOmVuZ2luZS92aWV3L2RvbWNvbnZlcnRlcn5Eb21Db252ZXJ0ZXJ9IHRvIHRyYW5zZm9ybSB2aWV3IG5vZGVzIGFuZCBwb3NpdGlvbnMKICogdG8gYW5kIGZyb20gdGhlIERPTS4KICovCgpleHBvcnQgZGVmYXVsdCBjbGFzcyBSZW5kZXJlciB7CiAgLyoqCiAgICogQ3JlYXRlcyBhIHJlbmRlcmVyIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvZG9tY29udmVydGVyfkRvbUNvbnZlcnRlcn0gZG9tQ29udmVydGVyIENvbnZlcnRlciBpbnN0YW5jZS4KICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9kb2N1bWVudHNlbGVjdGlvbn5Eb2N1bWVudFNlbGVjdGlvbn0gc2VsZWN0aW9uIFZpZXcgc2VsZWN0aW9uLgogICAqLwogIGNvbnN0cnVjdG9yKGRvbUNvbnZlcnRlciwgc2VsZWN0aW9uKSB7CiAgICAvKioKICAgICAqIFNldCBvZiBET00gRG9jdW1lbnRzIGluc3RhbmNlcy4KICAgICAqCiAgICAgKiBAcmVhZG9ubHkKICAgICAqIEBtZW1iZXIge1NldC48RG9jdW1lbnQ+fQogICAgICovCiAgICB0aGlzLmRvbURvY3VtZW50cyA9IG5ldyBTZXQoKTsKICAgIC8qKgogICAgICogQ29udmVydGVyIGluc3RhbmNlLgogICAgICoKICAgICAqIEByZWFkb25seQogICAgICogQG1lbWJlciB7bW9kdWxlOmVuZ2luZS92aWV3L2RvbWNvbnZlcnRlcn5Eb21Db252ZXJ0ZXJ9CiAgICAgKi8KCiAgICB0aGlzLmRvbUNvbnZlcnRlciA9IGRvbUNvbnZlcnRlcjsKICAgIC8qKgogICAgICogU2V0IG9mIG5vZGVzIHdoaWNoIGF0dHJpYnV0ZXMgY2hhbmdlZCBhbmQgbWF5IG5lZWQgdG8gYmUgcmVuZGVyZWQuCiAgICAgKgogICAgICogQHJlYWRvbmx5CiAgICAgKiBAbWVtYmVyIHtTZXQuPG1vZHVsZTplbmdpbmUvdmlldy9ub2Rlfk5vZGU+fQogICAgICovCgogICAgdGhpcy5tYXJrZWRBdHRyaWJ1dGVzID0gbmV3IFNldCgpOwogICAgLyoqCiAgICAgKiBTZXQgb2YgZWxlbWVudHMgd2hpY2ggY2hpbGQgbGlzdHMgY2hhbmdlZCBhbmQgbWF5IG5lZWQgdG8gYmUgcmVuZGVyZWQuCiAgICAgKgogICAgICogQHJlYWRvbmx5CiAgICAgKiBAbWVtYmVyIHtTZXQuPG1vZHVsZTplbmdpbmUvdmlldy9ub2Rlfk5vZGU+fQogICAgICovCgogICAgdGhpcy5tYXJrZWRDaGlsZHJlbiA9IG5ldyBTZXQoKTsKICAgIC8qKgogICAgICogU2V0IG9mIHRleHQgbm9kZXMgd2hpY2ggdGV4dCBkYXRhIGNoYW5nZWQgYW5kIG1heSBuZWVkIHRvIGJlIHJlbmRlcmVkLgogICAgICoKICAgICAqIEByZWFkb25seQogICAgICogQG1lbWJlciB7U2V0Ljxtb2R1bGU6ZW5naW5lL3ZpZXcvbm9kZX5Ob2RlPn0KICAgICAqLwoKICAgIHRoaXMubWFya2VkVGV4dHMgPSBuZXcgU2V0KCk7CiAgICAvKioKICAgICAqIFZpZXcgc2VsZWN0aW9uLiBSZW5kZXJlciB1cGRhdGVzIERPTSBzZWxlY3Rpb24gYmFzZWQgb24gdGhlIHZpZXcgc2VsZWN0aW9uLgogICAgICoKICAgICAqIEByZWFkb25seQogICAgICogQG1lbWJlciB7bW9kdWxlOmVuZ2luZS92aWV3L2RvY3VtZW50c2VsZWN0aW9ufkRvY3VtZW50U2VsZWN0aW9ufQogICAgICovCgogICAgdGhpcy5zZWxlY3Rpb24gPSBzZWxlY3Rpb247CiAgICAvKioKICAgICAqIEluZGljYXRlcyBpZiB0aGUgdmlldyBkb2N1bWVudCBpcyBmb2N1c2VkIGFuZCBzZWxlY3Rpb24gY2FuIGJlIHJlbmRlcmVkLiBTZWxlY3Rpb24gd2lsbCBub3QgYmUgcmVuZGVyZWQgaWYKICAgICAqIHRoaXMgaXMgc2V0IHRvIGBmYWxzZWAuCiAgICAgKgogICAgICogQG1lbWJlciB7Qm9vbGVhbn0KICAgICAqLwoKICAgIHRoaXMuaXNGb2N1c2VkID0gZmFsc2U7CiAgICAvKioKICAgICAqIFRoZSB0ZXh0IG5vZGUgaW4gd2hpY2ggdGhlIGlubGluZSBmaWxsZXIgd2FzIHJlbmRlcmVkLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAbWVtYmVyIHtUZXh0fQogICAgICovCgogICAgdGhpcy5faW5saW5lRmlsbGVyID0gbnVsbDsKICAgIC8qKgogICAgICogRE9NIGVsZW1lbnQgY29udGFpbmluZyBmYWtlIHNlbGVjdGlvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHR5cGUge251bGx8SFRNTEVsZW1lbnR9CiAgICAgKi8KCiAgICB0aGlzLl9mYWtlU2VsZWN0aW9uQ29udGFpbmVyID0gbnVsbDsKICB9CiAgLyoqCiAgICogTWFya3MgYSB2aWV3IG5vZGUgdG8gYmUgdXBkYXRlZCBpbiB0aGUgRE9NIGJ5IHtAbGluayAjcmVuZGVyIGByZW5kZXIoKWB9LgogICAqCiAgICogTm90ZSB0aGF0IG9ubHkgdmlldyBub2RlcyB3aG9zZSBwYXJlbnRzIGhhdmUgY29ycmVzcG9uZGluZyBET00gZWxlbWVudHMgbmVlZCB0byBiZSBtYXJrZWQgdG8gYmUgc3luY2hyb25pemVkLgogICAqCiAgICogQHNlZSAjbWFya2VkQXR0cmlidXRlcwogICAqIEBzZWUgI21hcmtlZENoaWxkcmVuCiAgICogQHNlZSAjbWFya2VkVGV4dHMKICAgKgogICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS92aWV3L2RvY3VtZW50fkNoYW5nZVR5cGV9IHR5cGUgVHlwZSBvZiB0aGUgY2hhbmdlLgogICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS92aWV3L25vZGV+Tm9kZX0gbm9kZSBOb2RlIHRvIGJlIG1hcmtlZC4KICAgKi8KCgogIG1hcmtUb1N5bmModHlwZSwgbm9kZSkgewogICAgaWYgKHR5cGUgPT09ICd0ZXh0JykgewogICAgICBpZiAodGhpcy5kb21Db252ZXJ0ZXIubWFwVmlld1RvRG9tKG5vZGUucGFyZW50KSkgewogICAgICAgIHRoaXMubWFya2VkVGV4dHMuYWRkKG5vZGUpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBJZiB0aGUgbm9kZSBoYXMgbm8gRE9NIGVsZW1lbnQgaXQgaXMgbm90IHJlbmRlcmVkIHlldCwKICAgICAgLy8gaXRzIGNoaWxkcmVuL2F0dHJpYnV0ZXMgZG8gbm90IG5lZWQgdG8gYmUgbWFya2VkIHRvIGJlIHN5bmMuCiAgICAgIGlmICghdGhpcy5kb21Db252ZXJ0ZXIubWFwVmlld1RvRG9tKG5vZGUpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAodHlwZSA9PT0gJ2F0dHJpYnV0ZXMnKSB7CiAgICAgICAgdGhpcy5tYXJrZWRBdHRyaWJ1dGVzLmFkZChub2RlKTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnY2hpbGRyZW4nKSB7CiAgICAgICAgdGhpcy5tYXJrZWRDaGlsZHJlbi5hZGQobm9kZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLyoqCiAgICAgICAgICogVW5rbm93biB0eXBlIHBhc3NlZCB0byBSZW5kZXJlci5tYXJrVG9TeW5jLgogICAgICAgICAqCiAgICAgICAgICogQGVycm9yIHJlbmRlcmVyLXVua25vd24tdHlwZQogICAgICAgICAqLwogICAgICAgIHRocm93IG5ldyBDS0VkaXRvckVycm9yKCd2aWV3LXJlbmRlcmVyLXVua25vd24tdHlwZTogVW5rbm93biB0eXBlIHBhc3NlZCB0byBSZW5kZXJlci5tYXJrVG9TeW5jLicsIHRoaXMpOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIFJlbmRlcnMgYWxsIGJ1ZmZlcmVkIGNoYW5nZXMgKHtAbGluayAjbWFya2VkQXR0cmlidXRlc30sIHtAbGluayAjbWFya2VkQ2hpbGRyZW59IGFuZCB7QGxpbmsgI21hcmtlZFRleHRzfSkgYW5kCiAgICogdGhlIGN1cnJlbnQgdmlldyBzZWxlY3Rpb24gKGlmIG5lZWRlZCkgdG8gdGhlIERPTSBieSBhcHBseWluZyBhIG1pbmltYWwgc2V0IG9mIGNoYW5nZXMgdG8gaXQuCiAgICoKICAgKiBSZW5kZXJlciB0cmllcyBub3QgdG8gYnJlYWsgdGhlIHRleHQgY29tcG9zaXRpb24gKGUuZy4gSU1FKSBhbmQgeC1pbmRleCBvZiB0aGUgc2VsZWN0aW9uLAogICAqIHNvIGl0IGRvZXMgYXMgbGl0dGxlIGFzIGl0IGlzIG5lZWRlZCB0byB1cGRhdGUgdGhlIERPTS4KICAgKgogICAqIFJlbmRlcmVyIGFsc28gaGFuZGxlcyB7QGxpbmsgbW9kdWxlOmVuZ2luZS92aWV3L2ZpbGxlciBmaWxsZXJzfS4gRXNwZWNpYWxseSwgaXQgY2hlY2tzIGlmIHRoZSBpbmxpbmUgZmlsbGVyIGlzIG5lZWRlZAogICAqIGF0IHRoZSBzZWxlY3Rpb24gcG9zaXRpb24gYW5kIGFkZHMgb3IgcmVtb3ZlcyBpdC4gVG8gcHJldmVudCBicmVha2luZyB0ZXh0IGNvbXBvc2l0aW9uIGlubGluZSBmaWxsZXIgd2lsbCBub3QgYmUKICAgKiByZW1vdmVkIGFzIGxvbmcgYXMgdGhlIHNlbGVjdGlvbiBpcyBpbiB0aGUgdGV4dCBub2RlIHdoaWNoIG5lZWRlZCBpdCBhdCBmaXJzdC4KICAgKi8KCgogIHJlbmRlcigpIHsKICAgIGxldCBpbmxpbmVGaWxsZXJQb3NpdGlvbjsgLy8gUmVmcmVzaCBtYXBwaW5ncy4KCiAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgdGhpcy5tYXJrZWRDaGlsZHJlbikgewogICAgICB0aGlzLl91cGRhdGVDaGlsZHJlbk1hcHBpbmdzKGVsZW1lbnQpOwogICAgfSAvLyBUaGVyZSB3YXMgaW5saW5lIGZpbGxlciByZW5kZXJlZCBpbiB0aGUgRE9NIGJ1dCBpdCdzIG5vdAogICAgLy8gYXQgdGhlIHNlbGVjdGlvbiBwb3NpdGlvbiBhbnkgbW9yZSwgc28gd2UgY2FuIHJlbW92ZSBpdAogICAgLy8gKGNhdXNlIGV2ZW4gaWYgaXQncyBuZWVkZWQsIGl0IG11c3QgYmUgcGxhY2VkIGluIGFub3RoZXIgbG9jYXRpb24pLgoKCiAgICBpZiAodGhpcy5faW5saW5lRmlsbGVyICYmICF0aGlzLl9pc1NlbGVjdGlvbkluSW5saW5lRmlsbGVyKCkpIHsKICAgICAgdGhpcy5fcmVtb3ZlSW5saW5lRmlsbGVyKCk7CiAgICB9IC8vIElmIHdlJ3ZlIGdvdCB0aGUgZmlsbGVyLCBsZXQncyB0cnkgdG8gZ3Vlc3MgaXRzIHBvc2l0aW9uIGluIHRoZSB2aWV3LgoKCiAgICBpZiAodGhpcy5faW5saW5lRmlsbGVyKSB7CiAgICAgIGlubGluZUZpbGxlclBvc2l0aW9uID0gdGhpcy5fZ2V0SW5saW5lRmlsbGVyUG9zaXRpb24oKTsKICAgIH0gLy8gT3RoZXJ3aXNlLCBpZiBpdCdzIG5lZWRlZCwgY3JlYXRlIGl0IGF0IHRoZSBzZWxlY3Rpb24gcG9zaXRpb24uCiAgICBlbHNlIGlmICh0aGlzLl9uZWVkc0lubGluZUZpbGxlckF0U2VsZWN0aW9uKCkpIHsKICAgICAgICBpbmxpbmVGaWxsZXJQb3NpdGlvbiA9IHRoaXMuc2VsZWN0aW9uLmdldEZpcnN0UG9zaXRpb24oKTsgLy8gRG8gbm90IHVzZSBgbWFya1RvU3luY2Agc28gaXQgd2lsbCBiZSBhZGRlZCBldmVuIGlmIHRoZSBwYXJlbnQgaXMgYWxyZWFkeSBhZGRlZC4KCiAgICAgICAgdGhpcy5tYXJrZWRDaGlsZHJlbi5hZGQoaW5saW5lRmlsbGVyUG9zaXRpb24ucGFyZW50KTsKICAgICAgfQoKICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiB0aGlzLm1hcmtlZEF0dHJpYnV0ZXMpIHsKICAgICAgdGhpcy5fdXBkYXRlQXR0cnMoZWxlbWVudCk7CiAgICB9CgogICAgZm9yIChjb25zdCBlbGVtZW50IG9mIHRoaXMubWFya2VkQ2hpbGRyZW4pIHsKICAgICAgdGhpcy5fdXBkYXRlQ2hpbGRyZW4oZWxlbWVudCwgewogICAgICAgIGlubGluZUZpbGxlclBvc2l0aW9uCiAgICAgIH0pOwogICAgfQoKICAgIGZvciAoY29uc3Qgbm9kZSBvZiB0aGlzLm1hcmtlZFRleHRzKSB7CiAgICAgIGlmICghdGhpcy5tYXJrZWRDaGlsZHJlbi5oYXMobm9kZS5wYXJlbnQpICYmIHRoaXMuZG9tQ29udmVydGVyLm1hcFZpZXdUb0RvbShub2RlLnBhcmVudCkpIHsKICAgICAgICB0aGlzLl91cGRhdGVUZXh0KG5vZGUsIHsKICAgICAgICAgIGlubGluZUZpbGxlclBvc2l0aW9uCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gLy8gQ2hlY2sgd2hldGhlciB0aGUgaW5saW5lIGZpbGxlciBpcyByZXF1aXJlZCBhbmQgd2hlcmUgaXQgcmVhbGx5IGlzIGluIHRoZSBET00uCiAgICAvLyBBdCB0aGlzIHBvaW50IGluIG1vc3QgY2FzZXMgaXQgd2lsbCBiZSBpbiB0aGUgRE9NLCBidXQgdGhlcmUgYXJlIGV4Y2VwdGlvbnMuCiAgICAvLyBGb3IgZXhhbXBsZSwgaWYgdGhlIGlubGluZSBmaWxsZXIgd2FzIGRlZXAgaW4gdGhlIGNyZWF0ZWQgRE9NIHN0cnVjdHVyZSwgaXQgd2lsbCBub3QgYmUgY3JlYXRlZC4KICAgIC8vIFNpbWlsYXJseSwgaWYgaXQgd2FzIHJlbW92ZWQgYXQgdGhlIGJlZ2lubmluZyBvZiB0aGlzIGZ1bmN0aW9uIGFuZCB0aGVuIG5laXRoZXIgdGV4dCBub3IgY2hpbGRyZW4gd2VyZSB1cGRhdGVkLAogICAgLy8gaXQgd2lsbCBub3QgYmUgcHJlc2VudC4KICAgIC8vIEZpeCB0aG9zZSBhbmQgc2ltaWxhciBzY2VuYXJpb3MuCgoKICAgIGlmIChpbmxpbmVGaWxsZXJQb3NpdGlvbikgewogICAgICBjb25zdCBmaWxsZXJEb21Qb3NpdGlvbiA9IHRoaXMuZG9tQ29udmVydGVyLnZpZXdQb3NpdGlvblRvRG9tKGlubGluZUZpbGxlclBvc2l0aW9uKTsKICAgICAgY29uc3QgZG9tRG9jdW1lbnQgPSBmaWxsZXJEb21Qb3NpdGlvbi5wYXJlbnQub3duZXJEb2N1bWVudDsKCiAgICAgIGlmICghc3RhcnRzV2l0aEZpbGxlcihmaWxsZXJEb21Qb3NpdGlvbi5wYXJlbnQpKSB7CiAgICAgICAgLy8gRmlsbGVyIGhhcyBub3QgYmVlbiBjcmVhdGVkIGF0IGZpbGxlciBwb3NpdGlvbi4gQ3JlYXRlIGl0IG5vdy4KICAgICAgICB0aGlzLl9pbmxpbmVGaWxsZXIgPSBhZGRJbmxpbmVGaWxsZXIoZG9tRG9jdW1lbnQsIGZpbGxlckRvbVBvc2l0aW9uLnBhcmVudCwgZmlsbGVyRG9tUG9zaXRpb24ub2Zmc2V0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBGaWxsZXIgaGFzIGJlZW4gZm91bmQsIHNhdmUgaXQuCiAgICAgICAgdGhpcy5faW5saW5lRmlsbGVyID0gZmlsbGVyRG9tUG9zaXRpb24ucGFyZW50OwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBUaGVyZSBpcyBubyBmaWxsZXIgbmVlZGVkLgogICAgICB0aGlzLl9pbmxpbmVGaWxsZXIgPSBudWxsOwogICAgfQoKICAgIHRoaXMuX3VwZGF0ZVNlbGVjdGlvbigpOwoKICAgIHRoaXMuX3VwZGF0ZUZvY3VzKCk7CgogICAgdGhpcy5tYXJrZWRUZXh0cy5jbGVhcigpOwogICAgdGhpcy5tYXJrZWRBdHRyaWJ1dGVzLmNsZWFyKCk7CiAgICB0aGlzLm1hcmtlZENoaWxkcmVuLmNsZWFyKCk7CiAgfQogIC8qKgogICAqIFVwZGF0ZXMgbWFwcGluZ3Mgb2YgdmlldyBlbGVtZW50J3MgY2hpbGRyZW4uCiAgICoKICAgKiBDaGlsZHJlbiB0aGF0IHdlcmUgcmVwbGFjZWQgaW4gdGhlIHZpZXcgc3RydWN0dXJlIGJ5IHNpbWlsYXIgZWxlbWVudHMgKHNhbWUgdGFnIG5hbWUpIGFyZSB0cmVhdGVkIGFzICdyZXBsYWNlZCcuCiAgICogVGhpcyBtZWFucyB0aGF0IHRoZWlyIG1hcHBpbmdzIGNhbiBiZSB1cGRhdGVkIHNvIHRoZSBuZXcgdmlldyBlbGVtZW50cyBhcmUgbWFwcGVkIHRvIHRoZSBleGlzdGluZyBET00gZWxlbWVudHMuCiAgICogVGhhbmtzIHRvIHRoYXQgdGhlc2UgZWxlbWVudHMgZG8gbm90IG5lZWQgdG8gYmUgcmUtcmVuZGVyZWQgY29tcGxldGVseS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvbm9kZX5Ob2RlfSB2aWV3RWxlbWVudCBUaGUgdmlldyBlbGVtZW50IHdob3NlIGNoaWxkcmVuIG1hcHBpbmdzIHdpbGwgYmUgdXBkYXRlZC4KICAgKi8KCgogIF91cGRhdGVDaGlsZHJlbk1hcHBpbmdzKHZpZXdFbGVtZW50KSB7CiAgICBjb25zdCBkb21FbGVtZW50ID0gdGhpcy5kb21Db252ZXJ0ZXIubWFwVmlld1RvRG9tKHZpZXdFbGVtZW50KTsKCiAgICBpZiAoIWRvbUVsZW1lbnQpIHsKICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gYGRvbUVsZW1lbnRgIGl0IG1lYW5zIHRoYXQgaXQgd2FzIGFscmVhZHkgcmVtb3ZlZCBmcm9tIERPTSBhbmQgdGhlcmUgaXMgbm8gbmVlZCB0byBwcm9jZXNzIGl0LgogICAgICByZXR1cm47CiAgICB9CgogICAgY29uc3QgYWN0dWFsRG9tQ2hpbGRyZW4gPSB0aGlzLmRvbUNvbnZlcnRlci5tYXBWaWV3VG9Eb20odmlld0VsZW1lbnQpLmNoaWxkTm9kZXM7CiAgICBjb25zdCBleHBlY3RlZERvbUNoaWxkcmVuID0gQXJyYXkuZnJvbSh0aGlzLmRvbUNvbnZlcnRlci52aWV3Q2hpbGRyZW5Ub0RvbSh2aWV3RWxlbWVudCwgZG9tRWxlbWVudC5vd25lckRvY3VtZW50LCB7CiAgICAgIHdpdGhDaGlsZHJlbjogZmFsc2UKICAgIH0pKTsKCiAgICBjb25zdCBkaWZmID0gdGhpcy5fZGlmZk5vZGVMaXN0cyhhY3R1YWxEb21DaGlsZHJlbiwgZXhwZWN0ZWREb21DaGlsZHJlbik7CgogICAgY29uc3QgYWN0aW9ucyA9IHRoaXMuX2ZpbmRSZXBsYWNlQWN0aW9ucyhkaWZmLCBhY3R1YWxEb21DaGlsZHJlbiwgZXhwZWN0ZWREb21DaGlsZHJlbik7CgogICAgaWYgKGFjdGlvbnMuaW5kZXhPZigncmVwbGFjZScpICE9PSAtMSkgewogICAgICBjb25zdCBjb3VudGVyID0gewogICAgICAgIGVxdWFsOiAwLAogICAgICAgIGluc2VydDogMCwKICAgICAgICBkZWxldGU6IDAKICAgICAgfTsKCiAgICAgIGZvciAoY29uc3QgYWN0aW9uIG9mIGFjdGlvbnMpIHsKICAgICAgICBpZiAoYWN0aW9uID09PSAncmVwbGFjZScpIHsKICAgICAgICAgIGNvbnN0IGluc2VydEluZGV4ID0gY291bnRlci5lcXVhbCArIGNvdW50ZXIuaW5zZXJ0OwogICAgICAgICAgY29uc3QgZGVsZXRlSW5kZXggPSBjb3VudGVyLmVxdWFsICsgY291bnRlci5kZWxldGU7CiAgICAgICAgICBjb25zdCB2aWV3Q2hpbGQgPSB2aWV3RWxlbWVudC5nZXRDaGlsZChpbnNlcnRJbmRleCk7IC8vIFRoZSAndWlFbGVtZW50JyBpcyBhIHNwZWNpYWwgb25lIGFuZCBpdHMgY2hpbGRyZW4gYXJlIG5vdCBzdG9yZWQgaW4gYSB2aWV3ICgjNzk5KSwKICAgICAgICAgIC8vIHNvIHdlIGNhbm5vdCB1c2UgaXQgd2l0aCByZXBsYWNpbmcgZmxvdyAoc2luY2UgaXQgdXNlcyB2aWV3IGNoaWxkcmVuIGR1cmluZyByZW5kZXJpbmcKICAgICAgICAgIC8vIHdoaWNoIHdpbGwgYWx3YXlzIHJlc3VsdCBpbiByZW5kZXJpbmcgZW1wdHkgZWxlbWVudCkuCgogICAgICAgICAgaWYgKHZpZXdDaGlsZCAmJiAhdmlld0NoaWxkLmlzKCd1aUVsZW1lbnQnKSkgewogICAgICAgICAgICB0aGlzLl91cGRhdGVFbGVtZW50TWFwcGluZ3Modmlld0NoaWxkLCBhY3R1YWxEb21DaGlsZHJlbltkZWxldGVJbmRleF0pOwogICAgICAgICAgfQoKICAgICAgICAgIHJlbW92ZShleHBlY3RlZERvbUNoaWxkcmVuW2luc2VydEluZGV4XSk7CiAgICAgICAgICBjb3VudGVyLmVxdWFsKys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvdW50ZXJbYWN0aW9uXSsrOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBVcGRhdGVzIG1hcHBpbmdzIG9mIGEgZ2l2ZW4gdmlldyBlbGVtZW50LgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9ub2Rlfk5vZGV9IHZpZXdFbGVtZW50IFRoZSB2aWV3IGVsZW1lbnQgd2hvc2UgbWFwcGluZ3Mgd2lsbCBiZSB1cGRhdGVkLgogICAqIEBwYXJhbSB7Tm9kZX0gZG9tRWxlbWVudCBUaGUgRE9NIGVsZW1lbnQgcmVwcmVzZW50aW5nIHRoZSBnaXZlbiB2aWV3IGVsZW1lbnQuCiAgICovCgoKICBfdXBkYXRlRWxlbWVudE1hcHBpbmdzKHZpZXdFbGVtZW50LCBkb21FbGVtZW50KSB7CiAgICAvLyBSZW1hcCAnRG9tQ29udmVydGVyJyBiaW5kaW5ncy4KICAgIHRoaXMuZG9tQ29udmVydGVyLnVuYmluZERvbUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICB0aGlzLmRvbUNvbnZlcnRlci5iaW5kRWxlbWVudHMoZG9tRWxlbWVudCwgdmlld0VsZW1lbnQpOyAvLyBWaWV3IGVsZW1lbnQgbWF5IGhhdmUgY2hpbGRyZW4gd2hpY2ggbmVlZHMgdG8gYmUgdXBkYXRlZCwgYnV0IGFyZSBub3QgbWFya2VkLCBtYXJrIHRoZW0gdG8gdXBkYXRlLgoKICAgIHRoaXMubWFya2VkQ2hpbGRyZW4uYWRkKHZpZXdFbGVtZW50KTsgLy8gQmVjYXVzZSB3ZSByZXBsYWNlIG5ldyB2aWV3IGVsZW1lbnQgbWFwcGluZyB3aXRoIHRoZSBleGlzdGluZyBvbmUsIHRoZSBjb3JyZXNwb25kaW5nIERPTSBlbGVtZW50CiAgICAvLyB3aWxsIG5vdCBiZSByZXJlbmRlcmVkLiBUaGUgbmV3IHZpZXcgZWxlbWVudCBtYXkgaGF2ZSBkaWZmZXJlbnQgYXR0cmlidXRlcyB0aGFuIHRoZSBwcmV2aW91cyBvbmUuCiAgICAvLyBTaW5jZSBpdHMgY29ycmVzcG9uZGluZyBET00gZWxlbWVudCB3aWxsIG5vdCBiZSByZXJlbmRlcmVkLCBuZXcgYXR0cmlidXRlcyB3aWxsIG5vdCBiZSBhZGRlZAogICAgLy8gdG8gdGhlIERPTSwgc28gd2UgbmVlZCB0byBtYXJrIGl0IGhlcmUgdG8gbWFrZSBzdXJlIGl0cyBhdHRyaWJ1dGVzIGdldHMgdXBkYXRlZC4gU2VlICMxNDI3IGZvciBtb3JlCiAgICAvLyBkZXRhaWxlZCBjYXNlIHN0dWR5LgogICAgLy8gQWxzbyB0aGVyZSBhcmUgY2FzZXMgd2hlcmUgcmVwbGFjZWQgZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIHZpZXcgc3RydWN0dXJlIGFuZCB0aGVuIGhhcwogICAgLy8gaXRzIGF0dHJpYnV0ZXMgY2hhbmdlZCBvciByZW1vdmVkLiBJbiBzdWNoIGNhc2VzIHRoZSBlbGVtZW50IHdpbGwgbm90IGJlIHByZXNlbnQgaW4gYG1hcmtlZEF0dHJpYnV0ZXNgCiAgICAvLyBhbmQgYWxzbyBtYXkgYmUgdGhlIHNhbWUgKGBlbGVtZW50LmlzU2ltaWxhcigpYCkgYXMgdGhlIHJldXNlZCBlbGVtZW50IG5vdCBoYXZpbmcgaXRzIGF0dHJpYnV0ZXMgdXBkYXRlZC4KICAgIC8vIFRvIHByZXZlbnQgc3VjaCBzaXR1YXRpb25zIHdlIGFsd2F5cyBtYXJrIHJldXNlZCBlbGVtZW50IHRvIGhhdmUgaXRzIGF0dHJpYnV0ZXMgcmVyZW5kZXJkICgjMTU2MCkuCgogICAgdGhpcy5tYXJrZWRBdHRyaWJ1dGVzLmFkZCh2aWV3RWxlbWVudCk7CiAgfQogIC8qKgogICAqIEdldHMgdGhlIHBvc2l0aW9uIG9mIHRoZSBpbmxpbmUgZmlsbGVyIGJhc2VkIG9uIHRoZSBjdXJyZW50IHNlbGVjdGlvbi4KICAgKiBIZXJlLCB3ZSBhc3N1bWUgdGhhdCB3ZSBrbm93IHRoYXQgdGhlIGZpbGxlciBpcyBuZWVkZWQgYW5kCiAgICoge0BsaW5rICNfaXNTZWxlY3Rpb25JbklubGluZUZpbGxlciBpcyBhdCB0aGUgc2VsZWN0aW9uIHBvc2l0aW9ufSwgYW5kLCBzaW5jZSBpdCBpcyBuZWVkZWQsCiAgICogaXQgaXMgc29tZXdoZXJlIGF0IHRoZSBzZWxlY3Rpb24gcG9zaXRpb24uCiAgICoKICAgKiBOb3RlOiBUaGUgZmlsbGVyIHBvc2l0aW9uIGNhbm5vdCBiZSByZXN0b3JlZCBiYXNlZCBvbiB0aGUgZmlsbGVyJ3MgRE9NIHRleHQgbm9kZSwgYmVjYXVzZQogICAqIHdoZW4gdGhpcyBtZXRob2QgaXMgY2FsbGVkIChiZWZvcmUgcmVuZGVyaW5nKSwgdGhlIGJpbmRpbmdzIHdpbGwgb2Z0ZW4gYmUgYnJva2VuLiBWaWV3LXRvLURPTQogICAqIGJpbmRpbmdzIGFyZSBvbmx5IGRlcGVuZGFibGUgYWZ0ZXIgcmVuZGVyaW5nLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcmV0dXJucyB7bW9kdWxlOmVuZ2luZS92aWV3L3Bvc2l0aW9uflBvc2l0aW9ufQogICAqLwoKCiAgX2dldElubGluZUZpbGxlclBvc2l0aW9uKCkgewogICAgY29uc3QgZmlyc3RQb3MgPSB0aGlzLnNlbGVjdGlvbi5nZXRGaXJzdFBvc2l0aW9uKCk7CgogICAgaWYgKGZpcnN0UG9zLnBhcmVudC5pcygndGV4dCcpKSB7CiAgICAgIHJldHVybiBWaWV3UG9zaXRpb24uX2NyZWF0ZUJlZm9yZSh0aGlzLnNlbGVjdGlvbi5nZXRGaXJzdFBvc2l0aW9uKCkucGFyZW50KTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmaXJzdFBvczsKICAgIH0KICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHNlbGVjdGlvbiBoYXMgbm90IGxlZnQgdGhlIGlubGluZSBmaWxsZXIncyB0ZXh0IG5vZGUuCiAgICogSWYgaXQgaXMgYHRydWVgLCBpdCBtZWFucyB0aGF0IHRoZSBmaWxsZXIgaGFkIGJlZW4gYWRkZWQgZm9yIGEgcmVhc29uIGFuZCB0aGUgc2VsZWN0aW9uIGRpZCBub3QKICAgKiBsZWF2ZSB0aGUgZmlsbGVyJ3MgdGV4dCBub2RlLiBGb3IgZXhhbXBsZSwgdGhlIHVzZXIgY2FuIGJlIGluIHRoZSBtaWRkbGUgb2YgYSBjb21wb3NpdGlvbiBzbyBpdCBzaG91bGQgbm90IGJlIHRvdWNoZWQuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEByZXR1cm5zIHtCb29sZWFufSBgdHJ1ZWAgaWYgdGhlIGlubGluZSBmaWxsZXIgYW5kIHNlbGVjdGlvbiBhcmUgaW4gdGhlIHNhbWUgcGxhY2UuCiAgICovCgoKICBfaXNTZWxlY3Rpb25JbklubGluZUZpbGxlcigpIHsKICAgIGlmICh0aGlzLnNlbGVjdGlvbi5yYW5nZUNvdW50ICE9IDEgfHwgIXRoaXMuc2VsZWN0aW9uLmlzQ29sbGFwc2VkKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gLy8gTm90ZSwgd2UgY2FuJ3QgY2hlY2sgaWYgc2VsZWN0aW9uJ3MgcG9zaXRpb24gZXF1YWxzIHBvc2l0aW9uIG9mIHRoZQogICAgLy8gdGhpcy5faW5saW5lRmlsbGVyIG5vZGUsIGJlY2F1c2Ugb2YgIzY2My4gV2UgbWF5IG5vdCBiZSBhYmxlIHRvIGNhbGN1bGF0ZQogICAgLy8gdGhlIGZpbGxlcidzIHBvc2l0aW9uIGluIHRoZSB2aWV3IGF0IHRoaXMgc3RhZ2UuCiAgICAvLyBJbnN0ZWFkLCB3ZSBjaGVjayBpdCB0aGUgb3RoZXIgd2F5IOKAkyB3aGV0aGVyIHNlbGVjdGlvbiBpcyBhbmNob3JlZCBpbgogICAgLy8gdGhhdCB0ZXh0IG5vZGUgb3IgbmV4dCB0byBpdC4KICAgIC8vIFBvc3NpYmxlIG9wdGlvbnMgYXJlOgogICAgLy8gIkZJTExFUnt9IgogICAgLy8gIkZJTExFUmFkZGVkLXRleHR7fSIKCgogICAgY29uc3Qgc2VsZWN0aW9uUG9zaXRpb24gPSB0aGlzLnNlbGVjdGlvbi5nZXRGaXJzdFBvc2l0aW9uKCk7CiAgICBjb25zdCBwb3NpdGlvbiA9IHRoaXMuZG9tQ29udmVydGVyLnZpZXdQb3NpdGlvblRvRG9tKHNlbGVjdGlvblBvc2l0aW9uKTsKCiAgICBpZiAocG9zaXRpb24gJiYgaXNUZXh0KHBvc2l0aW9uLnBhcmVudCkgJiYgc3RhcnRzV2l0aEZpbGxlcihwb3NpdGlvbi5wYXJlbnQpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9CiAgLyoqCiAgICogUmVtb3ZlcyB0aGUgaW5saW5lIGZpbGxlci4KICAgKgogICAqIEBwcml2YXRlCiAgICovCgoKICBfcmVtb3ZlSW5saW5lRmlsbGVyKCkgewogICAgY29uc3QgZG9tRmlsbGVyTm9kZSA9IHRoaXMuX2lubGluZUZpbGxlcjsgLy8gU29tZXRoaW5nIHdlaXJkIGhhcHBlbmVkIGFuZCB0aGUgc3RvcmVkIG5vZGUgZG9lc24ndCBjb250YWluIHRoZSBmaWxsZXIncyB0ZXh0LgoKICAgIGlmICghc3RhcnRzV2l0aEZpbGxlcihkb21GaWxsZXJOb2RlKSkgewogICAgICAvKioKICAgICAgICogVGhlIGlubGluZSBmaWxsZXIgbm9kZSB3YXMgbG9zdC4gTW9zdCBsaWtlbHksIHNvbWV0aGluZyBvdmVyd3JvdGUgdGhlIGZpbGxlciB0ZXh0IG5vZGUKICAgICAgICogaW4gdGhlIERPTS4KICAgICAgICoKICAgICAgICogQGVycm9yIHZpZXctcmVuZGVyZXItZmlsbGVyLXdhcy1sb3N0CiAgICAgICAqLwogICAgICB0aHJvdyBuZXcgQ0tFZGl0b3JFcnJvcigndmlldy1yZW5kZXJlci1maWxsZXItd2FzLWxvc3Q6IFRoZSBpbmxpbmUgZmlsbGVyIG5vZGUgd2FzIGxvc3QuJywgdGhpcyk7CiAgICB9CgogICAgaWYgKGlzSW5saW5lRmlsbGVyKGRvbUZpbGxlck5vZGUpKSB7CiAgICAgIGRvbUZpbGxlck5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChkb21GaWxsZXJOb2RlKTsKICAgIH0gZWxzZSB7CiAgICAgIGRvbUZpbGxlck5vZGUuZGF0YSA9IGRvbUZpbGxlck5vZGUuZGF0YS5zdWJzdHIoSU5MSU5FX0ZJTExFUl9MRU5HVEgpOwogICAgfQoKICAgIHRoaXMuX2lubGluZUZpbGxlciA9IG51bGw7CiAgfQogIC8qKgogICAqIENoZWNrcyBpZiB0aGUgaW5saW5lIHtAbGluayBtb2R1bGU6ZW5naW5lL3ZpZXcvZmlsbGVyIGZpbGxlcn0gc2hvdWxkIGJlIGFkZGVkLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gYHRydWVgIGlmIHRoZSBpbmxpbmUgZmlsbGVyIHNob3VsZCBiZSBhZGRlZC4KICAgKi8KCgogIF9uZWVkc0lubGluZUZpbGxlckF0U2VsZWN0aW9uKCkgewogICAgaWYgKHRoaXMuc2VsZWN0aW9uLnJhbmdlQ291bnQgIT0gMSB8fCAhdGhpcy5zZWxlY3Rpb24uaXNDb2xsYXBzZWQpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGNvbnN0IHNlbGVjdGlvblBvc2l0aW9uID0gdGhpcy5zZWxlY3Rpb24uZ2V0Rmlyc3RQb3NpdGlvbigpOwogICAgY29uc3Qgc2VsZWN0aW9uUGFyZW50ID0gc2VsZWN0aW9uUG9zaXRpb24ucGFyZW50OwogICAgY29uc3Qgc2VsZWN0aW9uT2Zmc2V0ID0gc2VsZWN0aW9uUG9zaXRpb24ub2Zmc2V0OyAvLyBJZiB0aGVyZSBpcyBubyBET00gcm9vdCB3ZSBkbyBub3QgY2FyZSBhYm91dCBmaWxsZXJzLgoKICAgIGlmICghdGhpcy5kb21Db252ZXJ0ZXIubWFwVmlld1RvRG9tKHNlbGVjdGlvblBhcmVudC5yb290KSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKCFzZWxlY3Rpb25QYXJlbnQuaXMoJ2VsZW1lbnQnKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9IC8vIFByZXZlbnQgYWRkaW5nIGlubGluZSBmaWxsZXIgaW5zaWRlIGVsZW1lbnRzIHdpdGggY29udGVudGVkaXRhYmxlPWZhbHNlLgogICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NrZWRpdG9yL2NrZWRpdG9yNS1lbmdpbmUvaXNzdWVzLzExNzAKCgogICAgaWYgKCFpc0VkaXRhYmxlKHNlbGVjdGlvblBhcmVudCkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSAvLyBXZSBoYXZlIGJsb2NrIGZpbGxlciwgd2UgZG8gbm90IG5lZWQgaW5saW5lIG9uZS4KCgogICAgaWYgKHNlbGVjdGlvbk9mZnNldCA9PT0gc2VsZWN0aW9uUGFyZW50LmdldEZpbGxlck9mZnNldCgpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBjb25zdCBub2RlQmVmb3JlID0gc2VsZWN0aW9uUG9zaXRpb24ubm9kZUJlZm9yZTsKICAgIGNvbnN0IG5vZGVBZnRlciA9IHNlbGVjdGlvblBvc2l0aW9uLm5vZGVBZnRlcjsKCiAgICBpZiAobm9kZUJlZm9yZSBpbnN0YW5jZW9mIFZpZXdUZXh0IHx8IG5vZGVBZnRlciBpbnN0YW5jZW9mIFZpZXdUZXh0KSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgLyoqCiAgICogQ2hlY2tzIGlmIHRleHQgbmVlZHMgdG8gYmUgdXBkYXRlZCBhbmQgcG9zc2libHkgdXBkYXRlcyBpdC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvdGV4dH5UZXh0fSB2aWV3VGV4dCBWaWV3IHRleHQgdG8gdXBkYXRlLgogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvcG9zaXRpb25+UG9zaXRpb259IG9wdGlvbnMuaW5saW5lRmlsbGVyUG9zaXRpb24gVGhlIHBvc2l0aW9uIHdoZXJlIHRoZSBpbmxpbmUKICAgKiBmaWxsZXIgc2hvdWxkIGJlIHJlbmRlcmVkLgogICAqLwoKCiAgX3VwZGF0ZVRleHQodmlld1RleHQsIG9wdGlvbnMpIHsKICAgIGNvbnN0IGRvbVRleHQgPSB0aGlzLmRvbUNvbnZlcnRlci5maW5kQ29ycmVzcG9uZGluZ0RvbVRleHQodmlld1RleHQpOwogICAgY29uc3QgbmV3RG9tVGV4dCA9IHRoaXMuZG9tQ29udmVydGVyLnZpZXdUb0RvbSh2aWV3VGV4dCwgZG9tVGV4dC5vd25lckRvY3VtZW50KTsKICAgIGNvbnN0IGFjdHVhbFRleHQgPSBkb21UZXh0LmRhdGE7CiAgICBsZXQgZXhwZWN0ZWRUZXh0ID0gbmV3RG9tVGV4dC5kYXRhOwogICAgY29uc3QgZmlsbGVyID0gb3B0aW9ucy5pbmxpbmVGaWxsZXJQb3NpdGlvbjsKCiAgICBpZiAoZmlsbGVyICYmIGZpbGxlci5wYXJlbnQgPT0gdmlld1RleHQucGFyZW50ICYmIGZpbGxlci5vZmZzZXQgPT0gdmlld1RleHQuaW5kZXgpIHsKICAgICAgZXhwZWN0ZWRUZXh0ID0gSU5MSU5FX0ZJTExFUiArIGV4cGVjdGVkVGV4dDsKICAgIH0KCiAgICBpZiAoYWN0dWFsVGV4dCAhPSBleHBlY3RlZFRleHQpIHsKICAgICAgY29uc3QgYWN0aW9ucyA9IGZhc3REaWZmKGFjdHVhbFRleHQsIGV4cGVjdGVkVGV4dCk7CgogICAgICBmb3IgKGNvbnN0IGFjdGlvbiBvZiBhY3Rpb25zKSB7CiAgICAgICAgaWYgKGFjdGlvbi50eXBlID09PSAnaW5zZXJ0JykgewogICAgICAgICAgZG9tVGV4dC5pbnNlcnREYXRhKGFjdGlvbi5pbmRleCwgYWN0aW9uLnZhbHVlcy5qb2luKCcnKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vICdkZWxldGUnCiAgICAgICAgICBkb21UZXh0LmRlbGV0ZURhdGEoYWN0aW9uLmluZGV4LCBhY3Rpb24uaG93TWFueSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIENoZWNrcyBpZiBhdHRyaWJ1dGUgbGlzdCBuZWVkcyB0byBiZSB1cGRhdGVkIGFuZCBwb3NzaWJseSB1cGRhdGVzIGl0LgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9lbGVtZW50fkVsZW1lbnR9IHZpZXdFbGVtZW50IFRoZSB2aWV3IGVsZW1lbnQgdG8gdXBkYXRlLgogICAqLwoKCiAgX3VwZGF0ZUF0dHJzKHZpZXdFbGVtZW50KSB7CiAgICBjb25zdCBkb21FbGVtZW50ID0gdGhpcy5kb21Db252ZXJ0ZXIubWFwVmlld1RvRG9tKHZpZXdFbGVtZW50KTsKCiAgICBpZiAoIWRvbUVsZW1lbnQpIHsKICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gYGRvbUVsZW1lbnRgIGl0IG1lYW5zIHRoYXQgJ3ZpZXdFbGVtZW50JyBpcyBvdXRkYXRlZCBhcyBpdHMgbWFwcGluZyB3YXMgdXBkYXRlZAogICAgICAvLyBpbiAndGhpcy5fdXBkYXRlQ2hpbGRyZW5NYXBwaW5ncygpJy4gVGhlcmUgaXMgbm8gbmVlZCB0byBwcm9jZXNzIGl0IGFzIG5ldyB2aWV3IGVsZW1lbnQgd2hpY2gKICAgICAgLy8gcmVwbGFjZWQgb2xkICd2aWV3RWxlbWVudCcgbWFwcGluZyB3YXMgYWxzbyBhZGRlZCB0byAndGhpcy5tYXJrZWRBdHRyaWJ1dGVzJwogICAgICAvLyBpbiAndGhpcy5fdXBkYXRlQ2hpbGRyZW5NYXBwaW5ncygpJyBzbyBpdCB3aWxsIGJlIHByb2Nlc3NlZCBzZXBhcmF0ZWx5LgogICAgICByZXR1cm47CiAgICB9CgogICAgY29uc3QgZG9tQXR0cktleXMgPSBBcnJheS5mcm9tKGRvbUVsZW1lbnQuYXR0cmlidXRlcykubWFwKGF0dHIgPT4gYXR0ci5uYW1lKTsKICAgIGNvbnN0IHZpZXdBdHRyS2V5cyA9IHZpZXdFbGVtZW50LmdldEF0dHJpYnV0ZUtleXMoKTsgLy8gQWRkIG9yIG92ZXJ3cml0ZSBhdHRyaWJ1dGVzLgoKICAgIGZvciAoY29uc3Qga2V5IG9mIHZpZXdBdHRyS2V5cykgewogICAgICBkb21FbGVtZW50LnNldEF0dHJpYnV0ZShrZXksIHZpZXdFbGVtZW50LmdldEF0dHJpYnV0ZShrZXkpKTsKICAgIH0gLy8gUmVtb3ZlIGZyb20gRE9NIGF0dHJpYnV0ZXMgd2hpY2ggZG8gbm90IGV4aXN0cyBpbiB0aGUgdmlldy4KCgogICAgZm9yIChjb25zdCBrZXkgb2YgZG9tQXR0cktleXMpIHsKICAgICAgaWYgKCF2aWV3RWxlbWVudC5oYXNBdHRyaWJ1dGUoa2V5KSkgewogICAgICAgIGRvbUVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKGtleSk7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogQ2hlY2tzIGlmIGVsZW1lbnRzIGNoaWxkIGxpc3QgbmVlZHMgdG8gYmUgdXBkYXRlZCBhbmQgcG9zc2libHkgdXBkYXRlcyBpdC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvZWxlbWVudH5FbGVtZW50fSB2aWV3RWxlbWVudCBWaWV3IGVsZW1lbnQgdG8gdXBkYXRlLgogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvcG9zaXRpb25+UG9zaXRpb259IG9wdGlvbnMuaW5saW5lRmlsbGVyUG9zaXRpb24gVGhlIHBvc2l0aW9uIHdoZXJlIHRoZSBpbmxpbmUKICAgKiBmaWxsZXIgc2hvdWxkIGJlIHJlbmRlcmVkLgogICAqLwoKCiAgX3VwZGF0ZUNoaWxkcmVuKHZpZXdFbGVtZW50LCBvcHRpb25zKSB7CiAgICBjb25zdCBkb21FbGVtZW50ID0gdGhpcy5kb21Db252ZXJ0ZXIubWFwVmlld1RvRG9tKHZpZXdFbGVtZW50KTsKCiAgICBpZiAoIWRvbUVsZW1lbnQpIHsKICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gYGRvbUVsZW1lbnRgIGl0IG1lYW5zIHRoYXQgaXQgd2FzIGFscmVhZHkgcmVtb3ZlZCBmcm9tIERPTS4KICAgICAgLy8gVGhlcmUgaXMgbm8gbmVlZCB0byBwcm9jZXNzIGl0LiBJdCB3aWxsIGJlIHByb2Nlc3NlZCB3aGVuIHJlLWluc2VydGVkLgogICAgICByZXR1cm47CiAgICB9CgogICAgY29uc3QgaW5saW5lRmlsbGVyUG9zaXRpb24gPSBvcHRpb25zLmlubGluZUZpbGxlclBvc2l0aW9uOwogICAgY29uc3QgYWN0dWFsRG9tQ2hpbGRyZW4gPSB0aGlzLmRvbUNvbnZlcnRlci5tYXBWaWV3VG9Eb20odmlld0VsZW1lbnQpLmNoaWxkTm9kZXM7CiAgICBjb25zdCBleHBlY3RlZERvbUNoaWxkcmVuID0gQXJyYXkuZnJvbSh0aGlzLmRvbUNvbnZlcnRlci52aWV3Q2hpbGRyZW5Ub0RvbSh2aWV3RWxlbWVudCwgZG9tRWxlbWVudC5vd25lckRvY3VtZW50LCB7CiAgICAgIGJpbmQ6IHRydWUsCiAgICAgIGlubGluZUZpbGxlclBvc2l0aW9uCiAgICB9KSk7IC8vIElubGluZSBmaWxsZXIgZWxlbWVudCBoYXMgdG8gYmUgY3JlYXRlZCBhcyBpdCBpcyBwcmVzZW50IGluIHRoZSBET00sIGJ1dCBub3QgaW4gdGhlIHZpZXcuIEl0IGlzIHJlcXVpcmVkCiAgICAvLyBkdXJpbmcgZGlmZmluZyBzbyB0ZXh0IG5vZGVzIGNvdWxkIGJlIGNvbXBhcmVkIGNvcnJlY3RseSBhbmQgYWxzbyBkdXJpbmcgcmVuZGVyaW5nIHRvIG1haW50YWluCiAgICAvLyBwcm9wZXIgb3JkZXIgYW5kIGluZGV4ZXMgd2hpbGUgdXBkYXRpbmcgdGhlIERPTS4KCiAgICBpZiAoaW5saW5lRmlsbGVyUG9zaXRpb24gJiYgaW5saW5lRmlsbGVyUG9zaXRpb24ucGFyZW50ID09PSB2aWV3RWxlbWVudCkgewogICAgICBhZGRJbmxpbmVGaWxsZXIoZG9tRWxlbWVudC5vd25lckRvY3VtZW50LCBleHBlY3RlZERvbUNoaWxkcmVuLCBpbmxpbmVGaWxsZXJQb3NpdGlvbi5vZmZzZXQpOwogICAgfQoKICAgIGNvbnN0IGRpZmYgPSB0aGlzLl9kaWZmTm9kZUxpc3RzKGFjdHVhbERvbUNoaWxkcmVuLCBleHBlY3RlZERvbUNoaWxkcmVuKTsKCiAgICBsZXQgaSA9IDA7CiAgICBjb25zdCBub2Rlc1RvVW5iaW5kID0gbmV3IFNldCgpOwoKICAgIGZvciAoY29uc3QgYWN0aW9uIG9mIGRpZmYpIHsKICAgICAgaWYgKGFjdGlvbiA9PT0gJ2luc2VydCcpIHsKICAgICAgICBpbnNlcnRBdChkb21FbGVtZW50LCBpLCBleHBlY3RlZERvbUNoaWxkcmVuW2ldKTsKICAgICAgICBpKys7CiAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnZGVsZXRlJykgewogICAgICAgIG5vZGVzVG9VbmJpbmQuYWRkKGFjdHVhbERvbUNoaWxkcmVuW2ldKTsKICAgICAgICByZW1vdmUoYWN0dWFsRG9tQ2hpbGRyZW5baV0pOwogICAgICB9IGVsc2UgewogICAgICAgIC8vICdlcXVhbCcKICAgICAgICAvLyBGb3JjZSB1cGRhdGluZyB0ZXh0IG5vZGVzIGluc2lkZSBlbGVtZW50cyB3aGljaCBkaWQgbm90IGNoYW5nZSBhbmQgZG8gbm90IG5lZWQgdG8gYmUgcmUtcmVuZGVyZWQgKCMxMTI1KS4KICAgICAgICB0aGlzLl9tYXJrRGVzY2VuZGFudFRleHRUb1N5bmModGhpcy5kb21Db252ZXJ0ZXIuZG9tVG9WaWV3KGV4cGVjdGVkRG9tQ2hpbGRyZW5baV0pKTsKCiAgICAgICAgaSsrOwogICAgICB9CiAgICB9IC8vIFVuYmluZCByZW1vdmVkIG5vZGVzLiBXaGVuIG5vZGUgZG9lcyBub3QgaGF2ZSBhIHBhcmVudCBpdCBtZWFucyB0aGF0IGl0IHdhcyByZW1vdmVkIGZyb20gRE9NIHRyZWUgZHVyaW5nCiAgICAvLyBjb21wYXJpc2lvbiB3aXRoIHRoZSBleHBlY3RlZCBET00uIFdlIGRvbid0IG5lZWQgdG8gY2hlY2sgY2hpbGQgbm9kZXMsIGJlY2F1c2UgaWYgY2hpbGQgbm9kZSB3YXMgcmVpbnNlcnRlZCwKICAgIC8vIGl0IHdhcyBtb3ZlZCB0byBET00gdHJlZSBvdXQgb2YgdGhlIHJlbW92ZWQgbm9kZS4KCgogICAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzVG9VbmJpbmQpIHsKICAgICAgaWYgKCFub2RlLnBhcmVudE5vZGUpIHsKICAgICAgICB0aGlzLmRvbUNvbnZlcnRlci51bmJpbmREb21FbGVtZW50KG5vZGUpOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIFNob3J0aGFuZCBmb3IgZGlmZmluZyB0d28gYXJyYXlzIG9yIG5vZGUgbGlzdHMgb2YgRE9NIG5vZGVzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5LjxOb2RlPnxOb2RlTGlzdH0gYWN0dWFsRG9tQ2hpbGRyZW4gQWN0dWFsIERPTSBjaGlsZHJlbgogICAqIEBwYXJhbSB7QXJyYXkuPE5vZGU+fE5vZGVMaXN0fSBleHBlY3RlZERvbUNoaWxkcmVuIEV4cGVjdGVkIERPTSBjaGlsZHJlbi4KICAgKiBAcmV0dXJucyB7QXJyYXkuPFN0cmluZz59IFRoZSBsaXN0IG9mIGFjdGlvbnMgYmFzZWQgb24gdGhlIHtAbGluayBtb2R1bGU6dXRpbHMvZGlmZn5kaWZmfSBmdW5jdGlvbi4KICAgKi8KCgogIF9kaWZmTm9kZUxpc3RzKGFjdHVhbERvbUNoaWxkcmVuLCBleHBlY3RlZERvbUNoaWxkcmVuKSB7CiAgICBhY3R1YWxEb21DaGlsZHJlbiA9IGZpbHRlck91dEZha2VTZWxlY3Rpb25Db250YWluZXIoYWN0dWFsRG9tQ2hpbGRyZW4sIHRoaXMuX2Zha2VTZWxlY3Rpb25Db250YWluZXIpOwogICAgcmV0dXJuIGRpZmYoYWN0dWFsRG9tQ2hpbGRyZW4sIGV4cGVjdGVkRG9tQ2hpbGRyZW4sIHNhbWVOb2Rlcy5iaW5kKG51bGwsIHRoaXMuZG9tQ29udmVydGVyKSk7CiAgfQogIC8qKgogICAqIEZpbmRzIERPTSBub2RlcyB0aGF0IHdlcmUgcmVwbGFjZWQgd2l0aCB0aGUgc2ltaWxhciBub2RlcyAoc2FtZSB0YWcgbmFtZSkgaW4gdGhlIHZpZXcuIEFsbCBub2RlcyBhcmUgY29tcGFyZWQKICAgKiB3aXRoaW4gb25lIGBpbnNlcnRgL2BkZWxldGVgIGFjdGlvbiBncm91cCwgZm9yIGV4YW1wbGU6CiAgICoKICAgKiAJCUFjdHVhbCBET006CQk8cD48Yj5Gb288L2I+QmFyPGk+QmF6PC9pPjxiPkJheDwvYj48L3A+CiAgICogCQlFeHBlY3RlZCBET006CTxwPkJhcjxiPjEyMzwvYj48aT5CYXo8L2k+PGI+NDU2PC9iPjwvcD4KICAgKiAJCUlucHV0IGFjdGlvbnM6CVsgaW5zZXJ0LCBpbnNlcnQsIGRlbGV0ZSwgZGVsZXRlLCBlcXVhbCwgaW5zZXJ0LCBkZWxldGUgXQogICAqIAkJT3V0cHV0IGFjdGlvbnM6CVsgaW5zZXJ0LCByZXBsYWNlLCBkZWxldGUsIGVxdWFsLCByZXBsYWNlIF0KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheS48U3RyaW5nPn0gYWN0aW9ucyBBY3Rpb25zIGFycmF5IHdoaWNoIGlzIGEgcmVzdWx0IG9mIHRoZSB7QGxpbmsgbW9kdWxlOnV0aWxzL2RpZmZ+ZGlmZn0gZnVuY3Rpb24uCiAgICogQHBhcmFtIHtBcnJheS48Tm9kZT58Tm9kZUxpc3R9IGFjdHVhbERvbSBBY3R1YWwgRE9NIGNoaWxkcmVuCiAgICogQHBhcmFtIHtBcnJheS48Tm9kZT59IGV4cGVjdGVkRG9tIEV4cGVjdGVkIERPTSBjaGlsZHJlbi4KICAgKiBAcmV0dXJucyB7QXJyYXkuPFN0cmluZz59IEFjdGlvbnMgYXJyYXkgbW9kaWZpZWQgd2l0aCB0aGUgYHJlcGxhY2VgIGFjdGlvbnMuCiAgICovCgoKICBfZmluZFJlcGxhY2VBY3Rpb25zKGFjdGlvbnMsIGFjdHVhbERvbSwgZXhwZWN0ZWREb20pIHsKICAgIC8vIElmIHRoZXJlIGlzIG5vIGJvdGggJ2luc2VydCcgYW5kICdkZWxldGUnIGFjdGlvbnMsIG5vIG5lZWQgdG8gY2hlY2sgZm9yIHJlcGxhY2VkIGVsZW1lbnRzLgogICAgaWYgKGFjdGlvbnMuaW5kZXhPZignaW5zZXJ0JykgPT09IC0xIHx8IGFjdGlvbnMuaW5kZXhPZignZGVsZXRlJykgPT09IC0xKSB7CiAgICAgIHJldHVybiBhY3Rpb25zOwogICAgfQoKICAgIGxldCBuZXdBY3Rpb25zID0gW107CiAgICBsZXQgYWN0dWFsU2xpY2UgPSBbXTsKICAgIGxldCBleHBlY3RlZFNsaWNlID0gW107CiAgICBjb25zdCBjb3VudGVyID0gewogICAgICBlcXVhbDogMCwKICAgICAgaW5zZXJ0OiAwLAogICAgICBkZWxldGU6IDAKICAgIH07CgogICAgZm9yIChjb25zdCBhY3Rpb24gb2YgYWN0aW9ucykgewogICAgICBpZiAoYWN0aW9uID09PSAnaW5zZXJ0JykgewogICAgICAgIGV4cGVjdGVkU2xpY2UucHVzaChleHBlY3RlZERvbVtjb3VudGVyLmVxdWFsICsgY291bnRlci5pbnNlcnRdKTsKICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdkZWxldGUnKSB7CiAgICAgICAgYWN0dWFsU2xpY2UucHVzaChhY3R1YWxEb21bY291bnRlci5lcXVhbCArIGNvdW50ZXIuZGVsZXRlXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZXF1YWwKICAgICAgICBuZXdBY3Rpb25zID0gbmV3QWN0aW9ucy5jb25jYXQoZGlmZihhY3R1YWxTbGljZSwgZXhwZWN0ZWRTbGljZSwgYXJlU2ltaWxhcikubWFwKHggPT4geCA9PT0gJ2VxdWFsJyA/ICdyZXBsYWNlJyA6IHgpKTsKICAgICAgICBuZXdBY3Rpb25zLnB1c2goJ2VxdWFsJyk7IC8vIFJlc2V0IHN0b3JlZCBlbGVtZW50cyBvbiAnZXF1YWwnLgoKICAgICAgICBhY3R1YWxTbGljZSA9IFtdOwogICAgICAgIGV4cGVjdGVkU2xpY2UgPSBbXTsKICAgICAgfQoKICAgICAgY291bnRlclthY3Rpb25dKys7CiAgICB9CgogICAgcmV0dXJuIG5ld0FjdGlvbnMuY29uY2F0KGRpZmYoYWN0dWFsU2xpY2UsIGV4cGVjdGVkU2xpY2UsIGFyZVNpbWlsYXIpLm1hcCh4ID0+IHggPT09ICdlcXVhbCcgPyAncmVwbGFjZScgOiB4KSk7CiAgfQogIC8qKgogICAqIE1hcmtzIHRleHQgbm9kZXMgdG8gYmUgc3luY2hyb25pemVkLgogICAqCiAgICogSWYgYSB0ZXh0IG5vZGUgaXMgcGFzc2VkLCBpdCB3aWxsIGJlIG1hcmtlZC4gSWYgYW4gZWxlbWVudCBpcyBwYXNzZWQsIGFsbCBkZXNjZW5kYW50IHRleHQgbm9kZXMgaW5zaWRlIGl0IHdpbGwgYmUgbWFya2VkLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9ub2Rlfk5vZGV9IHZpZXdOb2RlIFZpZXcgbm9kZSB0byBzeW5jLgogICAqLwoKCiAgX21hcmtEZXNjZW5kYW50VGV4dFRvU3luYyh2aWV3Tm9kZSkgewogICAgaWYgKCF2aWV3Tm9kZSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKHZpZXdOb2RlLmlzKCd0ZXh0JykpIHsKICAgICAgdGhpcy5tYXJrZWRUZXh0cy5hZGQodmlld05vZGUpOwogICAgfSBlbHNlIGlmICh2aWV3Tm9kZS5pcygnZWxlbWVudCcpKSB7CiAgICAgIGZvciAoY29uc3QgY2hpbGQgb2Ygdmlld05vZGUuZ2V0Q2hpbGRyZW4oKSkgewogICAgICAgIHRoaXMuX21hcmtEZXNjZW5kYW50VGV4dFRvU3luYyhjaGlsZCk7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBzZWxlY3Rpb24gbmVlZHMgdG8gYmUgdXBkYXRlZCBhbmQgcG9zc2libHkgdXBkYXRlcyBpdC4KICAgKgogICAqIEBwcml2YXRlCiAgICovCgoKICBfdXBkYXRlU2VsZWN0aW9uKCkgewogICAgLy8gSWYgdGhlcmUgaXMgbm8gc2VsZWN0aW9uIC0gcmVtb3ZlIERPTSBhbmQgZmFrZSBzZWxlY3Rpb25zLgogICAgaWYgKHRoaXMuc2VsZWN0aW9uLnJhbmdlQ291bnQgPT09IDApIHsKICAgICAgdGhpcy5fcmVtb3ZlRG9tU2VsZWN0aW9uKCk7CgogICAgICB0aGlzLl9yZW1vdmVGYWtlU2VsZWN0aW9uKCk7CgogICAgICByZXR1cm47CiAgICB9CgogICAgY29uc3QgZG9tUm9vdCA9IHRoaXMuZG9tQ29udmVydGVyLm1hcFZpZXdUb0RvbSh0aGlzLnNlbGVjdGlvbi5lZGl0YWJsZUVsZW1lbnQpOyAvLyBEbyBub3RoaW5nIGlmIHRoZXJlIGlzIG5vIGZvY3VzLCBvciB0aGVyZSBpcyBubyBET00gZWxlbWVudCBjb3JyZXNwb25kaW5nIHRvIHNlbGVjdGlvbidzIGVkaXRhYmxlIGVsZW1lbnQuCgogICAgaWYgKCF0aGlzLmlzRm9jdXNlZCB8fCAhZG9tUm9vdCkgewogICAgICByZXR1cm47CiAgICB9IC8vIFJlbmRlciBzZWxlY3Rpb24uCgoKICAgIGlmICh0aGlzLnNlbGVjdGlvbi5pc0Zha2UpIHsKICAgICAgdGhpcy5fdXBkYXRlRmFrZVNlbGVjdGlvbihkb21Sb290KTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3JlbW92ZUZha2VTZWxlY3Rpb24oKTsKCiAgICAgIHRoaXMuX3VwZGF0ZURvbVNlbGVjdGlvbihkb21Sb290KTsKICAgIH0KICB9CiAgLyoqCiAgICogVXBkYXRlcyB0aGUgZmFrZSBzZWxlY3Rpb24uCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IGRvbVJvb3QgQSB2YWxpZCBET00gcm9vdCB3aGVyZSB0aGUgZmFrZSBzZWxlY3Rpb24gY29udGFpbmVyIHNob3VsZCBiZSBhZGRlZC4KICAgKi8KCgogIF91cGRhdGVGYWtlU2VsZWN0aW9uKGRvbVJvb3QpIHsKICAgIGNvbnN0IGRvbURvY3VtZW50ID0gZG9tUm9vdC5vd25lckRvY3VtZW50OwoKICAgIGlmICghdGhpcy5fZmFrZVNlbGVjdGlvbkNvbnRhaW5lcikgewogICAgICB0aGlzLl9mYWtlU2VsZWN0aW9uQ29udGFpbmVyID0gY3JlYXRlRmFrZVNlbGVjdGlvbkNvbnRhaW5lcihkb21Eb2N1bWVudCk7CiAgICB9CgogICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5fZmFrZVNlbGVjdGlvbkNvbnRhaW5lcjsgLy8gQmluZCBmYWtlIHNlbGVjdGlvbiBjb250YWluZXIgd2l0aCB0aGUgY3VycmVudCBzZWxlY3Rpb24gKnBvc2l0aW9uKi4KCiAgICB0aGlzLmRvbUNvbnZlcnRlci5iaW5kRmFrZVNlbGVjdGlvbihjb250YWluZXIsIHRoaXMuc2VsZWN0aW9uKTsKCiAgICBpZiAoIXRoaXMuX2Zha2VTZWxlY3Rpb25OZWVkc1VwZGF0ZShkb21Sb290KSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKCFjb250YWluZXIucGFyZW50RWxlbWVudCB8fCBjb250YWluZXIucGFyZW50RWxlbWVudCAhPSBkb21Sb290KSB7CiAgICAgIGRvbVJvb3QuYXBwZW5kQ2hpbGQoY29udGFpbmVyKTsKICAgIH0KCiAgICBjb250YWluZXIudGV4dENvbnRlbnQgPSB0aGlzLnNlbGVjdGlvbi5mYWtlU2VsZWN0aW9uTGFiZWwgfHwgJ1x1MDBBMCc7CiAgICBjb25zdCBkb21TZWxlY3Rpb24gPSBkb21Eb2N1bWVudC5nZXRTZWxlY3Rpb24oKTsKICAgIGNvbnN0IGRvbVJhbmdlID0gZG9tRG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKICAgIGRvbVNlbGVjdGlvbi5yZW1vdmVBbGxSYW5nZXMoKTsKICAgIGRvbVJhbmdlLnNlbGVjdE5vZGVDb250ZW50cyhjb250YWluZXIpOwogICAgZG9tU2VsZWN0aW9uLmFkZFJhbmdlKGRvbVJhbmdlKTsKICB9CiAgLyoqCiAgICogVXBkYXRlcyB0aGUgRE9NIHNlbGVjdGlvbi4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gZG9tUm9vdCBBIHZhbGlkIERPTSByb290IHdoZXJlIHRoZSBET00gc2VsZWN0aW9uIHNob3VsZCBiZSByZW5kZXJlZC4KICAgKi8KCgogIF91cGRhdGVEb21TZWxlY3Rpb24oZG9tUm9vdCkgewogICAgY29uc3QgZG9tU2VsZWN0aW9uID0gZG9tUm9vdC5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LmdldFNlbGVjdGlvbigpOyAvLyBMZXQncyBjaGVjayB3aGV0aGVyIERPTSBzZWxlY3Rpb24gbmVlZHMgdXBkYXRpbmcgYXQgYWxsLgoKICAgIGlmICghdGhpcy5fZG9tU2VsZWN0aW9uTmVlZHNVcGRhdGUoZG9tU2VsZWN0aW9uKSkgewogICAgICByZXR1cm47CiAgICB9IC8vIE11bHRpLXJhbmdlIHNlbGVjdGlvbiBpcyBub3QgYXZhaWxhYmxlIGluIG1vc3QgYnJvd3NlcnMsIGFuZCwgYXQgbGVhc3QgaW4gQ2hyb21lLCB0cnlpbmcgdG8KICAgIC8vIHNldCBzdWNoIHNlbGVjdGlvbiwgdGhhdCBpcyBub3QgY29udGludW91cywgdGhyb3dzIGFuIGVycm9yLiBCZWNhdXNlIG9mIHRoYXQsIHdlIHdpbGwganVzdCB1c2UgYW5jaG9yCiAgICAvLyBhbmQgZm9jdXMgb2YgdmlldyBzZWxlY3Rpb24uCiAgICAvLyBTaW5jZSB3ZSBhcmUgbm90IHN1cHBvcnRpbmcgbXVsdGktcmFuZ2Ugc2VsZWN0aW9uLCB3ZSBhbHNvIGRvIG5vdCBuZWVkIHRvIGNoZWNrIGlmIHByb3BlciBlZGl0YWJsZSBpcwogICAgLy8gc2VsZWN0ZWQuIElmIHRoZXJlIGlzIGFueSBlZGl0YWJsZSBzZWxlY3RlZCwgaXQgaXMgb2theSAoZWRpdGFibGUgaXMgdGFrZW4gZnJvbSBzZWxlY3Rpb24gYW5jaG9yKS4KCgogICAgY29uc3QgYW5jaG9yID0gdGhpcy5kb21Db252ZXJ0ZXIudmlld1Bvc2l0aW9uVG9Eb20odGhpcy5zZWxlY3Rpb24uYW5jaG9yKTsKICAgIGNvbnN0IGZvY3VzID0gdGhpcy5kb21Db252ZXJ0ZXIudmlld1Bvc2l0aW9uVG9Eb20odGhpcy5zZWxlY3Rpb24uZm9jdXMpOyAvLyBGb2N1cyB0aGUgbmV3IGVkaXRpbmcgaG9zdC4KICAgIC8vIE90aGVyd2lzZSwgRkYgbWF5IHRocm93IGFuIGVycm9yIChodHRwczovL2dpdGh1Yi5jb20vY2tlZGl0b3IvY2tlZGl0b3I1L2lzc3Vlcy83MjEpLgoKICAgIGRvbVJvb3QuZm9jdXMoKTsKICAgIGRvbVNlbGVjdGlvbi5jb2xsYXBzZShhbmNob3IucGFyZW50LCBhbmNob3Iub2Zmc2V0KTsKICAgIGRvbVNlbGVjdGlvbi5leHRlbmQoZm9jdXMucGFyZW50LCBmb2N1cy5vZmZzZXQpOyAvLyBGaXJlZm944oCTc3BlY2lmaWMgaGFjayAoaHR0cHM6Ly9naXRodWIuY29tL2NrZWRpdG9yL2NrZWRpdG9yNS1lbmdpbmUvaXNzdWVzLzE0MzkpLgoKICAgIGlmIChlbnYuaXNHZWNrbykgewogICAgICBmaXhHZWNrb1NlbGVjdGlvbkFmdGVyQnIoZm9jdXMsIGRvbVNlbGVjdGlvbik7CiAgICB9CiAgfQogIC8qKgogICAqIENoZWNrcyB3aGV0aGVyIGEgZ2l2ZW4gRE9NIHNlbGVjdGlvbiBuZWVkcyB0byBiZSB1cGRhdGVkLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge1NlbGVjdGlvbn0gZG9tU2VsZWN0aW9uIFRoZSBET00gc2VsZWN0aW9uIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtCb29sZWFufQogICAqLwoKCiAgX2RvbVNlbGVjdGlvbk5lZWRzVXBkYXRlKGRvbVNlbGVjdGlvbikgewogICAgaWYgKCF0aGlzLmRvbUNvbnZlcnRlci5pc0RvbVNlbGVjdGlvbkNvcnJlY3QoZG9tU2VsZWN0aW9uKSkgewogICAgICAvLyBDdXJyZW50IERPTSBzZWxlY3Rpb24gaXMgaW4gaW5jb3JyZWN0IHBvc2l0aW9uLiBXZSBuZWVkIHRvIHVwZGF0ZSBpdC4KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgY29uc3Qgb2xkVmlld1NlbGVjdGlvbiA9IGRvbVNlbGVjdGlvbiAmJiB0aGlzLmRvbUNvbnZlcnRlci5kb21TZWxlY3Rpb25Ub1ZpZXcoZG9tU2VsZWN0aW9uKTsKCiAgICBpZiAob2xkVmlld1NlbGVjdGlvbiAmJiB0aGlzLnNlbGVjdGlvbi5pc0VxdWFsKG9sZFZpZXdTZWxlY3Rpb24pKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gLy8gSWYgc2VsZWN0aW9uIGlzIG5vdCBjb2xsYXBzZWQsIGl0IGRvZXMgbm90IG5lZWQgdG8gYmUgdXBkYXRlZCBpZiBpdCBpcyBzaW1pbGFyLgoKCiAgICBpZiAoIXRoaXMuc2VsZWN0aW9uLmlzQ29sbGFwc2VkICYmIHRoaXMuc2VsZWN0aW9uLmlzU2ltaWxhcihvbGRWaWV3U2VsZWN0aW9uKSkgewogICAgICAvLyBTZWxlY3Rpb24gZGlkIG5vdCBjaGFuZ2VkIGFuZCBpcyBjb3JyZWN0LCBkbyBub3QgdXBkYXRlLgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9IC8vIFNlbGVjdGlvbnMgYXJlIG5vdCBzaW1pbGFyLgoKCiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgLyoqCiAgICogQ2hlY2tzIHdoZXRoZXIgdGhlIGZha2Ugc2VsZWN0aW9uIG5lZWRzIHRvIGJlIHVwZGF0ZWQuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IGRvbVJvb3QgQSB2YWxpZCBET00gcm9vdCB3aGVyZSBhIG5ldyBmYWtlIHNlbGVjdGlvbiBjb250YWluZXIgc2hvdWxkIGJlIGFkZGVkLgogICAqIEByZXR1cm5zIHtCb29sZWFufQogICAqLwoKCiAgX2Zha2VTZWxlY3Rpb25OZWVkc1VwZGF0ZShkb21Sb290KSB7CiAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLl9mYWtlU2VsZWN0aW9uQ29udGFpbmVyOwogICAgY29uc3QgZG9tU2VsZWN0aW9uID0gZG9tUm9vdC5vd25lckRvY3VtZW50LmdldFNlbGVjdGlvbigpOyAvLyBGYWtlIHNlbGVjdGlvbiBuZWVkcyB0byBiZSB1cGRhdGVkIGlmIHRoZXJlJ3Mgbm8gZmFrZSBzZWxlY3Rpb24gY29udGFpbmVyLCBvciB0aGUgY29udGFpbmVyIGN1cnJlbnRseSBzaXRzCiAgICAvLyBpbiBhIGRpZmZlcmVudCByb290LgoKICAgIGlmICghY29udGFpbmVyIHx8IGNvbnRhaW5lci5wYXJlbnRFbGVtZW50ICE9PSBkb21Sb290KSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgc2VsZWN0aW9uIGFjdHVhbGx5IGlzIHdpdGhpbiB0aGUgZmFrZSBzZWxlY3Rpb24uCgoKICAgIGlmIChkb21TZWxlY3Rpb24uYW5jaG9yTm9kZSAhPT0gY29udGFpbmVyICYmICFjb250YWluZXIuY29udGFpbnMoZG9tU2VsZWN0aW9uLmFuY2hvck5vZGUpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHJldHVybiBjb250YWluZXIudGV4dENvbnRlbnQgIT09IHRoaXMuc2VsZWN0aW9uLmZha2VTZWxlY3Rpb25MYWJlbDsKICB9CiAgLyoqCiAgICogUmVtb3ZlcyB0aGUgRE9NIHNlbGVjdGlvbi4KICAgKgogICAqIEBwcml2YXRlCiAgICovCgoKICBfcmVtb3ZlRG9tU2VsZWN0aW9uKCkgewogICAgZm9yIChjb25zdCBkb2Mgb2YgdGhpcy5kb21Eb2N1bWVudHMpIHsKICAgICAgY29uc3QgZG9tU2VsZWN0aW9uID0gZG9jLmdldFNlbGVjdGlvbigpOwoKICAgICAgaWYgKGRvbVNlbGVjdGlvbi5yYW5nZUNvdW50KSB7CiAgICAgICAgY29uc3QgYWN0aXZlRG9tRWxlbWVudCA9IGRvYy5hY3RpdmVFbGVtZW50OwogICAgICAgIGNvbnN0IHZpZXdFbGVtZW50ID0gdGhpcy5kb21Db252ZXJ0ZXIubWFwRG9tVG9WaWV3KGFjdGl2ZURvbUVsZW1lbnQpOwoKICAgICAgICBpZiAoYWN0aXZlRG9tRWxlbWVudCAmJiB2aWV3RWxlbWVudCkgewogICAgICAgICAgZG9jLmdldFNlbGVjdGlvbigpLnJlbW92ZUFsbFJhbmdlcygpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBSZW1vdmVzIHRoZSBmYWtlIHNlbGVjdGlvbi4KICAgKgogICAqIEBwcml2YXRlCiAgICovCgoKICBfcmVtb3ZlRmFrZVNlbGVjdGlvbigpIHsKICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuX2Zha2VTZWxlY3Rpb25Db250YWluZXI7CgogICAgaWYgKGNvbnRhaW5lcikgewogICAgICBjb250YWluZXIucmVtb3ZlKCk7CiAgICB9CiAgfQogIC8qKgogICAqIENoZWNrcyBpZiBmb2N1cyBuZWVkcyB0byBiZSB1cGRhdGVkIGFuZCBwb3NzaWJseSB1cGRhdGVzIGl0LgogICAqCiAgICogQHByaXZhdGUKICAgKi8KCgogIF91cGRhdGVGb2N1cygpIHsKICAgIGlmICh0aGlzLmlzRm9jdXNlZCkgewogICAgICBjb25zdCBlZGl0YWJsZSA9IHRoaXMuc2VsZWN0aW9uLmVkaXRhYmxlRWxlbWVudDsKCiAgICAgIGlmIChlZGl0YWJsZSkgewogICAgICAgIHRoaXMuZG9tQ29udmVydGVyLmZvY3VzKGVkaXRhYmxlKTsKICAgICAgfQogICAgfQogIH0KCn0KbWl4KFJlbmRlcmVyLCBPYnNlcnZhYmxlTWl4aW4pOyAvLyBDaGVja3MgaWYgcHJvdmlkZWQgZWxlbWVudCBpcyBlZGl0YWJsZS4KLy8KLy8gQHByaXZhdGUKLy8gQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvZWxlbWVudH5FbGVtZW50fSBlbGVtZW50Ci8vIEByZXR1cm5zIHtCb29sZWFufQoKZnVuY3Rpb24gaXNFZGl0YWJsZShlbGVtZW50KSB7CiAgaWYgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdjb250ZW50ZWRpdGFibGUnKSA9PSAnZmFsc2UnKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBjb25zdCBwYXJlbnQgPSBlbGVtZW50LmZpbmRBbmNlc3RvcihlbGVtZW50ID0+IGVsZW1lbnQuaGFzQXR0cmlidXRlKCdjb250ZW50ZWRpdGFibGUnKSk7CiAgcmV0dXJuICFwYXJlbnQgfHwgcGFyZW50LmdldEF0dHJpYnV0ZSgnY29udGVudGVkaXRhYmxlJykgPT0gJ3RydWUnOwp9IC8vIEFkZHMgaW5saW5lIGZpbGxlciBhdCBhIGdpdmVuIHBvc2l0aW9uLgovLwovLyBUaGUgcG9zaXRpb24gY2FuIGJlIGdpdmVuIGFzIGFuIGFycmF5IG9mIERPTSBub2RlcyBhbmQgYW4gb2Zmc2V0IGluIHRoYXQgYXJyYXksCi8vIG9yIGEgRE9NIHBhcmVudCBlbGVtZW50IGFuZCBhbiBvZmZzZXQgaW4gdGhhdCBlbGVtZW50LgovLwovLyBAcHJpdmF0ZQovLyBAcGFyYW0ge0RvY3VtZW50fSBkb21Eb2N1bWVudAovLyBAcGFyYW0ge0VsZW1lbnR8QXJyYXkuPE5vZGU+fSBkb21QYXJlbnRPckFycmF5Ci8vIEBwYXJhbSB7TnVtYmVyfSBvZmZzZXQKLy8gQHJldHVybnMge1RleHR9IFRoZSBET00gdGV4dCBub2RlIHRoYXQgY29udGFpbnMgYW4gaW5saW5lIGZpbGxlci4KCgpmdW5jdGlvbiBhZGRJbmxpbmVGaWxsZXIoZG9tRG9jdW1lbnQsIGRvbVBhcmVudE9yQXJyYXksIG9mZnNldCkgewogIGNvbnN0IGNoaWxkTm9kZXMgPSBkb21QYXJlbnRPckFycmF5IGluc3RhbmNlb2YgQXJyYXkgPyBkb21QYXJlbnRPckFycmF5IDogZG9tUGFyZW50T3JBcnJheS5jaGlsZE5vZGVzOwogIGNvbnN0IG5vZGVBZnRlckZpbGxlciA9IGNoaWxkTm9kZXNbb2Zmc2V0XTsKCiAgaWYgKGlzVGV4dChub2RlQWZ0ZXJGaWxsZXIpKSB7CiAgICBub2RlQWZ0ZXJGaWxsZXIuZGF0YSA9IElOTElORV9GSUxMRVIgKyBub2RlQWZ0ZXJGaWxsZXIuZGF0YTsKICAgIHJldHVybiBub2RlQWZ0ZXJGaWxsZXI7CiAgfSBlbHNlIHsKICAgIGNvbnN0IGZpbGxlck5vZGUgPSBkb21Eb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShJTkxJTkVfRklMTEVSKTsKCiAgICBpZiAoQXJyYXkuaXNBcnJheShkb21QYXJlbnRPckFycmF5KSkgewogICAgICBjaGlsZE5vZGVzLnNwbGljZShvZmZzZXQsIDAsIGZpbGxlck5vZGUpOwogICAgfSBlbHNlIHsKICAgICAgaW5zZXJ0QXQoZG9tUGFyZW50T3JBcnJheSwgb2Zmc2V0LCBmaWxsZXJOb2RlKTsKICAgIH0KCiAgICByZXR1cm4gZmlsbGVyTm9kZTsKICB9Cn0gLy8gV2hldGhlciB0d28gRE9NIG5vZGVzIHNob3VsZCBiZSBjb25zaWRlcmVkIGFzIHNpbWlsYXIuCi8vIE5vZGVzIGFyZSBjb25zaWRlcmVkIHNpbWlsYXIgaWYgdGhleSBoYXZlIHRoZSBzYW1lIHRhZyBuYW1lLgovLwovLyBAcHJpdmF0ZQovLyBAcGFyYW0ge05vZGV9IG5vZGUxCi8vIEBwYXJhbSB7Tm9kZX0gbm9kZTIKLy8gQHJldHVybnMge0Jvb2xlYW59CgoKZnVuY3Rpb24gYXJlU2ltaWxhcihub2RlMSwgbm9kZTIpIHsKICByZXR1cm4gaXNOb2RlKG5vZGUxKSAmJiBpc05vZGUobm9kZTIpICYmICFpc1RleHQobm9kZTEpICYmICFpc1RleHQobm9kZTIpICYmIG5vZGUxLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gbm9kZTIudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwp9IC8vIFdoZXRoZXIgdHdvIGRvbSBub2RlcyBzaG91bGQgYmUgY29uc2lkZXJlZCBhcyB0aGUgc2FtZS4KLy8gVHdvIG5vZGVzIHdoaWNoIGFyZSBjb25zaWRlcmVkIHRoZSBzYW1lIGFyZToKLy8KLy8JCSogVGV4dCBub2RlcyB3aXRoIHRoZSBzYW1lIHRleHQuCi8vCQkqIEVsZW1lbnQgbm9kZXMgcmVwcmVzZW50ZWQgYnkgdGhlIHNhbWUgb2JqZWN0LgovLwkJKiBUd28gYmxvY2sgZmlsbGVyIGVsZW1lbnRzLgovLwovLyBAcHJpdmF0ZQovLyBAcGFyYW0ge1N0cmluZ30gYmxvY2tGaWxsZXJNb2RlIEJsb2NrIGZpbGxlciBtb2RlLCBzZWUge0BsaW5rIG1vZHVsZTplbmdpbmUvdmlldy9kb21jb252ZXJ0ZXJ+RG9tQ29udmVydGVyI2Jsb2NrRmlsbGVyTW9kZX0uCi8vIEBwYXJhbSB7Tm9kZX0gbm9kZTEKLy8gQHBhcmFtIHtOb2RlfSBub2RlMgovLyBAcmV0dXJucyB7Qm9vbGVhbn0KCgpmdW5jdGlvbiBzYW1lTm9kZXMoZG9tQ29udmVydGVyLCBhY3R1YWxEb21DaGlsZCwgZXhwZWN0ZWREb21DaGlsZCkgewogIC8vIEVsZW1lbnRzLgogIGlmIChhY3R1YWxEb21DaGlsZCA9PT0gZXhwZWN0ZWREb21DaGlsZCkgewogICAgcmV0dXJuIHRydWU7CiAgfSAvLyBUZXh0cy4KICBlbHNlIGlmIChpc1RleHQoYWN0dWFsRG9tQ2hpbGQpICYmIGlzVGV4dChleHBlY3RlZERvbUNoaWxkKSkgewogICAgICByZXR1cm4gYWN0dWFsRG9tQ2hpbGQuZGF0YSA9PT0gZXhwZWN0ZWREb21DaGlsZC5kYXRhOwogICAgfSAvLyBCbG9jayBmaWxsZXJzLgogICAgZWxzZSBpZiAoZG9tQ29udmVydGVyLmlzQmxvY2tGaWxsZXIoYWN0dWFsRG9tQ2hpbGQpICYmIGRvbUNvbnZlcnRlci5pc0Jsb2NrRmlsbGVyKGV4cGVjdGVkRG9tQ2hpbGQpKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gLy8gTm90IG1hdGNoaW5nIHR5cGVzLgoKCiAgcmV0dXJuIGZhbHNlOwp9IC8vIFRoZSBmb2xsb3dpbmcgaXMgYSBGaXJlZm944oCTc3BlY2lmaWMgaGFjayAoaHR0cHM6Ly9naXRodWIuY29tL2NrZWRpdG9yL2NrZWRpdG9yNS1lbmdpbmUvaXNzdWVzLzE0MzkpLgovLyBXaGVuIHRoZSBuYXRpdmUgRE9NIHNlbGVjdGlvbiBpcyBhdCB0aGUgZW5kIG9mIHRoZSBibG9jayBhbmQgcHJlY2VkZWQgYnkgPGJyIC8+IGUuZy4KLy8KLy8JCTxwPmZvbzxici8+W108L3A+Ci8vCi8vIHdoaWNoIGhhcHBlbnMgYSBsb3Qgd2hlbiB1c2luZyB0aGUgc29mdCBsaW5lIGJyZWFrLCB0aGUgYnJvd3NlciBmYWlscyB0byAodmlzdWFsbHkpIG1vdmUgdGhlCi8vIGNhcmV0IHRvIHRoZSBuZXcgbGluZS4gQSBxdWljayBmaXggaXMgYXMgc2ltcGxlIGFzIGZvcmNl4oCTcmVmcmVzaGluZyB0aGUgc2VsZWN0aW9uIHdpdGggdGhlIHNhbWUgcmFuZ2UuCgoKZnVuY3Rpb24gZml4R2Vja29TZWxlY3Rpb25BZnRlckJyKGZvY3VzLCBkb21TZWxlY3Rpb24pIHsKICBjb25zdCBwYXJlbnQgPSBmb2N1cy5wYXJlbnQ7IC8vIFRoaXMgZml4IHdvcmtzIG9ubHkgd2hlbiB0aGUgZm9jdXMgcG9pbnQgaXMgYXQgdGhlIHZlcnkgZW5kIG9mIGFuIGVsZW1lbnQuCiAgLy8gVGhlcmUgaXMgbm8gcG9pbnQgaW4gcnVubmluZyBpdCBpbiBjYXNlcyB1bnJlbGF0ZWQgdG8gdGhlIGJyb3dzZXIgYnVnLgoKICBpZiAocGFyZW50Lm5vZGVUeXBlICE9IE5vZGUuRUxFTUVOVF9OT0RFIHx8IGZvY3VzLm9mZnNldCAhPSBwYXJlbnQuY2hpbGROb2Rlcy5sZW5ndGggLSAxKSB7CiAgICByZXR1cm47CiAgfQoKICBjb25zdCBjaGlsZEF0T2Zmc2V0ID0gcGFyZW50LmNoaWxkTm9kZXNbZm9jdXMub2Zmc2V0XTsgLy8gVG8gc3RheSBvbiB0aGUgc2FmZSBzaWRlLCB0aGUgZml4IGJlaW5nIGFzIHNwZWNpZmljIGFzIHBvc3NpYmxlLCBpdCB0YXJnZXRzIG9ubHkgdGhlCiAgLy8gc2VsZWN0aW9uIHdoaWNoIGlzIGF0IHRoZSB2ZXJ5IGVuZCBvZiB0aGUgZWxlbWVudCBhbmQgcHJlY2VkZWQgYnkgPGJyIC8+LgoKICBpZiAoY2hpbGRBdE9mZnNldCAmJiBjaGlsZEF0T2Zmc2V0LnRhZ05hbWUgPT0gJ0JSJykgewogICAgZG9tU2VsZWN0aW9uLmFkZFJhbmdlKGRvbVNlbGVjdGlvbi5nZXRSYW5nZUF0KDApKTsKICB9Cn0KCmZ1bmN0aW9uIGZpbHRlck91dEZha2VTZWxlY3Rpb25Db250YWluZXIoZG9tQ2hpbGRMaXN0LCBmYWtlU2VsZWN0aW9uQ29udGFpbmVyKSB7CiAgY29uc3QgY2hpbGRMaXN0ID0gQXJyYXkuZnJvbShkb21DaGlsZExpc3QpOwoKICBpZiAoY2hpbGRMaXN0Lmxlbmd0aCA9PSAwIHx8ICFmYWtlU2VsZWN0aW9uQ29udGFpbmVyKSB7CiAgICByZXR1cm4gY2hpbGRMaXN0OwogIH0KCiAgY29uc3QgbGFzdCA9IGNoaWxkTGlzdFtjaGlsZExpc3QubGVuZ3RoIC0gMV07CgogIGlmIChsYXN0ID09IGZha2VTZWxlY3Rpb25Db250YWluZXIpIHsKICAgIGNoaWxkTGlzdC5wb3AoKTsKICB9CgogIHJldHVybiBjaGlsZExpc3Q7Cn0gLy8gQ3JlYXRlcyBhIGZha2Ugc2VsZWN0aW9uIGNvbnRhaW5lciBmb3IgYSBnaXZlbiBkb2N1bWVudC4KLy8KLy8gQHByaXZhdGUKLy8gQHBhcmFtIHtEb2N1bWVudH0gZG9tRG9jdW1lbnQKLy8gQHJldHVybnMge0hUTUxFbGVtZW50fQoKCmZ1bmN0aW9uIGNyZWF0ZUZha2VTZWxlY3Rpb25Db250YWluZXIoZG9tRG9jdW1lbnQpIHsKICBjb25zdCBjb250YWluZXIgPSBkb21Eb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICBPYmplY3QuYXNzaWduKGNvbnRhaW5lci5zdHlsZSwgewogICAgcG9zaXRpb246ICdmaXhlZCcsCiAgICB0b3A6IDAsCiAgICBsZWZ0OiAnLTk5OTlweCcsCiAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2NrZWRpdG9yL2NrZWRpdG9yNS9pc3N1ZXMvNzUyLgogICAgd2lkdGg6ICc0MnB4JwogIH0pOyAvLyBGaWxsIGl0IHdpdGggYSB0ZXh0IG5vZGUgc28gd2UgY2FuIHVwZGF0ZSBpdCBsYXRlci4KCiAgY29udGFpbmVyLnRleHRDb250ZW50ID0gJ1x1MDBBMCc7CiAgcmV0dXJuIGNvbnRhaW5lcjsKfQ=="},{"version":3,"sources":["/Users/antonyching/Desktop/project/new-builder-demo/node_modules/@ckeditor/ckeditor5-engine/src/view/renderer.js"],"names":["ViewText","ViewPosition","INLINE_FILLER","INLINE_FILLER_LENGTH","startsWithFiller","isInlineFiller","mix","diff","insertAt","remove","ObservableMixin","CKEditorError","isText","isNode","fastDiff","env","Renderer","constructor","domConverter","selection","domDocuments","Set","markedAttributes","markedChildren","markedTexts","isFocused","_inlineFiller","_fakeSelectionContainer","markToSync","type","node","mapViewToDom","parent","add","render","inlineFillerPosition","element","_updateChildrenMappings","_isSelectionInInlineFiller","_removeInlineFiller","_getInlineFillerPosition","_needsInlineFillerAtSelection","getFirstPosition","_updateAttrs","_updateChildren","has","_updateText","fillerDomPosition","viewPositionToDom","domDocument","ownerDocument","addInlineFiller","offset","_updateSelection","_updateFocus","clear","viewElement","domElement","actualDomChildren","childNodes","expectedDomChildren","Array","from","viewChildrenToDom","withChildren","_diffNodeLists","actions","_findReplaceActions","indexOf","counter","equal","insert","delete","action","insertIndex","deleteIndex","viewChild","getChild","is","_updateElementMappings","unbindDomElement","bindElements","firstPos","_createBefore","rangeCount","isCollapsed","selectionPosition","position","domFillerNode","parentNode","removeChild","data","substr","selectionParent","selectionOffset","root","isEditable","getFillerOffset","nodeBefore","nodeAfter","viewText","options","domText","findCorrespondingDomText","newDomText","viewToDom","actualText","expectedText","filler","index","insertData","values","join","deleteData","howMany","domAttrKeys","attributes","map","attr","name","viewAttrKeys","getAttributeKeys","key","setAttribute","getAttribute","hasAttribute","removeAttribute","bind","i","nodesToUnbind","_markDescendantTextToSync","domToView","filterOutFakeSelectionContainer","sameNodes","actualDom","expectedDom","newActions","actualSlice","expectedSlice","push","concat","areSimilar","x","viewNode","child","getChildren","_removeDomSelection","_removeFakeSelection","domRoot","editableElement","isFake","_updateFakeSelection","_updateDomSelection","createFakeSelectionContainer","container","bindFakeSelection","_fakeSelectionNeedsUpdate","parentElement","appendChild","textContent","fakeSelectionLabel","domSelection","getSelection","domRange","createRange","removeAllRanges","selectNodeContents","addRange","defaultView","_domSelectionNeedsUpdate","anchor","focus","collapse","extend","isGecko","fixGeckoSelectionAfterBr","isDomSelectionCorrect","oldViewSelection","domSelectionToView","isEqual","isSimilar","anchorNode","contains","doc","activeDomElement","activeElement","mapDomToView","editable","findAncestor","domParentOrArray","nodeAfterFiller","fillerNode","createTextNode","isArray","splice","node1","node2","tagName","toLowerCase","actualDomChild","expectedDomChild","isBlockFiller","nodeType","Node","ELEMENT_NODE","length","childAtOffset","getRangeAt","domChildList","fakeSelectionContainer","childList","last","pop","createElement","Object","assign","style","top","left","width"],"mappings":"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","sourcesContent":["/**\n * @license Copyright (c) 2003-2019, CKSource - Frederico Knabben. All rights reserved.\n * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license\n */\n\n/* globals Node */\n\n/**\n * @module engine/view/renderer\n */\n\nimport ViewText from './text';\nimport ViewPosition from './position';\nimport { INLINE_FILLER, INLINE_FILLER_LENGTH, startsWithFiller, isInlineFiller } from './filler';\n\nimport mix from '@ckeditor/ckeditor5-utils/src/mix';\nimport diff from '@ckeditor/ckeditor5-utils/src/diff';\nimport insertAt from '@ckeditor/ckeditor5-utils/src/dom/insertat';\nimport remove from '@ckeditor/ckeditor5-utils/src/dom/remove';\nimport ObservableMixin from '@ckeditor/ckeditor5-utils/src/observablemixin';\nimport CKEditorError from '@ckeditor/ckeditor5-utils/src/ckeditorerror';\nimport isText from '@ckeditor/ckeditor5-utils/src/dom/istext';\nimport isNode from '@ckeditor/ckeditor5-utils/src/dom/isnode';\nimport fastDiff from '@ckeditor/ckeditor5-utils/src/fastdiff';\nimport env from '@ckeditor/ckeditor5-utils/src/env';\n\n/**\n * Renderer is responsible for updating the DOM structure and the DOM selection based on\n * the {@link module:engine/view/renderer~Renderer#markToSync information about updated view nodes}.\n * In other words, it renders the view to the DOM.\n *\n * Its main responsibility is to make only the necessary, minimal changes to the DOM. However, unlike in many\n * virtual DOM implementations, the primary reason for doing minimal changes is not the performance but ensuring\n * that native editing features such as text composition, autocompletion, spell checking, selection's x-index are\n * affected as little as possible.\n *\n * Renderer uses {@link module:engine/view/domconverter~DomConverter} to transform view nodes and positions\n * to and from the DOM.\n */\nexport default class Renderer {\n\t/**\n\t * Creates a renderer instance.\n\t *\n\t * @param {module:engine/view/domconverter~DomConverter} domConverter Converter instance.\n\t * @param {module:engine/view/documentselection~DocumentSelection} selection View selection.\n\t */\n\tconstructor( domConverter, selection ) {\n\t\t/**\n\t\t * Set of DOM Documents instances.\n\t\t *\n\t\t * @readonly\n\t\t * @member {Set.<Document>}\n\t\t */\n\t\tthis.domDocuments = new Set();\n\n\t\t/**\n\t\t * Converter instance.\n\t\t *\n\t\t * @readonly\n\t\t * @member {module:engine/view/domconverter~DomConverter}\n\t\t */\n\t\tthis.domConverter = domConverter;\n\n\t\t/**\n\t\t * Set of nodes which attributes changed and may need to be rendered.\n\t\t *\n\t\t * @readonly\n\t\t * @member {Set.<module:engine/view/node~Node>}\n\t\t */\n\t\tthis.markedAttributes = new Set();\n\n\t\t/**\n\t\t * Set of elements which child lists changed and may need to be rendered.\n\t\t *\n\t\t * @readonly\n\t\t * @member {Set.<module:engine/view/node~Node>}\n\t\t */\n\t\tthis.markedChildren = new Set();\n\n\t\t/**\n\t\t * Set of text nodes which text data changed and may need to be rendered.\n\t\t *\n\t\t * @readonly\n\t\t * @member {Set.<module:engine/view/node~Node>}\n\t\t */\n\t\tthis.markedTexts = new Set();\n\n\t\t/**\n\t\t * View selection. Renderer updates DOM selection based on the view selection.\n\t\t *\n\t\t * @readonly\n\t\t * @member {module:engine/view/documentselection~DocumentSelection}\n\t\t */\n\t\tthis.selection = selection;\n\n\t\t/**\n\t\t * Indicates if the view document is focused and selection can be rendered. Selection will not be rendered if\n\t\t * this is set to `false`.\n\t\t *\n\t\t * @member {Boolean}\n\t\t */\n\t\tthis.isFocused = false;\n\n\t\t/**\n\t\t * The text node in which the inline filler was rendered.\n\t\t *\n\t\t * @private\n\t\t * @member {Text}\n\t\t */\n\t\tthis._inlineFiller = null;\n\n\t\t/**\n\t\t * DOM element containing fake selection.\n\t\t *\n\t\t * @private\n\t\t * @type {null|HTMLElement}\n\t\t */\n\t\tthis._fakeSelectionContainer = null;\n\t}\n\n\t/**\n\t * Marks a view node to be updated in the DOM by {@link #render `render()`}.\n\t *\n\t * Note that only view nodes whose parents have corresponding DOM elements need to be marked to be synchronized.\n\t *\n\t * @see #markedAttributes\n\t * @see #markedChildren\n\t * @see #markedTexts\n\t *\n\t * @param {module:engine/view/document~ChangeType} type Type of the change.\n\t * @param {module:engine/view/node~Node} node Node to be marked.\n\t */\n\tmarkToSync( type, node ) {\n\t\tif ( type === 'text' ) {\n\t\t\tif ( this.domConverter.mapViewToDom( node.parent ) ) {\n\t\t\t\tthis.markedTexts.add( node );\n\t\t\t}\n\t\t} else {\n\t\t\t// If the node has no DOM element it is not rendered yet,\n\t\t\t// its children/attributes do not need to be marked to be sync.\n\t\t\tif ( !this.domConverter.mapViewToDom( node ) ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ( type === 'attributes' ) {\n\t\t\t\tthis.markedAttributes.add( node );\n\t\t\t} else if ( type === 'children' ) {\n\t\t\t\tthis.markedChildren.add( node );\n\t\t\t} else {\n\t\t\t\t/**\n\t\t\t\t * Unknown type passed to Renderer.markToSync.\n\t\t\t\t *\n\t\t\t\t * @error renderer-unknown-type\n\t\t\t\t */\n\t\t\t\tthrow new CKEditorError( 'view-renderer-unknown-type: Unknown type passed to Renderer.markToSync.', this );\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Renders all buffered changes ({@link #markedAttributes}, {@link #markedChildren} and {@link #markedTexts}) and\n\t * the current view selection (if needed) to the DOM by applying a minimal set of changes to it.\n\t *\n\t * Renderer tries not to break the text composition (e.g. IME) and x-index of the selection,\n\t * so it does as little as it is needed to update the DOM.\n\t *\n\t * Renderer also handles {@link module:engine/view/filler fillers}. Especially, it checks if the inline filler is needed\n\t * at the selection position and adds or removes it. To prevent breaking text composition inline filler will not be\n\t * removed as long as the selection is in the text node which needed it at first.\n\t */\n\trender() {\n\t\tlet inlineFillerPosition;\n\n\t\t// Refresh mappings.\n\t\tfor ( const element of this.markedChildren ) {\n\t\t\tthis._updateChildrenMappings( element );\n\t\t}\n\n\t\t// There was inline filler rendered in the DOM but it's not\n\t\t// at the selection position any more, so we can remove it\n\t\t// (cause even if it's needed, it must be placed in another location).\n\t\tif ( this._inlineFiller && !this._isSelectionInInlineFiller() ) {\n\t\t\tthis._removeInlineFiller();\n\t\t}\n\n\t\t// If we've got the filler, let's try to guess its position in the view.\n\t\tif ( this._inlineFiller ) {\n\t\t\tinlineFillerPosition = this._getInlineFillerPosition();\n\t\t}\n\t\t// Otherwise, if it's needed, create it at the selection position.\n\t\telse if ( this._needsInlineFillerAtSelection() ) {\n\t\t\tinlineFillerPosition = this.selection.getFirstPosition();\n\n\t\t\t// Do not use `markToSync` so it will be added even if the parent is already added.\n\t\t\tthis.markedChildren.add( inlineFillerPosition.parent );\n\t\t}\n\n\t\tfor ( const element of this.markedAttributes ) {\n\t\t\tthis._updateAttrs( element );\n\t\t}\n\n\t\tfor ( const element of this.markedChildren ) {\n\t\t\tthis._updateChildren( element, { inlineFillerPosition } );\n\t\t}\n\n\t\tfor ( const node of this.markedTexts ) {\n\t\t\tif ( !this.markedChildren.has( node.parent ) && this.domConverter.mapViewToDom( node.parent ) ) {\n\t\t\t\tthis._updateText( node, { inlineFillerPosition } );\n\t\t\t}\n\t\t}\n\n\t\t// Check whether the inline filler is required and where it really is in the DOM.\n\t\t// At this point in most cases it will be in the DOM, but there are exceptions.\n\t\t// For example, if the inline filler was deep in the created DOM structure, it will not be created.\n\t\t// Similarly, if it was removed at the beginning of this function and then neither text nor children were updated,\n\t\t// it will not be present.\n\t\t// Fix those and similar scenarios.\n\t\tif ( inlineFillerPosition ) {\n\t\t\tconst fillerDomPosition = this.domConverter.viewPositionToDom( inlineFillerPosition );\n\t\t\tconst domDocument = fillerDomPosition.parent.ownerDocument;\n\n\t\t\tif ( !startsWithFiller( fillerDomPosition.parent ) ) {\n\t\t\t\t// Filler has not been created at filler position. Create it now.\n\t\t\t\tthis._inlineFiller = addInlineFiller( domDocument, fillerDomPosition.parent, fillerDomPosition.offset );\n\t\t\t} else {\n\t\t\t\t// Filler has been found, save it.\n\t\t\t\tthis._inlineFiller = fillerDomPosition.parent;\n\t\t\t}\n\t\t} else {\n\t\t\t// There is no filler needed.\n\t\t\tthis._inlineFiller = null;\n\t\t}\n\n\t\tthis._updateSelection();\n\t\tthis._updateFocus();\n\n\t\tthis.markedTexts.clear();\n\t\tthis.markedAttributes.clear();\n\t\tthis.markedChildren.clear();\n\t}\n\n\t/**\n\t * Updates mappings of view element's children.\n\t *\n\t * Children that were replaced in the view structure by similar elements (same tag name) are treated as 'replaced'.\n\t * This means that their mappings can be updated so the new view elements are mapped to the existing DOM elements.\n\t * Thanks to that these elements do not need to be re-rendered completely.\n\t *\n\t * @private\n\t * @param {module:engine/view/node~Node} viewElement The view element whose children mappings will be updated.\n\t */\n\t_updateChildrenMappings( viewElement ) {\n\t\tconst domElement = this.domConverter.mapViewToDom( viewElement );\n\n\t\tif ( !domElement ) {\n\t\t\t// If there is no `domElement` it means that it was already removed from DOM and there is no need to process it.\n\t\t\treturn;\n\t\t}\n\n\t\tconst actualDomChildren = this.domConverter.mapViewToDom( viewElement ).childNodes;\n\t\tconst expectedDomChildren = Array.from(\n\t\t\tthis.domConverter.viewChildrenToDom( viewElement, domElement.ownerDocument, { withChildren: false } )\n\t\t);\n\t\tconst diff = this._diffNodeLists( actualDomChildren, expectedDomChildren );\n\t\tconst actions = this._findReplaceActions( diff, actualDomChildren, expectedDomChildren );\n\n\t\tif ( actions.indexOf( 'replace' ) !== -1 ) {\n\t\t\tconst counter = { equal: 0, insert: 0, delete: 0 };\n\n\t\t\tfor ( const action of actions ) {\n\t\t\t\tif ( action === 'replace' ) {\n\t\t\t\t\tconst insertIndex = counter.equal + counter.insert;\n\t\t\t\t\tconst deleteIndex = counter.equal + counter.delete;\n\t\t\t\t\tconst viewChild = viewElement.getChild( insertIndex );\n\n\t\t\t\t\t// The 'uiElement' is a special one and its children are not stored in a view (#799),\n\t\t\t\t\t// so we cannot use it with replacing flow (since it uses view children during rendering\n\t\t\t\t\t// which will always result in rendering empty element).\n\t\t\t\t\tif ( viewChild && !viewChild.is( 'uiElement' ) ) {\n\t\t\t\t\t\tthis._updateElementMappings( viewChild, actualDomChildren[ deleteIndex ] );\n\t\t\t\t\t}\n\n\t\t\t\t\tremove( expectedDomChildren[ insertIndex ] );\n\t\t\t\t\tcounter.equal++;\n\t\t\t\t} else {\n\t\t\t\t\tcounter[ action ]++;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Updates mappings of a given view element.\n\t *\n\t * @private\n\t * @param {module:engine/view/node~Node} viewElement The view element whose mappings will be updated.\n\t * @param {Node} domElement The DOM element representing the given view element.\n\t */\n\t_updateElementMappings( viewElement, domElement ) {\n\t\t// Remap 'DomConverter' bindings.\n\t\tthis.domConverter.unbindDomElement( domElement );\n\t\tthis.domConverter.bindElements( domElement, viewElement );\n\n\t\t// View element may have children which needs to be updated, but are not marked, mark them to update.\n\t\tthis.markedChildren.add( viewElement );\n\n\t\t// Because we replace new view element mapping with the existing one, the corresponding DOM element\n\t\t// will not be rerendered. The new view element may have different attributes than the previous one.\n\t\t// Since its corresponding DOM element will not be rerendered, new attributes will not be added\n\t\t// to the DOM, so we need to mark it here to make sure its attributes gets updated. See #1427 for more\n\t\t// detailed case study.\n\t\t// Also there are cases where replaced element is removed from the view structure and then has\n\t\t// its attributes changed or removed. In such cases the element will not be present in `markedAttributes`\n\t\t// and also may be the same (`element.isSimilar()`) as the reused element not having its attributes updated.\n\t\t// To prevent such situations we always mark reused element to have its attributes rerenderd (#1560).\n\t\tthis.markedAttributes.add( viewElement );\n\t}\n\n\t/**\n\t * Gets the position of the inline filler based on the current selection.\n\t * Here, we assume that we know that the filler is needed and\n\t * {@link #_isSelectionInInlineFiller is at the selection position}, and, since it is needed,\n\t * it is somewhere at the selection position.\n\t *\n\t * Note: The filler position cannot be restored based on the filler's DOM text node, because\n\t * when this method is called (before rendering), the bindings will often be broken. View-to-DOM\n\t * bindings are only dependable after rendering.\n\t *\n\t * @private\n\t * @returns {module:engine/view/position~Position}\n\t */\n\t_getInlineFillerPosition() {\n\t\tconst firstPos = this.selection.getFirstPosition();\n\n\t\tif ( firstPos.parent.is( 'text' ) ) {\n\t\t\treturn ViewPosition._createBefore( this.selection.getFirstPosition().parent );\n\t\t} else {\n\t\t\treturn firstPos;\n\t\t}\n\t}\n\n\t/**\n\t * Returns `true` if the selection has not left the inline filler's text node.\n\t * If it is `true`, it means that the filler had been added for a reason and the selection did not\n\t * leave the filler's text node. For example, the user can be in the middle of a composition so it should not be touched.\n\t *\n\t * @private\n\t * @returns {Boolean} `true` if the inline filler and selection are in the same place.\n\t */\n\t_isSelectionInInlineFiller() {\n\t\tif ( this.selection.rangeCount != 1 || !this.selection.isCollapsed ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Note, we can't check if selection's position equals position of the\n\t\t// this._inlineFiller node, because of #663. We may not be able to calculate\n\t\t// the filler's position in the view at this stage.\n\t\t// Instead, we check it the other way  whether selection is anchored in\n\t\t// that text node or next to it.\n\n\t\t// Possible options are:\n\t\t// \"FILLER{}\"\n\t\t// \"FILLERadded-text{}\"\n\t\tconst selectionPosition = this.selection.getFirstPosition();\n\t\tconst position = this.domConverter.viewPositionToDom( selectionPosition );\n\n\t\tif ( position && isText( position.parent ) && startsWithFiller( position.parent ) ) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Removes the inline filler.\n\t *\n\t * @private\n\t */\n\t_removeInlineFiller() {\n\t\tconst domFillerNode = this._inlineFiller;\n\n\t\t// Something weird happened and the stored node doesn't contain the filler's text.\n\t\tif ( !startsWithFiller( domFillerNode ) ) {\n\t\t\t/**\n\t\t\t * The inline filler node was lost. Most likely, something overwrote the filler text node\n\t\t\t * in the DOM.\n\t\t\t *\n\t\t\t * @error view-renderer-filler-was-lost\n\t\t\t */\n\t\t\tthrow new CKEditorError( 'view-renderer-filler-was-lost: The inline filler node was lost.', this );\n\t\t}\n\n\t\tif ( isInlineFiller( domFillerNode ) ) {\n\t\t\tdomFillerNode.parentNode.removeChild( domFillerNode );\n\t\t} else {\n\t\t\tdomFillerNode.data = domFillerNode.data.substr( INLINE_FILLER_LENGTH );\n\t\t}\n\n\t\tthis._inlineFiller = null;\n\t}\n\n\t/**\n\t * Checks if the inline {@link module:engine/view/filler filler} should be added.\n\t *\n\t * @private\n\t * @returns {Boolean} `true` if the inline filler should be added.\n\t */\n\t_needsInlineFillerAtSelection() {\n\t\tif ( this.selection.rangeCount != 1 || !this.selection.isCollapsed ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst selectionPosition = this.selection.getFirstPosition();\n\t\tconst selectionParent = selectionPosition.parent;\n\t\tconst selectionOffset = selectionPosition.offset;\n\n\t\t// If there is no DOM root we do not care about fillers.\n\t\tif ( !this.domConverter.mapViewToDom( selectionParent.root ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif ( !( selectionParent.is( 'element' ) ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Prevent adding inline filler inside elements with contenteditable=false.\n\t\t// https://github.com/ckeditor/ckeditor5-engine/issues/1170\n\t\tif ( !isEditable( selectionParent ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// We have block filler, we do not need inline one.\n\t\tif ( selectionOffset === selectionParent.getFillerOffset() ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst nodeBefore = selectionPosition.nodeBefore;\n\t\tconst nodeAfter = selectionPosition.nodeAfter;\n\n\t\tif ( nodeBefore instanceof ViewText || nodeAfter instanceof ViewText ) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Checks if text needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t * @param {module:engine/view/text~Text} viewText View text to update.\n\t * @param {Object} options\n\t * @param {module:engine/view/position~Position} options.inlineFillerPosition The position where the inline\n\t * filler should be rendered.\n\t */\n\t_updateText( viewText, options ) {\n\t\tconst domText = this.domConverter.findCorrespondingDomText( viewText );\n\t\tconst newDomText = this.domConverter.viewToDom( viewText, domText.ownerDocument );\n\n\t\tconst actualText = domText.data;\n\t\tlet expectedText = newDomText.data;\n\n\t\tconst filler = options.inlineFillerPosition;\n\n\t\tif ( filler && filler.parent == viewText.parent && filler.offset == viewText.index ) {\n\t\t\texpectedText = INLINE_FILLER + expectedText;\n\t\t}\n\n\t\tif ( actualText != expectedText ) {\n\t\t\tconst actions = fastDiff( actualText, expectedText );\n\n\t\t\tfor ( const action of actions ) {\n\t\t\t\tif ( action.type === 'insert' ) {\n\t\t\t\t\tdomText.insertData( action.index, action.values.join( '' ) );\n\t\t\t\t} else { // 'delete'\n\t\t\t\t\tdomText.deleteData( action.index, action.howMany );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Checks if attribute list needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t * @param {module:engine/view/element~Element} viewElement The view element to update.\n\t */\n\t_updateAttrs( viewElement ) {\n\t\tconst domElement = this.domConverter.mapViewToDom( viewElement );\n\n\t\tif ( !domElement ) {\n\t\t\t// If there is no `domElement` it means that 'viewElement' is outdated as its mapping was updated\n\t\t\t// in 'this._updateChildrenMappings()'. There is no need to process it as new view element which\n\t\t\t// replaced old 'viewElement' mapping was also added to 'this.markedAttributes'\n\t\t\t// in 'this._updateChildrenMappings()' so it will be processed separately.\n\t\t\treturn;\n\t\t}\n\n\t\tconst domAttrKeys = Array.from( domElement.attributes ).map( attr => attr.name );\n\t\tconst viewAttrKeys = viewElement.getAttributeKeys();\n\n\t\t// Add or overwrite attributes.\n\t\tfor ( const key of viewAttrKeys ) {\n\t\t\tdomElement.setAttribute( key, viewElement.getAttribute( key ) );\n\t\t}\n\n\t\t// Remove from DOM attributes which do not exists in the view.\n\t\tfor ( const key of domAttrKeys ) {\n\t\t\tif ( !viewElement.hasAttribute( key ) ) {\n\t\t\t\tdomElement.removeAttribute( key );\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Checks if elements child list needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t * @param {module:engine/view/element~Element} viewElement View element to update.\n\t * @param {Object} options\n\t * @param {module:engine/view/position~Position} options.inlineFillerPosition The position where the inline\n\t * filler should be rendered.\n\t */\n\t_updateChildren( viewElement, options ) {\n\t\tconst domElement = this.domConverter.mapViewToDom( viewElement );\n\n\t\tif ( !domElement ) {\n\t\t\t// If there is no `domElement` it means that it was already removed from DOM.\n\t\t\t// There is no need to process it. It will be processed when re-inserted.\n\t\t\treturn;\n\t\t}\n\n\t\tconst inlineFillerPosition = options.inlineFillerPosition;\n\t\tconst actualDomChildren = this.domConverter.mapViewToDom( viewElement ).childNodes;\n\t\tconst expectedDomChildren = Array.from(\n\t\t\tthis.domConverter.viewChildrenToDom( viewElement, domElement.ownerDocument, { bind: true, inlineFillerPosition } )\n\t\t);\n\n\t\t// Inline filler element has to be created as it is present in the DOM, but not in the view. It is required\n\t\t// during diffing so text nodes could be compared correctly and also during rendering to maintain\n\t\t// proper order and indexes while updating the DOM.\n\t\tif ( inlineFillerPosition && inlineFillerPosition.parent === viewElement ) {\n\t\t\taddInlineFiller( domElement.ownerDocument, expectedDomChildren, inlineFillerPosition.offset );\n\t\t}\n\n\t\tconst diff = this._diffNodeLists( actualDomChildren, expectedDomChildren );\n\n\t\tlet i = 0;\n\t\tconst nodesToUnbind = new Set();\n\n\t\tfor ( const action of diff ) {\n\t\t\tif ( action === 'insert' ) {\n\t\t\t\tinsertAt( domElement, i, expectedDomChildren[ i ] );\n\t\t\t\ti++;\n\t\t\t} else if ( action === 'delete' ) {\n\t\t\t\tnodesToUnbind.add( actualDomChildren[ i ] );\n\t\t\t\tremove( actualDomChildren[ i ] );\n\t\t\t} else { // 'equal'\n\t\t\t\t// Force updating text nodes inside elements which did not change and do not need to be re-rendered (#1125).\n\t\t\t\tthis._markDescendantTextToSync( this.domConverter.domToView( expectedDomChildren[ i ] ) );\n\t\t\t\ti++;\n\t\t\t}\n\t\t}\n\n\t\t// Unbind removed nodes. When node does not have a parent it means that it was removed from DOM tree during\n\t\t// comparision with the expected DOM. We don't need to check child nodes, because if child node was reinserted,\n\t\t// it was moved to DOM tree out of the removed node.\n\t\tfor ( const node of nodesToUnbind ) {\n\t\t\tif ( !node.parentNode ) {\n\t\t\t\tthis.domConverter.unbindDomElement( node );\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Shorthand for diffing two arrays or node lists of DOM nodes.\n\t *\n\t * @private\n\t * @param {Array.<Node>|NodeList} actualDomChildren Actual DOM children\n\t * @param {Array.<Node>|NodeList} expectedDomChildren Expected DOM children.\n\t * @returns {Array.<String>} The list of actions based on the {@link module:utils/diff~diff} function.\n\t */\n\t_diffNodeLists( actualDomChildren, expectedDomChildren ) {\n\t\tactualDomChildren = filterOutFakeSelectionContainer( actualDomChildren, this._fakeSelectionContainer );\n\n\t\treturn diff( actualDomChildren, expectedDomChildren, sameNodes.bind( null, this.domConverter ) );\n\t}\n\n\t/**\n\t * Finds DOM nodes that were replaced with the similar nodes (same tag name) in the view. All nodes are compared\n\t * within one `insert`/`delete` action group, for example:\n\t *\n\t * \t\tActual DOM:\t\t<p><b>Foo</b>Bar<i>Baz</i><b>Bax</b></p>\n\t * \t\tExpected DOM:\t<p>Bar<b>123</b><i>Baz</i><b>456</b></p>\n\t * \t\tInput actions:\t[ insert, insert, delete, delete, equal, insert, delete ]\n\t * \t\tOutput actions:\t[ insert, replace, delete, equal, replace ]\n\t *\n\t * @private\n\t * @param {Array.<String>} actions Actions array which is a result of the {@link module:utils/diff~diff} function.\n\t * @param {Array.<Node>|NodeList} actualDom Actual DOM children\n\t * @param {Array.<Node>} expectedDom Expected DOM children.\n\t * @returns {Array.<String>} Actions array modified with the `replace` actions.\n\t */\n\t_findReplaceActions( actions, actualDom, expectedDom ) {\n\t\t// If there is no both 'insert' and 'delete' actions, no need to check for replaced elements.\n\t\tif ( actions.indexOf( 'insert' ) === -1 || actions.indexOf( 'delete' ) === -1 ) {\n\t\t\treturn actions;\n\t\t}\n\n\t\tlet newActions = [];\n\t\tlet actualSlice = [];\n\t\tlet expectedSlice = [];\n\n\t\tconst counter = { equal: 0, insert: 0, delete: 0 };\n\n\t\tfor ( const action of actions ) {\n\t\t\tif ( action === 'insert' ) {\n\t\t\t\texpectedSlice.push( expectedDom[ counter.equal + counter.insert ] );\n\t\t\t} else if ( action === 'delete' ) {\n\t\t\t\tactualSlice.push( actualDom[ counter.equal + counter.delete ] );\n\t\t\t} else { // equal\n\t\t\t\tnewActions = newActions.concat( diff( actualSlice, expectedSlice, areSimilar ).map( x => x === 'equal' ? 'replace' : x ) );\n\t\t\t\tnewActions.push( 'equal' );\n\t\t\t\t// Reset stored elements on 'equal'.\n\t\t\t\tactualSlice = [];\n\t\t\t\texpectedSlice = [];\n\t\t\t}\n\t\t\tcounter[ action ]++;\n\t\t}\n\n\t\treturn newActions.concat( diff( actualSlice, expectedSlice, areSimilar ).map( x => x === 'equal' ? 'replace' : x ) );\n\t}\n\n\t/**\n\t * Marks text nodes to be synchronized.\n\t *\n\t * If a text node is passed, it will be marked. If an element is passed, all descendant text nodes inside it will be marked.\n\t *\n\t * @private\n\t * @param {module:engine/view/node~Node} viewNode View node to sync.\n\t */\n\t_markDescendantTextToSync( viewNode ) {\n\t\tif ( !viewNode ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( viewNode.is( 'text' ) ) {\n\t\t\tthis.markedTexts.add( viewNode );\n\t\t} else if ( viewNode.is( 'element' ) ) {\n\t\t\tfor ( const child of viewNode.getChildren() ) {\n\t\t\t\tthis._markDescendantTextToSync( child );\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Checks if the selection needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t */\n\t_updateSelection() {\n\t\t// If there is no selection - remove DOM and fake selections.\n\t\tif ( this.selection.rangeCount === 0 ) {\n\t\t\tthis._removeDomSelection();\n\t\t\tthis._removeFakeSelection();\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst domRoot = this.domConverter.mapViewToDom( this.selection.editableElement );\n\n\t\t// Do nothing if there is no focus, or there is no DOM element corresponding to selection's editable element.\n\t\tif ( !this.isFocused || !domRoot ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Render selection.\n\t\tif ( this.selection.isFake ) {\n\t\t\tthis._updateFakeSelection( domRoot );\n\t\t} else {\n\t\t\tthis._removeFakeSelection();\n\t\t\tthis._updateDomSelection( domRoot );\n\t\t}\n\t}\n\n\t/**\n\t * Updates the fake selection.\n\t *\n\t * @private\n\t * @param {HTMLElement} domRoot A valid DOM root where the fake selection container should be added.\n\t */\n\t_updateFakeSelection( domRoot ) {\n\t\tconst domDocument = domRoot.ownerDocument;\n\n\t\tif ( !this._fakeSelectionContainer ) {\n\t\t\tthis._fakeSelectionContainer = createFakeSelectionContainer( domDocument );\n\t\t}\n\n\t\tconst container = this._fakeSelectionContainer;\n\n\t\t// Bind fake selection container with the current selection *position*.\n\t\tthis.domConverter.bindFakeSelection( container, this.selection );\n\n\t\tif ( !this._fakeSelectionNeedsUpdate( domRoot ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( !container.parentElement || container.parentElement != domRoot ) {\n\t\t\tdomRoot.appendChild( container );\n\t\t}\n\n\t\tcontainer.textContent = this.selection.fakeSelectionLabel || '\\u00A0';\n\n\t\tconst domSelection = domDocument.getSelection();\n\t\tconst domRange = domDocument.createRange();\n\n\t\tdomSelection.removeAllRanges();\n\t\tdomRange.selectNodeContents( container );\n\t\tdomSelection.addRange( domRange );\n\t}\n\n\t/**\n\t * Updates the DOM selection.\n\t *\n\t * @private\n\t * @param {HTMLElement} domRoot A valid DOM root where the DOM selection should be rendered.\n\t */\n\t_updateDomSelection( domRoot ) {\n\t\tconst domSelection = domRoot.ownerDocument.defaultView.getSelection();\n\n\t\t// Let's check whether DOM selection needs updating at all.\n\t\tif ( !this._domSelectionNeedsUpdate( domSelection ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Multi-range selection is not available in most browsers, and, at least in Chrome, trying to\n\t\t// set such selection, that is not continuous, throws an error. Because of that, we will just use anchor\n\t\t// and focus of view selection.\n\t\t// Since we are not supporting multi-range selection, we also do not need to check if proper editable is\n\t\t// selected. If there is any editable selected, it is okay (editable is taken from selection anchor).\n\t\tconst anchor = this.domConverter.viewPositionToDom( this.selection.anchor );\n\t\tconst focus = this.domConverter.viewPositionToDom( this.selection.focus );\n\n\t\t// Focus the new editing host.\n\t\t// Otherwise, FF may throw an error (https://github.com/ckeditor/ckeditor5/issues/721).\n\t\tdomRoot.focus();\n\n\t\tdomSelection.collapse( anchor.parent, anchor.offset );\n\t\tdomSelection.extend( focus.parent, focus.offset );\n\n\t\t// Firefoxspecific hack (https://github.com/ckeditor/ckeditor5-engine/issues/1439).\n\t\tif ( env.isGecko ) {\n\t\t\tfixGeckoSelectionAfterBr( focus, domSelection );\n\t\t}\n\t}\n\n\t/**\n\t * Checks whether a given DOM selection needs to be updated.\n\t *\n\t * @private\n\t * @param {Selection} domSelection The DOM selection to check.\n\t * @returns {Boolean}\n\t */\n\t_domSelectionNeedsUpdate( domSelection ) {\n\t\tif ( !this.domConverter.isDomSelectionCorrect( domSelection ) ) {\n\t\t\t// Current DOM selection is in incorrect position. We need to update it.\n\t\t\treturn true;\n\t\t}\n\n\t\tconst oldViewSelection = domSelection && this.domConverter.domSelectionToView( domSelection );\n\n\t\tif ( oldViewSelection && this.selection.isEqual( oldViewSelection ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// If selection is not collapsed, it does not need to be updated if it is similar.\n\t\tif ( !this.selection.isCollapsed && this.selection.isSimilar( oldViewSelection ) ) {\n\t\t\t// Selection did not changed and is correct, do not update.\n\t\t\treturn false;\n\t\t}\n\n\t\t// Selections are not similar.\n\t\treturn true;\n\t}\n\n\t/**\n\t * Checks whether the fake selection needs to be updated.\n\t *\n\t * @private\n\t * @param {HTMLElement} domRoot A valid DOM root where a new fake selection container should be added.\n\t * @returns {Boolean}\n\t */\n\t_fakeSelectionNeedsUpdate( domRoot ) {\n\t\tconst container = this._fakeSelectionContainer;\n\t\tconst domSelection = domRoot.ownerDocument.getSelection();\n\n\t\t// Fake selection needs to be updated if there's no fake selection container, or the container currently sits\n\t\t// in a different root.\n\t\tif ( !container || container.parentElement !== domRoot ) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// Make sure that the selection actually is within the fake selection.\n\t\tif ( domSelection.anchorNode !== container && !container.contains( domSelection.anchorNode ) ) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn container.textContent !== this.selection.fakeSelectionLabel;\n\t}\n\n\t/**\n\t * Removes the DOM selection.\n\t *\n\t * @private\n\t */\n\t_removeDomSelection() {\n\t\tfor ( const doc of this.domDocuments ) {\n\t\t\tconst domSelection = doc.getSelection();\n\n\t\t\tif ( domSelection.rangeCount ) {\n\t\t\t\tconst activeDomElement = doc.activeElement;\n\t\t\t\tconst viewElement = this.domConverter.mapDomToView( activeDomElement );\n\n\t\t\t\tif ( activeDomElement && viewElement ) {\n\t\t\t\t\tdoc.getSelection().removeAllRanges();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Removes the fake selection.\n\t *\n\t * @private\n\t */\n\t_removeFakeSelection() {\n\t\tconst container = this._fakeSelectionContainer;\n\n\t\tif ( container ) {\n\t\t\tcontainer.remove();\n\t\t}\n\t}\n\n\t/**\n\t * Checks if focus needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t */\n\t_updateFocus() {\n\t\tif ( this.isFocused ) {\n\t\t\tconst editable = this.selection.editableElement;\n\n\t\t\tif ( editable ) {\n\t\t\t\tthis.domConverter.focus( editable );\n\t\t\t}\n\t\t}\n\t}\n}\n\nmix( Renderer, ObservableMixin );\n\n// Checks if provided element is editable.\n//\n// @private\n// @param {module:engine/view/element~Element} element\n// @returns {Boolean}\nfunction isEditable( element ) {\n\tif ( element.getAttribute( 'contenteditable' ) == 'false' ) {\n\t\treturn false;\n\t}\n\n\tconst parent = element.findAncestor( element => element.hasAttribute( 'contenteditable' ) );\n\n\treturn !parent || parent.getAttribute( 'contenteditable' ) == 'true';\n}\n\n// Adds inline filler at a given position.\n//\n// The position can be given as an array of DOM nodes and an offset in that array,\n// or a DOM parent element and an offset in that element.\n//\n// @private\n// @param {Document} domDocument\n// @param {Element|Array.<Node>} domParentOrArray\n// @param {Number} offset\n// @returns {Text} The DOM text node that contains an inline filler.\nfunction addInlineFiller( domDocument, domParentOrArray, offset ) {\n\tconst childNodes = domParentOrArray instanceof Array ? domParentOrArray : domParentOrArray.childNodes;\n\tconst nodeAfterFiller = childNodes[ offset ];\n\n\tif ( isText( nodeAfterFiller ) ) {\n\t\tnodeAfterFiller.data = INLINE_FILLER + nodeAfterFiller.data;\n\n\t\treturn nodeAfterFiller;\n\t} else {\n\t\tconst fillerNode = domDocument.createTextNode( INLINE_FILLER );\n\n\t\tif ( Array.isArray( domParentOrArray ) ) {\n\t\t\tchildNodes.splice( offset, 0, fillerNode );\n\t\t} else {\n\t\t\tinsertAt( domParentOrArray, offset, fillerNode );\n\t\t}\n\n\t\treturn fillerNode;\n\t}\n}\n\n// Whether two DOM nodes should be considered as similar.\n// Nodes are considered similar if they have the same tag name.\n//\n// @private\n// @param {Node} node1\n// @param {Node} node2\n// @returns {Boolean}\nfunction areSimilar( node1, node2 ) {\n\treturn isNode( node1 ) && isNode( node2 ) &&\n\t\t!isText( node1 ) && !isText( node2 ) &&\n\t\tnode1.tagName.toLowerCase() === node2.tagName.toLowerCase();\n}\n\n// Whether two dom nodes should be considered as the same.\n// Two nodes which are considered the same are:\n//\n//\t\t* Text nodes with the same text.\n//\t\t* Element nodes represented by the same object.\n//\t\t* Two block filler elements.\n//\n// @private\n// @param {String} blockFillerMode Block filler mode, see {@link module:engine/view/domconverter~DomConverter#blockFillerMode}.\n// @param {Node} node1\n// @param {Node} node2\n// @returns {Boolean}\nfunction sameNodes( domConverter, actualDomChild, expectedDomChild ) {\n\t// Elements.\n\tif ( actualDomChild === expectedDomChild ) {\n\t\treturn true;\n\t}\n\t// Texts.\n\telse if ( isText( actualDomChild ) && isText( expectedDomChild ) ) {\n\t\treturn actualDomChild.data === expectedDomChild.data;\n\t}\n\t// Block fillers.\n\telse if ( domConverter.isBlockFiller( actualDomChild ) &&\n\t\tdomConverter.isBlockFiller( expectedDomChild ) ) {\n\t\treturn true;\n\t}\n\n\t// Not matching types.\n\treturn false;\n}\n\n// The following is a Firefoxspecific hack (https://github.com/ckeditor/ckeditor5-engine/issues/1439).\n// When the native DOM selection is at the end of the block and preceded by <br /> e.g.\n//\n//\t\t<p>foo<br/>[]</p>\n//\n// which happens a lot when using the soft line break, the browser fails to (visually) move the\n// caret to the new line. A quick fix is as simple as forcerefreshing the selection with the same range.\nfunction fixGeckoSelectionAfterBr( focus, domSelection ) {\n\tconst parent = focus.parent;\n\n\t// This fix works only when the focus point is at the very end of an element.\n\t// There is no point in running it in cases unrelated to the browser bug.\n\tif ( parent.nodeType != Node.ELEMENT_NODE || focus.offset != parent.childNodes.length - 1 ) {\n\t\treturn;\n\t}\n\n\tconst childAtOffset = parent.childNodes[ focus.offset ];\n\n\t// To stay on the safe side, the fix being as specific as possible, it targets only the\n\t// selection which is at the very end of the element and preceded by <br />.\n\tif ( childAtOffset && childAtOffset.tagName == 'BR' ) {\n\t\tdomSelection.addRange( domSelection.getRangeAt( 0 ) );\n\t}\n}\n\nfunction filterOutFakeSelectionContainer( domChildList, fakeSelectionContainer ) {\n\tconst childList = Array.from( domChildList );\n\n\tif ( childList.length == 0 || !fakeSelectionContainer ) {\n\t\treturn childList;\n\t}\n\n\tconst last = childList[ childList.length - 1 ];\n\n\tif ( last == fakeSelectionContainer ) {\n\t\tchildList.pop();\n\t}\n\n\treturn childList;\n}\n\n// Creates a fake selection container for a given document.\n//\n// @private\n// @param {Document} domDocument\n// @returns {HTMLElement}\nfunction createFakeSelectionContainer( domDocument ) {\n\tconst container = domDocument.createElement( 'div' );\n\n\tObject.assign( container.style, {\n\t\tposition: 'fixed',\n\t\ttop: 0,\n\t\tleft: '-9999px',\n\t\t// See https://github.com/ckeditor/ckeditor5/issues/752.\n\t\twidth: '42px'\n\t} );\n\n\t// Fill it with a text node so we can update it later.\n\tcontainer.textContent = '\\u00A0';\n\n\treturn container;\n}\n"]}]}